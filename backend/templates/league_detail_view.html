<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- El título se tomará de la variable 'league' si está disponible, sino un default -->
    <title>{{ league.name if league else "Detalle de Liga" }} - TriPredict</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> {# SweetAlert2 for notifications #}
    <!-- Favicon link -->
    <link rel="icon" href="{{ url_for('static', filename='img/favicon.svg') }}" type="image/svg+xml">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        /* Estilos para el modal de SweetAlert2 (si se usa para mensajes flash) */
        .swal2-popup {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100">

    <!-- Header Global (copiado del diseño proporcionado) -->
{% include '_header.html' %}

    <!-- Hero Section de la Liga con Acciones de Admin (Movida fuera del <main> para ancho completo) -->
    <div class="bg-orange-500 text-white shadow-md p-6"> <!-- Eliminado mb-8 y rounded-lg para que se pegue al header y ocupe todo el ancho sin redondearse si está pegado -->
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8"> <!-- Contenedor opcional para mantener padding interno consistente con el header -->
            <div class="flex flex-col md:flex-row md:justify-between md:items-start">
                <div>
                    <h1 class="text-3xl font-bold">{{ league.name }}</h1>
                    <p class="text-orange-100 mt-1">
                        Creada por: <span class="font-semibold">{{ league.creator.username if league.creator else 'N/A' }}</span> |
                        Fecha de creación: <span class="font-semibold">{{ league.created_at|format_date_filter }}</span>
                    </p>
                     <!-- Botones de Acción para el Admin de la Liga -->
                    {% if current_user_is_creator_or_admin %}
                    <div class="mt-4 flex items-center space-x-2">
                        <a href="{{ url_for('edit_league', league_id=league.id) }}" class="bg-white/20 hover:bg-white/30 text-white text-sm font-semibold py-2 px-3 rounded-md flex items-center"><i class="fas fa-edit mr-2"></i>Editar Liga</a>
                        {% if invitation_code and invitation_code.is_active %}
                        <button id="show-league-invitation-code-button" class="bg-white/20 hover:bg-white/30 text-white text-sm font-semibold py-2 px-3 rounded-md flex items-center"><i class="fas fa-share-alt mr-2"></i>Compartir Código</button>
                        {% elif not invitation_code or not invitation_code.is_active %}
                        {# Button to generate/reactivate code could go here or elsewhere as per original logic #}
                        {# For now, matching the new static HTML, it's not shown if no active code #}
                        {% endif %}
                        <form action="{{ url_for('delete_league', league_id=league.id) }}" method="POST" onsubmit="return confirm('¿Estás seguro de que quieres eliminar esta liga? Esta acción no se puede deshacer.');" class="inline">
                            <button type="submit" class="bg-red-500/50 hover:bg-red-500 text-white text-sm font-semibold py-2 px-3 rounded-md flex items-center"><i class="fas fa-trash-alt mr-2"></i>Eliminar Liga</button>
                        </form>
                    </div>
                    {% endif %}
                    {# Button to generate invitation code if none exists or is inactive, for admins #}
                    {% if current_user_is_creator_or_admin and (not invitation_code or not invitation_code.is_active) %}
                    <div class="mt-4">
                        <form action="{{ url_for('generate_league_invitation_code', league_id=league.id) }}" method="POST">
                            {% if not invitation_code %}
                                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-2 px-3 rounded-md flex items-center">
                                    <i class="fas fa-plus-circle mr-2"></i>Generar Código de Invitación
                                </button>
                            {% elif invitation_code and not invitation_code.is_active %}
                                <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-semibold py-2 px-3 rounded-md flex items-center">
                                    <i class="fas fa-redo-alt mr-2"></i>Reactivar Código
                                </button>
                            {% endif %}
                        </form>
                    </div>
                    {% endif %}

                </div>
                <div class="mt-4 md:mt-0 flex items-center space-x-6 bg-black bg-opacity-20 p-4 rounded-lg">
                    <div class="text-center">
                        <p class="text-sm text-orange-200 uppercase tracking-wider">Próximo Cierre</p>
                        {# El data attribute se poblará desde Flask/Jinja2 con la variable next_race_close_date_isoformat #}
                        <div class="text-2xl font-bold" id="countdown" data-next-close-date="{{ next_race_close_date_isoformat if next_race_close_date_isoformat else '' }}">
                            {# El contenido inicial será actualizado por JavaScript. Puede ser un loader o N/A #}
                            Calculando...
                        </div>
                    </div>
                    <div class="text-center border-l border-orange-400 pl-6">
                        <p class="text-3xl font-bold">{{ league_races_detailed|length }}</p>
                        <p class="text-sm text-orange-200">Carreras</p>
                    </div>
                    <div class="text-center">
                        {# Mostrar el número de participantes de la liga #}
                        <p class="text-3xl font-bold">{{ league_participants_count if league_participants_count is not none else '0' }}</p>
                        <p class="text-sm text-orange-200">Participantes</p>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- Fin de la sección Hero movida -->

    <!-- Contenido Principal (ahora solo contiene lo que no es Hero) -->
    <main class="p-4 sm:p-6 lg:p-8">

        <!-- Carreras y Clasificación en un grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Columna Izquierda: Carreras y Análisis -->
            <div class="lg:col-span-2 space-y-8">
                 <!-- Carreras en esta Liga -->
                <div class="bg-white shadow-md rounded-lg">
                    <div class="p-6 border-b">
                        <h2 class="text-xl font-bold text-gray-900">Carreras en esta Liga</h2>
                    </div>
                    <div class="overflow-x-auto">
                        {% if league_races_detailed and league_races_detailed|length > 0 %}
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Carrera</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cierre Pronósticos</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for race in league_races_detailed %}
                                <tr class="{% if loop.index is odd %}bg-white{% else %}bg-gray-50{% endif %}">
                                    <td class="px-6 py-4">
                                        <a href="{{ url_for('serve_race_detail_page', race_id=race.id) }}" class="font-medium text-gray-800 hover:text-orange-500 hover:underline">{{ race.title }}</a>
                                        <p class="text-sm text-gray-500">{{ race.event_date|format_date_filter }}</p>
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-500">{{ race.quiniela_close_date|format_date_filter if race.quiniela_close_date else 'N/A' }}</td>
                                    <td class="px-6 py-4">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                                        {% if race.status.value == 'CLOSED' %}bg-red-100 text-red-800
                                        {% elif race.status.value == 'PLANNED' %}bg-gray-100 text-gray-800
                                        {% elif race.status.value == 'ACTIVE' %}bg-green-100 text-green-800
                                        {% else %}bg-blue-100 text-blue-800{% endif %}">
                                            {{ race.status.value|capitalize }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 text-center space-x-1 sm:space-x-2 md:space-x-4">
                                        <button onclick="openRaceResultsModal('{{ race.id }}', '{{ race.title }}')" class="text-gray-400 hover:text-orange-600" title="Ver Clasificación"><i class="fas fa-trophy"></i></button>
                                        {# Assuming 'make_prediction_page' and 'view_prediction_page' routes exist #}
                                        {% set prediction_status = user_predictions_status.get(race.id) %}
                                        {% set user_prediction_exists = prediction_status.exists if prediction_status else false %}
                                        {% set prediction_status = user_predictions_status.get(race.id) %}
                                        {% set user_prediction_exists = prediction_status.exists if prediction_status else false %}
                                        {% set pending_count = prediction_status.pending_count if prediction_status and user_prediction_exists else 0 %}
                                        {% set quiniela_is_closed = race.quiniela_close_date and race.quiniela_close_date < current_time_utc %}

                                        {# Temporarily showing all buttons to debug visibility #}
                                        {# Original "Responder/Editar Quiniela" button #}
                                        <button onclick="openAnswerQuinielaModal('{{ race.id }}', '{{ race.title }}', {{ 'true' if user_prediction_exists else 'false' }}, {{ pending_count }})"
                                                class="text-orange-600 hover:text-orange-800 font-bold relative"
                                                title="{{ 'Editar mis Predicciones' if user_prediction_exists else 'Responder Quiniela' }}">
                                            <i class="fas fa-edit"></i>
                                            {% if user_prediction_exists and pending_count > 0 %}
                                                <span class="absolute -top-1 -right-2 bg-red-500 text-white text-xs font-semibold px-1.5 py-0.5 rounded-full" title="{{pending_count}} pregunta(s) pendiente(s)">{{ pending_count }}</span>
                                            {% endif %}
                                        </button>

                                        {# New Button for Question Wizard #}
                                        <button onclick="openWizardForRace('{{ race.id }}', '{{ race.title }}', {{ 'true' if quiniela_is_closed else 'false' }})"
                                                class="text-purple-600 hover:text-purple-800 font-bold relative"
                                                title="Participar con Wizard">
                                            <i class="fas fa-magic"></i>
                                        </button>

                                        {# Button for "Ver mi Quiniela" (if quiniela closed and user participated) #}
                                        <button onclick="openUserPredictionsModal('{{ race.id }}', '{{ race.title }}', true)"
                                                class="text-gray-400 hover:text-orange-600 font-bold"
                                                title="Ver mi Quiniela (Cerrada)">
                                            <i class="fas fa-eye"></i>
                                        </button>

                                        {# Indicator for "Quiniela cerrada y no participaste" #}
                                        <span class="text-gray-400 cursor-not-allowed" title="Quiniela cerrada y no participaste">
                                            <i class="fas fa-times-circle"></i>
                                        </span>
                                        {# End of temporarily showing all buttons #}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div class="p-6 text-center text-gray-500">
                            <i class="fas fa-flag-checkered text-4xl mb-2"></i>
                            <p>No hay carreras en esta liga todavía.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                 <!-- Análisis por Carrera -->
                <div class="bg-white shadow-md rounded-lg">
                    <div class="p-6 border-b flex justify-between items-center">
                        <h2 class="text-xl font-bold text-gray-900">Análisis por Carrera</h2>
                        {% if league_races_detailed and league_races_detailed|length > 0 %}
                        <select id="race-selector" class="text-sm border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500">
                            {% for race in league_races_detailed %}
                            <option value="{{ race.id }}">{{ race.title }}</option>
                            {% endfor %}
                        </select>
                        {% else %}
                        <p class="text-sm text-gray-500">No hay carreras para analizar.</p>
                        {% endif %}
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">Pos.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Participante</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Puntos</th>
                                </tr>
                            </thead>
                            <tbody id="race-details-body" class="bg-white divide-y divide-gray-200">
                                <!-- JS will populate this -->
                                 <tr><td colspan="3" class="text-center p-4 text-gray-500">Selecciona una carrera para ver el análisis.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Columna Derecha: Clasificación General y Actividad -->
            <div class="lg:col-span-1 space-y-8">
                 <!-- Clasificación General con Avatares -->
                <div class="bg-white shadow-md rounded-lg">
                     <div class="p-6 border-b"><h2 class="text-xl font-bold text-gray-900">Clasificación General</h2></div>
                    <div class="overflow-x-auto">
                        {% if league_standings and league_standings|length > 0 %}
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">Pos.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Participante</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Puntos</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for standing in league_standings %}
                                <tr class="{% if loop.index is odd %}bg-white{% else %}bg-gray-50{% endif %}">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">{{ loop.index }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center">
                                        <img src="{{ standing.avatar_url or url_for('static', filename='img/favicon_promo.svg') }}" class="w-8 h-8 rounded-full mr-3" alt="Avatar">
                                        {{ standing.username }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold text-orange-600">{{ standing.total_score }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div class="p-6 text-center text-gray-500">
                             <i class="fas fa-users-slash text-4xl mb-2"></i>
                            <p>Aún no hay clasificación disponible.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <!-- Feed de Actividad de la Liga (Dummy) REMOVED -->
            </div>
        </div>
    </main>

    <!-- Include the race results modal -->
    {% include '_race_results_modal.html' %}
    <!-- Include the user predictions modal -->
    {% include '_user_predictions_modal.html' %}

    {# Modal para unirse a la liga con código (similar al original) #}
    <div id="join-league-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full transform transition-all">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Unirse a la Liga "{{ league.name }}"</h3>
                    <button onclick="closeJoinLeagueModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="join-league-form" action="{{ url_for('process_join_league_with_code') }}" method="POST">
                    <div class="mb-4">
                        <label for="league-join-code" class="block text-sm font-medium text-gray-700 mb-1">Código de Invitación</label>
                        <input type="text" name="join_code" id="league-join-code" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm"
                               placeholder="Introduce el código de invitación">
                        <input type="hidden" name="league_id" value="{{ league.id }}">
                    </div>
                    <div class="flex items-center justify-end space-x-3">
                        <button type="button" onclick="closeJoinLeagueModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg font-medium transition-colors">
                            Unirme a la Liga
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para MOSTRAR el código de invitación de la liga (similar al original) -->
    {% if invitation_code %}
    <div id="show-league-code-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full transform transition-all">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Código de Invitación para "{{ league.name }}"</h3>
                    <button onclick="closeShowLeagueCodeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="my-4">
                    <p class="text-sm text-gray-600 mb-2">Comparte este código para que otros se unan:</p>
                    <div class="bg-gray-100 p-3 rounded-lg flex items-center justify-between">
                        <span id="league-invitation-code-display" class="text-xl font-mono text-gray-800">{{ invitation_code.code }}</span>
                        <button id="copy-league-code-button"
                                class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors flex items-center">
                            <i class="far fa-copy mr-2"></i>Copiar
                        </button>
                    </div>
                    {% if invitation_code.expires_at %}
                    <p class="text-xs text-gray-500 mt-2">Expira: {{ invitation_code.expires_at|format_date_filter('%d %b %Y %H:%M') }}</p>
                    {% else %}
                    <p class="text-xs text-gray-500 mt-2">Este código no expira.</p>
                    {% endif %}
                </div>
                <div class="flex items-center justify-end mt-6">
                    <button type="button" onclick="closeShowLeagueCodeModal()" class="btn-secondary px-5 py-2">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <script>
        // Data for race analysis - this would ideally come from Flask/backend
        // For now, using a structure that can be populated by Flask if needed
        // The keys for raceData should be race IDs.
        // Data for race analysis - this would ideally come from Flask/backend
        // For now, using a structure that can be populated by Flask if needed
        // The keys for raceData should be race IDs.
        // const raceAnalysisData = {
        //     {% for race in league_races_detailed %}
        //         "{{ race.id }}": [
        //             // This part needs to be populated with actual participant scores for each race.
        //             // Example: { pos: 1, name: 'Participant A', points: 50, avatar_url: '...' },
        //             // For now, it will be empty or use dummy data if available from backend.
        //             // Let's assume a variable `race_analysis_details` is passed from Flask
        //             // `race_analysis_details` would be a dict like: { race_id: [ {details}, ... ], ... }
        //             {% if race_analysis_details and race_analysis_details[race.id|string] %}
        //                 {% for detail in race_analysis_details[race.id|string] %}
        //                     { pos: {{ detail.pos if detail.pos is not none else "'-'" }}, name: '{{ detail.name }}', points: {{ detail.points if detail.points is not none else 0 }} },
        //                 {% endfor %}
        //             {% else %}
        //                  // Dummy data if not provided by backend for this specific race
        //                 // { pos: '-', name: 'Participante Ejemplo Desde JS', points: 0 },
        //             {% endif %}
        //         ],
        //     {% endfor %}
        // };
        // Convertir los datos de Flask/Jinja2 a un objeto JavaScript
        // Asegúrate que `race_analysis_details` se pasa correctamente desde Flask y tiene la estructura:
        // { "race_id_str": [ { "pos": X, "name": "Y", "points": Z }, ... ], ... }
        const raceAnalysisData = {{ race_analysis_details | tojson | safe }};

        const raceSelector = document.getElementById('race-selector');
        const raceDetailsBody = document.getElementById('race-details-body');

        function renderRaceDetails(raceId) {
            const data = raceAnalysisData[raceId] || [];
            raceDetailsBody.innerHTML = ''; // Clear previous entries

            if (data.length === 0) {
                raceDetailsBody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-gray-500">No hay datos de análisis para esta carrera.</td></tr>';
                return;
            }

            // Sort data by position, handling '-'
            data.sort((a, b) => {
                if (a.pos === '-' && b.pos === '-') return 0;
                if (a.pos === '-') return 1;
                if (b.pos === '-') return -1;
                return a.pos - b.pos;
            });

            data.forEach((player, index) => {
                const row = document.createElement('tr');
                if (index % 2 !== 0) { row.classList.add('bg-gray-50'); } // Alternate row color
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">${player.pos}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${player.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold text-gray-700">${player.points}</td>
                `;
                raceDetailsBody.appendChild(row);
            });
        }

        if (raceSelector) {
            raceSelector.addEventListener('change', (event) => {
                renderRaceDetails(event.target.value);
            });
            // Initial load for the first selected race (if any)
            if (raceSelector.value) {
                renderRaceDetails(raceSelector.value);
            } else if (raceDetailsBody) {
                 raceDetailsBody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-gray-500">No hay carreras seleccionadas o disponibles para análisis.</td></tr>';
            }
        } else if (raceDetailsBody) {
            // If no selector, means no races, so show message in table
            raceDetailsBody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-gray-500">No hay carreras disponibles para análisis.</td></tr>';
        }


        // Modal functions (similar to original, adapted for current structure)
        function openJoinLeagueModal(leagueId) {
            const modal = document.getElementById('join-league-modal');
            // const form = document.getElementById('join-league-form'); // Action is already set in HTML
            if (modal) {
                // If you need to dynamically set league_id in the form, do it here
                // For example, if you have a hidden input:
                // modal.querySelector('input[name="league_id"]').value = leagueId;
                modal.classList.remove('hidden');
                document.getElementById('league-join-code').focus();
            }
        }

        function closeJoinLeagueModal() {
            const modal = document.getElementById('join-league-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        const showCodeButton = document.getElementById('show-league-invitation-code-button');
        const showLeagueCodeModalElem = document.getElementById('show-league-code-modal');

        if (showCodeButton && showLeagueCodeModalElem) {
            showCodeButton.addEventListener('click', () => {
                showLeagueCodeModalElem.classList.remove('hidden');
            });
        }

        function closeShowLeagueCodeModal() {
            if (showLeagueCodeModalElem) {
                showLeagueCodeModalElem.classList.add('hidden');
            }
        }

        const copyCodeButton = document.getElementById('copy-league-code-button');
        if (copyCodeButton) {
            copyCodeButton.addEventListener('click', () => {
                const codeToCopy = document.getElementById('league-invitation-code-display').textContent;
                navigator.clipboard.writeText(codeToCopy).then(() => {
                    const originalButtonHtml = copyCodeButton.innerHTML;
                    copyCodeButton.innerHTML = '<i class="fas fa-check mr-2"></i>¡Copiado!';
                    copyCodeButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    copyCodeButton.classList.add('bg-green-500');
                    setTimeout(() => {
                        copyCodeButton.innerHTML = originalButtonHtml;
                        copyCodeButton.classList.remove('bg-green-500');
                        copyCodeButton.classList.add('bg-blue-500', 'hover:bg-blue-600');
                    }, 2000);
                }).catch(err => {
                    console.error('Error al copiar código: ', err);
                });
            });
        }

        // Countdown timer
        const countdownElement = document.getElementById('countdown');
        // Get the next closing date from the data attribute
        let nextCloseDateISO = countdownElement.dataset.nextCloseDate;
        console.log("[Countdown] Initial nextCloseDateISO from data attribute: ", nextCloseDateISO);

        function updateCountdown() {
            if (!nextCloseDateISO || nextCloseDateISO === '') { // Check if empty or not set
                console.log("[Countdown] No nextCloseDateISO or empty. Setting to N/A.");
                countdownElement.textContent = "N/A";
                if (countdownInterval) clearInterval(countdownInterval); // Stop interval if no date
                return;
            }

            // Asegurar que la fecha se interprete como UTC si no tiene 'Z'
            let dateStringToParse = nextCloseDateISO;
            if (!dateStringToParse.endsWith('Z') && dateStringToParse.includes('T')) {
                // Si es un formato ISO sin Z, asumimos UTC y lo añadimos para consistencia.
                // Esto es importante porque new Date("YYYY-MM-DDTHH:MM:SS") puede ser local o UTC según el navegador.
                // new Date("YYYY-MM-DDTHH:MM:SSZ") es explícitamente UTC.
                // No añadimos 'Z' si ya está o si no es un formato con 'T' (ej. solo fecha YYYY-MM-DD)
                // aunque el backend debería enviar con T.
                dateStringToParse += 'Z';
                console.log("[Countdown] Appended 'Z' for UTC parsing. String to parse: ", dateStringToParse);
            } else {
                console.log("[Countdown] Using original date string (already has Z or not a T-format): ", dateStringToParse);
            }

            const targetDate = new Date(dateStringToParse);
            const now = new Date(); // Esto es la hora local del navegador

            console.log("[Countdown] Target Date Object (parsed as UTC): ", targetDate.toISOString(), targetDate);
            console.log("[Countdown] Current Browser Local Date Object: ", now.toISOString(), now);

            // Para una comparación correcta, ambas fechas deben estar en la misma base (UTC o local).
            // targetDate ya es UTC (o se parseó como tal). `now.getTime()` da ms desde epoch UTC.
            // `targetDate.getTime()` también da ms desde epoch UTC.
            const diff = targetDate.getTime() - now.getTime();
            console.log("[Countdown] Difference in milliseconds: ", diff);


            if (diff <= 0) {
                console.log("[Countdown] Difference is zero or negative. Setting to Cerrado.");
                countdownElement.textContent = "Cerrado";
                if (countdownInterval) clearInterval(countdownInterval); // Stop interval
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            // const seconds = Math.floor((diff % (1000 * 60)) / 1000); // Uncomment if you want seconds

            countdownElement.textContent = `${String(days).padStart(2, '0')}d ${String(hours).padStart(2, '0')}h ${String(minutes).padStart(2, '0')}m`;
        }

        let countdownInterval; // Declare interval variable outside
        if (nextCloseDateISO && nextCloseDateISO !== '') {
            updateCountdown(); // Initial call
            countdownInterval = setInterval(updateCountdown, 60000); // Update every minute
        } else {
             countdownElement.textContent = "N/A"; // Default if no date
        }

        // Functions for Race Results Modal
        function openRaceResultsModal(raceId, raceName) {
            const modal = document.getElementById('raceResultsModal');
            const modalTitle = document.getElementById('raceResultsModalTitle');
            const modalContent = document.getElementById('raceResultsModalContent');

            if (modalTitle) {
                modalTitle.textContent = `Clasificación de: ${raceName}`;
            }
            if (modalContent) {
                modalContent.innerHTML = '<p class="text-center text-gray-500">Cargando resultados...</p>';
                // Fetch results from the backend
                fetch(`/race/${raceId}/results_modal_content`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(html => {
                        modalContent.innerHTML = html;
                    })
                    .catch(error => {
                        console.error('Error fetching race results:', error);
                        modalContent.innerHTML = `<p class="text-center text-red-500">Error al cargar los resultados. ${error.message}</p>`;
                    });
            }

            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function closeRaceResultsModal() {
            const modal = document.getElementById('raceResultsModal');
            if (modal) {
                modal.classList.add('hidden');
                // Optional: Clear content when closing
                const modalContent = document.getElementById('raceResultsModalContent');
                if (modalContent) {
                    modalContent.innerHTML = '';
                }
            }
        }

        // Functions for User Predictions Modal
        function openUserPredictionsModal(raceId, raceName, isQuinielaClosed) {
            const modal = document.getElementById('userPredictionsModal');
            const modalTitle = document.getElementById('userPredictionsModalTitle');
            const modalContent = document.getElementById('userPredictionsModalContent');
            const editButton = document.getElementById('editPredictionsButton');

            if (modalTitle) {
                modalTitle.textContent = `Mis Predicciones para: ${raceName}`;
            }
            if (modalContent) {
                modalContent.innerHTML = '<p class="text-center text-gray-500">Cargando tus predicciones...</p>';
                fetch(`/race/${raceId}/user_predictions_modal_content`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(html => {
                        modalContent.innerHTML = html;
                        // Show edit button only if quiniela is not closed
                        if (editButton) {
                            if (!isQuinielaClosed) {
                                editButton.href = `/race/${raceId}#hacer-prediccion`; // Or specific edit URL
                                editButton.classList.remove('hidden');
                            } else {
                                editButton.classList.add('hidden');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching user predictions:', error);
                        modalContent.innerHTML = `<p class="text-center text-red-500">Error al cargar tus predicciones. ${error.message}</p>`;
                        if (editButton) {
                            editButton.classList.add('hidden');
                        }
                    });
            }

            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function closeUserPredictionsModal() {
            const modal = document.getElementById('userPredictionsModal');
            if (modal) {
                modal.classList.add('hidden');
                const modalContent = document.getElementById('userPredictionsModalContent');
                if (modalContent) {
                    modalContent.innerHTML = '<p class="text-center text-gray-500">Cargando tus predicciones...</p>'; // Reset
                }
                const editButton = document.getElementById('editPredictionsButton');
                if (editButton) {
                    editButton.classList.add('hidden'); // Ensure edit button is hidden on close
                }
            }
        }

        // --- Answer/Edit Quiniela Modal JavaScript ---
        const answerQuinielaModal = document.getElementById('answerQuinielaModal');
        const answerQuinielaModalTitle = document.getElementById('answerQuinielaModalTitle');
        const answerQuinielaModalContent = document.getElementById('answerQuinielaModalContent');
        const answerQuinielaForm = document.getElementById('answerQuinielaForm');
        const answerQuinielaModalError = document.getElementById('answerQuinielaModalError');
        let currentAnsweringRaceId = null;

        function openAnswerQuinielaModal(raceId, raceName, hasPredictions, pendingCount) {
            currentAnsweringRaceId = raceId;
            answerQuinielaModalTitle.textContent = `${hasPredictions ? 'Editar' : 'Responder'} Quiniela: ${raceName}`;
            answerQuinielaModalContent.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-3xl text-orange-500"></i><p class="mt-2 text-gray-600">Cargando preguntas...</p></div>';
            answerQuinielaModalError.classList.add('hidden');
            answerQuinielaModalError.textContent = '';

            fetch(`/race/${raceId}/quiniela_form_content`)
                .then(response => {
                    if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);
                    return response.json();
                })
                .then(data => {
                    if (data.quiniela_closed) {
                        answerQuinielaModalContent.innerHTML = '<p class="text-center text-red-500">La quiniela para esta carrera ya está cerrada. No puedes modificar tus respuestas.</p>';
                        document.getElementById('saveQuinielaPredictionsButton').classList.add('hidden');
                        return;
                    }
                    document.getElementById('saveQuinielaPredictionsButton').classList.remove('hidden');
                    renderQuinielaForm(data.questions);
                })
                .catch(error => {
                    console.error('Error fetching quiniela form content:', error);
                    answerQuinielaModalContent.innerHTML = `<p class="text-center text-red-500">Error al cargar el formulario de la quiniela: ${error.message}</p>`;
                    document.getElementById('saveQuinielaPredictionsButton').classList.add('hidden');
                });

            answerQuinielaModal.classList.remove('hidden');
        }

        function renderQuinielaForm(questions) {
            answerQuinielaModalContent.innerHTML = ''; // Clear loading spinner
            if (!questions || questions.length === 0) {
                answerQuinielaModalContent.innerHTML = '<p class="text-gray-600">No hay preguntas disponibles para esta quiniela.</p>';
                document.getElementById('saveQuinielaPredictionsButton').classList.add('hidden');
                return;
            }

            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.classList.add('mb-6', 'p-4', 'border', 'rounded-md', 'shadow-sm');
                questionDiv.innerHTML = `<label class="block text-md font-semibold text-gray-800 mb-2">${index + 1}. ${q.text}</label>`;

                if (q.question_type === 'FREE_TEXT') {
                    const input = document.createElement('textarea');
                    input.name = `q_${q.id}`;
                    input.classList.add('w-full', 'p-2', 'border', 'border-gray-300', 'rounded-md', 'focus:ring-orange-500', 'focus:border-orange-500');
                    input.rows = 2;
                    input.value = q.user_answer || '';
                    questionDiv.appendChild(input);
                } else if (q.question_type === 'MULTIPLE_CHOICE') {
                    const optionsContainer = document.createElement('div');
                    optionsContainer.classList.add('space-y-2', 'mt-2');
                    q.options.forEach(opt => {
                        const optionDiv = document.createElement('div');
                        optionDiv.classList.add('flex', 'items-center');
                        const input = document.createElement('input');
                        input.type = q.is_mc_multiple_correct ? 'checkbox' : 'radio';
                        input.name = `q_${q.id}`;
                        input.value = opt.id;
                        input.id = `q_${q.id}_opt_${opt.id}`;
                        input.classList.add('h-4', 'w-4', 'text-orange-600', 'border-gray-300', 'focus:ring-orange-500');

                        if (q.is_mc_multiple_correct) {
                            if (Array.isArray(q.user_answer) && q.user_answer.includes(opt.id)) {
                                input.checked = true;
                            }
                        } else {
                            if (q.user_answer === opt.id) {
                                input.checked = true;
                            }
                        }

                        const label = document.createElement('label');
                        label.htmlFor = input.id;
                        label.textContent = opt.option_text;
                        label.classList.add('ml-2', 'block', 'text-sm', 'text-gray-700');

                        optionDiv.appendChild(input);
                        optionDiv.appendChild(label);
                        optionsContainer.appendChild(optionDiv);
                    });
                    questionDiv.appendChild(optionsContainer);
                } else if (q.question_type === 'SLIDER') {
                    const sliderContainer = document.createElement('div');
                    sliderContainer.classList.add('mt-2');
                    const input = document.createElement('input');
                    input.type = 'range';
                    input.name = `q_${q.id}`;
                    input.min = q.slider_min_value;
                    input.max = q.slider_max_value;
                    input.step = q.slider_step;
                    input.value = q.user_answer !== null ? q.user_answer : (q.slider_min_value + q.slider_max_value) / 2; // Default to middle if no answer
                    input.classList.add('w-full', 'h-2', 'bg-gray-200', 'rounded-lg', 'appearance-none', 'cursor-pointer', 'focus:outline-none', 'focus:ring-2', 'focus:ring-orange-500');

                    const valueDisplay = document.createElement('span');
                    valueDisplay.classList.add('ml-2', 'text-sm', 'text-gray-600');
                    valueDisplay.textContent = `${input.value}${q.slider_unit || ''}`;
                    input.oninput = () => { valueDisplay.textContent = `${input.value}${q.slider_unit || ''}`; };

                    sliderContainer.appendChild(input);
                    sliderContainer.appendChild(valueDisplay);
                    questionDiv.appendChild(sliderContainer);
                } else if (q.question_type === 'ORDERING') {
                    // Basic text area for comma-separated values for now
                    // A drag-and-drop UI would be more complex and is out of scope for this quick implementation.
                    const helpText = document.createElement('p');
                    helpText.textContent = 'Introduce los elementos en orden, separados por comas.';
                    helpText.classList.add('text-xs', 'text-gray-500', 'mb-1');
                    questionDiv.appendChild(helpText);

                    const textarea = document.createElement('textarea');
                    textarea.name = `q_${q.id}`;
                    textarea.classList.add('w-full', 'p-2', 'border', 'border-gray-300', 'rounded-md', 'focus:ring-orange-500', 'focus:border-orange-500');
                    textarea.rows = 3;
                    textarea.value = q.user_answer || ''; // User answer is comma-separated string of texts
                    questionDiv.appendChild(textarea);

                    const optionsList = document.createElement('div');
                    optionsList.classList.add('mt-2', 'text-xs', 'text-gray-500');
                    optionsList.innerHTML = '<strong>Opciones disponibles:</strong> ' + q.options.map(opt => opt.option_text).join(', ');
                    questionDiv.appendChild(optionsList);
                }
                answerQuinielaModalContent.appendChild(questionDiv);
            });
        }

        function closeAnswerQuinielaModal() {
            answerQuinielaModal.classList.add('hidden');
            answerQuinielaModalContent.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-3xl text-orange-500"></i><p class="mt-2 text-gray-600">Cargando preguntas...</p></div>';
            answerQuinielaModalError.classList.add('hidden');
            answerQuinielaModalError.textContent = '';
            currentAnsweringRaceId = null;
            document.getElementById('saveQuinielaPredictionsButton').classList.remove('hidden'); // Ensure button is visible for next opening
        }

        if (answerQuinielaForm) {
            answerQuinielaForm.addEventListener('submit', function(event) {
                event.preventDefault();
                if (!currentAnsweringRaceId) return;

                const formData = new FormData(answerQuinielaForm);
                const answersPayload = {};

                // Iterate over questions that were rendered (present in modal content)
                // to ensure we only collect data for displayed questions.
                const renderedQuestions = answerQuinielaModalContent.querySelectorAll('[name^="q_"]');
                const questionIdsProcessed = new Set();

                renderedQuestions.forEach(inputElement => {
                    const name = inputElement.name; // e.g., "q_123"
                    const questionId = name.substring(2); // "123"

                    if (questionIdsProcessed.has(questionId)) return; // Skip if already processed (for radio/checkbox groups)

                    const questionDiv = inputElement.closest('.mb-6'); // Find parent question div to get type if needed
                    // This is a simplified way; ideally, we'd iterate through the original `questions` data used for rendering.
                    // For robust type checking, one might need to re-fetch question types or store them.
                    // Here, we infer based on input types or rely on how data is structured.

                    if (inputElement.type === 'radio') {
                        const checkedRadio = answerQuinielaForm.querySelector(`input[name="${name}"]:checked`);
                        answersPayload[questionId] = { selected_option_id: checkedRadio ? parseInt(checkedRadio.value) : null };
                        questionIdsProcessed.add(questionId);
                    } else if (inputElement.type === 'checkbox') {
                        const checkedCheckboxes = Array.from(answerQuinielaForm.querySelectorAll(`input[name="${name}"]:checked`))
                                                     .map(cb => parseInt(cb.value));
                        answersPayload[questionId] = { selected_option_ids: checkedCheckboxes };
                        questionIdsProcessed.add(questionId);
                    } else if (inputElement.type === 'range') { // Slider
                        answersPayload[questionId] = { slider_answer_value: parseFloat(inputElement.value) };
                        questionIdsProcessed.add(questionId);
                    } else if (inputElement.tagName === 'TEXTAREA') { // Free Text or Ordering (as textarea)
                        // Need to differentiate if Ordering was rendered as textarea
                        // For now, assume if it's textarea, it could be free_text or ordering's comma-separated text
                        // This part needs to align with how `renderQuinielaForm` names Ordering textareas.
                        // Let's assume Ordering also uses `q_{id}`
                        answersPayload[questionId] = { answer_text: inputElement.value.trim() }; // For Free Text
                        // If it's an ordering question, the backend expects 'ordered_options_text' in some cases,
                        // but the generic save endpoint uses 'answer_text' for this.
                        questionIdsProcessed.add(questionId);
                    }
                });

                const saveButton = document.getElementById('saveQuinielaPredictionsButton');
                saveButton.disabled = true;
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';
                answerQuinielaModalError.classList.add('hidden');

                fetch(`/api/races/${currentAnsweringRaceId}/answers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(answersPayload)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || `Error ${response.status}`) });
                    }
                    return response.json();
                })
                .then(data => {
                    closeAnswerQuinielaModal();
                    Swal.fire({ title: '¡Éxito!', text: data.message || 'Predicciones guardadas correctamente.', icon: 'success', confirmButtonColor: '#F97316' });
                    // TODO: Update client-side state (e.g., pending count badge) or reload. For now, suggest reload.
                    // Simple reload for now to reflect changes.
                    window.location.reload();
                })
                .catch(error => {
                    console.error('Error saving predictions:', error);
                    answerQuinielaModalError.textContent = `Error: ${error.message}`;
                    answerQuinielaModalError.classList.remove('hidden');
                })
                .finally(() => {
                    saveButton.disabled = false;
                    saveButton.innerHTML = '<i class="fas fa-save mr-2"></i>Guardar Predicciones';
                });
            });
        }
        // --- End Answer/Edit Quiniela Modal JavaScript ---

        // --- Question Wizard Logic (Adapted for league_detail_view.html) ---
        let wizardCurrentRaceId = null;
        let wizardAllRaceQuestions = [];
        let wizardCurrentQuestionIndex = 0;
        let wizardUserAnswers = {}; // Stores answers as { question_id: { ...answer_data } }

        // Wizard Modal DOM Elements (ensure these are unique or scoped if multiple modals exist)
        const leagueDetailQuestionWizardModal = document.getElementById('questionWizardModal'); // Already exists from copied HTML
        const leagueDetailWizardQuestionProgress = document.getElementById('wizardQuestionProgress');
        const leagueDetailCloseWizardModalBtn = document.getElementById('closeWizardModalBtn');
        const leagueDetailWizardQuestionText = document.getElementById('wizardQuestionText');
        const leagueDetailWizardAnswerOptions = document.getElementById('wizardAnswerOptions');
        const leagueDetailWizardPrevBtn = document.getElementById('wizardPrevBtn');
        const leagueDetailWizardNextBtn = document.getElementById('wizardNextBtn');
        const leagueDetailWizardFinishBtn = document.getElementById('wizardFinishBtn');

        // Helper function to update enabled/disabled state of move buttons in wizard ordering list
        // This function is specific to the wizard's ordering question type.
        function updateWizardOrderingButtonStatesLeagueDetail(ulElement) {
            if (!ulElement) return;
            const listItems = ulElement.querySelectorAll('li[data-option-id]');
            listItems.forEach((li, index) => {
                const upButton = li.querySelector('.wizard-move-up-btn-league-detail'); // Use unique class if needed
                const downButton = li.querySelector('.wizard-move-down-btn-league-detail'); // Use unique class if needed

                if (upButton) {
                    upButton.disabled = (index === 0);
                    upButton.classList.toggle('opacity-50', upButton.disabled);
                    upButton.classList.toggle('cursor-not-allowed', upButton.disabled);
                }
                if (downButton) {
                    downButton.disabled = (index === listItems.length - 1);
                    downButton.classList.toggle('opacity-50', downButton.disabled);
                    downButton.classList.toggle('cursor-not-allowed', downButton.disabled);
                }
            });
        }


        function openWizardForRace(raceId, raceTitle, isQuinielaClosed) {
            if (isQuinielaClosed) {
                Swal.fire({ title: 'Quiniela Cerrada', text: `La quiniela para "${raceTitle}" ya está cerrada.`, icon: 'info', confirmButtonColor: '#F97316' });
                return;
            }

            wizardCurrentRaceId = raceId;
            // Update modal title or other elements if needed, e.g., include raceTitle
            // For now, the existing wizardQuestionProgress will show "Pregunta X de Y"

            // Show a loading state in the modal while fetching questions
            if(leagueDetailWizardAnswerOptions) leagueDetailWizardAnswerOptions.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-3xl text-orange-500"></i><p class="mt-2 text-gray-600">Cargando quiniela...</p></div>';
            if(leagueDetailQuestionWizardModal) leagueDetailQuestionWizardModal.style.display = 'flex';


            fetch(`/api/races/${wizardCurrentRaceId}/questions`)
                .then(response => {
                    if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);
                    return response.json();
                })
                .then(questions => {
                    wizardAllRaceQuestions = questions;
                    if (!wizardAllRaceQuestions || wizardAllRaceQuestions.length === 0) {
                        if(leagueDetailWizardAnswerOptions) leagueDetailWizardAnswerOptions.innerHTML = '<p class="text-gray-600 text-center py-4">No hay preguntas disponibles para esta carrera.</p>';
                        // Hide nav buttons if no questions
                        if(leagueDetailWizardNextBtn) leagueDetailWizardNextBtn.style.display = 'none';
                        if(leagueDetailWizardFinishBtn) leagueDetailWizardFinishBtn.style.display = 'none';
                        if(leagueDetailWizardPrevBtn) leagueDetailWizardPrevBtn.style.display = 'none';
                        return;
                    }
                    wizardCurrentQuestionIndex = 0;
                    wizardUserAnswers = {}; // Reset previous answers for a new race
                    displayWizardQuestionLeagueDetail(wizardCurrentQuestionIndex);
                })
                .catch(error => {
                    console.error('Error fetching questions for wizard:', error);
                    if(leagueDetailWizardAnswerOptions) leagueDetailWizardAnswerOptions.innerHTML = `<p class="text-red-500 text-center py-4">Error al cargar la quiniela: ${error.message}. Inténtalo de nuevo.</p>`;
                     // Hide nav buttons on error
                    if(leagueDetailWizardNextBtn) leagueDetailWizardNextBtn.style.display = 'none';
                    if(leagueDetailWizardFinishBtn) leagueDetailWizardFinishBtn.style.display = 'none';
                    if(leagueDetailWizardPrevBtn) leagueDetailWizardPrevBtn.style.display = 'none';
                });
        }

        function closeWizardLeagueDetail() {
            if(leagueDetailQuestionWizardModal) leagueDetailQuestionWizardModal.style.display = 'none';
            // Reset state if needed
            wizardCurrentRaceId = null;
            wizardAllRaceQuestions = [];
            wizardUserAnswers = {};
        }

        function displayWizardQuestionLeagueDetail(index) {
            if (!wizardAllRaceQuestions || wizardAllRaceQuestions.length === 0) {
                // This case should be handled by the loader, but as a safeguard:
                if(leagueDetailWizardQuestionText) leagueDetailWizardQuestionText.textContent = 'Error';
                if(leagueDetailWizardAnswerOptions) leagueDetailWizardAnswerOptions.innerHTML = '<p class="text-red-500 text-center py-4">No hay preguntas cargadas.</p>';
                if(leagueDetailWizardNextBtn) leagueDetailWizardNextBtn.style.display = 'none';
                if(leagueDetailWizardFinishBtn) leagueDetailWizardFinishBtn.style.display = 'none';
                if(leagueDetailWizardPrevBtn) leagueDetailWizardPrevBtn.style.display = 'none';
                return;
            }
             if (index < 0 || index >= wizardAllRaceQuestions.length) {
                console.error("Invalid question index for wizard:", index);
                // Potentially show an error in the modal or close it
                return;
            }

            const question = wizardAllRaceQuestions[index];
            const existingAnswer = wizardUserAnswers[question.id];

            if(leagueDetailWizardQuestionProgress) leagueDetailWizardQuestionProgress.textContent = `Pregunta ${index + 1} de ${wizardAllRaceQuestions.length}`;
            if(leagueDetailWizardQuestionText) leagueDetailWizardQuestionText.textContent = `${index + 1}. ${question.text}`;
            if(leagueDetailWizardAnswerOptions) leagueDetailWizardAnswerOptions.innerHTML = ''; // Clear previous

            try {
                switch (question.question_type) {
                    case 'FREE_TEXT':
                        const textarea = document.createElement('textarea');
                        textarea.id = `wizardFreeTextAnswer_ld_${question.id}`; // Suffix ld for league_detail
                        textarea.className = 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent';
                        textarea.rows = 4;
                        textarea.placeholder = 'Escribe tu respuesta...';
                        textarea.value = existingAnswer?.answer_text || '';
                        if (leagueDetailWizardAnswerOptions) leagueDetailWizardAnswerOptions.appendChild(textarea);
                        break;
                    case 'MULTIPLE_CHOICE':
                        if (!question.options || !Array.isArray(question.options)) {
                            throw new Error('Datos de opciones de Opción Múltiple no válidos o ausentes.');
                        }
                        question.options.forEach(opt => {
                            const label = document.createElement('label');
                            label.className = 'flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded-md border border-gray-200 hover:border-orange-300';
                            const input = document.createElement('input');
                            input.type = question.is_mc_multiple_correct ? 'checkbox' : 'radio';
                            input.name = `wizard_q_ld_${question.id}`; // Suffix ld
                            input.value = opt.id;
                            input.className = 'text-orange-500 focus:ring-orange-400 focus:ring-offset-0';
                            if (question.is_mc_multiple_correct) {
                                input.classList.add('rounded');
                                if (existingAnswer?.selected_option_ids?.includes(opt.id)) input.checked = true;
                            } else {
                                if (existingAnswer?.selected_option_id == opt.id) input.checked = true;
                            }
                            const span = document.createElement('span');
                            span.className = 'text-gray-700';
                            span.textContent = opt.option_text;
                            label.appendChild(input);
                            label.appendChild(span);
                            if (leagueDetailWizardAnswerOptions) leagueDetailWizardAnswerOptions.appendChild(label);
                        });
                        break;
                    case 'ORDERING':
                        const orderingListContainer = document.createElement('ul');
                        orderingListContainer.id = `wizardOrderingList_ld_${question.id}`;
                        orderingListContainer.className = 'list-none p-0 m-0 space-y-2';

                        if (question.options && question.options.length > 0) {
                            let orderedOptions = [...question.options];
                            if (existingAnswer && existingAnswer.ordered_options_text) {
                                const savedOrderIds = existingAnswer.ordered_options_text.split(',').map(id => parseInt(id.trim(), 10));
                                const optionsMap = new Map(question.options.map(opt => [opt.id, opt]));
                                const newOrderedOptions = [];
                                const addedOptionIds = new Set();
                                savedOrderIds.forEach(id => {
                                    if (optionsMap.has(id)) {
                                        newOrderedOptions.push(optionsMap.get(id));
                                        addedOptionIds.add(id);
                                    }
                                });
                                question.options.forEach(opt => {
                                    if (!addedOptionIds.has(opt.id)) newOrderedOptions.push(opt);
                                });
                                orderedOptions = newOrderedOptions;
                            }
                            orderedOptions.forEach(opt => {
                                const listItem = document.createElement('li');
                                listItem.dataset.optionId = opt.id;
                                listItem.className = 'p-3 border rounded-md bg-gray-50 flex justify-between items-center shadow-sm cursor-move'; // Added cursor-move
                                const textSpan = document.createElement('span');
                                textSpan.className = 'text-gray-700';
                                textSpan.textContent = opt.option_text;
                                listItem.appendChild(textSpan);
                                const buttonContainer = document.createElement('div');
                                buttonContainer.className = 'space-x-1';
                                const moveUpBtn = document.createElement('button');
                                moveUpBtn.innerHTML = '↑';
                                moveUpBtn.type = 'button';
                                moveUpBtn.className = 'wizard-move-up-btn-league-detail px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-200 transition-colors focus:outline-none focus:ring-2 focus:ring-orange-300';
                                moveUpBtn.addEventListener('click', () => {
                                    const currentLi = moveUpBtn.closest('li');
                                    if (currentLi && currentLi.previousElementSibling) {
                                        currentLi.parentNode.insertBefore(currentLi, currentLi.previousElementSibling);
                                        updateWizardOrderingButtonStatesLeagueDetail(orderingListContainer);
                                    }
                                });
                                buttonContainer.appendChild(moveUpBtn);
                                const moveDownBtn = document.createElement('button');
                                moveDownBtn.innerHTML = '↓';
                                moveDownBtn.type = 'button';
                                moveDownBtn.className = 'wizard-move-down-btn-league-detail px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-200 transition-colors focus:outline-none focus:ring-2 focus:ring-orange-300';
                                moveDownBtn.addEventListener('click', () => {
                                    const currentLi = moveDownBtn.closest('li');
                                    if (currentLi && currentLi.nextElementSibling) {
                                        currentLi.parentNode.insertBefore(currentLi, currentLi.nextElementSibling.nextSibling);
                                        updateWizardOrderingButtonStatesLeagueDetail(orderingListContainer);
                                    }
                                });
                                buttonContainer.appendChild(moveDownBtn);
                                listItem.appendChild(buttonContainer);
                                orderingListContainer.appendChild(listItem);
                            });
                        } else {
                            orderingListContainer.innerHTML = '<p class="text-sm text-gray-500">No hay opciones para ordenar.</p>';
                        }
                        if (leagueDetailWizardAnswerOptions) {
                            leagueDetailWizardAnswerOptions.appendChild(orderingListContainer);
                            if (orderingListContainer.firstChild) updateWizardOrderingButtonStatesLeagueDetail(orderingListContainer);
                        }
                        break;
                    case 'SLIDER':
                         if (!leagueDetailWizardAnswerOptions) break;
                        leagueDetailWizardAnswerOptions.innerHTML = ''; // Clear previous content

                        const minValue = parseFloat(question.slider_min_value);
                        const maxValue = parseFloat(question.slider_max_value);
                        const unit = question.slider_unit || "";
                        let parsedStep = parseFloat(question.slider_step);
                        let stepValue = (isNaN(parsedStep) || parsedStep <= 0) ? 1 : parsedStep;

                        let errorMessage = "";
                        if (isNaN(minValue)) errorMessage = "Min no numérico.";
                        else if (isNaN(maxValue)) errorMessage = "Max no numérico.";
                        else if (maxValue <= minValue) errorMessage = "Max <= Min.";

                        if (errorMessage) {
                            leagueDetailWizardAnswerOptions.innerHTML = `<p class="text-red-500 text-center py-4">Error Slider: ${errorMessage}</p>`;
                            break;
                        }
                        const sliderContainer = document.createElement('div');
                        sliderContainer.className = 'custom-slider-container w-full pt-8 pb-4 relative select-none';
                        const trackBackground = document.createElement('div');
                        trackBackground.className = 'slider-track-background h-2 bg-gray-300 rounded-full absolute top-1/2 left-0 right-0 -translate-y-1/2';
                        sliderContainer.appendChild(trackBackground);
                        const thumb = document.createElement('div');
                        thumb.className = 'slider-thumb absolute top-1/2 -translate-y-1/2 flex items-stretch h-6 rounded shadow-md border border-gray-400';
                        thumb.style.cursor = 'grab';
                        thumb.id = `sliderThumb_ld_${question.id}`;
                        const yellowZoneLeft = document.createElement('div');
                        yellowZoneLeft.className = 'slider-yellow-zone-left bg-yellow-300 border-r border-yellow-400';
                        thumb.appendChild(yellowZoneLeft);
                        const greenZone = document.createElement('div');
                        greenZone.className = 'slider-green-zone bg-green-500 border-l border-r border-green-600';
                        thumb.appendChild(greenZone);
                        const yellowZoneRight = document.createElement('div');
                        yellowZoneRight.className = 'slider-yellow-zone-right bg-yellow-300 border-l border-yellow-400';
                        thumb.appendChild(yellowZoneRight);
                        sliderContainer.appendChild(thumb);
                        const valueDisplay = document.createElement('div');
                        valueDisplay.id = `wizardSliderValueDisplay_ld_${question.id}`;
                        valueDisplay.className = 'slider-value-display text-center text-lg font-semibold text-gray-700 mt-3 mb-1';
                        sliderContainer.appendChild(valueDisplay);
                        const labelsContainerElement = document.createElement('div');
                        labelsContainerElement.className = 'slider-labels flex justify-between text-xs text-gray-500';
                        const minLabel = document.createElement('span'); minLabel.id = `wizardSliderMinLabel_ld_${question.id}`;
                        const maxLabel = document.createElement('span'); maxLabel.id = `wizardSliderMaxLabel_ld_${question.id}`;
                        labelsContainerElement.appendChild(minLabel); labelsContainerElement.appendChild(maxLabel);
                        sliderContainer.appendChild(labelsContainerElement);
                        const hiddenInput = document.createElement('input'); hiddenInput.type = 'hidden'; hiddenInput.id = `hiddenSliderValue_ld_${question.id}`;
                        sliderContainer.appendChild(hiddenInput);
                        leagueDetailWizardAnswerOptions.appendChild(sliderContainer);

                        requestAnimationFrame(() => {
                            const trackWidthPx = trackBackground.offsetWidth;
                            const valueRange = maxValue - minValue;
                            if (valueRange <= 0 || trackWidthPx === 0) {
                                leagueDetailWizardAnswerOptions.innerHTML = '<p class="text-red-500 text-center">Error: Slider inválido o contenedor no visible.</p>';
                                return;
                            }
                            const pixelsPerUnit = trackWidthPx / valueRange;
                            const greenZoneUnitWidth = 1; // Smallest unit the green zone represents
                            const thresholdPartial = parseFloat(question.slider_threshold_partial) || 0;

                            const greenZonePxWidth = Math.max(2, greenZoneUnitWidth * pixelsPerUnit);
                            const yellowZonePxWidth = Math.max(0, thresholdPartial * pixelsPerUnit);
                            greenZone.style.width = `${greenZonePxWidth}px`;
                            yellowZoneLeft.style.width = `${yellowZonePxWidth}px`;
                            yellowZoneRight.style.width = `${yellowZonePxWidth}px`;
                            const thumbWidthPx = greenZonePxWidth + (2 * yellowZonePxWidth);
                            thumb.style.width = `${thumbWidthPx}px`;
                            minLabel.textContent = `${minValue} ${unit}`; maxLabel.textContent = `${maxValue} ${unit}`;

                            let initialValue = parseFloat(existingAnswer?.slider_answer_value ?? minValue);
                            initialValue = Math.max(minValue, Math.min(maxValue, initialValue));
                            let numDecimalPlaces = stepValue.toString().includes('.') ? (stepValue.toString().split('.')[1].length || 0) : 0;
                            initialValue = parseFloat((Math.round((initialValue - minValue) / stepValue) * stepValue + minValue).toFixed(numDecimalPlaces));
                            hiddenInput.value = initialValue;
                            valueDisplay.textContent = `${initialValue} ${unit}`;
                            const valuePointOffsetWithinThumbPx = yellowZonePxWidth + (greenZonePxWidth / 2);
                            let initialValuePointOnTrackPx = ((initialValue - minValue) / valueRange) * trackWidthPx;
                            initialValuePointOnTrackPx = Math.max(0, Math.min(initialValuePointOnTrackPx, trackWidthPx));
                            thumb.style.left = (initialValuePointOnTrackPx - valuePointOffsetWithinThumbPx) + 'px';

                            let isDragging = false, dragStartX, thumbInitialLeftPx;
                            thumb.addEventListener('pointerdown', (e) => {
                                if (e.button !== 0) return; isDragging = true; dragStartX = e.clientX; thumbInitialLeftPx = thumb.offsetLeft;
                                thumb.setPointerCapture(e.pointerId); thumb.style.cursor = 'grabbing'; document.body.style.userSelect = 'none';
                                document.addEventListener('pointermove', onPointerMove); document.addEventListener('pointerup', onPointerUp);
                            });
                            function onPointerMove(e) {
                                if (!isDragging) return; let dx = e.clientX - dragStartX; let desiredThumbLeftPx = thumbInitialLeftPx + dx;
                                const valuePointOffsetWithinThumbPxLocal = parseFloat(yellowZoneLeft.style.width) + (parseFloat(greenZone.style.width) / 2);
                                let desiredValuePointOnTrackPx = desiredThumbLeftPx + valuePointOffsetWithinThumbPxLocal;
                                let clampedValuePointOnTrackPx = Math.max(0, Math.min(desiredValuePointOnTrackPx, trackWidthPx));
                                let currentValue = (clampedValuePointOnTrackPx / trackWidthPx) * valueRange + minValue;
                                currentValue = Math.max(minValue, Math.min(maxValue, currentValue));
                                let numDecimalPlacesLocal = stepValue.toString().includes('.') ? (stepValue.toString().split('.')[1].length || 0) : 0;
                                currentValue = parseFloat((Math.round((currentValue - minValue) / stepValue) * stepValue + minValue).toFixed(numDecimalPlacesLocal));
                                currentValue = Math.max(minValue, Math.min(maxValue, currentValue));
                                hiddenInput.value = currentValue; valueDisplay.textContent = `${currentValue} ${unit}`;
                                let finalValuePointOnTrackPx = ((currentValue - minValue) / valueRange) * trackWidthPx;
                                finalValuePointOnTrackPx = Math.max(0, Math.min(finalValuePointOnTrackPx, trackWidthPx));
                                thumb.style.left = (finalValuePointOnTrackPx - valuePointOffsetWithinThumbPxLocal) + 'px';
                            }
                            function onPointerUp(e) {
                                if (!isDragging) return; isDragging = false; thumb.releasePointerCapture(e.pointerId);
                                thumb.style.cursor = 'grab'; document.body.style.userSelect = '';
                                document.removeEventListener('pointermove', onPointerMove); document.removeEventListener('pointerup', onPointerUp);
                            }
                            const scoringInfoContainer = document.createElement('div');
                            scoringInfoContainer.className = 'slider-scoring-info mt-3 pt-3 border-t border-gray-200 text-sm text-gray-600';
                            const exactPointsP = document.createElement('p'); exactPointsP.className = 'mb-1';
                            exactPointsP.innerHTML = `Puntos exactos: <strong class="text-green-600">${question.slider_points_exact !== null ? question.slider_points_exact : 'N/A'}</strong>`;
                            scoringInfoContainer.appendChild(exactPointsP);
                            if (question.slider_points_partial !== null && question.slider_points_partial > 0 && question.slider_threshold_partial !== null) {
                                const partialPointsP = document.createElement('p');
                                partialPointsP.innerHTML = `Puntos parciales (+/- ${question.slider_threshold_partial} ${unit}): <strong class="text-yellow-600">${question.slider_points_partial}</strong>`;
                                scoringInfoContainer.appendChild(partialPointsP);
                            }
                            leagueDetailWizardAnswerOptions.appendChild(scoringInfoContainer);
                        });
                        break;
                    default:
                        if (leagueDetailWizardAnswerOptions) leagueDetailWizardAnswerOptions.innerHTML = `<p class="text-red-500">Tipo de pregunta '${question.question_type}' no soportado.</p>`;
                }
            } catch (e) {
                console.error('Error renderizando pregunta en wizard (league_detail):', e, 'Pregunta:', question);
                if(leagueDetailWizardQuestionText) leagueDetailWizardQuestionText.textContent = 'Error de Visualización';
                if(leagueDetailWizardAnswerOptions) leagueDetailWizardAnswerOptions.innerHTML = '<p class="text-red-500 text-center py-4">Error al mostrar esta pregunta.</p>';
            }

            if(leagueDetailWizardPrevBtn) leagueDetailWizardPrevBtn.style.display = index > 0 ? 'inline-flex' : 'none';
            if(leagueDetailWizardNextBtn) leagueDetailWizardNextBtn.style.display = index < wizardAllRaceQuestions.length - 1 ? 'inline-flex' : 'none';
            if(leagueDetailWizardFinishBtn) leagueDetailWizardFinishBtn.style.display = index === wizardAllRaceQuestions.length - 1 ? 'inline-flex' : 'none';
        }

        function saveCurrentWizardAnswerLeagueDetail() {
            if (!wizardAllRaceQuestions || wizardCurrentQuestionIndex < 0 || wizardCurrentQuestionIndex >= wizardAllRaceQuestions.length) return;
            const question = wizardAllRaceQuestions[wizardCurrentQuestionIndex];
            if (!question) return;

            switch (question.question_type) {
                case 'FREE_TEXT':
                    const textarea = document.getElementById(`wizardFreeTextAnswer_ld_${question.id}`);
                    if (textarea) wizardUserAnswers[question.id] = { question_id: question.id, answer_text: textarea.value.trim() };
                    break;
                case 'MULTIPLE_CHOICE':
                    if (question.is_mc_multiple_correct) {
                        const ids = [];
                        document.querySelectorAll(`input[name="wizard_q_ld_${question.id}"]:checked`).forEach(cb => ids.push(parseInt(cb.value)));
                        wizardUserAnswers[question.id] = { question_id: question.id, selected_option_ids: ids };
                    } else {
                        const radio = document.querySelector(`input[name="wizard_q_ld_${question.id}"]:checked`);
                        wizardUserAnswers[question.id] = { question_id: question.id, selected_option_id: radio ? parseInt(radio.value) : null };
                    }
                    break;
                case 'ORDERING':
                    const listContainer = document.getElementById(`wizardOrderingList_ld_${question.id}`);
                    if (listContainer) {
                        const ids = Array.from(listContainer.querySelectorAll('li[data-option-id]')).map(li => li.dataset.optionId);
                        wizardUserAnswers[question.id] = { question_id: question.id, ordered_options_text: ids.join(',') };
                    }
                    break;
                case 'SLIDER':
                    const hiddenInput = document.getElementById(`hiddenSliderValue_ld_${question.id}`);
                    if (hiddenInput) {
                        const val = parseFloat(hiddenInput.value);
                        wizardUserAnswers[question.id] = { question_id: question.id, slider_answer_value: isNaN(val) ? null : val };
                    }
                    break;
            }
        }

        function handleNextWizardQuestionLeagueDetail() {
            saveCurrentWizardAnswerLeagueDetail();
            if (wizardCurrentQuestionIndex < wizardAllRaceQuestions.length - 1) {
                wizardCurrentQuestionIndex++;
                displayWizardQuestionLeagueDetail(wizardCurrentQuestionIndex);
            }
        }

        function handlePreviousWizardQuestionLeagueDetail() {
            saveCurrentWizardAnswerLeagueDetail();
            if (wizardCurrentQuestionIndex > 0) {
                wizardCurrentQuestionIndex--;
                displayWizardQuestionLeagueDetail(wizardCurrentQuestionIndex);
            }
        }

        // Event Listeners for Wizard in league_detail_view
        if (leagueDetailCloseWizardModalBtn) leagueDetailCloseWizardModalBtn.addEventListener('click', closeWizardLeagueDetail);
        if (leagueDetailWizardNextBtn) leagueDetailWizardNextBtn.addEventListener('click', handleNextWizardQuestionLeagueDetail);
        if (leagueDetailWizardPrevBtn) leagueDetailWizardPrevBtn.addEventListener('click', handlePreviousWizardQuestionLeagueDetail);

        if (leagueDetailWizardFinishBtn) {
            leagueDetailWizardFinishBtn.addEventListener('click', () => {
                saveCurrentWizardAnswerLeagueDetail();
                if (Object.keys(wizardUserAnswers).length === 0) {
                    Swal.fire({ title: 'Sin Respuestas', text: 'No has respondido ninguna pregunta.', icon: 'info', confirmButtonColor: '#F97316' });
                    return;
                }
                leagueDetailWizardFinishBtn.disabled = true;
                leagueDetailWizardFinishBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';

                fetch(`/api/races/${wizardCurrentRaceId}/answers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(wizardUserAnswers)
                })
                .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, body: data })))
                .then(result => {
                    if (result.ok) {
                        closeWizardLeagueDetail();
                        Swal.fire({ title: '¡Éxito!', text: result.body.message || 'Respuestas guardadas.', icon: 'success', confirmButtonColor: '#F97316' })
                            .then(() => window.location.reload()); // Reload to update user prediction status
                    } else {
                        Swal.fire({ title: 'Error', text: `Error: ${result.body.message || `Estatus ${result.status}`}`, icon: 'error', confirmButtonColor: '#F97316' });
                    }
                })
                .catch(error => {
                    console.error('Error saving wizard answers:', error);
                    Swal.fire({ title: 'Error de Conexión', text: 'Inténtalo de nuevo.', icon: 'error', confirmButtonColor: '#F97316' });
                })
                .finally(() => {
                    if(leagueDetailWizardFinishBtn) { // Check again in case it was removed from DOM
                        leagueDetailWizardFinishBtn.disabled = false;
                        leagueDetailWizardFinishBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Finalizar y Guardar';
                    }
                });
            });
        }
        // --- End Question Wizard Logic ---

    </script>
    <!-- Script para SweetAlert (mensajes flash) - Movido fuera de los bloques Jinja eliminados -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure wizard close button has its listener if not covered by general setup
            // This is a fallback, ideally the main script block handles this.
            // const specificCloseBtn = document.getElementById('closeWizardModalBtn');
            // if (specificCloseBtn && !specificCloseBtn.getAttribute('listener_set_by_league_detail')) {
            //     specificCloseBtn.addEventListener('click', closeWizardLeagueDetail);
            //     specificCloseBtn.setAttribute('listener_set_by_league_detail', 'true');
            // }

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        Swal.fire({
                            title: '{{ category|capitalize }}!',
                            text: '{{ message }}',
                            icon: '{{ "success" if category == "message" or category == "success" else ("error" if category == "danger" or category == "error" else category) }}',
                            confirmButtonColor: '#F97316' // Orange color for confirm button
                        });
                    {% endfor %}
                {% endif %}
            {% endwith %}
        });
    </script>
</body>
</html>
