{% extends "admin_dashboard.html" %}

{% block page_title %}{{ league.name }} - Detalles de la Liga{% endblock %}

{% block main_dashboard_content %}
<div class="px-6 pt-6">

    <!-- 1. Cabecera de la Liga -->
    <header class="mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="brand-font text-3xl font-bold text-gray-800">{{ league.name }}</h1>
                <p class="mt-1 text-gray-500">{{ league.description_or_default }}</p> {# Asumiendo que añades una propiedad/método para descripción con fallback #}
            </div>
            <div>
                {% if league.is_active %}
                    <span class="text-xs bg-green-500 text-white px-3 py-1 rounded-full shadow-sm font-semibold">Activa</span>
                {% else %}
                    <span class="text-xs bg-gray-500 text-white px-3 py-1 rounded-full shadow-sm font-semibold">Inactiva</span>
                {% endif %}
            </div>
        </div>
        <div class="mt-3 text-sm text-gray-500">
            <span>Creada por: <strong class="text-gray-700">{{ league.creator.username if league.creator else 'N/A' }}</strong></span>
            <span class="mx-2">|</span>
            <span>Fecha de creación: <strong class="text-gray-700">{{ league.created_at|format_date_filter }}</strong></span>
        </div>
    </header>

    <!-- 2. Sección de Carreras de la Liga -->
    <section class="mb-10">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Carreras en esta Liga</h2>
        {% if league.races and league.races.count() > 0 %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for race in league_races_detailed %} {# Asumiendo que pasas una lista detallada de carreras #}
                    <article class="bg-white rounded-xl shadow-md overflow-hidden card-hover flex flex-col">
                        <div class="p-5 flex-grow flex flex-col">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-lg text-gray-800 truncate" title="{{ race.title }}">{{ race.title }}</h3>
                                <span class="text-xs px-2 py-1 rounded-full
                                    {% if race.status.value == 'PLANNED' %}bg-blue-100 text-blue-700
                                    {% elif race.status.value == 'ACTIVE' %}bg-yellow-100 text-yellow-700
                                    {% elif race.status.value == 'ARCHIVED' %}bg-gray-100 text-gray-600
                                    {% else %}bg-gray-100 text-gray-500{% endif %}">
                                    {{ race.status.value|capitalize }}
                                </span>
                            </div>
                            <p class="text-sm text-gray-500 mb-1">Fecha: {{ race.event_date|format_date_filter }}</p>
                            <p class="text-sm text-gray-500 mb-3">Formato: {{ race.race_format.name if race.race_format else 'N/A' }}</p>

                            <div class="mt-auto border-t pt-3">
                                <a href="{{ url_for('serve_race_detail_page', race_id=race.id) }}" class="btn-secondary-outline w-full text-center">
                                    Ver Carrera y Clasificación
                                </a>
                            </div>
                        </div>
                    </article>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-10 px-6 bg-white rounded-xl shadow-md mt-6">
                <i class="fas fa-flag-checkered text-5xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-bold text-gray-700 mb-2">No hay Carreras en esta Liga</h3>
                <p class="text-gray-500">Aún no se han añadido carreras a esta liga.</p>
                {# Podrías añadir un botón para añadir carreras si el usuario es el creador #}
            </div>
        {% endif %}
    </section>

    <!-- 3. Sección de Participantes y Código de Invitación -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Columna de Participantes (Opcional, podría ser mucho si hay muchos) -->
        <div class="md:col-span-1 bg-white p-6 rounded-xl shadow-md">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Participantes ({{ league_participants_count }})</h3>
            {% if league_participants and league_participants|length > 0 %}
                <ul class="space-y-2 max-h-60 overflow-y-auto">
                    {% for participant in league_participants %}
                        <li class="text-sm text-gray-600 p-2 bg-gray-50 rounded-md">{{ participant.user.username }}</li>
                    {% endfor %}
                </ul>
                {% if league_participants_count > league_participants|length %}
                     <p class="text-xs text-gray-400 mt-2">Mostrando {{ league_participants|length }} de {{ league_participants_count }}...</p>
                {% endif %}
            {% else %}
                <p class="text-sm text-gray-500 italic">Aún no hay participantes unidos a esta liga.</p>
            {% endif %}
        </div>

        <!-- Columna de Código de Invitación y Unirse -->
        <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-md">
            {% if current_user_is_creator_or_admin %}
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Código de Invitación</h3>
                <form action="{{ url_for('generate_league_join_code', league_id=league.id) }}" method="POST" class="mb-4">
                    <button type="submit" class="btn-primary text-white px-5 py-2 rounded-lg font-semibold shadow-sm hover:shadow-md transition-shadow flex items-center">
                        <i class="fas fa-plus-circle mr-2"></i>Generar Nuevo Código
                    </button>
                </form>
                {% if invitation_code %}
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-md mb-3">
                        <p class="text-sm text-blue-700">Comparte este código para que otros se unan a la liga:</p>
                        <strong class="text-lg text-blue-800 font-mono bg-blue-100 px-2 py-1 rounded inline-block my-1">{{ invitation_code.code }}</strong>
                        {% if invitation_code.expires_at %}
                        <p class="text-xs text-blue-600">Expira: {{ invitation_code.expires_at|format_date_filter }}</p>
                        {% else %}
                        <p class="text-xs text-blue-600">Este código no expira.</p>
                        {% endif %}
                        {% if not invitation_code.is_active %}
                        <p class="text-xs text-red-600 font-semibold mt-1">Este código ya no está activo.</p>
                        {% endif %}
                    </div>
                {% elif generated_code_message %} {# Para mostrar el código recién generado si la página se recarga #}
                     <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-md mb-3">
                        <p class="text-sm text-green-700">Nuevo código generado:</p>
                        <strong class="text-lg text-green-800 font-mono bg-green-100 px-2 py-1 rounded inline-block my-1">{{ generated_code_message }}</strong>
                    </div>
                {% endif %}
            {% endif %}

            {% if league.is_active and not current_user_is_participant %}
                <div class="mt-6 pt-4 border-t">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Unirse a la Liga</h3>
                    <form action="{{ url_for('join_league_with_code_page') }}" method="GET"> {# Asume una página intermedia o un modal para el código #}
                        {# Este formulario podría ser más complejo si se introduce el código aquí directamente #}
                        {# Por ahora, redirige a una página/modal para introducir el código de invitación #}
                        <input type="hidden" name="league_id_to_join" value="{{ league.id }}">
                        <button type="button" onclick="openJoinLeagueModal('{{ league.id }}')" class="btn-success text-white w-full md:w-auto px-6 py-3 rounded-lg font-semibold shadow-sm hover:shadow-md transition-shadow flex items-center justify-center">
                            <i class="fas fa-user-plus mr-2"></i>Unirme con Código de Invitación
                        </button>
                    </form>
                </div>
            {% elif current_user_is_participant %}
                 <div class="mt-6 pt-4 border-t">
                    <p class="text-green-600 font-semibold flex items-center">
                        <i class="fas fa-check-circle mr-2 text-xl"></i>Ya eres participante de esta liga.
                    </p>
                </div>
            {% endif %}
        </div>
    </section>

</div>

{# Modal para unirse a la liga con código (ejemplo, similar al de unirse a carrera) #}
{# Este modal podría estar en la plantilla base o ser incluido aquí #}
<div id="join-league-modal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full transform transition-all">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Unirse a la Liga "{{ league.name }}"</h3>
                <button onclick="closeJoinLeagueModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="join-league-form" action="" method="POST"> {# La acción se establecerá dinámicamente #}
                <div class="mb-4">
                    <label for="league-join-code" class="block text-sm font-medium text-gray-700 mb-1">Código de Invitación</label>
                    <input type="text" name="join_code" id="league-join-code" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm"
                           placeholder="Introduce el código de invitación">
                </div>
                <div class="flex items-center justify-end space-x-3">
                    <button type="button" onclick="closeJoinLeagueModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg font-medium transition-colors">
                        Unirme a la Liga
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block additional_scripts %}
{{ super() }} {# Para incluir scripts del padre si los hay #}
<script>
    function openJoinLeagueModal(leagueId) {
        const modal = document.getElementById('join-league-modal');
        const form = document.getElementById('join-league-form');
        if (modal && form) {
            // La URL para unirse a la liga con código. Necesitarás una ruta como /league/join_with_code (POST)
            // que tome el 'join_code' del formulario.
            // El 'league_id' es solo para el título del modal o información adicional, el código debe ser suficiente.
            form.action = "{{ url_for('process_join_league_with_code') }}"; // Asumiendo que la ruta se llama así
            modal.classList.remove('hidden');
            document.getElementById('league-join-code').focus();
        }
    }

    function closeJoinLeagueModal() {
        const modal = document.getElementById('join-league-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
    }

    // Si tienes mensajes flash que quieres mostrar como pop-ups (ej. con SweetAlert2)
    // document.addEventListener('DOMContentLoaded', function() {
    //     {% with messages = get_flashed_messages(with_categories=true) %}
    //         {% if messages %}
    //             {% for category, message in messages %}
    //                 Swal.fire({
    //                     title: '{{ category|capitalize }}!',
    //                     text: '{{ message }}',
    //                     icon: '{{ category }}', // success, error, warning, info, question
    //                     confirmButtonColor: '#F97316' // Naranja Tailwind
    //                 });
    //             {% endfor %}
    //         {% endif %}
    //     {% endwith %}
    // });
</script>
{% endblock %}
