<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- El título se tomará de la variable 'league' si está disponible, sino un default -->
    <title>{{ league.name if league else "Detalle de Liga" }} - TriPredict</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!-- Favicon link -->
    <link rel="icon" href="{{ url_for('static', filename='img/favicon.svg') }}" type="image/svg+xml">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        /* Estilos para el modal de SweetAlert2 (si se usa para mensajes flash) */
        .swal2-popup {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100">

    <!-- Header Global (copiado del diseño proporcionado) -->
{% include '_header.html' %}

    <!-- Hero Section de la Liga con Acciones de Admin (Movida fuera del <main> para ancho completo) -->
    <div class="bg-orange-500 text-white shadow-md p-6"> <!-- Eliminado mb-8 y rounded-lg para que se pegue al header y ocupe todo el ancho sin redondearse si está pegado -->
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8"> <!-- Contenedor opcional para mantener padding interno consistente con el header -->
            <div class="flex flex-col md:flex-row md:justify-between md:items-start">
                <div>
                    <h1 class="text-3xl font-bold">{{ league.name }}</h1>
                    <p class="text-orange-100 mt-1">
                        Creada por: <span class="font-semibold">{{ league.creator.username if league.creator else 'N/A' }}</span> |
                        Fecha de creación: <span class="font-semibold">{{ league.created_at|format_date_filter }}</span>
                    </p>
                     <!-- Botones de Acción para el Admin de la Liga -->
                    {% if current_user_is_creator_or_admin %}
                    <div class="mt-4 flex items-center space-x-2">
                        <a href="{{ url_for('edit_league', league_id=league.id) }}" class="bg-white/20 hover:bg-white/30 text-white text-sm font-semibold py-2 px-3 rounded-md flex items-center"><i class="fas fa-edit mr-2"></i>Editar Liga</a>
                        {% if invitation_code and invitation_code.is_active %}
                        <button id="show-league-invitation-code-button" class="bg-white/20 hover:bg-white/30 text-white text-sm font-semibold py-2 px-3 rounded-md flex items-center"><i class="fas fa-share-alt mr-2"></i>Compartir Código</button>
                        {% elif not invitation_code or not invitation_code.is_active %}
                        {# Button to generate/reactivate code could go here or elsewhere as per original logic #}
                        {# For now, matching the new static HTML, it's not shown if no active code #}
                        {% endif %}
                        <form action="{{ url_for('delete_league', league_id=league.id) }}" method="POST" onsubmit="return confirm('¿Estás seguro de que quieres eliminar esta liga? Esta acción no se puede deshacer.');" class="inline">
                            <button type="submit" class="bg-red-500/50 hover:bg-red-500 text-white text-sm font-semibold py-2 px-3 rounded-md flex items-center"><i class="fas fa-trash-alt mr-2"></i>Eliminar Liga</button>
                        </form>
                    </div>
                    {% endif %}
                    {# Button to generate invitation code if none exists or is inactive, for admins #}
                    {% if current_user_is_creator_or_admin and (not invitation_code or not invitation_code.is_active) %}
                    <div class="mt-4">
                        <form action="{{ url_for('generate_league_invitation_code', league_id=league.id) }}" method="POST">
                            {% if not invitation_code %}
                                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-2 px-3 rounded-md flex items-center">
                                    <i class="fas fa-plus-circle mr-2"></i>Generar Código de Invitación
                                </button>
                            {% elif invitation_code and not invitation_code.is_active %}
                                <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-semibold py-2 px-3 rounded-md flex items-center">
                                    <i class="fas fa-redo-alt mr-2"></i>Reactivar Código
                                </button>
                            {% endif %}
                        </form>
                    </div>
                    {% endif %}

                </div>
                <div class="mt-4 md:mt-0 flex items-center space-x-6 bg-black bg-opacity-20 p-4 rounded-lg">
                    <div class="text-center">
                        <p class="text-sm text-orange-200 uppercase tracking-wider">Próximo Cierre</p>
                        {# El data attribute se poblará desde Flask/Jinja2 con la variable next_race_close_date_isoformat #}
                        <div class="text-2xl font-bold" id="countdown" data-next-close-date="{{ next_race_close_date_isoformat if next_race_close_date_isoformat else '' }}">
                            {# El contenido inicial será actualizado por JavaScript. Puede ser un loader o N/A #}
                            Calculando...
                        </div>
                    </div>
                    <div class="text-center border-l border-orange-400 pl-6">
                        <p class="text-3xl font-bold">{{ league_races_detailed|length }}</p>
                        <p class="text-sm text-orange-200">Carreras</p>
                    </div>
                    <div class="text-center">
                        {# Mostrar el número de participantes de la liga #}
                        <p class="text-3xl font-bold">{{ league_participants_count if league_participants_count is not none else '0' }}</p>
                        <p class="text-sm text-orange-200">Participantes</p>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- Fin de la sección Hero movida -->

    <!-- Contenido Principal (ahora solo contiene lo que no es Hero) -->
    <main class="p-4 sm:p-6 lg:p-8">

        <!-- Carreras y Clasificación en un grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Columna Izquierda: Carreras y Análisis -->
            <div class="lg:col-span-2 space-y-8">
                 <!-- Carreras en esta Liga -->
                <div class="bg-white shadow-md rounded-lg">
                    <div class="p-6 border-b">
                        <h2 class="text-xl font-bold text-gray-900">Carreras en esta Liga</h2>
                    </div>
                    <div class="overflow-x-auto">
                        {% if league_races_detailed and league_races_detailed|length > 0 %}
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Carrera</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cierre Pronósticos</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for race in league_races_detailed %}
                                <tr class="{% if loop.index is odd %}bg-white{% else %}bg-gray-50{% endif %}">
                                    <td class="px-6 py-4">
                                        <a href="{{ url_for('serve_race_detail_page', race_id=race.id) }}" class="font-medium text-gray-800 hover:text-orange-500 hover:underline">{{ race.title }}</a>
                                        <p class="text-sm text-gray-500">{{ race.event_date|format_date_filter }}</p>
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-500">{{ race.quiniela_close_date|format_date_filter if race.quiniela_close_date else 'N/A' }}</td>
                                    <td class="px-6 py-4">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                                        {% if race.status.value == 'CLOSED' %}bg-red-100 text-red-800
                                        {% elif race.status.value == 'PLANNED' %}bg-gray-100 text-gray-800
                                        {% elif race.status.value == 'ACTIVE' %}bg-green-100 text-green-800
                                        {% else %}bg-blue-100 text-blue-800{% endif %}">
                                            {{ race.status.value|capitalize }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 text-center space-x-1 sm:space-x-2 md:space-x-4">
                                        <button onclick="openRaceResultsModal('{{ race.id }}', '{{ race.title }}')" class="text-gray-400 hover:text-orange-600" title="Ver Clasificación"><i class="fas fa-trophy"></i></button>
                                        {# Assuming 'make_prediction_page' and 'view_prediction_page' routes exist #}
                                        {% set prediction_status = user_predictions_status.get(race.id) %}
                                        {% set user_prediction_exists = prediction_status.exists if prediction_status else false %}
                                        {% set prediction_status = user_predictions_status.get(race.id) %}
                                        {% set user_prediction_exists = prediction_status.exists if prediction_status else false %}
                                        {% set pending_count = prediction_status.pending_count if prediction_status and user_prediction_exists else 0 %}
                                        {% set quiniela_is_closed = race.quiniela_close_date and race.quiniela_close_date < current_time_utc %}

                                        {% if race.status.value == 'PLANNED' or race.status.value == 'ACTIVE' %}
                                            {# Quiniela is Open: Show "Responder/Editar Quiniela" button #}
                                            <button onclick="openAnswerQuinielaModal('{{ race.id }}', '{{ race.title }}', {{ 'true' if user_prediction_exists else 'false' }}, {{ pending_count }})"
                                                    class="text-orange-600 hover:text-orange-800 font-bold relative"
                                                    title="{{ 'Editar mis Predicciones' if user_prediction_exists else 'Responder Quiniela' }}">
                                                <i class="fas fa-edit"></i> {# Using fa-edit icon #}
                                                {% if user_prediction_exists and pending_count > 0 %}
                                                    <span class="absolute -top-1 -right-2 bg-red-500 text-white text-xs font-semibold px-1.5 py-0.5 rounded-full" title="{{pending_count}} pregunta(s) pendiente(s)">{{ pending_count }}</span>
                                                {% endif %}
                                            </button>
                                        {% elif user_prediction_exists %}
                                            {# Quiniela is Closed, but user made predictions: Show "Ver mi Quiniela" (read-only) #}
                                            {# This now uses the openUserPredictionsModal to show already submitted answers, edit button will be hidden by JS #}
                                            <button onclick="openUserPredictionsModal('{{ race.id }}', '{{ race.title }}', true)"
                                                    class="text-gray-400 hover:text-orange-600 font-bold"
                                                    title="Ver mi Quiniela (Cerrada)">
                                                <i class="fas fa-eye"></i> {# Changed icon to fa-eye for clarity #}
                                            </button>
                                        {% else %}
                                            {# Quiniela is Closed, and user did NOT make predictions #}
                                            <span class="text-gray-400 cursor-not-allowed" title="Quiniela cerrada y no participaste">
                                                <i class="fas fa-times-circle"></i> {# Changed icon #}
                                            </span>
                                        {% endif %}
                                        {# The "Ver Participantes" link is removed as per the new requirement #}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div class="p-6 text-center text-gray-500">
                            <i class="fas fa-flag-checkered text-4xl mb-2"></i>
                            <p>No hay carreras en esta liga todavía.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                 <!-- Análisis por Carrera -->
                <div class="bg-white shadow-md rounded-lg">
                    <div class="p-6 border-b flex justify-between items-center">
                        <h2 class="text-xl font-bold text-gray-900">Análisis por Carrera</h2>
                        {% if league_races_detailed and league_races_detailed|length > 0 %}
                        <select id="race-selector" class="text-sm border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500">
                            {% for race in league_races_detailed %}
                            <option value="{{ race.id }}">{{ race.title }}</option>
                            {% endfor %}
                        </select>
                        {% else %}
                        <p class="text-sm text-gray-500">No hay carreras para analizar.</p>
                        {% endif %}
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">Pos.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Participante</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Puntos</th>
                                </tr>
                            </thead>
                            <tbody id="race-details-body" class="bg-white divide-y divide-gray-200">
                                <!-- JS will populate this -->
                                 <tr><td colspan="3" class="text-center p-4 text-gray-500">Selecciona una carrera para ver el análisis.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Columna Derecha: Clasificación General y Actividad -->
            <div class="lg:col-span-1 space-y-8">
                 <!-- Clasificación General con Avatares -->
                <div class="bg-white shadow-md rounded-lg">
                     <div class="p-6 border-b"><h2 class="text-xl font-bold text-gray-900">Clasificación General</h2></div>
                    <div class="overflow-x-auto">
                        {% if league_standings and league_standings|length > 0 %}
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">Pos.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Participante</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Puntos</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for standing in league_standings %}
                                <tr class="{% if loop.index is odd %}bg-white{% else %}bg-gray-50{% endif %}">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">{{ loop.index }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center">
                                        <img src="{{ standing.avatar_url or url_for('static', filename='img/favicon_promo.svg') }}" class="w-8 h-8 rounded-full mr-3" alt="Avatar">
                                        {{ standing.username }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold text-orange-600">{{ standing.total_score }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div class="p-6 text-center text-gray-500">
                             <i class="fas fa-users-slash text-4xl mb-2"></i>
                            <p>Aún no hay clasificación disponible.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <!-- Feed de Actividad de la Liga (Dummy) REMOVED -->
            </div>
        </div>
    </main>

    <!-- Include the race results modal -->
    {% include '_race_results_modal.html' %}
    <!-- Include the user predictions modal -->
    {% include '_user_predictions_modal.html' %}

    {# Modal para unirse a la liga con código (similar al original) #}
    <div id="join-league-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full transform transition-all">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Unirse a la Liga "{{ league.name }}"</h3>
                    <button onclick="closeJoinLeagueModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="join-league-form" action="{{ url_for('process_join_league_with_code') }}" method="POST">
                    <div class="mb-4">
                        <label for="league-join-code" class="block text-sm font-medium text-gray-700 mb-1">Código de Invitación</label>
                        <input type="text" name="join_code" id="league-join-code" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm"
                               placeholder="Introduce el código de invitación">
                        <input type="hidden" name="league_id" value="{{ league.id }}">
                    </div>
                    <div class="flex items-center justify-end space-x-3">
                        <button type="button" onclick="closeJoinLeagueModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg font-medium transition-colors">
                            Unirme a la Liga
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para MOSTRAR el código de invitación de la liga (similar al original) -->
    {% if invitation_code %}
    <div id="show-league-code-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full transform transition-all">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Código de Invitación para "{{ league.name }}"</h3>
                    <button onclick="closeShowLeagueCodeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="my-4">
                    <p class="text-sm text-gray-600 mb-2">Comparte este código para que otros se unan:</p>
                    <div class="bg-gray-100 p-3 rounded-lg flex items-center justify-between">
                        <span id="league-invitation-code-display" class="text-xl font-mono text-gray-800">{{ invitation_code.code }}</span>
                        <button id="copy-league-code-button"
                                class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors flex items-center">
                            <i class="far fa-copy mr-2"></i>Copiar
                        </button>
                    </div>
                    {% if invitation_code.expires_at %}
                    <p class="text-xs text-gray-500 mt-2">Expira: {{ invitation_code.expires_at|format_date_filter('%d %b %Y %H:%M') }}</p>
                    {% else %}
                    <p class="text-xs text-gray-500 mt-2">Este código no expira.</p>
                    {% endif %}
                </div>
                <div class="flex items-center justify-end mt-6">
                    <button type="button" onclick="closeShowLeagueCodeModal()" class="btn-secondary px-5 py-2">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <script>
        // Data for race analysis - this would ideally come from Flask/backend
        // For now, using a structure that can be populated by Flask if needed
        // The keys for raceData should be race IDs.
        // Data for race analysis - this would ideally come from Flask/backend
        // For now, using a structure that can be populated by Flask if needed
        // The keys for raceData should be race IDs.
        // const raceAnalysisData = {
        //     {% for race in league_races_detailed %}
        //         "{{ race.id }}": [
        //             // This part needs to be populated with actual participant scores for each race.
        //             // Example: { pos: 1, name: 'Participant A', points: 50, avatar_url: '...' },
        //             // For now, it will be empty or use dummy data if available from backend.
        //             // Let's assume a variable `race_analysis_details` is passed from Flask
        //             // `race_analysis_details` would be a dict like: { race_id: [ {details}, ... ], ... }
        //             {% if race_analysis_details and race_analysis_details[race.id|string] %}
        //                 {% for detail in race_analysis_details[race.id|string] %}
        //                     { pos: {{ detail.pos if detail.pos is not none else "'-'" }}, name: '{{ detail.name }}', points: {{ detail.points if detail.points is not none else 0 }} },
        //                 {% endfor %}
        //             {% else %}
        //                  // Dummy data if not provided by backend for this specific race
        //                 // { pos: '-', name: 'Participante Ejemplo Desde JS', points: 0 },
        //             {% endif %}
        //         ],
        //     {% endfor %}
        // };
        // Convertir los datos de Flask/Jinja2 a un objeto JavaScript
        // Asegúrate que `race_analysis_details` se pasa correctamente desde Flask y tiene la estructura:
        // { "race_id_str": [ { "pos": X, "name": "Y", "points": Z }, ... ], ... }
        const raceAnalysisData = {{ race_analysis_details | tojson | safe }};

        const raceSelector = document.getElementById('race-selector');
        const raceDetailsBody = document.getElementById('race-details-body');

        function renderRaceDetails(raceId) {
            const data = raceAnalysisData[raceId] || [];
            raceDetailsBody.innerHTML = ''; // Clear previous entries

            if (data.length === 0) {
                raceDetailsBody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-gray-500">No hay datos de análisis para esta carrera.</td></tr>';
                return;
            }

            // Sort data by position, handling '-'
            data.sort((a, b) => {
                if (a.pos === '-' && b.pos === '-') return 0;
                if (a.pos === '-') return 1;
                if (b.pos === '-') return -1;
                return a.pos - b.pos;
            });

            data.forEach((player, index) => {
                const row = document.createElement('tr');
                if (index % 2 !== 0) { row.classList.add('bg-gray-50'); } // Alternate row color
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">${player.pos}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${player.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold text-gray-700">${player.points}</td>
                `;
                raceDetailsBody.appendChild(row);
            });
        }

        if (raceSelector) {
            raceSelector.addEventListener('change', (event) => {
                renderRaceDetails(event.target.value);
            });
            // Initial load for the first selected race (if any)
            if (raceSelector.value) {
                renderRaceDetails(raceSelector.value);
            } else if (raceDetailsBody) {
                 raceDetailsBody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-gray-500">No hay carreras seleccionadas o disponibles para análisis.</td></tr>';
            }
        } else if (raceDetailsBody) {
            // If no selector, means no races, so show message in table
            raceDetailsBody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-gray-500">No hay carreras disponibles para análisis.</td></tr>';
        }


        // Modal functions (similar to original, adapted for current structure)
        function openJoinLeagueModal(leagueId) {
            const modal = document.getElementById('join-league-modal');
            // const form = document.getElementById('join-league-form'); // Action is already set in HTML
            if (modal) {
                // If you need to dynamically set league_id in the form, do it here
                // For example, if you have a hidden input:
                // modal.querySelector('input[name="league_id"]').value = leagueId;
                modal.classList.remove('hidden');
                document.getElementById('league-join-code').focus();
            }
        }

        function closeJoinLeagueModal() {
            const modal = document.getElementById('join-league-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        const showCodeButton = document.getElementById('show-league-invitation-code-button');
        const showLeagueCodeModalElem = document.getElementById('show-league-code-modal');

        if (showCodeButton && showLeagueCodeModalElem) {
            showCodeButton.addEventListener('click', () => {
                showLeagueCodeModalElem.classList.remove('hidden');
            });
        }

        function closeShowLeagueCodeModal() {
            if (showLeagueCodeModalElem) {
                showLeagueCodeModalElem.classList.add('hidden');
            }
        }

        const copyCodeButton = document.getElementById('copy-league-code-button');
        if (copyCodeButton) {
            copyCodeButton.addEventListener('click', () => {
                const codeToCopy = document.getElementById('league-invitation-code-display').textContent;
                navigator.clipboard.writeText(codeToCopy).then(() => {
                    const originalButtonHtml = copyCodeButton.innerHTML;
                    copyCodeButton.innerHTML = '<i class="fas fa-check mr-2"></i>¡Copiado!';
                    copyCodeButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    copyCodeButton.classList.add('bg-green-500');
                    setTimeout(() => {
                        copyCodeButton.innerHTML = originalButtonHtml;
                        copyCodeButton.classList.remove('bg-green-500');
                        copyCodeButton.classList.add('bg-blue-500', 'hover:bg-blue-600');
                    }, 2000);
                }).catch(err => {
                    console.error('Error al copiar código: ', err);
                });
            });
        }

        // Countdown timer
        const countdownElement = document.getElementById('countdown');
        // Get the next closing date from the data attribute
        let nextCloseDateISO = countdownElement.dataset.nextCloseDate;
        console.log("[Countdown] Initial nextCloseDateISO from data attribute: ", nextCloseDateISO);

        function updateCountdown() {
            if (!nextCloseDateISO || nextCloseDateISO === '') { // Check if empty or not set
                console.log("[Countdown] No nextCloseDateISO or empty. Setting to N/A.");
                countdownElement.textContent = "N/A";
                if (countdownInterval) clearInterval(countdownInterval); // Stop interval if no date
                return;
            }

            // Asegurar que la fecha se interprete como UTC si no tiene 'Z'
            let dateStringToParse = nextCloseDateISO;
            if (!dateStringToParse.endsWith('Z') && dateStringToParse.includes('T')) {
                // Si es un formato ISO sin Z, asumimos UTC y lo añadimos para consistencia.
                // Esto es importante porque new Date("YYYY-MM-DDTHH:MM:SS") puede ser local o UTC según el navegador.
                // new Date("YYYY-MM-DDTHH:MM:SSZ") es explícitamente UTC.
                // No añadimos 'Z' si ya está o si no es un formato con 'T' (ej. solo fecha YYYY-MM-DD)
                // aunque el backend debería enviar con T.
                dateStringToParse += 'Z';
                console.log("[Countdown] Appended 'Z' for UTC parsing. String to parse: ", dateStringToParse);
            } else {
                console.log("[Countdown] Using original date string (already has Z or not a T-format): ", dateStringToParse);
            }

            const targetDate = new Date(dateStringToParse);
            const now = new Date(); // Esto es la hora local del navegador

            console.log("[Countdown] Target Date Object (parsed as UTC): ", targetDate.toISOString(), targetDate);
            console.log("[Countdown] Current Browser Local Date Object: ", now.toISOString(), now);

            // Para una comparación correcta, ambas fechas deben estar en la misma base (UTC o local).
            // targetDate ya es UTC (o se parseó como tal). `now.getTime()` da ms desde epoch UTC.
            // `targetDate.getTime()` también da ms desde epoch UTC.
            const diff = targetDate.getTime() - now.getTime();
            console.log("[Countdown] Difference in milliseconds: ", diff);


            if (diff <= 0) {
                console.log("[Countdown] Difference is zero or negative. Setting to Cerrado.");
                countdownElement.textContent = "Cerrado";
                if (countdownInterval) clearInterval(countdownInterval); // Stop interval
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            // const seconds = Math.floor((diff % (1000 * 60)) / 1000); // Uncomment if you want seconds

            countdownElement.textContent = `${String(days).padStart(2, '0')}d ${String(hours).padStart(2, '0')}h ${String(minutes).padStart(2, '0')}m`;
        }

        let countdownInterval; // Declare interval variable outside
        if (nextCloseDateISO && nextCloseDateISO !== '') {
            updateCountdown(); // Initial call
            countdownInterval = setInterval(updateCountdown, 60000); // Update every minute
        } else {
             countdownElement.textContent = "N/A"; // Default if no date
        }

        // Functions for Race Results Modal
        function openRaceResultsModal(raceId, raceName) {
            const modal = document.getElementById('raceResultsModal');
            const modalTitle = document.getElementById('raceResultsModalTitle');
            const modalContent = document.getElementById('raceResultsModalContent');

            if (modalTitle) {
                modalTitle.textContent = `Clasificación de: ${raceName}`;
            }
            if (modalContent) {
                modalContent.innerHTML = '<p class="text-center text-gray-500">Cargando resultados...</p>';
                // Fetch results from the backend
                fetch(`/race/${raceId}/results_modal_content`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(html => {
                        modalContent.innerHTML = html;
                    })
                    .catch(error => {
                        console.error('Error fetching race results:', error);
                        modalContent.innerHTML = `<p class="text-center text-red-500">Error al cargar los resultados. ${error.message}</p>`;
                    });
            }

            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function closeRaceResultsModal() {
            const modal = document.getElementById('raceResultsModal');
            if (modal) {
                modal.classList.add('hidden');
                // Optional: Clear content when closing
                const modalContent = document.getElementById('raceResultsModalContent');
                if (modalContent) {
                    modalContent.innerHTML = '';
                }
            }
        }

        // Functions for User Predictions Modal
        function openUserPredictionsModal(raceId, raceName, isQuinielaClosed) {
            const modal = document.getElementById('userPredictionsModal');
            const modalTitle = document.getElementById('userPredictionsModalTitle');
            const modalContent = document.getElementById('userPredictionsModalContent');
            const editButton = document.getElementById('editPredictionsButton');

            if (modalTitle) {
                modalTitle.textContent = `Mis Predicciones para: ${raceName}`;
            }
            if (modalContent) {
                modalContent.innerHTML = '<p class="text-center text-gray-500">Cargando tus predicciones...</p>';
                fetch(`/race/${raceId}/user_predictions_modal_content`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(html => {
                        modalContent.innerHTML = html;
                        // Show edit button only if quiniela is not closed
                        if (editButton) {
                            if (!isQuinielaClosed) {
                                editButton.href = `/race/${raceId}#hacer-prediccion`; // Or specific edit URL
                                editButton.classList.remove('hidden');
                            } else {
                                editButton.classList.add('hidden');
                            }
                        }
                        // Add event listeners for the new "Edit/Answer" buttons within the modal
                        attachEditSingleQuestionButtonListeners(isQuinielaClosed);
                    })
                    .catch(error => {
                        console.error('Error fetching user predictions:', error);
                        modalContent.innerHTML = `<p class="text-center text-red-500">Error al cargar tus predicciones. ${error.message}</p>`;
                        if (editButton) {
                            editButton.classList.add('hidden');
                        }
                    });
            }

            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function attachEditSingleQuestionButtonListeners(isQuinielaClosed) {
            if (isQuinielaClosed) return; // Don't attach if quiniela is closed

            const buttons = document.querySelectorAll('.edit-single-question-button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    const raceId = this.dataset.raceId;
                    const raceName = this.dataset.raceName;
                    const questionId = this.dataset.questionId;

                    // Close the current "UserPredictionsModal"
                    closeUserPredictionsModal();

                    // Open the "AnswerQuinielaModal" and scroll to the question
                    // The 'hasPredictions' and 'pendingCount' arguments for openAnswerQuinielaModal
                    // are not strictly necessary for this direct jump, but we can pass defaults or fetch.
                    // For simplicity, using true for hasPredictions (as we are editing) and 0 for pending.
                    openAnswerQuinielaModal(raceId, raceName, true, 0, questionId);
                });
            });
        }

        function closeUserPredictionsModal() {
            const modal = document.getElementById('userPredictionsModal');
            if (modal) {
                modal.classList.add('hidden');
                const modalContent = document.getElementById('userPredictionsModalContent');
                if (modalContent) {
                    modalContent.innerHTML = '<p class="text-center text-gray-500">Cargando tus predicciones...</p>'; // Reset
                }
                const editButton = document.getElementById('editPredictionsButton');
                if (editButton) {
                    editButton.classList.add('hidden'); // Ensure edit button is hidden on close
                }
            }
        }

        // --- Answer/Edit Quiniela Modal JavaScript ---
        const answerQuinielaModal = document.getElementById('answerQuinielaModal');
        const answerQuinielaModalTitle = document.getElementById('answerQuinielaModalTitle');
        const answerQuinielaModalContent = document.getElementById('answerQuinielaModalContent');
        const answerQuinielaForm = document.getElementById('answerQuinielaForm');
        const answerQuinielaModalError = document.getElementById('answerQuinielaModalError');
        let currentAnsweringRaceId = null;
        let questionToFocus = null; // Variable to store the ID of the question to focus/scroll to

        function openAnswerQuinielaModal(raceId, raceName, hasPredictions, pendingCount, targetQuestionId = null) {
            currentAnsweringRaceId = raceId;
            questionToFocus = targetQuestionId; // Store the target question ID
            answerQuinielaModalTitle.textContent = `${hasPredictions ? 'Editar' : 'Responder'} Quiniela: ${raceName}`;
            answerQuinielaModalContent.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-3xl text-orange-500"></i><p class="mt-2 text-gray-600">Cargando preguntas...</p></div>';
            answerQuinielaModalError.classList.add('hidden');
            answerQuinielaModalError.textContent = '';

            fetch(`/race/${raceId}/quiniela_form_content`)
                .then(response => {
                    if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);
                    return response.json();
                })
                .then(data => {
                    if (data.quiniela_closed) {
                        answerQuinielaModalContent.innerHTML = '<p class="text-center text-red-500">La quiniela para esta carrera ya está cerrada. No puedes modificar tus respuestas.</p>';
                        document.getElementById('saveQuinielaPredictionsButton').classList.add('hidden');
                        return;
                    }
                    document.getElementById('saveQuinielaPredictionsButton').classList.remove('hidden');
                    renderQuinielaForm(data.questions, questionToFocus); // Pass questionToFocus
                })
                .catch(error => {
                    console.error('Error fetching quiniela form content:', error);
                    questionToFocus = null; // Reset on error
                    answerQuinielaModalContent.innerHTML = `<p class="text-center text-red-500">Error al cargar el formulario de la quiniela: ${error.message}</p>`;
                    document.getElementById('saveQuinielaPredictionsButton').classList.add('hidden');
                });

            answerQuinielaModal.classList.remove('hidden');
        }

        function renderQuinielaForm(questions, targetQuestionId) {
            answerQuinielaModalContent.innerHTML = ''; // Clear loading spinner
            if (!questions || questions.length === 0) {
                answerQuinielaModalContent.innerHTML = '<p class="text-gray-600">No hay preguntas disponibles para esta quiniela.</p>';
                document.getElementById('saveQuinielaPredictionsButton').classList.add('hidden');
                return;
            }

            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.classList.add('mb-6', 'p-4', 'border', 'rounded-md', 'shadow-sm');
                questionDiv.innerHTML = `<label class="block text-md font-semibold text-gray-800 mb-2">${index + 1}. ${q.text}</label>`;

                if (q.question_type === 'FREE_TEXT') {
                    const input = document.createElement('textarea');
                    input.name = `q_${q.id}`;
                    input.classList.add('w-full', 'p-2', 'border', 'border-gray-300', 'rounded-md', 'focus:ring-orange-500', 'focus:border-orange-500');
                    input.rows = 2;
                    input.value = q.user_answer || '';
                    questionDiv.appendChild(input);
                } else if (q.question_type === 'MULTIPLE_CHOICE') {
                    const optionsContainer = document.createElement('div');
                    optionsContainer.classList.add('space-y-2', 'mt-2');
                    q.options.forEach(opt => {
                        const optionDiv = document.createElement('div');
                        optionDiv.classList.add('flex', 'items-center');
                        const input = document.createElement('input');
                        input.type = q.is_mc_multiple_correct ? 'checkbox' : 'radio';
                        input.name = `q_${q.id}`;
                        input.value = opt.id;
                        input.id = `q_${q.id}_opt_${opt.id}`;
                        input.classList.add('h-4', 'w-4', 'text-orange-600', 'border-gray-300', 'focus:ring-orange-500');

                        if (q.is_mc_multiple_correct) {
                            if (Array.isArray(q.user_answer) && q.user_answer.includes(opt.id)) {
                                input.checked = true;
                            }
                        } else {
                            if (q.user_answer === opt.id) {
                                input.checked = true;
                            }
                        }

                        const label = document.createElement('label');
                        label.htmlFor = input.id;
                        label.textContent = opt.option_text;
                        label.classList.add('ml-2', 'block', 'text-sm', 'text-gray-700');

                        optionDiv.appendChild(input);
                        optionDiv.appendChild(label);
                        optionsContainer.appendChild(optionDiv);
                    });
                    questionDiv.appendChild(optionsContainer);
                } else if (q.question_type === 'SLIDER') {
                    const sliderContainer = document.createElement('div');
                    sliderContainer.classList.add('mt-2');
                    const input = document.createElement('input');
                    input.type = 'range';
                    input.name = `q_${q.id}`;
                    input.min = q.slider_min_value;
                    input.max = q.slider_max_value;
                    input.step = q.slider_step;
                    input.value = q.user_answer !== null ? q.user_answer : (q.slider_min_value + q.slider_max_value) / 2; // Default to middle if no answer
                    input.classList.add('w-full', 'h-2', 'bg-gray-200', 'rounded-lg', 'appearance-none', 'cursor-pointer', 'focus:outline-none', 'focus:ring-2', 'focus:ring-orange-500');

                    const valueDisplay = document.createElement('span');
                    valueDisplay.classList.add('ml-2', 'text-sm', 'text-gray-600');
                    valueDisplay.textContent = `${input.value}${q.slider_unit || ''}`;
                    input.oninput = () => { valueDisplay.textContent = `${input.value}${q.slider_unit || ''}`; };

                    sliderContainer.appendChild(input);
                    sliderContainer.appendChild(valueDisplay);
                    questionDiv.appendChild(sliderContainer);
                } else if (q.question_type === 'ORDERING') {
                    // Basic text area for comma-separated values for now
                    // A drag-and-drop UI would be more complex and is out of scope for this quick implementation.
                    const helpText = document.createElement('p');
                    helpText.textContent = 'Introduce los elementos en orden, separados por comas.';
                    helpText.classList.add('text-xs', 'text-gray-500', 'mb-1');
                    questionDiv.appendChild(helpText);

                    const textarea = document.createElement('textarea');
                    textarea.name = `q_${q.id}`;
                    textarea.classList.add('w-full', 'p-2', 'border', 'border-gray-300', 'rounded-md', 'focus:ring-orange-500', 'focus:border-orange-500');
                    textarea.rows = 3;
                    textarea.value = q.user_answer || ''; // User answer is comma-separated string of texts
                    questionDiv.appendChild(textarea);

                    const optionsList = document.createElement('div');
                    optionsList.classList.add('mt-2', 'text-xs', 'text-gray-500');
                    optionsList.innerHTML = '<strong>Opciones disponibles:</strong> ' + q.options.map(opt => opt.option_text).join(', ');
                    questionDiv.appendChild(optionsList);
                }
                questionDiv.setAttribute('data-question-form-id', q.id); // Add data attribute for scrolling
                answerQuinielaModalContent.appendChild(questionDiv);
            });

            if (targetQuestionId) {
                // Scroll to the target question if specified
                const targetQuestionElement = answerQuinielaModalContent.querySelector(`[data-question-form-id="${targetQuestionId}"]`);
                if (targetQuestionElement) {
                    // Delay slightly to ensure modal is fully rendered and visible before scrolling
                    setTimeout(() => {
                        targetQuestionElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Optionally, add a visual highlight
                        targetQuestionElement.classList.add('ring-2', 'ring-orange-500', 'transition-all', 'duration-300');
                        setTimeout(() => targetQuestionElement.classList.remove('ring-2', 'ring-orange-500'), 2000);
                    }, 100);
                }
                questionToFocus = null; // Reset after attempting to focus
            }
        }

        function closeAnswerQuinielaModal() {
            answerQuinielaModal.classList.add('hidden');
            answerQuinielaModalContent.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-3xl text-orange-500"></i><p class="mt-2 text-gray-600">Cargando preguntas...</p></div>'; // Reset content
            answerQuinielaModalError.classList.add('hidden');
            answerQuinielaModalError.textContent = '';
            currentAnsweringRaceId = null;
            questionToFocus = null; // Reset focused question on close
            document.getElementById('saveQuinielaPredictionsButton').classList.remove('hidden');
        }

        if (answerQuinielaForm) {
            answerQuinielaForm.addEventListener('submit', function(event) {
                event.preventDefault();
                if (!currentAnsweringRaceId) return;

                const formData = new FormData(answerQuinielaForm);
                const answersPayload = {};

                // Iterate over questions that were rendered (present in modal content)
                // to ensure we only collect data for displayed questions.
                const renderedQuestions = answerQuinielaModalContent.querySelectorAll('[name^="q_"]');
                const questionIdsProcessed = new Set();

                renderedQuestions.forEach(inputElement => {
                    const name = inputElement.name; // e.g., "q_123"
                    const questionId = name.substring(2); // "123"

                    if (questionIdsProcessed.has(questionId)) return; // Skip if already processed (for radio/checkbox groups)

                    const questionDiv = inputElement.closest('.mb-6'); // Find parent question div to get type if needed
                    // This is a simplified way; ideally, we'd iterate through the original `questions` data used for rendering.
                    // For robust type checking, one might need to re-fetch question types or store them.
                    // Here, we infer based on input types or rely on how data is structured.

                    if (inputElement.type === 'radio') {
                        const checkedRadio = answerQuinielaForm.querySelector(`input[name="${name}"]:checked`);
                        answersPayload[questionId] = { selected_option_id: checkedRadio ? parseInt(checkedRadio.value) : null };
                        questionIdsProcessed.add(questionId);
                    } else if (inputElement.type === 'checkbox') {
                        const checkedCheckboxes = Array.from(answerQuinielaForm.querySelectorAll(`input[name="${name}"]:checked`))
                                                     .map(cb => parseInt(cb.value));
                        answersPayload[questionId] = { selected_option_ids: checkedCheckboxes };
                        questionIdsProcessed.add(questionId);
                    } else if (inputElement.type === 'range') { // Slider
                        answersPayload[questionId] = { slider_answer_value: parseFloat(inputElement.value) };
                        questionIdsProcessed.add(questionId);
                    } else if (inputElement.tagName === 'TEXTAREA') { // Free Text or Ordering (as textarea)
                        // Need to differentiate if Ordering was rendered as textarea
                        // For now, assume if it's textarea, it could be free_text or ordering's comma-separated text
                        // This part needs to align with how `renderQuinielaForm` names Ordering textareas.
                        // Let's assume Ordering also uses `q_{id}`
                        answersPayload[questionId] = { answer_text: inputElement.value.trim() }; // For Free Text
                        // If it's an ordering question, the backend expects 'ordered_options_text' in some cases,
                        // but the generic save endpoint uses 'answer_text' for this.
                        questionIdsProcessed.add(questionId);
                    }
                });

                const saveButton = document.getElementById('saveQuinielaPredictionsButton');
                saveButton.disabled = true;
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';
                answerQuinielaModalError.classList.add('hidden');

                fetch(`/api/races/${currentAnsweringRaceId}/answers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(answersPayload)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || `Error ${response.status}`) });
                    }
                    return response.json();
                })
                .then(data => {
                    closeAnswerQuinielaModal();
                    Swal.fire({ title: '¡Éxito!', text: data.message || 'Predicciones guardadas correctamente.', icon: 'success', confirmButtonColor: '#F97316' });
                    // TODO: Update client-side state (e.g., pending count badge) or reload. For now, suggest reload.
                    // Simple reload for now to reflect changes.
                    window.location.reload();
                })
                .catch(error => {
                    console.error('Error saving predictions:', error);
                    answerQuinielaModalError.textContent = `Error: ${error.message}`;
                    answerQuinielaModalError.classList.remove('hidden');
                })
                .finally(() => {
                    saveButton.disabled = false;
                    saveButton.innerHTML = '<i class="fas fa-save mr-2"></i>Guardar Predicciones';
                });
            });
        }
        // --- End Answer/Edit Quiniela Modal JavaScript ---

    </script>
    <!-- Script para SweetAlert (mensajes flash) - Movido fuera de los bloques Jinja eliminados -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        Swal.fire({
                            title: '{{ category|capitalize }}!',
                            text: '{{ message }}',
                            icon: '{{ "success" if category == "message" or category == "success" else ("error" if category == "danger" or category == "error" else category) }}',
                            confirmButtonColor: '#F97316' // Orange color for confirm button
                        });
                    {% endfor %}
                {% endif %}
            {% endwith %}
        });
    </script>
</body>
</html>
