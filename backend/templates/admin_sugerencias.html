{% extends "base.html" %}

{% block title %}Gestionar Sugerencias - {{ super() }}{% endblock %}

{% block head_extra %}
    {# main_theme.css ya define .table-hover, pero podemos añadir estilos específicos si es necesario #}
    <style>
        /* Ajustes para la tabla si son necesarios más allá de Tailwind y main_theme.css */
        thead.table-header-custom th { /* Aplicar a los th dentro de un thead con esta clase */
            background-color: var(--orange-primary);
            color: white;
            font-weight: 600; /*semibold*/
        }
    </style>
{% endblock %}

{% block hero %}
    {% set hero_title = "Gestionar Sugerencias de Eventos" %}
    {% set hero_subtitle = "Revisa, valida o descarta las sugerencias de eventos enviadas por los usuarios." %}
    {% include '_hero_section.html' %}
{% endblock hero %}

{% block content %}
<div class="px-6 py-8">
    {# Contenedor para mensajes Flash - Asegúrate de que este ID sea único o que tu JS de mensajes flash lo maneje bien #}
    <div id="flash-messages-container-sugerencias" class="mb-4"></div>

    <div class="bg-white shadow-xl rounded-lg overflow-hidden">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-dark brand-font">Sugerencias de Eventos Pendientes</h2>
        </div>
        {% if pending_events %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 table-hover">
                <thead class="table-header-custom">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Nombre</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Fecha</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Lugar</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Disciplina</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Distancia</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">URL Sugerida</th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-semibold uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for event in pending_events %}
                    <tr id="suggestion-row-{{ event.id }}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ event.name }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">{{ event.event_date | format_date_filter }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">{{ event.city }}{% if event.city and event.province %}, {% endif %}{{ event.province }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                {{ event.discipline | default('N/A') }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">{{ event.distance | default('N/A') }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {% if event.source_url %}
                            <a href="{{ event.source_url }}" target="_blank" class="text-orange-primary hover:text-orange-dark hover:underline">Ver enlace</a>
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button onclick="handleSuggestionAction('{{ url_for('admin_validate_event_suggestion', event_id=event.id) }}', 'Validar', {{ event.id }})"
                                    class="text-green-600 hover:text-green-800 hover:underline focus:outline-none font-semibold">Validar</button>
                            <button onclick="handleSuggestionAction('{{ url_for('admin_discard_event_suggestion', event_id=event.id) }}', 'Descartar', {{ event.id }})"
                                    class="text-red-600 hover:text-red-800 hover:underline focus:outline-none font-semibold">Descartar</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="p-6 text-center">
            <i class="fas fa-info-circle fa-3x text-gray-400 mb-4"></i>
            <p class="text-gray-600 text-lg">No hay sugerencias pendientes en este momento.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock content %}

{% block scripts %}
{{ super() }} {# Incluye scripts de base.html si los hay #}
<script>
// Función para mostrar mensajes flash (adaptada para este contexto)
function showAppFlashMessage(message, category, containerId = 'flash-messages-container-sugerencias') {
    const flashContainer = document.getElementById(containerId);
    if (!flashContainer) {
        console.error('Flash message container not found:', containerId);
        alert(`${category.toUpperCase()}: ${message}`); // Fallback
        return;
    }

    const alertDiv = document.createElement('div');
    let bgColor, textColor, borderColor, iconHtml;

    switch (category) {
        case 'success':
            bgColor = 'bg-green-100'; // Tailwind green-100
            textColor = 'text-green-700'; // Tailwind green-700
            borderColor = 'border-green-400'; // Tailwind green-400
            iconHtml = '<i class="fas fa-check-circle mr-2"></i>';
            break;
        case 'error':
            bgColor = 'bg-red-100'; // Tailwind red-100
            textColor = 'text-red-700'; // Tailwind red-700
            borderColor = 'border-red-400'; // Tailwind red-400
            iconHtml = '<i class="fas fa-exclamation-triangle mr-2"></i>';
            break;
        default: // info or warning
            bgColor = 'bg-blue-100';
            textColor = 'text-blue-700';
            borderColor = 'border-blue-400';
            iconHtml = '<i class="fas fa-info-circle mr-2"></i>';
            break;
    }

    alertDiv.className = `${bgColor} ${textColor} border-l-4 ${borderColor} p-4 mb-4 rounded-md shadow-sm flex items-center`;
    alertDiv.setAttribute('role', 'alert');
    alertDiv.innerHTML = `${iconHtml}<span>${message}</span><button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-transparent ${textColor} rounded-lg focus:ring-2 focus:ring-opacity-50 p-1.5 hover:bg-opacity-20 inline-flex h-8 w-8" onclick="this.parentElement.remove();"><span class="sr-only">Cerrar</span><i class="fas fa-times"></i></button>`;

    // Limpiar mensajes anteriores antes de añadir uno nuevo para evitar acumulación
    while (flashContainer.firstChild) {
        flashContainer.removeChild(flashContainer.firstChild);
    }
    flashContainer.appendChild(alertDiv);

    // Auto-dismiss after 7 seconds
    setTimeout(() => {
        if (alertDiv.parentElement) { // Check if still in DOM
            alertDiv.remove();
        }
    }, 7000);
}


function handleSuggestionAction(url, actionName, eventId) {
    const row = document.getElementById(`suggestion-row-${eventId}`);

    if (!confirm(`¿Estás seguro de que quieres ${actionName.toLowerCase()} esta sugerencia?`)) {
        return;
    }

    // Mostrar un indicador de carga visual si es posible
    if (row) {
        row.style.opacity = '0.5'; // Ejemplo simple
    }

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            // 'X-CSRFToken': '{{ csrf_token() }}' // Si CSRF está implementado globalmente y es necesario
        }
    })
    .then(response => {
        const statusCode = response.status;
        return response.json().then(data => ({ ok: response.ok, status: statusCode, data: data }));
    })
    .then(result => {
        if (result.ok) {
            showAppFlashMessage(result.data.message || `Sugerencia ${actionName.toLowerCase()}da correctamente.`, 'success');
            if (row) {
                row.remove(); // Eliminar la fila de la tabla
            }
            // Opcional: actualizar un contador de sugerencias si existe en la UI
            // Considerar recargar si la tabla necesita paginación o reordenamiento: location.reload();
        } else {
            showAppFlashMessage(result.data.message || `Error al ${actionName.toLowerCase()} la sugerencia. Código: ${result.status}`, 'error');
        }
    })
    .catch(error => {
        console.error(`Error en la acción '${actionName}' para el evento ${eventId}:`, error);
        showAppFlashMessage(`Error de conexión o respuesta inesperada al ${actionName.toLowerCase()} la sugerencia. Por favor, revisa la consola.`, 'error');
    })
    .finally(() => {
        // Restaurar opacidad si no se eliminó la fila (en caso de error)
        if (row && row.parentElement) {
            row.style.opacity = '1';
        }
    });
}
</script>
{% endblock scripts %}
