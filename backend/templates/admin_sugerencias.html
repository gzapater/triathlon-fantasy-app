{% extends "admin_dashboard.html" %}

{% block title %}Gestionar Sugerencias de Eventos - Admin{% endblock %}

{% block header_title %}Gestionar Sugerencias de Eventos{% endblock %}
{% block header_subtitle %}Revisa, valida o rechaza las sugerencias de eventos enviadas por los usuarios.{% endblock %}

{% block admin_content %}
<div class="bg-white shadow px-4 py-5 sm:rounded-lg sm:p-6">
    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
        Sugerencias Pendientes
    </h3>
    {% if pending_events %}
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lugar</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Disciplina</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Distancia</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">URL</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for event in pending_events %}
                <tr id="suggestion-row-{{ event.id }}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ event.name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ event.event_date.strftime('%Y-%m-%d') }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ event.city }}, {{ event.province }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ event.discipline }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ event.distance }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {% if event.source_url %}
                        <a href="{{ event.source_url }}" target="_blank" class="text-orange-600 hover:text-orange-900 hover:underline">Ver enlace</a>
                        {% else %}
                        N/A
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <button onclick="handleSuggestionAction({{ event.id }}, 'validar')" class="text-green-600 hover:text-green-900 hover:underline">Validar</button>
                        <button onclick="handleSuggestionAction({{ event.id }}, 'rechazar')" class="text-red-600 hover:text-red-900 hover:underline">Rechazar</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-gray-500">No hay sugerencias pendientes en este momento.</p>
    {% endif %}
</div>

<script>
function handleSuggestionAction(eventId, action) {
    const url = `/api/admin/sugerencias/${eventId}/${action}`;
    const row = document.getElementById(`suggestion-row-${eventId}`);

    if (!confirm(`¿Estás seguro de que quieres ${action} esta sugerencia?`)) {
        return;
    }

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            // Asumimos que el CSRF token se maneja globalmente si es necesario, o se añade aquí
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.message || `Error al ${action} la sugerencia.`); });
        }
        return response.json();
    })
    .then(data => {
        alert(data.message || `Sugerencia ${action}da correctamente.`);
        if (row) {
            row.remove(); // Eliminar la fila de la tabla
        }
        // Opcional: Recargar la página o actualizar la lista de otra forma
        // location.reload();
    })
    .catch(error => {
        console.error(`Error al ${action} la sugerencia:`, error);
        alert(error.message || `Error al ${action} la sugerencia. Inténtalo de nuevo.`);
    });
}
</script>
{% endblock %}

{% block additional_scripts %}
{{ super() }}
<!-- Aquí puedes añadir scripts adicionales específicos para esta página si es necesario -->
{% endblock %}
