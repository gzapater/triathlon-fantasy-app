<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Triatlón - {{ race.title if race else 'Detalle de Carrera' }}</title> <!-- Dynamic Title -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --orange-primary: #FF6B35;
            --orange-light: #FF8F65;
            --orange-dark: #FF4500;
            --orange-pale: #FFB380;
            --gray-dark: #2C3E50;
            --gray-medium: #34495E;
            --gray-light: #7F8C8D;
            --blue-water: #3498DB;
            --green-run: #27AE60;
            --red-accent: #E74C3C;
        }

        * {
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }

        .hero-bg {
            background: linear-gradient(135deg, var(--orange-dark) 0%, var(--orange-primary) 50%, var(--orange-light) 100%);
            position: relative;
            overflow: hidden;
        }

        /* .hero-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><defs><pattern id="triPattern" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="25" r="2" fill="rgba(255,255,255,0.1)"/><path d="M25,75 L75,75 L50,25 Z" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23triPattern)"/></svg>') repeat;
            opacity: 0.3;
        } */

        .segment-card {
            /* transition: all 0.3s ease; */
            border-left: 4px solid var(--orange-primary);
        }

        .segment-card:hover {
            /* transform: translateY(-2px); */
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.15);
        }

        .swim-segment { border-left-color: var(--blue-water); }
        .bike-segment { border-left-color: var(--gray-dark); }
        .run-segment { border-left-color: var(--green-run); }
        .transition-segment { border-left-color: var(--orange-primary); } /* Orange for transitions */

        .question-card {
            border: 1px solid #e5e7eb; /* Tailwind gray-200 */
            border-radius: 12px;      /* Slightly larger radius */
            /* transition: all 0.3s ease; */
            background-color: white; /* Ensure questions have white background */
        }

        .question-card:hover {
            /* border-color: var(--orange-primary); */
            /* box-shadow: 0 4px 12px rgba(255, 107, 53, 0.1); */
        }

        .btn { /* Base button style */
            padding: 0.625rem 1.25rem; /* py-2.5 px-5 */
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            /* transition: all 0.3s ease; */
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--orange-primary) 0%, var(--orange-dark) 100%);
            border: none;
            color: white;
        }

        .btn-primary:hover {
            /* transform: translateY(-1px); */
            /* box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3); */
        }

        .btn-secondary {
            background-color: #E5E7EB; /* Tailwind gray-200 */
            color: var(--gray-dark);
            border: 1px solid #D1D5DB; /* Tailwind gray-300 */
        }
        .btn-secondary:hover {
            /* background-color: #D1D5DB; */
        }


        .timeline-line {
            position: relative;
        }

        /* Adjusted timeline for better responsiveness and alignment */
        /* .timeline-line::before {
            content: '';
            position: absolute;
            left: calc(1.5rem + 1px);
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, var(--blue-water), var(--gray-dark), var(--green-run));
            transform: translateX(-50%);
            z-index: -1;
        } */

        .drag-item {
            cursor: move;
            /* transition: all 0.3s ease; */
        }

        .drag-item:hover {
            background-color: #f8f9fa;
        }

        .drag-item.dragging {
            /* opacity: 0.5; */
            /* transform: rotate(5deg); */
        }

        .stats-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            /* transition: all 0.3s ease; */
        }

        .stats-card:hover {
            /* box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12); */
        }

        @media (max-width: 768px) {
            /* In mobile, make timeline vertical and align to left of segment cards */
            /* .timeline-line::before {
                left: calc(1.5rem);
            } */
            .segment-card { /* Remove margin for mobile timeline */
                margin-left: 0 !important;
            }
        }


        .expandable-content {
            max-height: 0;
            overflow: hidden;
            /* transition: max-height 0.5s ease-out; */ /* Smoother transition */
        }

        .expandable-content.expanded {
            max-height: 2000px; /* Large enough for content */
        }

        .badge-role { /* Copied from index.html for consistency */
            color: white;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
        }
        .badge-admin { background: linear-gradient(135deg, var(--red-accent) 0%, #F1948A 100%); }
        .badge-league { background: linear-gradient(135deg, var(--orange-primary) 0%, var(--orange-light) 100%); }
        .badge-player { background: linear-gradient(135deg, var(--blue-water) 0%, #5DADE2 100%); }


        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            stroke-dasharray: 251.2 251.2; /* Circumference of circle with r=40 */
            stroke-dashoffset: 251.2;
            transition: stroke-dashoffset 0.3s ease;
        }
        /* Ensure Font Awesome icons align well with text */
        .fas, .fab {
            vertical-align: -0.125em; /* default is -0.125em, adjust if needed */
        }
    </style>
</head>
<body class="text-gray-700">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <a href="{{ url_for('serve_hello_world_page') }}" class="flex items-center space-x-2">
                        <!-- LOGO_PLACEHOLDER: Replace this with your <img src='your_logo_url_here' alt='TriFantasy Logo' class='h-8 w-auto'> tag -->
                        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-orange-500 to-orange-600 flex items-center justify-center">
                            <i class="fas fa-trophy text-white text-lg"></i> <!-- Changed icon to trophy -->
                        </div>
                        <span class="text-xl font-bold text-gray-800">Fantasy Tri</span>
                    </a>
                </div>
                <div class="hidden md:flex items-center space-x-6">
                    <a href="{{ url_for('serve_hello_world_page') }}" class="text-gray-600 hover:text-orange-500 transition-colors">Dashboard</a>
                    <a href="{{ url_for('serve_hello_world_page') }}" class="text-orange-500 font-medium">Carreras</a>
                    <a href="#" class="text-gray-600 hover:text-orange-500 transition-colors">Ligas (Próx.)</a>
                    <a href="#" class="text-gray-600 hover:text-orange-500 transition-colors">Perfil (Próx.)</a>
                </div>
                <div class="flex items-center space-x-3">
                    {% if current_user and current_user.is_authenticated %}
                        {% set badge_class = 'badge-player' %} {# Default #}
                        {% if current_user.role and current_user.role.code == 'ADMIN' %}
                            {% set badge_class = 'badge-admin' %}
                        {% elif current_user.role and current_user.role.code == 'LEAGUE_ADMIN' %}
                            {% set badge_class = 'badge-league' %}
                        {% endif %}
                        <span class="badge-role {{ badge_class }} hidden sm:inline">{{ current_user.role.description if current_user.role else 'Rol no definido' }}</span>
                        <span class="text-sm text-gray-700 hidden sm:inline">{{ current_user.username }}</span>
                         <button id="logoutButtonNav" class="text-gray-600 hover:text-orange-500 transition-colors">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    {% else %}
                        <a href="{{ url_for('serve_login_page') }}" class="text-gray-600 hover:text-orange-500 transition-colors">Login</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero-bg text-white py-12 md:py-16 lg:py-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col lg:flex-row items-center justify-between">
                <div class="flex-1 text-center lg:text-left mb-6 lg:mb-0">
                    <div class="flex flex-wrap justify-center lg:justify-start gap-2 mb-3">
                        <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-xs sm:text-sm">{{ race.race_format.name | default('Formato no especificado') }}</span>
                        <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-xs sm:text-sm">{{ race.gender_category | default('N/A') }}</span>
                        <!-- Example status badge - make dynamic later if needed -->
                        <span class="bg-green-500 px-3 py-1 rounded-full text-xs sm:text-sm">Activa</span>
                    </div>
                    <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold mb-3">{{ race.title | default('Título de la Carrera no Disponible') }}</h1>
                    <p class="text-lg sm:text-xl mb-5 opacity-90">{{ race.description | truncate(150) if race.description else 'Descripción no disponible.' }}</p>
                    <div class="flex flex-wrap justify-center lg:justify-start gap-x-4 gap-y-2 text-sm mb-6">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-calendar"></i>
                            <span>{{ race.event_date.strftime('%d %B, %Y %H:%M') if race.event_date else 'Fecha no especificada' }}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>{{ race.location if race.location else 'Ubicación no especificada' }}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-user-tie"></i>
                            <span>Organizado por: <span class="font-semibold">{{ race.user.username if race.user else 'N/A' }}</span></span>
                        </div>
                    </div>
                    <div class="flex flex-wrap justify-center lg:justify-start gap-3">
                        <button class="btn btn-primary px-5 py-2.5 sm:px-6 sm:py-3">
                            <i class="fas fa-play mr-2"></i>Participar (Próx.)
                        </button>
                        <button class="bg-white bg-opacity-20 px-5 py-2.5 sm:px-6 sm:py-3 rounded-lg font-semibold hover:bg-opacity-30 transition-colors">
                            <i class="fas fa-heart mr-2"></i>Favorito (Próx.)
                        </button>
                        {% if currentUserRole == 'ADMIN' or currentUserRole == 'LEAGUE_ADMIN' %}
                        <button id="openEditRaceModalBtn" class="btn btn-secondary px-5 py-2.5 sm:px-6 sm:py-3">
                            <i class="fas fa-edit mr-2"></i>Editar Detalles Carrera
                        </button>
                        <button id="deleteRaceBtn" class="btn bg-red-600 hover:bg-red-700 text-white px-5 py-2.5 sm:px-6 sm:py-3">
                            <i class="fas fa-trash-alt mr-2"></i>Eliminar Carrera
                        </button>
                        <button id="shareRaceBtn" class="btn bg-blue-500 hover:bg-blue-600 text-white px-5 py-2.5 sm:px-6 sm:py-3">
                            <i class="fas fa-share-alt mr-2"></i>Compartir Carrera
                        </button>
                        {% endif %}
                        <button id="answerQuestionsBtn" class="btn btn-primary bg-green-500 hover:bg-green-600 px-5 py-2.5 sm:px-6 sm:py-3" style="display: none;">
                            <i class="fas fa-tasks mr-2"></i>Responder Preguntas
                        </button>
                    </div>
                </div>
                {% if race.promo_image_url %}
                <div class="flex-shrink-0 lg:ml-12 mt-6 lg:mt-0">
                    <img src="{{ race.promo_image_url }}" alt="Imagen de {{ race.title }}" class="rounded-lg shadow-xl w-full max-w-md lg:max-w-sm object-cover h-64 lg:h-auto">
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Race Full Description (if different from hero) -->
                {% if race.description and race.description|length > 150 %}
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Descripción Detallada</h2>
                    <p class="text-gray-600 leading-relaxed whitespace-pre-line">{{ race.description }}</p>
                </div>
                {% endif %}

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="font-bold text-gray-800 mb-4">Estadísticas de la Carrera</h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 flex items-center"><i class="fas fa-users mr-2"></i>Participantes:</span>
                                <span id="statParticipantsCount" class="font-semibold text-gray-800">Cargando...</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 flex items-center"><i class="fas fa-pencil-alt mr-2"></i>Predicciones:</span>
                                <span id="statPredictionsCount" class="font-semibold text-gray-800">Cargando...</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 flex items-center"><i class="fas fa-clock mr-2"></i>Tiempo Restante Quiniela:</span>
                                <span id="statTimeRemaining" class="font-semibold text-orange-600">Cargando...</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="font-bold text-gray-800 mb-4">Enlaces Rápidos (Próx.)</h3>
                        <div class="space-y-2">
                            <a href="#" class="flex items-center space-x-2 text-sm text-gray-600 hover:text-orange-500"><i class="fas fa-info-circle w-4"></i><span>Reglamento</span></a>
                            <a href="#" class="flex items-center space-x-2 text-sm text-gray-600 hover:text-orange-500"><i class="fas fa-map w-4"></i><span>Mapa</span></a>
                        </div>
                    </div>
                </div>

                <!-- Prediction Questions / Quiniela -->
                <div id="predictionQuestionsSection" class="bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Quiniela de la carrera</h2>
                        {% if currentUserRole == 'ADMIN' or currentUserRole == 'LEAGUE_ADMIN' %}
                        <div class="flex space-x-2"> {# Wrapper for admin buttons #}
                            <button id="addNewQuestionBtn" class="btn btn-primary text-sm px-4 py-2">
                                <i class="fas fa-plus mr-2"></i>Añadir Pregunta
                            </button>
                            <button data-race-id="{{ race.id }}" data-race-title="{{ race.title | e }}" onclick="openOfficialAnswersModal(this)" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors text-sm">
                                Gestionar Quiniela
                            </button>
                        </div>
                        {% endif %}
                    </div>

                    {% if not has_user_answered_pool %}
                        <p class="text-gray-600 mb-4">Participa en la quiniela de esta carrera y pon a prueba tus conocimientos.</p>
                        <button id="participateInPoolBtn" class="btn btn-primary w-full md:w-auto">
                            <i class="fas fa-tasks mr-2"></i>Participar
                        </button>
                        <!-- The original question display elements (questionsLoading, questionsError, etc.) are removed here -->
                        <!-- If you need to load questions for admins to manage even if user hasn't answered, that logic needs to be separate -->
                    {% else %}
                        <p class="text-gray-700 text-lg mb-3"><i class="fas fa-check-circle text-green-500 mr-2"></i>Ya has participado en esta Quiniela.</p>
                        <button id="reviewUserAnswersBtn" class="btn btn-secondary">
                            <i class="fas fa-eye mr-2"></i>Revisar respuestas
                        </button>
                    {% endif %}

                    {% if currentUserRole == 'LEAGUE_ADMIN' %}
                    <div id="adminQuestionsViewContainer" class="mt-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Todas las Preguntas de la Quiniela</h3>
                        <!-- Questions will be rendered here by JavaScript -->
                        <div id="adminQuestionsList" class="space-y-2">
                            <!-- JS will populate this -->
                        </div>
                    </div>
                    {% endif %}
                </div>

            </div>

            <!-- Sidebar -->
            <aside class="space-y-6 lg:sticky lg:top-24 self-start"> <!-- Added self-start for sticky behavior -->
                <!-- Race Participants Section (Moved Here) -->
                {% if currentUserRole == 'ADMIN' or currentUserRole == 'LEAGUE_ADMIN' %}
                <div id="raceParticipantsSection" class="bg-white rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Participantes de la Carrera</h2>
                    <div id="raceParticipantsListContainer">
                        <div id="loadingParticipantsMessage" style="display: none;">
                            <p class="text-gray-600">Cargando participantes...</p>
                        </div>
                        <div id="errorLoadingParticipantsMessage" style="display: none;">
                            <p class="text-red-500">Error al cargar los participantes.</p>
                        </div>
                        <!-- Participant list will be populated here by JavaScript -->
                    </div>
                </div>
                {% endif %}

                <!-- Race Segments (Moved Here) -->
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Segmentos de la Carrera</h2>
                    {% if race.segment_details and race.segment_details|length > 0 %}
                    <div class="space-y-6 relative"> {# <--- Removed timeline-line class #}
                        {% for detail in race.segment_details %}
                            {% if detail.segment %}
                                {% set segment_name = detail.segment.name %}
                                {% set segment_name_lower = segment_name.lower() %}
                                {% set border_color_class = 'transition-segment' %}
                                {% set icon_bg_color = 'bg-orange-500' %}
                                {% set text_color = 'text-orange-500' %}
                                {% set segment_icon = 'fa-exchange-alt' %}

                                {% if 'natación' in segment_name_lower or 'swim' in segment_name_lower %}
                                    {% set border_color_class = 'swim-segment' %}
                                    {% set icon_bg_color = 'bg-blue-500' %}
                                    {% set text_color = 'text-blue-500' %}
                                    {% set segment_icon = 'fa-swimmer' %}
                                {% elif 'ciclismo' in segment_name_lower or 'bike' in segment_name_lower %}
                                    {% set border_color_class = 'bike-segment' %}
                                    {% set icon_bg_color = 'bg-gray-700' %}
                                    {% set text_color = 'text-gray-700' %}
                                    {% set segment_icon = 'fa-biking' %}
                                {% elif 'carrera' in segment_name_lower or 'running' in segment_name_lower or 'run' in segment_name_lower %}
                                    {% set border_color_class = 'run-segment' %}
                                    {% set icon_bg_color = 'bg-green-500' %}
                                    {% set text_color = 'text-green-500' %}
                                    {% set segment_icon = 'fa-running' %}
                                {% endif %}

                            <!-- Segment Card -->
                            <div class="segment-card {{ border_color_class }} bg-white p-4 rounded-lg shadow-md relative pl-12"> {# <--- Adjusted classes: removed md:ml-6, changed pl-16 md:pl-4 to pl-12 #}
                                <div class="absolute left-0 top-1/2 transform -translate-y-1/2 -translate-x-1/2 w-12 h-12 {{ icon_bg_color }} rounded-full flex items-center justify-center border-4 border-white"> {# <--- Removed md:-translate-x-1/2 #}
                                    <i class="fas {{ segment_icon }} text-white text-lg"></i>
                                </div>
                                <div class="flex items-center space-x-4 ml-8"> {# <--- Changed ml-8 md:ml-10 to ml-8 #}
                                    <div class="flex-1">
                                        <h3 class="font-bold text-gray-800">{{ segment_name }}</h3>
                                        <p class="text-gray-600 text-sm">{{ detail.distance_km }} km</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold {{ text_color }}">{{ detail.distance_km }} KM</div>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                                <div class="segment-card bg-white p-4 rounded-lg shadow-md relative pl-12"> {# <--- Adjusted classes similarly for error card #}
                                    <p class="text-red-500">Error: Datos del segmento incompletos.</p>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-gray-500">No hay detalles de segmentos para esta carrera.</p>
                    {% endif %}
                </div>
            </aside>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p>&copy; {{ current_year }} Fantasy Tri. Todos los derechos reservados.</p>
        </div>
    </footer>

    <!-- Share Race Modal -->
    <div id="shareRaceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 110;">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">Compartir Enlace de Carrera</h2>
                <button id="closeShareRaceModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div class="mb-4">
                <label for="shareableLinkInput" class="block text-sm font-medium text-gray-700 mb-1">Enlace Compartible:</label>
                <input type="text" id="shareableLinkInput" readonly class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-gray-100 rounded-md shadow-sm sm:text-sm">
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" id="copyShareLinkBtn" class="btn btn-primary">Copiar Enlace</button>
            </div>
            <p id="copyShareLinkFeedback" class="text-sm text-green-600 mt-2" style="display:none;">¡Enlace copiado!</p>
        </div>
    </div>

    <!-- Edit Race Details Modal -->
    {% if currentUserRole == 'ADMIN' or currentUserRole == 'LEAGUE_ADMIN' %}
    <div id="editRaceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 100;">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Editar Detalles de la Carrera</h2>
                <button id="closeEditRaceModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <form id="editRaceForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="raceTitle" class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                        <input type="text" id="raceTitle" name="title" value="{{ race.title | default('') }}" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="raceLocation" class="block text-sm font-medium text-gray-700 mb-1">Ubicación</label>
                        <input type="text" id="raceLocation" name="location" value="{{ race.location | default('') }}" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                    </div>
                </div>
                <div class="mb-6"> <!-- New field for Category -->
                    <label for="raceCategory" class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                    <input type="text" id="raceCategory" name="category" value="{{ race.category | default('Elite') }}" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm" placeholder="Ej: Elite, Sub-23, General">
                </div>
                <div class="mb-6">
                    <label for="raceDescription" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                    <textarea id="raceDescription" name="description" rows="4" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">{{ race.description | default('') }}</textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="raceEventDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha y Hora del Evento</label>
                        <input type="datetime-local" id="raceEventDate" name="event_date" value="{{ race.event_date.strftime('%Y-%m-%dT%H:%M') if race.event_date else '' }}" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="raceGenderCategory" class="block text-sm font-medium text-gray-700 mb-1">Categoría de Género</label>
                        <select id="raceGenderCategory" name="gender_category" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                            <option value="MIXED" {% if race.gender_category == 'MIXED' %}selected{% endif %}>Mixta</option>
                            <option value="MALE_ONLY" {% if race.gender_category == 'MALE_ONLY' %}selected{% endif %}>Solo Hombres</option>
                            <option value="FEMALE_ONLY" {% if race.gender_category == 'FEMALE_ONLY' %}selected{% endif %}>Solo Mujeres</option>
                            <option value="OTHER" {% if race.gender_category == 'OTHER' %}selected{% endif %}>Otra</option>
                        </select>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="racePromoImageUrl" class="block text-sm font-medium text-gray-700 mb-1">URL Imagen Promocional</label>
                    <input type="url" id="racePromoImageUrl" name="promo_image_url" value="{{ race.promo_image_url | default('') }}" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm" placeholder="https://ejemplo.com/imagen.jpg">
                </div>
                </div>
                <div class="mb-6">
                    <label for="editRaceQuinielaCloseDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha Cierre Quiniela</label>
                    <input type="datetime-local" id="editRaceQuinielaCloseDate" name="quiniela_close_date" value="{{ race.quiniela_close_date.strftime('%Y-%m-%dT%H:%M') if race.quiniela_close_date else '' }}" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelEditRaceBtn" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" id="saveRaceChangesBtn" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <script>
        const raceId = "{{ race.id | default('') }}";
        const raceEventDateString = "{{ race.event_date.isoformat() if race.event_date else '' }}";
        const raceTitle = {{ race.title | tojson }};
        const currentUserRole = "{{ current_user.role.code if current_user and current_user.is_authenticated and current_user.role else 'GUEST' }}";
        const isUserRegisteredForRace = {{ is_user_registered_for_race | tojson }};
        const hasUserAnsweredPool = {{ has_user_answered_pool | tojson }}; // Added this line
        let allRaceQuestions = [];
        let isFetchingQuestions = false;
        let raceStatsCountdownInterval = null; // Variable to hold the interval ID

        function startCountdown(targetDateISO, displayElement) {
            if (raceStatsCountdownInterval) {
                clearInterval(raceStatsCountdownInterval); // Clear any existing interval
            }

            const targetDate = new Date(targetDateISO);

            function updateCountdown() {
                const now = new Date();
                const difference = targetDate - now;

                if (difference <= 0) {
                    displayElement.textContent = 'Quiniela Cerrada';
                    clearInterval(raceStatsCountdownInterval);
                    return;
                }

                const days = Math.floor(difference / (1000 * 60 * 60 * 24));
                const hours = Math.floor((difference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((difference % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((difference % (1000 * 60)) / 1000);

                let parts = [];
                if (days > 0) parts.push(days + (days === 1 ? ' día' : ' días'));
                if (hours > 0) parts.push(hours + (hours === 1 ? ' hr' : ' hrs'));
                if (minutes > 0) parts.push(minutes + (minutes === 1 ? ' min' : ' mins'));
                if (days === 0 && hours === 0 && minutes < 30) { // Show seconds only if less than 30 mins remaining and no days/hours
                     if (seconds > 0 || parts.length === 0) parts.push(seconds + (seconds === 1 ? ' seg' : ' segs'));
                }

                if (parts.length === 0 && difference > 0) { // If difference is small (e.g. few seconds)
                    displayElement.textContent = 'Cerrando pronto...';
                } else if (parts.length > 0) {
                    displayElement.textContent = parts.join(', ');
                } else { // Should be caught by difference <=0, but as a fallback
                    displayElement.textContent = 'Calculando...';
                }
            }

            updateCountdown(); // Initial call
            raceStatsCountdownInterval = setInterval(updateCountdown, 1000); // Update every second
        }

        function fetchAndDisplayRaceStats(raceIdForStats) {
            if (!raceIdForStats) return;

            const participantsSpan = document.getElementById('statParticipantsCount');
            const predictionsSpan = document.getElementById('statPredictionsCount');
            const timeRemainingSpan = document.getElementById('statTimeRemaining');

            if (!participantsSpan || !predictionsSpan || !timeRemainingSpan) {
                console.error("Statistic display elements not found.");
                return;
            }

            fetch(`/api/races/${raceIdForStats}/statistics`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(stats => {
                    participantsSpan.textContent = stats.participant_count !== undefined ? stats.participant_count : 'N/A';
                    predictionsSpan.textContent = stats.predictions_count !== undefined ? stats.predictions_count : 'N/A';

                    if (stats.quiniela_close_date) {
                        startCountdown(stats.quiniela_close_date, timeRemainingSpan);
                    } else {
                        timeRemainingSpan.textContent = 'No definida';
                    }
                })
                .catch(error => {
                    console.error('Error fetching race statistics:', error);
                    participantsSpan.textContent = 'Error';
                    predictionsSpan.textContent = 'Error';
                    timeRemainingSpan.textContent = 'Error';
                });
        }

        // Function to render questions for LEAGUE_ADMIN
        function renderAdminQuestionsView(questions) {
            const adminQuestionsListDiv = document.getElementById('adminQuestionsList');
            if (!adminQuestionsListDiv) {
                console.log("Admin questions list div not found");
                return;
            }

            adminQuestionsListDiv.innerHTML = ''; // Clear previous content

            if (!questions || questions.length === 0) {
                adminQuestionsListDiv.innerHTML = '<p class="text-gray-500">No hay preguntas definidas para esta carrera.</p>';
                return;
            }

        questions.forEach(q => {
            const questionCard = document.createElement('div');
            questionCard.className = 'bg-white shadow-md rounded-lg p-4 mb-4'; // Main card styling

            // Question Text
            const questionTextElem = document.createElement('p');
            questionTextElem.className = 'font-semibold text-gray-800 mb-2'; // Adjusted margin
            questionTextElem.textContent = q.text;
            questionCard.appendChild(questionTextElem);

            // Scoring Info (using existing function)
            const scoringInfoElem = document.createElement('div');
            scoringInfoElem.className = 'mb-3'; // Add some margin below scoring info
            scoringInfoElem.innerHTML = formatScoringInfoForDisplay(q); // Existing function
            questionCard.appendChild(scoringInfoElem);

            // Options
            if (q.options && q.options.length > 0) {
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'mt-2'; // Margin for options section

                const optionsHeading = document.createElement('h5');
                optionsHeading.className = 'text-sm font-medium text-gray-700 mb-1';
                optionsHeading.textContent = 'Opciones:';
                optionsContainer.appendChild(optionsHeading);

                const optionsList = document.createElement('ul');
                optionsList.className = 'list-disc pl-5 space-y-1'; // Tailwind for basic list

                q.options.forEach(opt => {
                    const optionItem = document.createElement('li');
                    optionItem.className = 'text-gray-600 text-sm'; // Styling for option text
                    optionItem.textContent = opt.option_text;
                    optionsList.appendChild(optionItem);
                });
                optionsContainer.appendChild(optionsList);
                questionCard.appendChild(optionsContainer);
            }
            adminQuestionsListDiv.appendChild(questionCard);
            });
        }

        // Global Helper Functions
        // function toggleQuestions() { // Commenting out as it's no longer used directly by a button
        //     const questionsContentElem = document.getElementById('questionsContent');
        //     const expandIconElem = document.getElementById('expandIcon');
        //     const toggleQuestionsBtnElem = document.getElementById('toggleQuestionsBtn');

        //     if (questionsContentElem.classList.contains('expanded')) {
        //         questionsContentElem.classList.remove('expanded');
        //         if(expandIconElem) expandIconElem.classList.replace('fa-chevron-up', 'fa-chevron-down');
        //         if(toggleQuestionsBtnElem) toggleQuestionsBtnElem.innerHTML = '<i id="expandIcon" class="fas fa-chevron-down mr-1"></i>Ver Preguntas';
        //     } else {
        //         questionsContentElem.classList.add('expanded');
        //         if(expandIconElem) expandIconElem.classList.replace('fa-chevron-down', 'fa-chevron-up');
        //         if(toggleQuestionsBtnElem) toggleQuestionsBtnElem.innerHTML = '<i id="expandIcon" class="fas fa-chevron-up mr-1"></i>Ocultar Preguntas';
        //     }
        // }

        function formatScoringInfoForDisplay(question) {
            let scoringText = '';
            switch (question.question_type) {
                case 'FREE_TEXT':
                    scoringText = `Máx. ${question.max_score_free_text || 'N/A'} pts.`;
                    break;
                case 'MULTIPLE_CHOICE':
                    if (question.is_mc_multiple_correct) {
                        scoringText = `Selección Múltiple. ${question.points_per_correct_mc || 'N/A'} pts/correcta, ${question.points_per_incorrect_mc || '0'} pts/incorrecta.`;
                    } else {
                        scoringText = `Selección Única. ${question.total_score_mc_single || 'N/A'} pts total.`;
                    }
                    break;
                case 'ORDERING':
                    scoringText = `Ordenamiento. ${question.points_per_correct_order || 'N/A'} pts/item, ${question.bonus_for_full_order || '0'} pts bonus.`;
                    break;
                default:
                    scoringText = 'Puntuación no especificada.';
            }
            return `<span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">${scoringText}</span>`;
        }

        function renderQuestions(questions) {
            const questionsLoadingDivElem = document.getElementById('questionsLoading');
            const questionsContentElem = document.getElementById('questionsContent');
            const noQuestionsMessageDivElem = document.getElementById('noQuestionsMessage');
            const currentToggleQuestionsBtnElem = document.getElementById('toggleQuestionsBtn');
            const currentSubmitPredictionsContainerElem = document.getElementById('submitPredictionsContainer');

            if(questionsLoadingDivElem) questionsLoadingDivElem.style.display = 'none';
            if(questionsContentElem) questionsContentElem.innerHTML = '';

            allRaceQuestions = questions;

            if (!questions || questions.length === 0) {
                if(noQuestionsMessageDivElem) noQuestionsMessageDivElem.style.display = 'block';
                if(currentToggleQuestionsBtnElem) {
                    currentToggleQuestionsBtnElem.innerHTML = '<i id="expandIcon" class="fas fa-info-circle mr-1"></i>No hay preguntas';
                }
                if(questionsContentElem) questionsContentElem.classList.remove('expanded');
                if(currentSubmitPredictionsContainerElem) currentSubmitPredictionsContainerElem.classList.add('hidden');
                return;
            }

            if(noQuestionsMessageDivElem) noQuestionsMessageDivElem.style.display = 'none';

            questions.forEach(q => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card p-5';
                let optionsHtml = '';
                if (q.question_type === 'MULTIPLE_CHOICE') {
                    optionsHtml += '<div class="space-y-2 mt-3">';
                    q.options.forEach(opt => {
                        const inputType = q.is_mc_multiple_correct ? 'checkbox' : 'radio';
                        optionsHtml += `
                            <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded-md border border-gray-200 hover:border-orange-300">
                                <input type="${inputType}" name="question_${q.id}" value="${opt.id}" class="text-orange-500 focus:ring-orange-400 focus:ring-offset-0">
                                <span class="text-gray-700">${opt.option_text}</span>
                            </label>
                        `;
                    });
                    optionsHtml += '</div>';
                } else if (q.question_type === 'FREE_TEXT') {
                    optionsHtml = `
                        <textarea class="w-full p-3 mt-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                  rows="3" placeholder="Escribe tu predicción..."></textarea>
                        <div class="flex justify-between items-center mt-1 text-xs text-gray-500">
                            <span>Texto libre</span>
                            <span>0/200 caracteres</span>
                        </div>
                    `;
                } else if (q.question_type === 'ORDERING') {
                     optionsHtml += '<div id="sortableList_' + q.id + '" class="space-y-2 mt-3">';
                     q.options.forEach(opt => {
                        optionsHtml += `
                            <div class="drag-item bg-gray-50 p-3 rounded-lg border-2 border-gray-200 cursor-move flex items-center justify-between">
                                <span class="text-gray-700">${opt.option_text}</span>
                                <i class="fas fa-grip-vertical text-gray-400"></i>
                            </div>
                        `;
                     });
                     optionsHtml += '</div>';
                }

                questionCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-semibold text-gray-800 flex-1 pr-2">${q.text} ${q.is_active ? '' : '<span class="text-red-500 text-xs font-normal">(Inactiva)</span>'}</h3>
                        ${formatScoringInfoForDisplay(q)}
                    </div>
                    ${optionsHtml}
                    <div class="flex justify-between items-center mt-4">
                        <div class="text-xs text-gray-500">${q.question_type.replace('_', ' ').toLowerCase()}</div>
                        {% if currentUserRole == 'ADMIN' or currentUserRole == 'LEAGUE_ADMIN' %}
                        <div class="space-x-2">
                            <button id="editQuestionBtn_${q.id}" class="text-blue-500 hover:text-blue-700 text-sm font-medium">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button id="deleteQuestionBtn_${q.id}" class="text-red-500 hover:text-red-700 text-sm font-medium">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                        {% endif %}
                    </div>
                `;
                if(questionsContentElem) questionsContentElem.appendChild(questionCard);

                if (currentUserRole === 'ADMIN' || currentUserRole === 'LEAGUE_ADMIN') {
                    const editBtn = document.getElementById(`editQuestionBtn_${q.id}`);
                    if (editBtn) {
                        editBtn.addEventListener('click', () => openEditQuestionModal(q.id));
                    }
                    const deleteBtn = document.getElementById(`deleteQuestionBtn_${q.id}`);
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', () => openDeleteConfirmModal(q.id));
                    }
                }
            });

            if(questionsContentElem) questionsContentElem.classList.add('expanded');
            if(currentToggleQuestionsBtnElem) {
                currentToggleQuestionsBtnElem.innerHTML = `<i id="expandIcon" class="fas fa-chevron-up mr-1"></i>Ocultar Preguntas (${questions.length})`;
            }
            if(currentSubmitPredictionsContainerElem) currentSubmitPredictionsContainerElem.classList.remove('hidden');
        }

        function fetchAndRenderQuestions() {
            const questionsLoadingDivElem = document.getElementById('questionsLoading');
            const questionsErrorDivElem = document.getElementById('questionsError');
            const noQuestionsMessageDivElem = document.getElementById('noQuestionsMessage');

            if(!raceId || !document.getElementById('predictionQuestionsSection')) return;

            if (isFetchingQuestions) return;
            isFetchingQuestions = true;

            if(questionsLoadingDivElem) questionsLoadingDivElem.style.display = 'block';
            if(questionsErrorDivElem) questionsErrorDivElem.style.display = 'none';
            if(noQuestionsMessageDivElem) noQuestionsMessageDivElem.style.display = 'none';

            fetch(`/api/races/${raceId}/questions`)
                .then(response => {
                    if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);
                    return response.json();
                })
                .then(questions => {
                    allRaceQuestions = questions;
                    renderQuestions(questions); // This is for the main question display (wizard/user participation)

                    // If the current user is LEAGUE_ADMIN, render the admin-specific view
                    if (currentUserRole === 'LEAGUE_ADMIN') {
                        const adminQuestionsListContainer = document.getElementById('adminQuestionsViewContainer');
                        if (adminQuestionsListContainer) { // Check if the container exists
                             renderAdminQuestionsView(allRaceQuestions);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching questions:', error);
                    if(questionsLoadingDivElem) questionsLoadingDivElem.style.display = 'none';
                    if(questionsErrorDivElem) {
                        questionsErrorDivElem.textContent = `Error al cargar preguntas: ${error.message}.`;
                        questionsErrorDivElem.style.display = 'block';
                    }
                })
                .finally(() => {
                    isFetchingQuestions = false;
                    // Check to display Answer Questions button after questions are fetched
                    const answerQuestionsBtn = document.getElementById('answerQuestionsBtn');
                    if (answerQuestionsBtn && isUserRegisteredForRace && allRaceQuestions && allRaceQuestions.length > 0) {
                        answerQuestionsBtn.style.display = 'inline-flex'; // Or 'block' or other appropriate display style
                    }
                });
        }

        function handleQuestionTypeChange() {
            const mcFieldsContainer = document.getElementById('multipleChoiceFieldsContainer');
            const oFieldsContainer = document.getElementById('orderingFieldsContainer');
            const ftFieldsContainer = document.getElementById('freeTextFieldsContainer');
            const qTypeSelect = document.getElementById('questionTypeSelect');

            if (!mcFieldsContainer || !oFieldsContainer || !ftFieldsContainer || !qTypeSelect) return;
            mcFieldsContainer.style.display = 'none';
            oFieldsContainer.style.display = 'none';
            ftFieldsContainer.style.display = 'none';

            const selectedType = qTypeSelect.value;
            if (selectedType === 'MULTIPLE_CHOICE') {
                mcFieldsContainer.style.display = 'block';
            } else if (selectedType === 'ORDERING') {
                oFieldsContainer.style.display = 'block';
            } else if (selectedType === 'FREE_TEXT') {
                ftFieldsContainer.style.display = 'block';
            }
        }

        function resetAddEditQuestionForm() {
            const form = document.getElementById('addEditQuestionForm');
            const editingIdInput = document.getElementById('editingQuestionId');
            const qTypeSelect = document.getElementById('questionTypeSelect');
            const mcOptContainer = document.getElementById('mcOptionsContainer');
            const oOptContainer = document.getElementById('orderingOptionsContainer');
            const ptsPerCorrectMc = document.getElementById('pointsPerCorrectMc');
            const ptsPerIncorrectMc = document.getElementById('pointsPerIncorrectMc');
            const totalScoreMc = document.getElementById('totalScoreMcSingle');
            const ptsPerCorrectOrd = document.getElementById('pointsPerCorrectOrder');
            const bonusFullOrd = document.getElementById('bonusForFullOrder');
            const maxScoreFt = document.getElementById('maxScoreFreeText');

            if(form) form.reset();
            if(editingIdInput) editingIdInput.value = '';
            if(qTypeSelect) qTypeSelect.disabled = false;
            if(mcOptContainer) mcOptContainer.innerHTML = '';
            if(oOptContainer) oOptContainer.innerHTML = '';
            if(ptsPerCorrectMc) ptsPerCorrectMc.value = '';
            if(ptsPerIncorrectMc) ptsPerIncorrectMc.value = '';
            if(totalScoreMc) totalScoreMc.value = '';
            if(ptsPerCorrectOrd) ptsPerCorrectOrd.value = '';
            if(bonusFullOrd) bonusFullOrd.value = '';
            if(maxScoreFt) maxScoreFt.value = '';
            if(qTypeSelect) handleQuestionTypeChange();
        }

        function createOptionInputDiv(optionText = "", optionId = null, isCorrect = false, questionType = "MULTIPLE_CHOICE") {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'flex items-center space-x-2 mb-2';
            const textInput = document.createElement('input');
            textInput.type = 'text';
            textInput.className = 'mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm sm:text-sm flex-grow';
            textInput.value = optionText;
            textInput.placeholder = (questionType === "ORDERING") ? "Texto del ítem" : "Texto de la opción";
            optionDiv.appendChild(textInput);
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'text-red-500 hover:text-red-700';
            removeBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
            removeBtn.onclick = () => optionDiv.remove();
            optionDiv.appendChild(removeBtn);
            return optionDiv;
        }

        function openAddQuestionModal() {
            const modal = document.getElementById('addEditQuestionModal');
            const title = document.getElementById('addEditQuestionModalTitle');
            const editingIdInput = document.getElementById('editingQuestionId');
            const form = document.getElementById('addEditQuestionForm');
            const mcOptContainer = document.getElementById('mcOptionsContainer');
            const oOptContainer = document.getElementById('orderingOptionsContainer');
            const qTypeSelect = document.getElementById('questionTypeSelect');

            if (!modal) return;
            if(editingIdInput) editingIdInput.value = '';
            if(title) title.textContent = 'Añadir Nueva Pregunta';
            if(form) form.reset();
            if(mcOptContainer) mcOptContainer.innerHTML = '';
            if(oOptContainer) oOptContainer.innerHTML = '';
            if(qTypeSelect) handleQuestionTypeChange();
            const currentSelectedType = qTypeSelect ? qTypeSelect.value : null;
            if (currentSelectedType === 'MULTIPLE_CHOICE' && mcOptContainer) {
                mcOptContainer.appendChild(createOptionInputDiv("", null, false, "MULTIPLE_CHOICE"));
                mcOptContainer.appendChild(createOptionInputDiv("", null, false, "MULTIPLE_CHOICE"));
            } else if (currentSelectedType === 'ORDERING' && oOptContainer) {
                oOptContainer.appendChild(createOptionInputDiv("", null, false, "ORDERING"));
                oOptContainer.appendChild(createOptionInputDiv("", null, false, "ORDERING"));
            }
            modal.style.display = 'flex';
        }

        function openEditQuestionModal(questionId) {
            const modal = document.getElementById('addEditQuestionModal');
            const title = document.getElementById('addEditQuestionModalTitle');
            const editingIdInput = document.getElementById('editingQuestionId');
            const qTextInput = document.getElementById('questionText');
            const qTypeSelect = document.getElementById('questionTypeSelect');
            const maxScoreFtInput = document.getElementById('maxScoreFreeText');
            const isMcMultiCorrectCb = document.getElementById('isMcMultipleCorrect');
            const ptsPerCorrectMc = document.getElementById('pointsPerCorrectMc');
            const ptsPerIncorrectMc = document.getElementById('pointsPerIncorrectMc');
            const totalScoreMcSingle = document.getElementById('totalScoreMcSingle');
            const mcOptContainer = document.getElementById('mcOptionsContainer');
            const ptsPerCorrectOrd = document.getElementById('pointsPerCorrectOrder');
            const bonusForFullOrd = document.getElementById('bonusForFullOrder');
            const oOptContainer = document.getElementById('orderingOptionsContainer');

            if (!modal || !allRaceQuestions) return;
            const question = allRaceQuestions.find(q => q.id === questionId);
            if (!question) {
                alert('Error: No se encontró la pregunta para editar.');
                return;
            }
            resetAddEditQuestionForm();
            if(title) title.textContent = 'Editar Pregunta';
            if(editingIdInput) editingIdInput.value = question.id;
            if(qTextInput) qTextInput.value = question.text;
            if(qTypeSelect) {
                qTypeSelect.value = question.question_type;
                qTypeSelect.disabled = true;
            }
            handleQuestionTypeChange();
            if (question.question_type === 'FREE_TEXT') {
                if(maxScoreFtInput) maxScoreFtInput.value = question.max_score_free_text !== null ? question.max_score_free_text : '';
            } else if (question.question_type === 'MULTIPLE_CHOICE') {
                if(isMcMultiCorrectCb) isMcMultiCorrectCb.checked = question.is_mc_multiple_correct;
                if(ptsPerCorrectMc) ptsPerCorrectMc.value = question.points_per_correct_mc !== null ? question.points_per_correct_mc : '';
                if(ptsPerIncorrectMc) ptsPerIncorrectMc.value = question.points_per_incorrect_mc !== null ? question.points_per_incorrect_mc : '';
                if(totalScoreMcSingle) totalScoreMcSingle.value = question.total_score_mc_single !== null ? question.total_score_mc_single : '';
                if(mcOptContainer) {
                    mcOptContainer.innerHTML = '';
                    question.options.forEach(opt => {
                        mcOptContainer.appendChild(createOptionInputDiv(opt.option_text, opt.id, false, "MULTIPLE_CHOICE"));
                    });
                }
            } else if (question.question_type === 'ORDERING') {
                if(ptsPerCorrectOrd) ptsPerCorrectOrd.value = question.points_per_correct_order !== null ? question.points_per_correct_order : '';
                if(bonusForFullOrd) bonusForFullOrd.value = question.bonus_for_full_order !== null ? question.bonus_for_full_order : '';
                if(oOptContainer) {
                    oOptContainer.innerHTML = '';
                    question.options.forEach(opt => {
                        oOptContainer.appendChild(createOptionInputDiv(opt.option_text, opt.id, false, "ORDERING"));
                    });
                }
            }
            modal.style.display = 'flex';
        }

        function closeAddEditQuestionModal() {
            const modal = document.getElementById('addEditQuestionModal');
            const qTypeSelect = document.getElementById('questionTypeSelect');
            if (!modal) return;
            modal.style.display = 'none';
            if(qTypeSelect) qTypeSelect.disabled = false;
        }

        function openDeleteConfirmModal(questionId) {
            const modal = document.getElementById('deleteQuestionConfirmModal');
            const input = document.getElementById('questionIdToDelete');
            if(!modal) return;
            if(input) input.value = questionId;
            modal.style.display = 'flex';
        }

        function closeDeleteConfirmModal() {
            const modal = document.getElementById('deleteQuestionConfirmModal');
            if(!modal) return;
            modal.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function() {
            // DOM Element Declarations
            const logoutButtonNav = document.getElementById('logoutButtonNav');
            // const questionsContent = document.getElementById('questionsContent'); // Commented out
            // const expandIcon = document.getElementById('expandIcon'); // Commented out
            // const toggleQuestionsBtn = document.getElementById('toggleQuestionsBtn'); // Commented out
            // const submitPredictionsContainer = document.getElementById('submitPredictionsContainer'); // Commented out
            // const questionsLoadingDiv = document.getElementById('questionsLoading'); // Commented out
            // const questionsErrorDiv = document.getElementById('questionsError'); // Commented out
            // const noQuestionsMessageDiv = document.getElementById('noQuestionsMessage'); // Commented out

            const addEditQuestionModal = document.getElementById('addEditQuestionModal');
            const addNewQuestionBtn = document.getElementById('addNewQuestionBtn');
            const closeAddEditQuestionModalBtn = document.getElementById('closeAddEditQuestionModalBtn');
            const cancelAddEditQuestionBtn = document.getElementById('cancelAddEditQuestionBtn');
            const addEditQuestionForm = document.getElementById('addEditQuestionForm');
            const saveQuestionBtn = document.getElementById('saveQuestionBtn');
            const addEditQuestionModalTitle = document.getElementById('addEditQuestionModalTitle');
            const editingQuestionIdInput = document.getElementById('editingQuestionId');

            const questionTextInput = document.getElementById('questionText');
            const questionTypeSelect = document.getElementById('questionTypeSelect');
            const multipleChoiceFieldsContainer = document.getElementById('multipleChoiceFieldsContainer');
            const orderingFieldsContainer = document.getElementById('orderingFieldsContainer');
            const freeTextFieldsContainer = document.getElementById('freeTextFieldsContainer');
            const mcOptionsContainer = document.getElementById('mcOptionsContainer');
            const addMcOptionBtn = document.getElementById('addMcOptionBtn');
            const isMcMultipleCorrectCheckbox = document.getElementById('isMcMultipleCorrect');
            const pointsPerCorrectMcInput = document.getElementById('pointsPerCorrectMc');
            const pointsPerIncorrectMcInput = document.getElementById('pointsPerIncorrectMc');
            const totalScoreMcSingleInput = document.getElementById('totalScoreMcSingle');
            const orderingOptionsContainer = document.getElementById('orderingOptionsContainer');
            const addOrderingOptionBtn = document.getElementById('addOrderingOptionBtn');
            const pointsPerCorrectOrderInput = document.getElementById('pointsPerCorrectOrder');
            const bonusForFullOrderInput = document.getElementById('bonusForFullOrder');
            const maxScoreFreeTextInput = document.getElementById('maxScoreFreeText');

            const deleteQuestionConfirmModal = document.getElementById('deleteQuestionConfirmModal');
            const questionIdToDeleteInput = document.getElementById('questionIdToDelete');
            const cancelDeleteQuestionBtn = document.getElementById('cancelDeleteQuestionBtn');
            const confirmDeleteQuestionBtn = document.getElementById('confirmDeleteQuestionBtn');

            const editRaceModal = document.getElementById('editRaceModal');
            const openEditRaceModalBtn = document.getElementById('openEditRaceModalBtn');
            const closeEditRaceModalBtn = document.getElementById('closeEditRaceModalBtn');
            const cancelEditRaceBtn = document.getElementById('cancelEditRaceBtn');
            const editRaceForm = document.getElementById('editRaceForm');
            const saveRaceChangesBtn = document.getElementById('saveRaceChangesBtn');
            const raceTitleInput = document.getElementById('raceTitle');
            const raceLocationInput = document.getElementById('raceLocation');
            const raceDescriptionInput = document.getElementById('raceDescription');
            const raceEventDateInput = document.getElementById('raceEventDate');
            const raceGenderCategoryInput = document.getElementById('raceGenderCategory');
            const racePromoImageUrlInput = document.getElementById('racePromoImageUrl');
            const editRaceQuinielaCloseDateInput = document.getElementById('editRaceQuinielaCloseDate'); // Added
            const deleteRaceBtn = document.getElementById('deleteRaceBtn');

            // Event Listener Attachments
            if (logoutButtonNav) {
                logoutButtonNav.addEventListener('click', function(event) {
                    event.preventDefault();
                    fetch("{{ url_for('logout_api') }}", { method: 'POST' })
                        .then(response => {
                            if (response.ok) window.location.href = "{{ url_for('serve_login_page') }}";
                            else alert('Logout failed.');
                        })
                        .catch(error => console.error('Logout error:', error));
                });
            }

            // if(toggleQuestionsBtn) { // Commented out
            //      toggleQuestionsBtn.addEventListener('click', toggleQuestions);
            // }

            console.log('DEBUG: Looking for participateInPoolBtn.');
            const participateInPoolBtn = document.getElementById('participateInPoolBtn');
            if (participateInPoolBtn) {
                console.log('DEBUG: participateInPoolBtn FOUND. Attaching listener. Typeof openWizard at this point:', typeof openWizard);
                participateInPoolBtn.addEventListener('click', function(event) {
                    console.log('DEBUG: participateInPoolBtn clicked. Calling openWizard. Typeof openWizard now:', typeof openWizard);
                    if (typeof openWizard === 'function') {
                        openWizard();
                    } else {
                        console.error('DEBUG: openWizard is NOT a function when participateInPoolBtn was clicked!');
                        alert('DEBUG: Critical error - openWizard is not a function. Check console.');
                    }
                });
            } else {
                console.log('DEBUG: participateInPoolBtn NOT FOUND.');
            }

            const reviewUserAnswersBtn = document.getElementById('reviewUserAnswersBtn');
            const reviewUserAnswersModal = document.getElementById('reviewUserAnswersModal');
            const closeReviewUserAnswersModalBtn = document.getElementById('closeReviewUserAnswersModalBtn');
            // Corrected variable to get the wrapper that contains loading/error/display area
            const reviewUserAnswersContentWrapper = document.getElementById('reviewUserAnswersContentWrapper');
            const reviewUserAnswersDisplayArea = document.getElementById('reviewUserAnswersDisplayArea');
            const confirmAndCloseReviewModalBtn = document.getElementById('confirmAndCloseReviewModalBtn');
            const reviewAnswersLoading = document.getElementById('reviewAnswersLoading');
            const reviewAnswersError = document.getElementById('reviewAnswersError');

            // Elements for Edit Answer Modal
            const editAnswerModal = document.getElementById('editAnswerModal');
            const closeEditAnswerModalBtn = document.getElementById('closeEditAnswerModalBtn');
            const cancelEditAnswerBtn = document.getElementById('cancelEditAnswerBtn');
            const saveEditedAnswerBtn = document.getElementById('saveEditedAnswerBtn');
            const editAnswerQuestionText = document.getElementById('editAnswerQuestionText');
            const editAnswerOptionsArea = document.getElementById('editAnswerOptionsArea');
            const editingQuestionIdStore = document.getElementById('editingQuestionIdStore');
            const editingUserAnswerIdStore = document.getElementById('editingUserAnswerIdStore');
            const editAnswerLoading = document.getElementById('editAnswerLoading');
            const editAnswerError = document.getElementById('editAnswerError');

            let currentUserAnswersData = []; // To store fetched user answers

            // Refactored function to load and display user answers
            async function loadAndDisplayUserAnswers(raceIdToLoad) {
                if (!reviewUserAnswersModal || !reviewAnswersLoading || !reviewAnswersError || !reviewUserAnswersDisplayArea) {
                    console.error("Review answers modal elements not found for loadAndDisplayUserAnswers");
                    return;
                }
                reviewUserAnswersDisplayArea.innerHTML = '';
                reviewAnswersError.style.display = 'none';
                reviewAnswersLoading.style.display = 'block';
                // reviewUserAnswersModal.style.display = 'flex'; // Ensure modal is visible if called independently

                try {
                    const response = await fetch(`/api/races/${raceIdToLoad}/user_answers`);
                    if (!response.ok) {
                        const errData = await response.json().catch(() => null);
                        throw new Error(errData?.message || `Error ${response.status}: ${response.statusText}`);
                    }
                    const answers = await response.json();
                    currentUserAnswersData = answers; // Store/update fetched answers
                    reviewAnswersLoading.style.display = 'none';
                    if (answers && answers.length > 0) {
                        answers.forEach(answer => {
                            reviewUserAnswersDisplayArea.appendChild(renderSingleUserAnswer(answer));
                        });
                    } else {
                        reviewUserAnswersDisplayArea.innerHTML = '<p class="text-gray-600 text-center py-4">No has respondido ninguna pregunta para esta quiniela todavía.</p>';
                    }
                } catch (error) {
                    console.error('Error fetching user answers:', error);
                    reviewAnswersLoading.style.display = 'none';
                    reviewAnswersError.textContent = `Error al cargar tus respuestas: ${error.message}. Inténtalo de nuevo.`;
                    reviewAnswersError.style.display = 'block';
                    reviewUserAnswersDisplayArea.innerHTML = '';
                }
            }

            if (reviewUserAnswersBtn) {
                reviewUserAnswersBtn.addEventListener('click', function() {
                    reviewUserAnswersModal.style.display = 'flex'; // Show modal first
                    loadAndDisplayUserAnswers(raceId);
                });
            }

            if (closeReviewUserAnswersModalBtn) {
                closeReviewUserAnswersModalBtn.addEventListener('click', function() {
                    if(reviewUserAnswersModal) reviewUserAnswersModal.style.display = 'none';
                });
            }

            if (confirmAndCloseReviewModalBtn) {
                confirmAndCloseReviewModalBtn.addEventListener('click', function() {
                     if(reviewUserAnswersModal) reviewUserAnswersModal.style.display = 'none';
                });
            }

            function renderSingleUserAnswer(answer) {
                const answerItemDiv = document.createElement('div');
                // Added some bottom margin for spacing between answer items
                answerItemDiv.className = 'p-4 border border-gray-200 rounded-lg bg-white shadow mb-3';

                let formattedAnswerHtml = '';
                switch (answer.question_type) {
                    case 'FREE_TEXT':
                        formattedAnswerHtml = `<p class="text-gray-700">${answer.answer_text || '<span class="text-gray-500 italic">No respondida</span>'}</p>`;
                        break;
                    case 'ORDERING':
                        formattedAnswerHtml = `<p class="text-gray-700">${answer.answer_text || '<span class="text-gray-500 italic">No respondida</span>'}</p>`;
                        break;
                    case 'MULTIPLE_CHOICE':
                        if (answer.selected_option_text) {
                            formattedAnswerHtml = `<p class="text-gray-700">${answer.selected_option_text}</p>`;
                        } else if (answer.selected_mc_options && answer.selected_mc_options.length > 0) {
                            formattedAnswerHtml = '<ul class="list-disc list-inside text-gray-700 space-y-1">';
                            answer.selected_mc_options.forEach(opt => {
                                formattedAnswerHtml += `<li>${opt.option_text}</li>`;
                            });
                            formattedAnswerHtml += '</ul>';
                        } else {
                            formattedAnswerHtml = '<p class="text-gray-500 italic">No seleccionaste ninguna opción.</p>';
                        }
                        break;
                    default:
                        formattedAnswerHtml = '<p class="text-red-500">Tipo de respuesta no reconocido.</p>';
                }

                answerItemDiv.innerHTML = `
                    <p class="font-semibold text-gray-800 mb-1">${answer.question_text}</p>
                    <div class="text-xs text-gray-500 mb-2">Tu respuesta:</div>
                    <div class="p-3 bg-gray-50 border border-gray-300 rounded-md min-h-[40px]">
                        ${formattedAnswerHtml}
                    </div>
                    <div class="text-right mt-3">
                        <button class="editAnswerBtn btn btn-sm btn-secondary hover:bg-gray-300" data-question-id="${answer.question_id}" data-user-answer-id="${answer.user_answer_id}">
                            <i class="fas fa-edit mr-1"></i>Editar
                        </button>
                    </div>
                `;

                const editButton = answerItemDiv.querySelector('.editAnswerBtn');
                if(editButton) {
                    editButton.addEventListener('click', function() {
                        const questionId = this.dataset.questionId;
                        const userAnswerId = this.dataset.userAnswerId;

                        if (!editAnswerModal || !editingQuestionIdStore || !editingUserAnswerIdStore || !editAnswerQuestionText || !editAnswerOptionsArea || !editAnswerLoading || !editAnswerError) {
                            console.error("Edit answer modal elements not found");
                            return;
                        }

                        editAnswerLoading.style.display = 'block';
                        editAnswerError.style.display = 'none';
                        editAnswerOptionsArea.innerHTML = ''; // Clear previous content
                        editAnswerModal.style.display = 'flex';

                        editingQuestionIdStore.value = questionId;
                        editingUserAnswerIdStore.value = userAnswerId;

                        const foundAnswer = currentUserAnswersData.find(ans => ans.question_id == questionId && ans.user_answer_id == userAnswerId);

                        if (foundAnswer) {
                            editAnswerQuestionText.textContent = foundAnswer.question_text;
                            populateEditAnswerForm(foundAnswer);
                            editAnswerLoading.style.display = 'none';
                        } else {
                            editAnswerQuestionText.textContent = '';
                            editAnswerError.textContent = 'Error: No se pudieron cargar los detalles de la respuesta. Intenta cerrar y abrir esta ventana.';
                            editAnswerError.style.display = 'block';
                            editAnswerLoading.style.display = 'none';
                        }
                    });
                }
                return answerItemDiv;
            }

            function populateEditAnswerForm(answerData) {
                if (!editAnswerOptionsArea) return;
                editAnswerOptionsArea.innerHTML = ''; // Clear previous inputs

                switch (answerData.question_type) {
                    case 'FREE_TEXT':
                        const textarea = document.createElement('textarea');
                        textarea.id = `editFreeTextAnswer_${answerData.question_id}`;
                        textarea.className = 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent';
                        textarea.rows = 4;
                        textarea.value = answerData.answer_text || '';
                        editAnswerOptionsArea.appendChild(textarea);
                        break;

                    case 'ORDERING':
                        const orderingInfo = document.createElement('p');
                        orderingInfo.className = 'text-sm text-gray-600 mb-2';
                        orderingInfo.textContent = "Reordena los items en el cuadro de texto de abajo, separados por comas y en el orden deseado. Items originales para referencia:";
                        editAnswerOptionsArea.appendChild(orderingInfo);

                        const itemsList = document.createElement('ul');
                        itemsList.className = 'list-disc list-inside bg-gray-100 p-3 rounded-md mb-2';
                        answerData.all_question_options.forEach(opt => {
                            const item = document.createElement('li');
                            item.textContent = opt.option_text;
                            itemsList.appendChild(item);
                        });
                        editAnswerOptionsArea.appendChild(itemsList);

                        const orderingTextarea = document.createElement('textarea');
                        orderingTextarea.id = `editOrderingAnswer_${answerData.question_id}`;
                        orderingTextarea.className = 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent';
                        orderingTextarea.rows = 3;
                        orderingTextarea.placeholder = 'Ej: Item C, Item A, Item B';
                        orderingTextarea.value = answerData.answer_text || '';
                        editAnswerOptionsArea.appendChild(orderingTextarea);
                        break;

                    case 'MULTIPLE_CHOICE':
                        answerData.all_question_options.forEach(opt => {
                            const label = document.createElement('label');
                            label.className = 'flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded-md border border-gray-200 hover:border-orange-300';
                            const input = document.createElement('input');
                            input.name = `edit_q_${answerData.question_id}`; // Unique name for radio group
                            input.value = opt.id;
                            input.className = 'text-orange-500 focus:ring-orange-400 focus:ring-offset-0';

                            if (answerData.selected_mc_options && answerData.selected_mc_options.length > 0) { // Is multi-select
                                input.type = 'checkbox';
                                input.classList.add('rounded');
                                if (answerData.selected_mc_options.some(selOpt => selOpt.option_id == opt.id)) {
                                    input.checked = true;
                                }
                            } else { // Is single-select
                                input.type = 'radio';
                                if (answerData.selected_option_id == opt.id) {
                                    input.checked = true;
                                }
                            }

                            const span = document.createElement('span');
                            span.className = 'text-gray-700';
                            span.textContent = opt.option_text;

                            label.appendChild(input);
                            label.appendChild(span);
                            editAnswerOptionsArea.appendChild(label);
                        });
                        break;
                    default:
                        editAnswerOptionsArea.innerHTML = '<p class="text-red-500">Tipo de pregunta no soportado para edición.</p>';
                }
            }

            if (closeEditAnswerModalBtn) {
                closeEditAnswerModalBtn.addEventListener('click', () => { if(editAnswerModal) editAnswerModal.style.display = 'none'; });
            }
            if (cancelEditAnswerBtn) {
                cancelEditAnswerBtn.addEventListener('click', () => { if(editAnswerModal) editAnswerModal.style.display = 'none'; });
            }
            if (saveEditedAnswerBtn) {
                saveEditedAnswerBtn.addEventListener('click', function() {
                    const userAnswerId = editingUserAnswerIdStore.value;
                    const questionId = editingQuestionIdStore.value;

                    if (!userAnswerId || !questionId) {
                        editAnswerError.textContent = 'Error: No se pudo identificar la respuesta a guardar.';
                        editAnswerError.style.display = 'block';
                        return;
                    }

                    saveEditedAnswerBtn.disabled = true;
                    saveEditedAnswerBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';
                    editAnswerError.style.display = 'none';

                    const originalAnswerData = currentUserAnswersData.find(ans => ans.question_id == questionId && ans.user_answer_id == userAnswerId);
                    if (!originalAnswerData) {
                        editAnswerError.textContent = 'Error: Datos originales de la respuesta no encontrados.';
                        editAnswerError.style.display = 'block';
                        saveEditedAnswerBtn.disabled = false;
                        saveEditedAnswerBtn.innerHTML = 'Guardar Cambios';
                        return;
                    }

                    let payload = {};
                    switch (originalAnswerData.question_type) {
                        case 'FREE_TEXT':
                            const ftTextarea = editAnswerOptionsArea.querySelector(`#editFreeTextAnswer_${questionId}`);
                            payload.answer_text = ftTextarea ? ftTextarea.value : null;
                            break;
                        case 'ORDERING':
                            const orTextarea = editAnswerOptionsArea.querySelector(`#editOrderingAnswer_${questionId}`);
                            payload.ordered_options_text = orTextarea ? orTextarea.value : null;
                            break;
                        case 'MULTIPLE_CHOICE':
                            // For MC, need to check if it's single or multi based on original data.
                            // The original API for UserAnswer returns `selected_mc_options` as an array for multi,
                            // and `selected_option_id` for single.
                            // The `populateEditAnswerForm` uses `answerData.selected_mc_options.length > 0` to infer multi for form creation.
                            // A more robust way would be to have `is_mc_multiple_correct` in `originalAnswerData`.
                            // Assuming `originalAnswerData.all_question_options` exists and `originalAnswerData` has enough info.

                            // Let's find the question details from allRaceQuestions if available, or rely on structure of originalAnswerData
                            const questionDetails = allRaceQuestions.find(q => q.id == questionId) || {is_mc_multiple_correct: (originalAnswerData.selected_mc_options && originalAnswerData.selected_mc_options.length > 0)};

                            if (questionDetails.is_mc_multiple_correct) {
                                payload.selected_option_ids = [];
                                editAnswerOptionsArea.querySelectorAll(`input[name="edit_q_${questionId}"]:checked`).forEach(cb => {
                                    payload.selected_option_ids.push(parseInt(cb.value));
                                });
                            } else { // Single-select
                                const checkedRadio = editAnswerOptionsArea.querySelector(`input[name="edit_q_${questionId}"]:checked`);
                                payload.selected_option_id = checkedRadio ? parseInt(checkedRadio.value) : null;
                            }
                            break;
                        default:
                            editAnswerError.textContent = 'Tipo de pregunta no reconocido para guardar.';
                            editAnswerError.style.display = 'block';
                            saveEditedAnswerBtn.disabled = false;
                            saveEditedAnswerBtn.innerHTML = 'Guardar Cambios';
                            return;
                    }

                    fetch(`/api/user_answers/${userAnswerId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}' // Add CSRF token if needed by your Flask setup
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, body: data })))
                    .then(result => {
                        if (result.ok) {
                            if(editAnswerModal) editAnswerModal.style.display = 'none';
                            alert(result.body.message || "Respuesta actualizada con éxito.");
                            // Refresh the review modal to show the updated answer
                            if(reviewUserAnswersModal.style.display === 'flex' || reviewUserAnswersModal.classList.contains('flex')) { // Check if review modal was open
                                loadAndDisplayUserAnswers(raceId);
                            }
                        } else {
                            editAnswerError.textContent = result.body.message || 'Error al guardar la respuesta.';
                            editAnswerError.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Error saving answer:', error);
                        editAnswerError.textContent = `Error de conexión al guardar: ${error.message}. Inténtalo de nuevo.`;
                        editAnswerError.style.display = 'block';
                    })
                    .finally(() => {
                        saveEditedAnswerBtn.disabled = false;
                        saveEditedAnswerBtn.innerHTML = 'Guardar Cambios';
                    });
                });
            }


            if(addMcOptionBtn && mcOptionsContainer) {
                addMcOptionBtn.addEventListener('click', () => {
                    mcOptionsContainer.appendChild(createOptionInputDiv("", null, false, "MULTIPLE_CHOICE"));
                });
            }

            if(addOrderingOptionBtn && orderingOptionsContainer) {
                addOrderingOptionBtn.addEventListener('click', () => {
                    orderingOptionsContainer.appendChild(createOptionInputDiv("", null, false, "ORDERING"));
                });
            }

            // Edit Race Modal Functions (defined locally as they use DOMContentLoaded-defined consts)
            function openEditRaceModal() {
                if (!editRaceModal) return;
                editRaceModal.style.display = 'flex';
            }

            function closeEditRaceModal() {
                if (!editRaceModal) return;
                editRaceModal.style.display = 'none';
            }

            if (openEditRaceModalBtn) {
                openEditRaceModalBtn.addEventListener('click', openEditRaceModal);
            }
            if (closeEditRaceModalBtn) {
                closeEditRaceModalBtn.addEventListener('click', closeEditRaceModal);
            }
            if (cancelEditRaceBtn) {
                cancelEditRaceBtn.addEventListener('click', closeEditRaceModal);
            }

            if (editRaceForm) {
                editRaceForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    if(!saveRaceChangesBtn) return;
                    saveRaceChangesBtn.disabled = true;
                    saveRaceChangesBtn.classList.add('opacity-50');

                    const formData = {
                        title: raceTitleInput.value,
                        location: raceLocationInput.value,
                        description: raceDescriptionInput.value,
                        event_date: raceEventDateInput.value,
                        gender_category: raceGenderCategoryInput.value,
                        promo_image_url: racePromoImageUrlInput.value,
                        category: document.getElementById('raceCategory').value,
                        quiniela_close_date: document.getElementById('editRaceQuinielaCloseDate').value // Added
                    };

                    if (!formData.title.trim()) {
                        alert('El título de la carrera es obligatorio.');
                        saveRaceChangesBtn.disabled = false;
                        saveRaceChangesBtn.classList.remove('opacity-50');
                        return;
                    }
                     if (!formData.event_date) {
                        alert('La fecha del evento es obligatoria.');
                        saveRaceChangesBtn.disabled = false;
                        saveRaceChangesBtn.classList.remove('opacity-50');
                        return;
                    }

                    fetch(`/api/races/${raceId}/details`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', },
                        body: JSON.stringify(formData)
                    })
                    .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, body: data })))
                    .then(result => {
                        if (result.ok) {
                            alert(result.body.message || 'Detalles de la carrera actualizados con éxito.');
                            closeEditRaceModal();
                            // Update page content dynamically
                            const titleElement = document.querySelector('.hero-bg h1');
                            if (titleElement) titleElement.textContent = result.body.race.title;
                            const heroDescription = document.querySelector('.hero-bg p.opacity-90');
                            if (heroDescription) heroDescription.textContent = result.body.race.description.substring(0,150) + (result.body.race.description.length > 150 ? '...' : '');
                            const detailedDescriptionP = document.querySelector('.bg-white.rounded-xl.p-6.shadow-lg > p.text-gray-600.leading-relaxed.whitespace-pre-line');
                            if(detailedDescriptionP && result.body.race.description.length > 150) {
                                detailedDescriptionP.textContent = result.body.race.description;
                                const detailedDescSection = detailedDescriptionP.closest('.bg-white.rounded-xl.p-6.shadow-lg');
                                if(detailedDescSection) detailedDescSection.style.display = 'block';
                            } else if (detailedDescriptionP && result.body.race.description.length <= 150) {
                                const detailedDescSection = detailedDescriptionP.closest('.bg-white.rounded-xl.p-6.shadow-lg');
                                if(detailedDescSection) detailedDescSection.style.display = 'none';
                            }
                            const heroDateSpan = document.querySelector('.hero-bg .fa-calendar').nextElementSibling;
                            if (heroDateSpan && result.body.race.event_date) {
                                const eventDate = new Date(result.body.race.event_date);
                                heroDateSpan.textContent = eventDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' }) + ' ' + eventDate.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                            } else if (heroDateSpan) {
                                heroDateSpan.textContent = 'Fecha no especificada';
                            }
                            const heroLocationSpan = document.querySelector('.hero-bg .fa-map-marker-alt').nextElementSibling;
                            if (heroLocationSpan) heroLocationSpan.textContent = result.body.race.location || 'Ubicación no especificada';
                            const genderBadge = document.querySelector('.hero-bg span.bg-white.bg-opacity-20:nth-of-type(2)');
                            if(genderBadge) genderBadge.textContent = result.body.race.gender_category;
                            const promoImage = document.querySelector('.hero-bg img');
                            const promoImageContainer = promoImage ? promoImage.parentElement : null;
                            if (promoImage && result.body.race.promo_image_url) {
                                promoImage.src = result.body.race.promo_image_url;
                                promoImage.alt = `Imagen de ${result.body.race.title}`;
                                if(promoImageContainer) promoImageContainer.style.display = '';
                            } else if (promoImage && !result.body.race.promo_image_url) {
                                if(promoImageContainer) promoImageContainer.style.display = 'none';
                            }
                            const raceCategoryInputModal = document.getElementById('raceCategory');
                            if (raceCategoryInputModal) raceCategoryInputModal.value = result.body.race.category;

                            // Update global race variable or re-fetch if necessary for quiniela_close_date
                            // For now, assuming direct update to the 'race' object if it's accessible globally
                            // or that the page might be reloaded/data re-fetched by other means for other sections.
                            // The modal itself will be repopulated with fresh data from result.body.race if reopened.
                            if (typeof race === 'object' && race !== null && result.body.race.quiniela_close_date) {
                                race.quiniela_close_date = result.body.race.quiniela_close_date;
                            }


                        } else {
                            alert(`Error: ${result.body.message || 'No se pudo actualizar la carrera.'}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error saving race details:', error);
                        alert('Error de conexión al guardar los detalles de la carrera.');
                    })
                    .finally(() => {
                        if(saveRaceChangesBtn) {
                            saveRaceChangesBtn.disabled = false;
                            saveRaceChangesBtn.classList.remove('opacity-50');
                        }
                    });
                });
            }

            // Add/Edit Question Modal Listeners
            if (addNewQuestionBtn) {
                addNewQuestionBtn.addEventListener('click', openAddQuestionModal);
            }
            if (closeAddEditQuestionModalBtn) {
                closeAddEditQuestionModalBtn.addEventListener('click', closeAddEditQuestionModal);
            }
            if (cancelAddEditQuestionBtn) {
                cancelAddEditQuestionBtn.addEventListener('click', closeAddEditQuestionModal);
            }
            if(questionTypeSelect) {
                questionTypeSelect.addEventListener('change', handleQuestionTypeChange);
            }

            // Delete Question Modal Listeners
            if(cancelDeleteQuestionBtn) {
                cancelDeleteQuestionBtn.addEventListener('click', closeDeleteConfirmModal);
            }
            if(addEditQuestionForm) {
                addEditQuestionForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    if(!saveQuestionBtn) return;

                    saveQuestionBtn.disabled = true;
                    saveQuestionBtn.classList.add('opacity-50');

                    const editingId = editingQuestionIdInput.value;
                    const type = questionTypeSelect.value;
                    let questionData = {
                        text: questionTextInput.value.trim(),
                        is_active: true,
                    };

                    if (!questionData.text) {
                        alert('El texto de la pregunta es obligatorio.');
                        saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                    }

                    let options = [];
                    if (type === 'MULTIPLE_CHOICE') {
                        mcOptionsContainer.querySelectorAll('input[type="text"]').forEach(input => {
                            if(input.value.trim()) options.push({ option_text: input.value.trim() });
                        });
                        if (options.length < 2) {
                            alert('Las preguntas de opción múltiple deben tener al menos 2 opciones con texto.');
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                        questionData.options = options;
                        questionData.is_mc_multiple_correct = isMcMultipleCorrectCheckbox.checked;

                        if (questionData.is_mc_multiple_correct) {
                            const pointsCorrect = parseInt(pointsPerCorrectMcInput.value);
                            const pointsIncorrect = parseInt(pointsPerIncorrectMcInput.value);
                            if (isNaN(pointsCorrect)) {
                                alert('Puntos por opción correcta debe ser un número para selección múltiple.');
                                saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                            }
                            if (isNaN(pointsIncorrect)) {
                                alert('Puntos por opción incorrecta debe ser un número para selección múltiple.');
                                saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                            }
                            questionData.points_per_correct_mc = pointsCorrect;
                            questionData.points_per_incorrect_mc = pointsIncorrect;
                        } else {
                            const totalScore = parseInt(totalScoreMcSingleInput.value);
                            if (isNaN(totalScore) || totalScore <= 0) {
                                alert('La puntuación total para opción única debe ser un número entero positivo.');
                                saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                            }
                            questionData.total_score_mc_single = totalScore;
                        }
                    } else if (type === 'ORDERING') {
                        orderingOptionsContainer.querySelectorAll('input[type="text"]').forEach(input => {
                           if(input.value.trim()) options.push({ option_text: input.value.trim() });
                        });
                        if (options.length < 2) {
                            alert('Las preguntas de ordenamiento deben tener al menos 2 ítems con texto.');
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                        questionData.options = options;
                        const pointsPerCorrect = parseInt(pointsPerCorrectOrderInput.value);
                        const bonusFullOrder = parseInt(bonusForFullOrderInput.value);
                        if (isNaN(pointsPerCorrect) || pointsPerCorrect <= 0) {
                             alert('Los puntos por ítem correcto en ordenamiento deben ser un número entero positivo.');
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                        if (isNaN(bonusFullOrder) || bonusFullOrder < 0) {
                             alert('El bonus por orden completo debe ser un número entero no negativo.');
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                        questionData.points_per_correct_order = pointsPerCorrect;
                        questionData.bonus_for_full_order = bonusFullOrder;
                    } else if (type === 'FREE_TEXT') {
                        const maxScore = parseInt(maxScoreFreeTextInput.value);
                        if (isNaN(maxScore) || maxScore <= 0) {
                             alert('La puntuación máxima para texto libre debe ser un número entero positivo.');
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                        questionData.max_score_free_text = maxScore;
                    }

                    let url, method;
                    const currentQuestionType = questionTypeSelect.value;
                    const typeSlug = currentQuestionType.toLowerCase().replace('_', '-');

                    if (editingId) {
                        url = `/api/questions/${typeSlug}/${editingId}`;
                        method = 'PUT';
                    } else {
                        if (!raceId) {
                            alert("Error: El ID de la carrera no está definido. No se puede crear la pregunta.");
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                        url = `/api/races/${raceId}/questions/${typeSlug}`;
                        method = 'POST';
                        questionData.is_active = true;
                    }

                    fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(questionData)
                    })
                    .then(response => response.json().then(data => ({ok: response.ok, status: response.status, body: data})))
                    .then(result => {
                        if (result.ok) {
                            alert(result.body.message || `Pregunta ${editingId ? 'actualizada' : 'creada'} con éxito.`);
                            closeAddEditQuestionModal();
                            fetchAndRenderQuestions();
                        } else {
                            alert(`Error: ${result.body.message || 'No se pudo guardar la pregunta.'}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error saving question:', error);
                        alert('Error de conexión al guardar la pregunta.');
                    })
                    .finally(() => {
                        if(saveQuestionBtn) {
                            saveQuestionBtn.disabled = false;
                            saveQuestionBtn.classList.remove('opacity-50');
                        }
                    });
                });
            }

            if(confirmDeleteQuestionBtn) {
                confirmDeleteQuestionBtn.addEventListener('click', function() {
                    const questionIdVal = questionIdToDeleteInput.value;
                    if (!questionIdVal) return;
                    if(!confirmDeleteQuestionBtn) return;

                    confirmDeleteQuestionBtn.disabled = true;
                    confirmDeleteQuestionBtn.classList.add('opacity-50');

                    fetch(`/api/questions/${questionIdVal}`, { method: 'DELETE' })
                    .then(response => response.json().then(data => ({ok: response.ok, status: response.status, body: data})))
                    .then(result => {
                        if (result.ok) {
                            alert(result.body.message || 'Pregunta eliminada con éxito.');
                            closeDeleteConfirmModal();
                            fetchAndRenderQuestions();
                        } else {
                            alert(`Error: ${result.body.message || 'No se pudo eliminar la pregunta.'}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting question:', error);
                        alert('Error de conexión al eliminar la pregunta.');
                    })
                    .finally(() => {
                        if(confirmDeleteQuestionBtn) {
                            confirmDeleteQuestionBtn.disabled = false;
                            confirmDeleteQuestionBtn.classList.remove('opacity-50');
                        }
                    });
                });
            }

            if (deleteRaceBtn) {
                deleteRaceBtn.addEventListener('click', function() {
                    const confirmationMessage = '¿Estás seguro de que quieres eliminar esta carrera? Esta acción no se puede deshacer y eliminará todos los datos asociados (segmentos, preguntas, etc.).';
                    if (confirm(confirmationMessage)) {
                        if (!raceId) {
                            alert('Error: ID de la carrera no encontrado.');
                            return;
                        }
                        fetch(`/api/races/${raceId}`, { method: 'DELETE' })
                        .then(response => {
                            const clonedResponse = response.clone();
                            return response.json()
                                .then(data => ({ ok: response.ok, status: response.status, body: data }))
                                .catch(() => clonedResponse.text().then(textData => ({
                                        ok: response.ok,
                                        status: response.status,
                                        body: { message: `Could not parse JSON. Raw text: ${textData}` }
                                    }))
                                );
                        })
                        .then(result => {
                            if (result.ok) {
                                alert(result.body.message || 'Carrera eliminada con éxito.');
                                window.location.href = "{{ url_for('serve_hello_world_page') }}";
                            } else {
                                alert(`Error al eliminar la carrera: ${result.body.message || `Error de servidor ${result.status}`}`);
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting race:', error);
                            alert('Error en la conexión o al procesar la solicitud de eliminación.');
                        });
                    }
                });
            }

            // Clear All Official Results Button Logic
            const clearAllOfficialResultsBtn = document.getElementById('clearAllOfficialResultsBtn');
            if (clearAllOfficialResultsBtn && (currentUserRole === 'ADMIN' || currentUserRole === 'LEAGUE_ADMIN')) {
                clearAllOfficialResultsBtn.addEventListener('click', function() {
                    if (confirm("¿Estás seguro de que quieres borrar todos los resultados oficiales para esta carrera? Esta acción no se puede deshacer.")) {
                        this.disabled = true;
                        this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Borrando...';

                        fetch(`/api/races/${raceId}/official_answers`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                                // 'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}' // Add CSRF if needed
                            }
                        })
                        .then(response => {
                            this.disabled = false;
                            this.innerHTML = '<i class="fas fa-trash-alt mr-2"></i>Borrar Todos los Resultados';

                            if (response.ok) {
                                // Try to parse JSON, but if it fails (e.g. empty response with 204),
                                // still treat as success for deletion.
                                return response.json().catch(() => ({
                                    message: "Resultados oficiales borrados con éxito.",
                                    ok: true,
                                    status: response.status
                                }));
                            } else {
                                // If response is not OK, try to parse error from JSON body
                                return response.json().then(err => { throw err; });
                            }
                        })
                        .then(data => {
                            alert(data.message || "Resultados oficiales borrados con éxito.");
                            const officialResultsContent = document.getElementById('officialResultsContent');
                            if (officialResultsContent) {
                                officialResultsContent.innerHTML = '<p id="loadingOfficialResultsMsg" class="text-gray-600">Los resultados oficiales han sido borrados. Recarga la página para actualizar la vista o para volver a cargarlos.</p>';
                                // Consider hiding the edit/clear buttons or calling fetchAndDisplayOfficialResults()
                                // if it correctly handles an empty or "no results" state.
                                // For now, just updating the message.
                            }
                        })
                        .catch(error => {
                            this.disabled = false;
                            this.innerHTML = '<i class="fas fa-trash-alt mr-2"></i>Borrar Todos los Resultados';
                            alert('Error al borrar los resultados oficiales: ' + (error.message || error.detail || 'Error desconocido. Revisa la consola para más detalles.'));
                            console.error('Error clearing official results:', error);
                        });
                    }
                });
            }

            // Initial data fetch
            // fetchAndRenderQuestions(); // Commented out - questions are now fetched by wizard or admin section
            // Admin might still need a way to see questions even if user hasn't answered.
            // For now, this is removed to simplify. If questions need to be displayed for admins
            // outside the wizard, fetchAndRenderQuestions() should be called conditionally based on role.
            // e.g., if (currentUserRole === 'ADMIN' || currentUserRole === 'LEAGUE_ADMIN') { fetchAndRenderQuestions(); }
            // But ensure it doesn't interfere with the new `has_user_answered_pool` logic.

            // If admin needs to manage questions, they should be loaded regardless of has_user_answered_pool
            // The display of these questions for admin management would be separate from the user participation flow.
            // For now, let's assume question management is handled by "Añadir Pregunta" and subsequent edit/delete in modals.
            // The `fetchAndRenderQuestions` was originally tied to the "Ver Preguntas" button which is removed.
            // If questions are needed for the wizard, the wizard should fetch them.
            // The current `fetchAndRenderQuestions` also populates `allRaceQuestions` which is used by the wizard.
            // So, it needs to be called, but its rendering part should be conditional or managed.

            if (allRaceQuestions.length === 0 && (currentUserRole === 'ADMIN' || currentUserRole === 'LEAGUE_ADMIN' || !hasUserAnsweredPool) ) {
                 // Fetch questions if they are not yet loaded, and user is admin/league_admin OR if user has not answered (for wizard)
                fetchAndRenderQuestions();
            }


            // Fetch and Display Race Participants Logic
            if (currentUserRole === 'ADMIN' || currentUserRole === 'LEAGUE_ADMIN') {
                if (raceId) {
                    const participantsContainer = document.getElementById('raceParticipantsListContainer');
                    const loadingMsg = document.getElementById('loadingParticipantsMessage');
                    const errorMsg = document.getElementById('errorLoadingParticipantsMessage');

                    if (participantsContainer && loadingMsg && errorMsg) {
                        loadingMsg.style.display = 'block';
                        errorMsg.style.display = 'none';

                        fetch(`/api/races/${raceId}/participants`)
                            .then(response => {
                                loadingMsg.style.display = 'none';
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(participants => {
                                participantsContainer.innerHTML = ''; // Clear previous content or loading message

                                if (participants && participants.length > 0) {
                                    participants.forEach(participant => {
                                        const participantItem = document.createElement('div');
                                        participantItem.className = 'participant-item flex justify-between items-center py-2 border-b border-gray-200';

                                        const userLink = document.createElement('a');
                                        userLink.href = '#'; // Prevent page jump, will be handled by JS
                                        userLink.className = 'participant-details-link text-blue-600 hover:underline';
                                        userLink.textContent = participant.username;
                                        userLink.dataset.userId = participant.user_id;
                                        userLink.addEventListener('click', function(event) {
                                            event.preventDefault();
                                            // Placeholder for opening a modal or navigating to user-specific answers
                                            // For now, it will use the existing reviewUserAnswersModal logic
                                            // but ideally, this would be adapted to show a specific user's answers for admin
                                            console.log(`Clicked participant: ${participant.username}, ID: ${participant.user_id}`);
                                            // alert(`Mostrar detalles/respuestas para ${participant.username} (ID: ${participant.user_id})`);
                                            // TODO: Implement modal or view for specific user's answers for admin.
                                            // As a temporary measure, if reviewUserAnswersModal exists and can be adapted:
                                            // openReviewModalForUser(participant.user_id, raceId);
                                        });


                                        const answeredIcon = document.createElement('i');
                                        answeredIcon.className = participant.has_answered
                                            ? 'fas fa-check-circle text-green-500'
                                            : 'fas fa-times-circle text-red-500';
                                        answeredIcon.title = participant.has_answered ? 'Ha respondido' : 'No ha respondido';


                                        participantItem.appendChild(userLink);
                                        participantItem.appendChild(answeredIcon);
                                        participantsContainer.appendChild(participantItem);
                                    });
                                } else {
                                    participantsContainer.innerHTML = '<p class="text-gray-600">No hay participantes inscritos en esta carrera.</p>';
                                }
                            })
                            .catch(error => {
                                loadingMsg.style.display = 'none';
                                errorMsg.style.display = 'block';
                                console.error('Error fetching race participants:', error);
                            });
                    } else {
                        console.error('Required elements for participants list not found in the DOM.');
                    }
                } else {
                    console.error('Race ID not available for fetching participants.');
                     const errorMsgElem = document.getElementById('errorLoadingParticipantsMessage');
                     if(errorMsgElem) {
                        errorMsgElem.textContent = 'ID de la carrera no disponible.';
                        errorMsgElem.style.display = 'block';
                     }
                }
            }

            // Share Race Functionality
            const participantAnswersModal = document.getElementById('participantAnswersModal');
            const participantAnswersModalTitle = document.getElementById('participantAnswersModalTitle');
            const participantAnswersModalBody = document.getElementById('participantAnswersModalBody');
            const closeParticipantAnswersModalBtn = document.getElementById('closeParticipantAnswersModalBtn');
            const closeParticipantAnswersModalFooterBtn = document.getElementById('closeParticipantAnswersModalFooterBtn');
            const raceParticipantsListContainer = document.getElementById('raceParticipantsListContainer');


            function openParticipantAnswersModal() {
                if (participantAnswersModal) {
                    participantAnswersModal.classList.remove('hidden');
                    participantAnswersModal.classList.add('flex');
                }
            }

            function closeParticipantAnswersModal() {
                if (participantAnswersModal) {
                    participantAnswersModal.classList.add('hidden');
                    participantAnswersModal.classList.remove('flex');
                    if (participantAnswersModalTitle) {
                        participantAnswersModalTitle.textContent = 'Respuestas del Participante'; // Reset title
                    }
                    if (participantAnswersModalBody) {
                        participantAnswersModalBody.innerHTML = '<p>Cargando respuestas...</p>'; // Reset body
                    }
                }
            }

            if (raceParticipantsListContainer) {
                raceParticipantsListContainer.addEventListener('click', function(event) {
                    const targetLink = event.target.closest('.participant-details-link');
                    if (targetLink) {
                        event.preventDefault();
                        const userId = targetLink.dataset.userId;
                        const username = targetLink.textContent;

                        if (participantAnswersModalTitle) {
                            participantAnswersModalTitle.textContent = 'Respuestas de ' + username;
                        }
                        if (participantAnswersModalBody) {
                            participantAnswersModalBody.innerHTML = '<p class="text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Cargando respuestas...</p>';
                        }
                        openParticipantAnswersModal();

                        fetch(`/api/races/${raceId}/participants/${userId}/answers`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(answersDetails => {
                                if (participantAnswersModalBody) {
                                    participantAnswersModalBody.innerHTML = ''; // Clear loading message
                                    if (answersDetails && answersDetails.length > 0) {
                                        answersDetails.forEach(detail => {
                                            const itemDiv = document.createElement('div');
                                            itemDiv.className = 'py-3 border-b last:border-b-0 border-gray-200';

                                            const questionTextP = document.createElement('p');
                                            questionTextP.className = 'font-semibold text-gray-700 mb-1';
                                            questionTextP.textContent = detail.question_text;
                                            itemDiv.appendChild(questionTextP);

                                            const answerDiv = document.createElement('div');
                                            answerDiv.className = 'pl-4 text-gray-600 bg-gray-50 p-2 rounded';

                                            let answerDisplay = '<span class="italic text-gray-500">No respondida</span>'; // Default for no answer

                                            if (detail.participant_answer !== null) {
                                                switch (detail.question_type) {
                                                    case 'FREE_TEXT':
                                                    case 'ORDERING':
                                                        answerDisplay = detail.participant_answer ? detail.participant_answer : '<span class="italic text-gray-500">No respondida</span>';
                                                        break;
                                                    case 'MULTIPLE_CHOICE':
                                                        if (detail.is_mc_multiple_correct) {
                                                            if (Array.isArray(detail.participant_answer) && detail.participant_answer.length > 0) {
                                                                answerDisplay = '<ul class="list-disc list-inside">';
                                                                detail.participant_answer.forEach(opt => {
                                                                    answerDisplay += `<li>${opt.text}</li>`;
                                                                });
                                                                answerDisplay += '</ul>';
                                                            }
                                                        } else {
                                                            if (detail.participant_answer && detail.participant_answer.text) {
                                                                answerDisplay = detail.participant_answer.text;
                                                            }
                                                        }
                                                        break;
                                                }
                                            }
                                            answerDiv.innerHTML = answerDisplay;
                                            itemDiv.appendChild(answerDiv);
                                            participantAnswersModalBody.appendChild(itemDiv);
                                        });
                                    } else {
                                        participantAnswersModalBody.innerHTML = '<p class="text-gray-600 text-center py-4">No se encontraron respuestas para este participante.</p>';
                                    }
                                }
                            })
                            .catch(error => {
                                if (participantAnswersModalBody) {
                                    participantAnswersModalBody.innerHTML = '<p class="text-red-500 text-center py-4">Error al cargar las respuestas del participante.</p>';
                                }
                                console.error('Error fetching participant answers:', error);
                            });
                    }
                });
            }

            if (closeParticipantAnswersModalBtn) {
                closeParticipantAnswersModalBtn.addEventListener('click', closeParticipantAnswersModal);
            }
            if (closeParticipantAnswersModalFooterBtn) {
                closeParticipantAnswersModalFooterBtn.addEventListener('click', closeParticipantAnswersModal);
            }
            // Close modal by clicking on backdrop
            if (participantAnswersModal) {
                participantAnswersModal.addEventListener('click', function(event) {
                    if (event.target === participantAnswersModal) { // Check if the click is on the backdrop itself
                        closeParticipantAnswersModal();
                    }
                });
            }


            const shareRaceBtn = document.getElementById('shareRaceBtn');
            const shareRaceModal = document.getElementById('shareRaceModal');
            const closeShareRaceModalBtn = document.getElementById('closeShareRaceModalBtn');
            const shareableLinkInput = document.getElementById('shareableLinkInput');
            const copyShareLinkBtn = document.getElementById('copyShareLinkBtn');
            const copyShareLinkFeedback = document.getElementById('copyShareLinkFeedback');

            if (shareRaceBtn) {
                shareRaceBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    if (!raceId) {
                        alert('Error: ID de la carrera no disponible.');
                        return;
                    }
                    // Optional: Show loading state
                    shareRaceBtn.disabled = true;
                    shareRaceBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generando...';

                    fetch(`/api/races/${raceId}/share_link`)
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(err => { throw new Error(err.message || `Error ${response.status}`) });
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.share_link) {
                                const fullShareLink = window.location.origin + data.share_link;
                                shareableLinkInput.value = fullShareLink;
                                shareRaceModal.style.display = 'flex';
                            } else {
                                throw new Error('No se recibió el enlace para compartir.');
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching share link:', error);
                            alert(`Error al generar el enlace: ${error.message}`);
                        })
                        .finally(() => {
                            // Hide loading state
                            shareRaceBtn.disabled = false;
                            shareRaceBtn.innerHTML = '<i class="fas fa-share-alt mr-2"></i>Compartir Carrera';
                        });
                });
            }

            if (closeShareRaceModalBtn) {
                closeShareRaceModalBtn.addEventListener('click', function() {
                    shareRaceModal.style.display = 'none';
                    copyShareLinkFeedback.style.display = 'none'; // Hide feedback on close
                });
            }

            if (copyShareLinkBtn) {
                copyShareLinkBtn.addEventListener('click', function() {
                    if (shareableLinkInput.value) {
                        navigator.clipboard.writeText(shareableLinkInput.value)
                            .then(() => {
                                copyShareLinkFeedback.style.display = 'block';
                                setTimeout(() => {
                                    copyShareLinkFeedback.style.display = 'none';
                                }, 2000); // Hide feedback after 2 seconds
                            })
                            .catch(err => {
                                console.error('Error copying to clipboard:', err);
                                alert('No se pudo copiar el enlace. Por favor, cópielo manualmente.');
                            });
                    }
                });
            }
        });

        // --- End Question Wizard Logic ---

        // --- Official Results Modal & Logic ---
            // const editOfficialResultsBtn = document.getElementById('editOfficialResultsBtn'); // Added in previous step, ensure it's declared if used here
        const setOfficialResultsBtn = document.getElementById('setOfficialResultsBtn');
        const officialResultsModal = document.getElementById('officialResultsModal');
        const closeOfficialResultsModalBtn = document.getElementById('closeOfficialResultsModalBtn');
        const cancelOfficialResultsBtn = document.getElementById('cancelOfficialResultsBtn');
        const saveOfficialResultsForm = document.getElementById('saveOfficialResultsForm');
        const officialResultsFormContent = document.getElementById('officialResultsFormContent');
        const officialResultsModalTitle = document.getElementById('officialResultsModalTitle');

        function showSetOfficialResultsButton() {
            if (setOfficialResultsBtn && (currentUserRole === 'ADMIN' || currentUserRole === 'LEAGUE_ADMIN')) {
                if (raceEventDateString) {
                    const eventDate = new Date(raceEventDateString);
                    if (eventDate < new Date()) {
                        setOfficialResultsBtn.style.display = 'inline-flex';
                    }
                }
            }
        }

        async function populateOfficialResultsForm() {
            if (!officialResultsFormContent) return;
            officialResultsFormContent.innerHTML = '<p class="text-center">Cargando preguntas...</p>';

            try {
                // Fetch all questions for the race
                const questionsResponse = await fetch(`/api/races/${raceId}/questions`);
                if (!questionsResponse.ok) throw new Error('Failed to fetch questions');
                const questions = await questionsResponse.json();

                // Fetch existing official answers
                let existingOfficialAnswers = {};
                try {
                    const officialAnswersResponse = await fetch(`/api/races/${raceId}/official_answers`);
                    if (officialAnswersResponse.ok) {
                        existingOfficialAnswers = await officialAnswersResponse.json(); // Expected: { "question_id": { answer_data... } }
                    } else if (officialAnswersResponse.status !== 404) { // 404 is fine (no answers yet)
                        console.warn('Could not fetch existing official answers, proceeding with empty form.');
                    }
                } catch (error) {
                    console.warn('Error fetching existing official answers:', error);
                }


                if (!questions || questions.length === 0) {
                    officialResultsFormContent.innerHTML = '<p class="text-center text-red-500">No hay preguntas configuradas para esta carrera.</p>';
                    return;
                }

                officialResultsFormContent.innerHTML = ''; // Clear loading message

                questions.forEach(q => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50';
                    questionDiv.dataset.questionId = q.id;
                    questionDiv.dataset.questionType = q.question_type;
                    questionDiv.dataset.isMcMultipleCorrect = q.is_mc_multiple_correct || false;


                    let inputHtml = `<h4 class="font-semibold text-gray-700 mb-2">${q.text}</h4>`;
                    const currentAnswer = existingOfficialAnswers[q.id.toString()] || {};

                    switch (q.question_type) {
                        case 'FREE_TEXT':
                            inputHtml += `<textarea name="official_answer_q${q.id}_text" class="w-full p-2 border border-gray-300 rounded-md" rows="3">${currentAnswer.answer_text || ''}</textarea>`;
                            break;
                        case 'ORDERING':
                            inputHtml += `<textarea name="official_answer_q${q.id}_ordering" class="w-full p-2 border border-gray-300 rounded-md" rows="3" placeholder="Ej: Opción C, Opción A, Opción B">${currentAnswer.ordered_options_text || ''}</textarea>`;
                            // Display options for reference
                            if (q.options && q.options.length > 0) {
                                inputHtml += '<p class="text-xs text-gray-500 mt-1">Opciones disponibles (para referencia de ordenamiento):</p><ul class="text-xs list-disc list-inside pl-4">';
                                q.options.forEach(opt => inputHtml += `<li>${opt.option_text} (ID: ${opt.id})</li>`);
                                inputHtml += '</ul>';
                            }
                            break;
                        case 'MULTIPLE_CHOICE':
                            if (q.options && q.options.length > 0) {
                                inputHtml += '<div class="space-y-2 mt-1">';
                                q.options.forEach(opt => {
                                    if (q.is_mc_multiple_correct) {
                                        const isChecked = currentAnswer.selected_option_ids?.includes(opt.id) ? 'checked' : '';
                                        inputHtml += `
                                            <label class="flex items-center space-x-2 p-1 hover:bg-gray-100 rounded">
                                                <input type="checkbox" name="official_answer_q${q.id}_option" value="${opt.id}" class="form-checkbox h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500" ${isChecked}>
                                                <span>${opt.option_text}</span>
                                            </label>`;
                                    } else {
                                        const isChecked = currentAnswer.selected_option_id == opt.id ? 'checked' : '';
                                        inputHtml += `
                                            <label class="flex items-center space-x-2 p-1 hover:bg-gray-100 rounded">
                                                <input type="radio" name="official_answer_q${q.id}_option" value="${opt.id}" class="form-radio h-4 w-4 text-orange-600 border-gray-300 focus:ring-orange-500" ${isChecked}>
                                                <span>${opt.option_text}</span>
                                            </label>`;
                                    }
                                });
                                inputHtml += '</div>';
                            } else {
                                inputHtml += '<p class="text-red-500 text-sm">No hay opciones para esta pregunta.</p>';
                            }
                            break;
                        default:
                            inputHtml += '<p class="text-red-500 text-sm">Tipo de pregunta no soportado para resultados oficiales.</p>';
                    }
                    questionDiv.innerHTML = inputHtml;
                    officialResultsFormContent.appendChild(questionDiv);
                });

            } catch (error) {
                console.error('Error populating official results form:', error);
                officialResultsFormContent.innerHTML = `<p class="text-center text-red-500">Error al cargar el formulario: ${error.message}</p>`;
            }
        }

        if (setOfficialResultsBtn) {
            setOfficialResultsBtn.addEventListener('click', () => {
                if (officialResultsModalTitle) officialResultsModalTitle.textContent = `Set Official Quiniela Results for ${raceTitle}`;
                populateOfficialResultsForm();
                if (officialResultsModal) officialResultsModal.style.display = 'flex';
            });
        }

        if (closeOfficialResultsModalBtn) {
            closeOfficialResultsModalBtn.addEventListener('click', () => {
                if (officialResultsModal) officialResultsModal.style.display = 'none';
            });
        }
        if (cancelOfficialResultsBtn) {
            cancelOfficialResultsBtn.addEventListener('click', () => {
                if (officialResultsModal) officialResultsModal.style.display = 'none';
            });
        }

        if (saveOfficialResultsForm) {
            saveOfficialResultsForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const saveButton = saveOfficialResultsForm.querySelector('button[type="submit"]');
                saveButton.disabled = true;
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';

                const payload = {};
                const questionDivs = officialResultsFormContent.querySelectorAll('div[data-question-id]');

                questionDivs.forEach(div => {
                    const questionId = div.dataset.questionId;
                    const questionType = div.dataset.questionType;
                    const isMultipleCorrect = div.dataset.isMcMultipleCorrect === 'true';
                    let answerData = {};

                    switch (questionType) {
                        case 'FREE_TEXT':
                            const ftTextarea = div.querySelector(`textarea[name="official_answer_q${questionId}_text"]`);
                            if (ftTextarea) answerData.answer_text = ftTextarea.value;
                            break;
                        case 'ORDERING':
                            const orTextarea = div.querySelector(`textarea[name="official_answer_q${questionId}_ordering"]`);
                            if (orTextarea) answerData.ordered_options_text = orTextarea.value;
                            break;
                        case 'MULTIPLE_CHOICE':
                            if (isMultipleCorrect) {
                                answerData.selected_option_ids = [];
                                div.querySelectorAll(`input[name="official_answer_q${questionId}_option"]:checked`).forEach(checkbox => {
                                    answerData.selected_option_ids.push(parseInt(checkbox.value));
                                });
                            } else {
                                const radioChecked = div.querySelector(`input[name="official_answer_q${questionId}_option"]:checked`);
                                answerData.selected_option_id = radioChecked ? parseInt(radioChecked.value) : null;
                            }
                            break;
                    }
                    payload[questionId] = answerData;
                });

                try {
                    const response = await fetch(`/api/races/${raceId}/official_answers`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}' // If CSRF needed
                        },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (response.ok) {
                        alert(result.message || 'Resultados oficiales guardados con éxito.');
                        if (officialResultsModal) officialResultsModal.style.display = 'none';
                    } else {
                        alert(`Error: ${result.body.message || 'No se pudieron guardar los resultados oficiales.'}`);
                    }
                } catch (error) {
                    console.error('Error saving official results:', error);
                    alert('Error de conexión al guardar los resultados oficiales.');
                } finally {
                    saveButton.disabled = false;
                    saveButton.innerHTML = 'Guardar Resultados Oficiales';
                }
            });
        }
        // --- End Official Results Modal & Logic ---

        // --- Display Official Results Logic ---
        async function fetchAndDisplayOfficialResults() {
            const officialResultsSection = document.getElementById('officialResultsSection');
            const officialResultsContent = document.getElementById('officialResultsContent');
            const loadingMsg = document.getElementById('loadingOfficialResultsMsg');

            if (!officialResultsSection || !officialResultsContent || !loadingMsg) {
                console.error("Official results display elements not found.");
                return;
            }

            // Ensure questions are loaded first, as we need question text
            if (allRaceQuestions.length === 0) {
                try {
                    const qResponse = await fetch(`/api/races/${raceId}/questions`);
                    if (!qResponse.ok) throw new Error('Failed to fetch questions for official results display');
                    allRaceQuestions = await qResponse.json();
                } catch (error) {
                    console.error("Error pre-fetching questions for official results:", error);
                    loadingMsg.textContent = 'Error al cargar datos de preguntas para mostrar resultados.';
                    officialResultsSection.style.display = 'block'; // Show section to display error
                    return;
                }
            }

            if (!raceEventDateString || new Date(raceEventDateString) > new Date()) {
                // Race hasn't concluded or no date available, so don't attempt to show official results.
                // The section will remain hidden by default.
                console.log("Race has not concluded or event date is not available. Official results will not be displayed.");
                return;
            }

            loadingMsg.style.display = 'block';
            officialResultsContent.innerHTML = ''; // Clear previous content (like loading message if it was there)
            officialResultsContent.appendChild(loadingMsg); // Re-add loading message for this specific fetch
            officialResultsSection.style.display = 'block'; // Show the section

            try {
                const response = await fetch(`/api/races/${raceId}/official_answers`);
                if (!response.ok) {
                    if (response.status === 403) {
                        const eventDate = new Date(raceEventDateString);
                        const formattedEventDate = eventDate.toLocaleString(); // Format to local date/time
                        loadingMsg.textContent = `Los resultados oficiales estarán disponibles después de la fecha y hora del evento: ${formattedEventDate}. Por favor, inténtalo de nuevo más tarde.`;
                        officialResultsSection.style.display = 'block'; // Ensure section is visible
                        return;
                    }
                    throw new Error(`Error ${response.status}: Failed to fetch official answers.`);
                }
                const officialAnswersData = await response.json();

                if (Object.keys(officialAnswersData).length === 0) {
                    loadingMsg.textContent = 'Los resultados oficiales aún no han sido cargados por el administrador.';
                    officialResultsSection.style.display = 'block'; // Ensure section is visible
                    return;
                }

                loadingMsg.style.display = 'none'; // Hide loading message

                for (const qIdStr in officialAnswersData) {
                    const answerInfo = officialAnswersData[qIdStr];
                    const question = allRaceQuestions.find(q => q.id.toString() === qIdStr);

                    if (!question) {
                        console.warn(`Question with ID ${qIdStr} not found in allRaceQuestions. Skipping display for this official answer.`);
                        continue;
                    }

                    const resultItemDiv = document.createElement('div');
                    resultItemDiv.className = 'p-4 border border-gray-200 rounded-lg bg-gray-50 shadow-sm';

                    let answerHtml = '';
                    switch (answerInfo.question_type) {
                        case 'FREE_TEXT':
                        case 'ORDERING':
                            answerHtml = `<p class="text-gray-800">${answerInfo.answer_text || '<em class="text-gray-500">No se proporcionó respuesta.</em>'}</p>`;
                            break;
                        case 'MULTIPLE_CHOICE':
                            if (answerInfo.selected_option_text !== undefined) { // Single choice
                                answerHtml = `<p class="text-gray-800">${answerInfo.selected_option_text || '<em class="text-gray-500">Ninguna opción seleccionada.</em>'}</p>`;
                                if (answerInfo.selected_option_id && answerInfo.selected_option_text === null) {
                                    console.warn(`Official answer for single-choice MC Question ID ${qIdStr} (text: "${question.text}") references selected_option_id ${answerInfo.selected_option_id}, but this option was not found or has no text. Check data integrity.`);
                                }
                            } else if (answerInfo.selected_options && answerInfo.selected_options.length > 0) { // Multiple choice
                                answerHtml = '<ul class="list-disc list-inside space-y-1">';
                                answerInfo.selected_options.forEach(opt => {
                                    const questionOptionExists = question.options.find(qOpt => qOpt.id === opt.option_id);
                                    if (!questionOptionExists) {
                                        console.warn(`Official answer for multi-choice MC Question ID ${qIdStr} (text: "${question.text}") includes an option_id ${opt.option_id} ("${opt.option_text}") which was not found among the question's defined options. Check data integrity.`);
                                    }
                                    answerHtml += `<li class="text-gray-800">${opt.option_text}</li>`;
                                });
                                answerHtml += '</ul>';
                            } else {
                                answerHtml = '<em class="text-gray-500">Ninguna opción seleccionada.</em>';
                            }
                            break;
                        default:
                            answerHtml = '<em class="text-red-500">Tipo de respuesta no reconocido.</em>';
                    }

                    resultItemDiv.innerHTML = `
                        <h4 class="font-semibold text-gray-700 mb-1">${question.text}</h4>
                        <div class="text-sm text-gray-500 mb-2">Respuesta Oficial:</div>
                        <div class="p-2 rounded-md bg-white border border-gray-300 min-h-[30px]">${answerHtml}</div>
                    `;
                    officialResultsContent.appendChild(resultItemDiv);
                }

            } catch (error) {
                console.error('Error fetching or displaying official results:', error);
                loadingMsg.textContent = `Se produjo un error al intentar cargar los resultados oficiales. Por favor, inténtalo de nuevo más tarde. (${error.message})`;
                officialResultsSection.style.display = 'block'; // Ensure section is visible
            }
        }
        // --- End Display Official Results Logic ---


        document.addEventListener('DOMContentLoaded', function() {
            // --- Question Wizard Logic ---
            let currentQuestionIndex = 0;
            let userWizardAnswers = {}; // Stores answers as { question_id: { ...answer_data } }

            // Wizard Modal DOM Elements
            const questionWizardModal = document.getElementById('questionWizardModal');
            const wizardQuestionProgress = document.getElementById('wizardQuestionProgress');
            const closeWizardModalBtn = document.getElementById('closeWizardModalBtn');
            const wizardQuestionText = document.getElementById('wizardQuestionText');
            const wizardAnswerOptions = document.getElementById('wizardAnswerOptions');
            const wizardPrevBtn = document.getElementById('wizardPrevBtn');
            const wizardNextBtn = document.getElementById('wizardNextBtn');
            const wizardFinishBtn = document.getElementById('wizardFinishBtn');
            const answerQuestionsBtn = document.getElementById('answerQuestionsBtn'); // This is the hero button

            console.log('DEBUG: About to define openWizard function.');
            function openWizard() {
                // If questions haven't been loaded yet (e.g. for a player who hasn't answered)
                // Ensure questions are fetched before opening the wizard.
                if (allRaceQuestions.length === 0) {
                    // Temporarily show a loading indicator for the wizard button or modal
                    const wizardTriggerButton = document.getElementById('participateInPoolBtn') || document.getElementById('answerQuestionsBtn');
                    let originalButtonText = '';
                    if (wizardTriggerButton) {
                        originalButtonText = wizardTriggerButton.innerHTML;
                        wizardTriggerButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Cargando Quiniela...';
                        wizardTriggerButton.disabled = true;
                    }

                    fetch(`/api/races/${raceId}/questions`)
                        .then(response => {
                            if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);
                            return response.json();
                        })
                        .then(questions => {
                            allRaceQuestions = questions; // Populate global questions
                            console.log('Wizard: Fetched questions inside openWizard:', allRaceQuestions);
                            if (!allRaceQuestions || allRaceQuestions.length === 0) {
                                alert("No hay preguntas disponibles para esta carrera en este momento.");
                                if (wizardTriggerButton) { // Restore button
                                    wizardTriggerButton.innerHTML = originalButtonText;
                                    wizardTriggerButton.disabled = false;
                                }
                                return;
                            }
                            // Now that questions are loaded, proceed to open wizard
                            currentQuestionIndex = 0;
                            userWizardAnswers = {}; // Reset answers
                            displayWizardQuestion(currentQuestionIndex);
                            if(questionWizardModal) questionWizardModal.style.display = 'flex';

                            // Also, if LEAGUE_ADMIN, ensure their view is updated if wizard was the first to fetch.
                            if (currentUserRole === 'LEAGUE_ADMIN') {
                                const adminQuestionsListContainer = document.getElementById('adminQuestionsViewContainer');
                                if (adminQuestionsListContainer) {
                                     renderAdminQuestionsView(allRaceQuestions);
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching questions for wizard:', error);
                            alert(`Error al cargar las preguntas de la quiniela: ${error.message}. Inténtalo de nuevo.`);
                        })
                        .finally(() => {
                            if (wizardTriggerButton) { // Restore button
                                wizardTriggerButton.innerHTML = originalButtonText;
                                wizardTriggerButton.disabled = false;
                            }
                        });
                } else {
                    // Questions are already loaded, open wizard directly
                    console.log('Wizard: Using pre-loaded questions in openWizard:', allRaceQuestions);
                    currentQuestionIndex = 0;
                    userWizardAnswers = {}; // Reset answers
                    displayWizardQuestion(currentQuestionIndex);
                    if(questionWizardModal) questionWizardModal.style.display = 'flex';

                    // If questions were pre-loaded and user is LEAGUE_ADMIN, render their view.
                    // This handles the case where fetchAndRenderQuestions() might not have been the one populating allRaceQuestions.
                    if (currentUserRole === 'LEAGUE_ADMIN') {
                         const adminQuestionsListContainer = document.getElementById('adminQuestionsViewContainer');
                         if (adminQuestionsListContainer && allRaceQuestions.length > 0) { // Ensure container and questions exist
                            renderAdminQuestionsView(allRaceQuestions);
                         }
                    }
                }
            }

            function closeWizard() {
                if(questionWizardModal) questionWizardModal.style.display = 'none';
            }

            function displayWizardQuestion(index) {
                const questionForLog = allRaceQuestions && index >= 0 && index < allRaceQuestions.length ? allRaceQuestions[index] : undefined;
                console.log('Wizard: displayWizardQuestion called. Index:', index, 'Question to display:', questionForLog);

                if(wizardAnswerOptions) wizardAnswerOptions.innerHTML = '<p class="text-center text-gray-500 py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Cargando pregunta...</p>';

                if (!allRaceQuestions || allRaceQuestions.length === 0) {
                    console.error("displayWizardQuestion called with no questions available.");
                    if(wizardQuestionText) wizardQuestionText.textContent = 'Error';
                    if(wizardAnswerOptions) wizardAnswerOptions.innerHTML = '<p class="text-red-500 text-center py-4">Error: No hay preguntas disponibles para esta carrera.</p>';
                    if(wizardNextBtn) wizardNextBtn.style.display = 'none';
                    if(wizardFinishBtn) wizardFinishBtn.style.display = 'none';
                    // Keep PrevBtn to allow user to go back if possible, or hide it too if state is unrecoverable.
                    // closeWizard(); // Or let user close manually.
                    return;
                }
                if (index < 0 || index >= allRaceQuestions.length) {
                    console.error("Invalid question index:", index);
                    if(wizardQuestionText) wizardQuestionText.textContent = 'Error';
                    if(wizardAnswerOptions) wizardAnswerOptions.innerHTML = '<p class="text-red-500 text-center py-4">Error: Índice de pregunta no válido.</p>';
                    if(wizardNextBtn) wizardNextBtn.style.display = 'none';
                    if(wizardFinishBtn) wizardFinishBtn.style.display = 'none';
                    return;
                }

                const question = allRaceQuestions[index];
                if (!question) {
                    if(wizardQuestionText) wizardQuestionText.textContent = 'Error';
                    if(wizardAnswerOptions) wizardAnswerOptions.innerHTML = '<p class="text-red-500 text-center py-4">Error: No se pudo cargar esta pregunta (datos no válidos).</p>';
                    console.error('displayWizardQuestion: question data is invalid for index', index, 'in allRaceQuestions:', allRaceQuestions);
                    if(wizardNextBtn) wizardNextBtn.style.display = 'none';
                    if(wizardFinishBtn) wizardFinishBtn.style.display = 'none';
                    return;
                }
                const existingAnswer = userWizardAnswers[question.id];

                if(wizardQuestionProgress) wizardQuestionProgress.textContent = `Pregunta ${index + 1} de ${allRaceQuestions.length}`;
                if(wizardQuestionText) wizardQuestionText.textContent = question.text;
                // Clear previous options, will be repopulated in try or error caught in catch
                if(wizardAnswerOptions) wizardAnswerOptions.innerHTML = '';

                try {
                    switch (question.question_type) {
                        case 'FREE_TEXT':
                            const textarea = document.createElement('textarea');
                        textarea.id = `wizardFreeTextAnswer_${question.id}`;
                        textarea.className = 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent';
                        textarea.rows = 4;
                        textarea.placeholder = 'Escribe tu respuesta...';
                        textarea.value = existingAnswer?.answer_text || '';
                        if (wizardAnswerOptions) wizardAnswerOptions.appendChild(textarea);
                        break;

                    case 'MULTIPLE_CHOICE':
                        if (!question.options || !Array.isArray(question.options)) {
                            throw new Error('Datos de opciones de Opción Múltiple no válidos o ausentes.');
                        }
                        question.options.forEach(opt => {
                            const label = document.createElement('label');
                            label.className = 'flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded-md border border-gray-200 hover:border-orange-300';

                            const input = document.createElement('input');
                            input.type = question.is_mc_multiple_correct ? 'checkbox' : 'radio';
                            input.name = `wizard_q_${question.id}`;
                            input.value = opt.id;
                            input.className = 'text-orange-500 focus:ring-orange-400 focus:ring-offset-0';
                            if (question.is_mc_multiple_correct) {
                                input.classList.add('rounded');
                                if (existingAnswer?.selected_option_ids?.includes(opt.id)) {
                                    input.checked = true;
                                }
                            } else {
                                if (existingAnswer?.selected_option_id == opt.id) {
                                    input.checked = true;
                                }
                            }

                            const span = document.createElement('span');
                            span.className = 'text-gray-700';
                            span.textContent = opt.option_text;

                            label.appendChild(input);
                            label.appendChild(span);
                            if (wizardAnswerOptions) wizardAnswerOptions.appendChild(label);
                        });
                        break;

                    case 'ORDERING':
                        const infoText = document.createElement('p');
                        infoText.className = 'text-sm text-gray-600 mb-2';
                        infoText.textContent = "Ordena los siguientes items. Indica tu orden en el cuadro de texto (ej: Opción C, Opción A, Opción B).";
                        if (wizardAnswerOptions) wizardAnswerOptions.appendChild(infoText);

                        const listContainer = document.createElement('div');
                        listContainer.className = 'space-y-1 mb-3 p-2 border rounded-md';
                        question.options.forEach(opt => {
                            const listItem = document.createElement('div');
                            listItem.className = 'bg-gray-100 p-2 rounded text-sm';
                            listItem.textContent = opt.option_text;
                            listContainer.appendChild(listItem);
                        });
                        if (wizardAnswerOptions) wizardAnswerOptions.appendChild(listContainer);

                        const orderingTextarea = document.createElement('textarea');
                        orderingTextarea.id = `wizardOrderingAnswer_${question.id}`;
                        orderingTextarea.className = 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent';
                        orderingTextarea.rows = 3;
                        orderingTextarea.placeholder = 'Ej: Item C, Item A, Item B';
                        orderingTextarea.value = existingAnswer?.ordered_options_text || '';
                        if (wizardAnswerOptions) wizardAnswerOptions.appendChild(orderingTextarea);
                        break;
                    default:
                        if (wizardAnswerOptions) wizardAnswerOptions.innerHTML = `<p class="text-red-500">Tipo de pregunta '${question.question_type}' no soportado en el wizard.</p>`;
                }
            } catch (e) {
                console.error('Error rendering question in wizard:', e, 'Question data:', question);
                if(wizardQuestionText) wizardQuestionText.textContent = 'Error de Visualización';
                if(wizardAnswerOptions) wizardAnswerOptions.innerHTML = '<p class="text-red-500 text-center py-4">Ocurrió un error al mostrar esta pregunta. Por favor, intente avanzar a la siguiente o reinicie la quiniela.</p>';
                // Optionally hide next/finish if error is critical for this question
                // if(wizardNextBtn) wizardNextBtn.style.display = 'none';
                // if(wizardFinishBtn) wizardFinishBtn.style.display = 'none';
            }

                if(wizardPrevBtn) wizardPrevBtn.style.display = index > 0 ? 'inline-flex' : 'none';
                if(wizardNextBtn) wizardNextBtn.style.display = index < allRaceQuestions.length - 1 ? 'inline-flex' : 'none';
                if(wizardFinishBtn) wizardFinishBtn.style.display = index === allRaceQuestions.length - 1 ? 'inline-flex' : 'none';
            }

            function saveCurrentWizardAnswer() {
                if (!allRaceQuestions || currentQuestionIndex < 0 || currentQuestionIndex >= allRaceQuestions.length) {
                    return;
                }
                const question = allRaceQuestions[currentQuestionIndex];
                if (!question) return;

                switch (question.question_type) {
                    case 'FREE_TEXT':
                        const textarea = document.getElementById(`wizardFreeTextAnswer_${question.id}`);
                        if (textarea) {
                            userWizardAnswers[question.id] = { question_id: question.id, answer_text: textarea.value.trim() };
                        }
                        break;
                    case 'MULTIPLE_CHOICE':
                        if (question.is_mc_multiple_correct) {
                            const selected_option_ids = [];
                            document.querySelectorAll(`input[name="wizard_q_${question.id}"]:checked`).forEach(cb => {
                                selected_option_ids.push(parseInt(cb.value));
                            });
                            userWizardAnswers[question.id] = { question_id: question.id, selected_option_ids: selected_option_ids };
                        } else {
                            const selectedRadio = document.querySelector(`input[name="wizard_q_${question.id}"]:checked`);
                            userWizardAnswers[question.id] = {
                                question_id: question.id,
                                selected_option_id: selectedRadio ? parseInt(selectedRadio.value) : null
                            };
                        }
                        break;
                    case 'ORDERING':
                        const orderingTextarea = document.getElementById(`wizardOrderingAnswer_${question.id}`);
                        if (orderingTextarea) {
                             userWizardAnswers[question.id] = { question_id: question.id, ordered_options_text: orderingTextarea.value.trim() };
                        }
                        break;
                }
            }

            function handleNextWizardQuestion() {
                saveCurrentWizardAnswer();
                if (currentQuestionIndex < allRaceQuestions.length - 1) {
                    currentQuestionIndex++;
                    displayWizardQuestion(currentQuestionIndex);
                }
            }

            function handlePreviousWizardQuestion() {
                saveCurrentWizardAnswer();
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    displayWizardQuestion(currentQuestionIndex);
                }
            }

            // Event Listeners for Wizard
            if (answerQuestionsBtn) {
                answerQuestionsBtn.addEventListener('click', openWizard);
            }
            if (closeWizardModalBtn) {
                closeWizardModalBtn.addEventListener('click', closeWizard);
            }
            if (wizardNextBtn) {
                wizardNextBtn.addEventListener('click', handleNextWizardQuestion);
            }
            if (wizardPrevBtn) {
                wizardPrevBtn.addEventListener('click', handlePreviousWizardQuestion);
            }
            if (wizardFinishBtn) {
                wizardFinishBtn.addEventListener('click', () => {
                    saveCurrentWizardAnswer();

                    if (Object.keys(userWizardAnswers).length === 0) {
                        alert("No has respondido ninguna pregunta aún.");
                        return;
                    }

                    wizardFinishBtn.disabled = true;
                    wizardFinishBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';

                    fetch(`/api/races/${raceId}/answers`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(userWizardAnswers)
                    })
                    .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, body: data })))
                    .then(result => {
                        if (result.ok) {
                            alert(result.body.message || '¡Respuestas guardadas con éxito!');
                            closeWizard();
                                // Update UI to reflect that user has answered
                                // This might involve hiding the "Participar" button and showing "Ya has participado"
                                // This can be done by re-evaluating the Jinja or by JS DOM manipulation
                                // For simplicity, we can reload the page to let Jinja handle it:
                                window.location.reload();
                        } else {
                            alert(`Error al guardar respuestas: ${result.body.message || `Error ${result.status}`}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error saving answers:', error);
                        alert('Error de conexión al guardar respuestas. Por favor, inténtalo de nuevo.');
                    })
                    .finally(() => {
                        wizardFinishBtn.disabled = false;
                        wizardFinishBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Finalizar y Guardar';
                    });
                });
            }
            console.log('DEBUG: openWizard function should now be defined. Typeof openWizard:', typeof openWizard);
            // --- End Question Wizard Logic ---

            // DOM Element Declarations
            const logoutButtonNav = document.getElementById('logoutButtonNav');
            showSetOfficialResultsButton(); // Call function to determine button visibility after DOM is loaded
            fetchAndDisplayOfficialResults(); // Attempt to display official results

            const participateInPoolBtn = document.getElementById('participateInPoolBtn');
            if (participateInPoolBtn) {
                participateInPoolBtn.addEventListener('click', openWizard);
            }
            // ... (rest of existing DOMContentLoaded listeners) ...

            // Initial call for LEAGUE_ADMIN if questions are already loaded (e.g. by a different mechanism or edge case)
            // This is a fallback, the primary calls are within fetchAndRenderQuestions and openWizard success paths.
            if (currentUserRole === 'LEAGUE_ADMIN' && allRaceQuestions.length > 0) {
                const adminQuestionsListContainer = document.getElementById('adminQuestionsViewContainer');
                if (adminQuestionsListContainer && !adminQuestionsListContainer.querySelector('ul')) { // Avoid re-rendering if already populated
                    // Check if adminQuestionsList is empty before rendering to avoid duplicate calls from different paths.
                    const adminList = document.getElementById('adminQuestionsList');
                    if (adminList && adminList.innerHTML.trim() === '') {
                         renderAdminQuestionsView(allRaceQuestions);
                    }
                }
            }

            // Event listener for "Edit Official Results" button
            const editOfficialResultsBtn = document.getElementById('editOfficialResultsBtn');
            if (editOfficialResultsBtn && (currentUserRole === 'ADMIN' || currentUserRole === 'LEAGUE_ADMIN')) {
                editOfficialResultsBtn.addEventListener('click', () => {
                    console.log('DEBUG: editOfficialResultsBtn clicked. Attempting to open officialResultsModal and populate form.');
                    const officialResultsModal = document.getElementById('officialResultsModal');
                    const officialResultsModalTitle = document.getElementById('officialResultsModalTitle');

                    if (officialResultsModalTitle) {
                        officialResultsModalTitle.textContent = `Editar Resultados Oficiales de Quiniela para ${raceTitle}`;
                    } else {
                        console.error('DEBUG: officialResultsModalTitle element not found');
                    }

                    populateOfficialResultsForm(); // Ensure this line is present and uncommented

                    if (officialResultsModal) {
                        officialResultsModal.style.display = 'flex';
                    } else {
                        console.error('DEBUG: officialResultsModal element not found');
                    }
                });
            }

            // Fetch Race Statistics
            if (raceId) {
                fetchAndDisplayRaceStats(raceId);
            }

        }); // Main DOMContentLoaded closing bracket
    </script>

    {% include '_official_answers_modal.html' %}

    <!-- Question Wizard Modal -->
    <div id="questionWizardModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 120;">
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-lg sm:max-w-xl md:max-w-2xl mx-auto">
            <!-- Modal Header -->
            <div class="flex justify-between items-center mb-6">
                <h2 id="wizardQuestionProgress" class="text-xl sm:text-2xl font-bold text-gray-800">Pregunta X de Y</h2>
                <button id="closeWizardModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <!-- Modal Body: Question Display Area -->
            <div id="wizardQuestionArea" class="mb-6">
                <h3 id="wizardQuestionText" class="text-lg sm:text-xl font-semibold text-gray-700 mb-4"></h3>
                <div id="wizardAnswerOptions" class="space-y-3">
                    <!-- Input fields will be dynamically inserted here by JavaScript -->
                    <!-- Example for Free Text (to be controlled by JS) -->
                    <!-- <textarea id="wizardFreeTextAnswer" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" rows="4" placeholder="Escribe tu respuesta..."></textarea> -->

                    <!-- Example for MC Single (to be controlled by JS) -->
                    <!-- <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded-md border border-gray-200 hover:border-orange-300">
                        <input type="radio" name="wizardMcOption" value="option1" class="text-orange-500 focus:ring-orange-400 focus:ring-offset-0">
                        <span class="text-gray-700">Option 1</span>
                    </label> -->

                    <!-- Example for MC Multiple (to be controlled by JS) -->
                    <!-- <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded-md border border-gray-200 hover:border-orange-300">
                        <input type="checkbox" name="wizardMcOption_multi" value="optionA" class="text-orange-500 focus:ring-orange-400 focus:ring-offset-0 rounded">
                        <span class="text-gray-700">Option A</span>
                    </label> -->

                    <!-- Example for Ordering (placeholder, actual implementation might differ) -->
                    <!-- <div id="wizardOrderingOptionsContainer" class="space-y-2">
                         <div class="bg-gray-100 p-2 rounded border">Item A (Drag me)</div>
                         <div class="bg-gray-100 p-2 rounded border">Item B (Drag me)</div>
                    </div> -->
                </div>
            </div>

            <!-- Modal Footer: Navigation -->
            <div class="flex justify-between items-center pt-6 border-t border-gray-200">
                <button id="wizardPrevBtn" class="btn btn-secondary">
                    <i class="fas fa-arrow-left mr-2"></i>Anterior
                </button>
                <button id="wizardNextBtn" class="btn btn-primary">
                    Siguiente<i class="fas fa-arrow-right ml-2"></i>
                </button>
                <button id="wizardFinishBtn" class="btn btn-primary bg-green-500 hover:bg-green-600" style="display: none;">
                    <i class="fas fa-check mr-2"></i>Finalizar y Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Question Modal -->
    {% if currentUserRole == 'ADMIN' or currentUserRole == 'LEAGUE_ADMIN' %}
    <div id="addEditQuestionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 100;">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-3xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="addEditQuestionModalTitle" class="text-2xl font-bold text-gray-800">Añadir Nueva Pregunta</h2>
                <button id="closeAddEditQuestionModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <form id="addEditQuestionForm">
                <input type="hidden" id="editingQuestionId" value="">
                <div class="mb-4">
                    <label for="questionText" class="block text-sm font-medium text-gray-700 mb-1">Texto de la Pregunta</label>
                    <textarea id="questionText" name="text" rows="3" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm" placeholder="Ej: ¿Quién ganará la carrera?"></textarea>
                </div>

                <div class="mb-4">
                    <label for="questionTypeSelect" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Pregunta</label>
                    <select id="questionTypeSelect" name="question_type" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                        <option value="FREE_TEXT">Texto Libre</option>
                        <option value="MULTIPLE_CHOICE">Opción Múltiple</option>
                        <option value="ORDERING">Ordenamiento</option>
                    </select>
                </div>

                <!-- Dynamic fields based on question type -->
                <div id="questionTypeSpecificFields" class="space-y-4 mb-4">
                    <!-- Fields for MULTIPLE_CHOICE -->
                    <div id="multipleChoiceFieldsContainer" style="display:none;" class="p-4 border border-gray-200 rounded-md">
                        <h4 class="font-semibold text-gray-700 mb-2">Opciones de Opción Múltiple:</h4>
                        <div id="mcOptionsContainer" class="space-y-2">
                            <!-- JS will add option input fields here -->
                        </div>
                        <button type="button" id="addMcOptionBtn" class="btn btn-secondary btn-sm mt-2"><i class="fas fa-plus mr-1"></i>Añadir Opción</button>
                        <div class="mt-3">
                             <label class="flex items-center">
                                <input type="checkbox" id="isMcMultipleCorrect" name="is_mc_multiple_correct" class="h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                                <span class="ml-2 text-sm text-gray-700">Permitir múltiples respuestas correctas</span>
                            </label>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                            <div>
                                <label for="pointsPerCorrectMc" class="block text-sm font-medium text-gray-700">Puntos por opción correcta (si múltiple)</label>
                                <input type="number" id="pointsPerCorrectMc" name="points_per_correct_mc" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: 10">
                            </div>
                            <div>
                                <label for="pointsPerIncorrectMc" class="block text-sm font-medium text-gray-700">Puntos por opción incorrecta (si múltiple)</label>
                                <input type="number" id="pointsPerIncorrectMc" name="points_per_incorrect_mc" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: -5">
                            </div>
                             <div>
                                <label for="totalScoreMcSingle" class="block text-sm font-medium text-gray-700">Puntuación total (si única respuesta)</label>
                                <input type="number" id="totalScoreMcSingle" name="total_score_mc_single" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: 25">
                            </div>
                        </div>
                    </div>

                    <!-- Fields for ORDERING -->
                    <div id="orderingFieldsContainer" style="display:none;" class="p-4 border border-gray-200 rounded-md">
                        <h4 class="font-semibold text-gray-700 mb-2">Items para Ordenar:</h4>
                        <div id="orderingOptionsContainer" class="space-y-2">
                            <!-- JS will add item input fields here -->
                        </div>
                        <button type="button" id="addOrderingOptionBtn" class="btn btn-secondary btn-sm mt-2"><i class="fas fa-plus mr-1"></i>Añadir Item</button>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                           <div>
                                <label for="pointsPerCorrectOrder" class="block text-sm font-medium text-gray-700">Puntos por item en posición correcta</label>
                                <input type="number" id="pointsPerCorrectOrder" name="points_per_correct_order" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: 5">
                            </div>
                            <div>
                                <label for="bonusForFullOrder" class="block text-sm font-medium text-gray-700">Bonus por orden completo correcto</label>
                                <input type="number" id="bonusForFullOrder" name="bonus_for_full_order" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: 15">
                            </div>
                        </div>
                    </div>

                    <!-- Fields for FREE_TEXT -->
                    <div id="freeTextFieldsContainer" style="display:none;" class="p-4 border border-gray-200 rounded-md">
                        <h4 class="font-semibold text-gray-700 mb-2">Configuración de Texto Libre:</h4>
                        <div>
                            <label for="maxScoreFreeText" class="block text-sm font-medium text-gray-700">Puntuación Máxima</label>
                            <input type="number" id="maxScoreFreeText" name="max_score_free_text" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: 50">
                        </div>
                        <!-- Potentially add fields for keywords, case sensitivity etc. later -->
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancelAddEditQuestionBtn" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" id="saveQuestionBtn" class="btn btn-primary">Guardar Pregunta</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Question Confirmation Modal -->
    <div id="deleteQuestionConfirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 105;">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Confirmar Eliminación</h2>
            <p class="text-gray-600 mb-6">¿Estás seguro de que quieres eliminar esta pregunta? Esta acción no se puede deshacer.</p>
            <input type="hidden" id="questionIdToDelete" value="">
            <div class="flex justify-end space-x-3">
                <button type="button" id="cancelDeleteQuestionBtn" class="btn btn-secondary">Cancelar</button>
                <button type="button" id="confirmDeleteQuestionBtn" class="btn btn-danger bg-red-600 hover:bg-red-700 text-white">Eliminar</button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Edit Answer Modal -->
    <div id="editAnswerModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 130;"> <!-- Higher z-index -->
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-lg sm:max-w-xl md:max-w-2xl mx-auto">
            <!-- Modal Header -->
            <div class="flex justify-between items-center mb-6">
                <h2 id="editAnswerModalTitle" class="text-xl sm:text-2xl font-bold text-gray-800">Editar Respuesta</h2>
                <button id="closeEditAnswerModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <!-- Modal Body: Edit Area -->
            <input type="hidden" id="editingQuestionIdStore" value="">
            <input type="hidden" id="editingUserAnswerIdStore" value="">

            <div id="editAnswerQuestionText" class="text-lg font-semibold text-gray-700 mb-4"></div>
            <div id="editAnswerOptionsArea" class="space-y-3 mb-6">
                <!-- Input fields will be dynamically inserted here -->
                <div id="editAnswerLoading" style="display: none;" class="text-center py-4">Cargando pregunta... <i class="fas fa-spinner fa-spin"></i></div>
                <div id="editAnswerError" style="display: none;" class="text-red-500 py-4"></div>
            </div>

            <!-- Modal Footer -->
            <div class="flex justify-end items-center pt-6 border-t border-gray-200 space-x-3">
                <button id="cancelEditAnswerBtn" class="btn btn-secondary">Cancelar</button>
                <button id="saveEditedAnswerBtn" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Review User Answers Modal -->
    <div id="reviewUserAnswersModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 120;">
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-lg sm:max-w-xl md:max-w-2xl mx-auto">
            <!-- Modal Header -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Mis Respuestas de la Quiniela</h2>
                <button id="closeReviewUserAnswersModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <!-- Modal Body: Answers Display Area -->
            <div id="reviewUserAnswersContentWrapper" class="space-y-4 max-h-96 overflow-y-auto mb-6">
                 <div id="reviewAnswersLoading" style="display: none;" class="text-center py-4">Cargando respuestas... <i class="fas fa-spinner fa-spin"></i></div>
                 <div id="reviewAnswersError" style="display: none;" class="text-red-500 py-4 text-center"></div>
                 <div id="reviewUserAnswersDisplayArea" class="space-y-3"> <!-- Added space-y-3 for spacing between answers -->
                    <!-- Answers will be dynamically inserted here -->
                 </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex justify-end items-center pt-6 border-t border-gray-200">
                <button id="confirmAndCloseReviewModalBtn" class="btn btn-primary">
                    Confirmar y Volver
                </button>
            </div>
        </div>
    </div>

    <!-- Participant Answers Modal -->
    <div id="participantAnswersModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center hidden" style="z-index: 140;">
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-lg sm:max-w-xl md:max-w-2xl mx-auto">
            <!-- Modal Header -->
            <div class="flex justify-between items-center mb-6 pb-3 border-b border-gray-200">
                <h2 id="participantAnswersModalTitle" class="text-xl sm:text-2xl font-bold text-gray-800">Respuestas del Participante</h2>
                <button id="closeParticipantAnswersModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <!-- Modal Body: Answers Display Area -->
            <div id="participantAnswersModalBody" class="space-y-4 max-h-96 overflow-y-auto mb-6">
                 <p>Cargando respuestas...</p>
                 <!-- Answers will be dynamically inserted here by JavaScript -->
            </div>

            <!-- Modal Footer -->
            <div class="flex justify-end items-center pt-6 border-t border-gray-200">
                <button id="closeParticipantAnswersModalFooterBtn" class="btn btn-secondary">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
    <script src="{{ url_for('static', filename='js/admin_official_answers.js') }}"></script>
</body>
</html>
