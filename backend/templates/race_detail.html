<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Triatlón - {{ race.title if race else 'Detalle de Carrera' }}</title> <!-- Dynamic Title -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --orange-primary: #FF6B35;
            --orange-light: #FF8F65;
            --orange-dark: #FF4500;
            --orange-pale: #FFB380;
            --gray-dark: #2C3E50;
            --gray-medium: #34495E;
            --gray-light: #7F8C8D;
            --blue-water: #3498DB;
            --green-run: #27AE60;
            --red-accent: #E74C3C;
        }

        * {
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }

        .hero-bg {
            background: linear-gradient(135deg, var(--orange-dark) 0%, var(--orange-primary) 50%, var(--orange-light) 100%);
            position: relative;
            overflow: hidden;
        }

        /* .hero-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><defs><pattern id="triPattern" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="25" r="2" fill="rgba(255,255,255,0.1)"/><path d="M25,75 L75,75 L50,25 Z" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23triPattern)"/></svg>') repeat;
            opacity: 0.3;
        } */

        .segment-card {
            /* transition: all 0.3s ease; */
            border-left: 4px solid var(--orange-primary);
        }

        .segment-card:hover {
            /* transform: translateY(-2px); */
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.15);
        }

        .swim-segment { border-left-color: var(--blue-water); }
        .bike-segment { border-left-color: var(--gray-dark); }
        .run-segment { border-left-color: var(--green-run); }
        .transition-segment { border-left-color: var(--orange-primary); } /* Orange for transitions */

        .question-card {
            border: 1px solid #e5e7eb; /* Tailwind gray-200 */
            border-radius: 12px;      /* Slightly larger radius */
            /* transition: all 0.3s ease; */
            background-color: white; /* Ensure questions have white background */
        }

        .question-card:hover {
            /* border-color: var(--orange-primary); */
            /* box-shadow: 0 4px 12px rgba(255, 107, 53, 0.1); */
        }

        .btn { /* Base button style */
            padding: 0.625rem 1.25rem; /* py-2.5 px-5 */
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            /* transition: all 0.3s ease; */
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--orange-primary) 0%, var(--orange-dark) 100%);
            border: none;
            color: white;
        }

        .btn-primary:hover {
            /* transform: translateY(-1px); */
            /* box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3); */
        }

        .btn-secondary {
            background-color: #E5E7EB; /* Tailwind gray-200 */
            color: var(--gray-dark);
            border: 1px solid #D1D5DB; /* Tailwind gray-300 */
        }
        .btn-secondary:hover {
            /* background-color: #D1D5DB; */
        }


        .timeline-line {
            position: relative;
        }

        /* Adjusted timeline for better responsiveness and alignment */
        /* .timeline-line::before {
            content: '';
            position: absolute;
            left: calc(1.5rem + 1px);
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, var(--blue-water), var(--gray-dark), var(--green-run));
            transform: translateX(-50%);
            z-index: -1;
        } */

        .drag-item {
            cursor: move;
            /* transition: all 0.3s ease; */
        }

        .drag-item:hover {
            background-color: #f8f9fa;
        }

        .drag-item.dragging {
            /* opacity: 0.5; */
            /* transform: rotate(5deg); */
        }

        .stats-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            /* transition: all 0.3s ease; */
        }

        .stats-card:hover {
            /* box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12); */
        }

        @media (max-width: 768px) {
            /* In mobile, make timeline vertical and align to left of segment cards */
            /* .timeline-line::before {
                left: calc(1.5rem);
            } */
            .segment-card { /* Remove margin for mobile timeline */
                margin-left: 0 !important;
            }
        }


        .expandable-content {
            max-height: 0;
            overflow: hidden;
            /* transition: max-height 0.5s ease-out; */ /* Smoother transition */
        }

        .expandable-content.expanded {
            max-height: 2000px; /* Large enough for content */
        }

        .badge-role { /* Copied from index.html for consistency */
            color: white;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
        }
        .badge-admin { background: linear-gradient(135deg, var(--red-accent) 0%, #F1948A 100%); }
        .badge-league { background: linear-gradient(135deg, var(--orange-primary) 0%, var(--orange-light) 100%); }
        .badge-player { background: linear-gradient(135deg, var(--blue-water) 0%, #5DADE2 100%); }


        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            stroke-dasharray: 251.2 251.2; /* Circumference of circle with r=40 */
            stroke-dashoffset: 251.2;
            transition: stroke-dashoffset 0.3s ease;
        }
        /* Ensure Font Awesome icons align well with text */
        .fas, .fab {
            vertical-align: -0.125em; /* default is -0.125em, adjust if needed */
        }
    </style>
</head>
<body class="text-gray-700">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <a href="{{ url_for('serve_hello_world_page') }}" class="flex items-center space-x-2">
                        <!-- LOGO_PLACEHOLDER: Replace this with your <img src='your_logo_url_here' alt='TriFantasy Logo' class='h-8 w-auto'> tag -->
                        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-orange-500 to-orange-600 flex items-center justify-center">
                            <i class="fas fa-trophy text-white text-lg"></i> <!-- Changed icon to trophy -->
                        </div>
                        <span class="text-xl font-bold text-gray-800">Fantasy Tri</span>
                    </a>
                </div>
                <div class="hidden md:flex items-center space-x-6">
                    <a href="{{ url_for('serve_hello_world_page') }}" class="text-gray-600 hover:text-orange-500 transition-colors">Dashboard</a>
                    <a href="{{ url_for('serve_hello_world_page') }}" class="text-orange-500 font-medium">Carreras</a>
                    <a href="#" class="text-gray-600 hover:text-orange-500 transition-colors">Ligas (Próx.)</a>
                    <a href="#" class="text-gray-600 hover:text-orange-500 transition-colors">Perfil (Próx.)</a>
                </div>
                <div class="flex items-center space-x-3">
                    {% if current_user and current_user.is_authenticated %}
                        {% set badge_class = 'badge-player' %} {# Default #}
                        {% if current_user.role and current_user.role.code == 'ADMIN' %}
                            {% set badge_class = 'badge-admin' %}
                        {% elif current_user.role and current_user.role.code == 'LEAGUE_ADMIN' %}
                            {% set badge_class = 'badge-league' %}
                        {% endif %}
                        <span class="badge-role {{ badge_class }} hidden sm:inline">{{ current_user.role.description if current_user.role else 'Rol no definido' }}</span>
                        <span class="text-sm text-gray-700 hidden sm:inline">{{ current_user.username }}</span>
                         <button id="logoutButtonNav" class="text-gray-600 hover:text-orange-500 transition-colors">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    {% else %}
                        <a href="{{ url_for('serve_login_page') }}" class="text-gray-600 hover:text-orange-500 transition-colors">Login</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero-bg text-white py-12 md:py-16 lg:py-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col lg:flex-row items-center justify-between">
                <div class="flex-1 text-center lg:text-left mb-6 lg:mb-0">
                    <div class="flex flex-wrap justify-center lg:justify-start gap-2 mb-3">
                        <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-xs sm:text-sm">{{ race.race_format.name | default('Formato no especificado') }}</span>
                        <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-xs sm:text-sm">{{ race.gender_category | default('N/A') }}</span>
                        <!-- Example status badge - make dynamic later if needed -->
                        <span class="bg-green-500 px-3 py-1 rounded-full text-xs sm:text-sm">Activa</span>
                    </div>
                    <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold mb-3">{{ race.title | default('Título de la Carrera no Disponible') }}</h1>
                    <p class="text-lg sm:text-xl mb-5 opacity-90">{{ race.description | truncate(150) if race.description else 'Descripción no disponible.' }}</p>
                    <div class="flex flex-wrap justify-center lg:justify-start gap-x-4 gap-y-2 text-sm mb-6">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-calendar"></i>
                            <span>{{ race.event_date.strftime('%d %B, %Y %H:%M') if race.event_date else 'Fecha no especificada' }}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>{{ race.location if race.location else 'Ubicación no especificada' }}</span>
                        </div>
                    </div>
                    <div class="flex flex-wrap justify-center lg:justify-start gap-3">
                        <button class="btn btn-primary px-5 py-2.5 sm:px-6 sm:py-3">
                            <i class="fas fa-play mr-2"></i>Participar (Próx.)
                        </button>
                        <button class="bg-white bg-opacity-20 px-5 py-2.5 sm:px-6 sm:py-3 rounded-lg font-semibold hover:bg-opacity-30 transition-colors">
                            <i class="fas fa-heart mr-2"></i>Favorito (Próx.)
                        </button>
                        {% if currentUserRole == 'ADMIN' or currentUserRole == 'LEAGUE_ADMIN' %}
                        <button id="openEditRaceModalBtn" class="btn btn-secondary px-5 py-2.5 sm:px-6 sm:py-3">
                            <i class="fas fa-edit mr-2"></i>Editar Detalles Carrera
                        </button>
                        <button id="deleteRaceBtn" class="btn bg-red-600 hover:bg-red-700 text-white px-5 py-2.5 sm:px-6 sm:py-3">
                            <i class="fas fa-trash-alt mr-2"></i>Eliminar Carrera
                        </button>
                        <button id="shareRaceBtn" class="btn bg-blue-500 hover:bg-blue-600 text-white px-5 py-2.5 sm:px-6 sm:py-3">
                            <i class="fas fa-share-alt mr-2"></i>Compartir Carrera
                        </button>
                        {% endif %}
                        <button id="answerQuestionsBtn" class="btn btn-primary bg-green-500 hover:bg-green-600 px-5 py-2.5 sm:px-6 sm:py-3" style="display: none;">
                            <i class="fas fa-tasks mr-2"></i>Responder Preguntas
                        </button>
                    </div>
                </div>
                {% if race.promo_image_url %}
                <div class="flex-shrink-0 lg:ml-12 mt-6 lg:mt-0">
                    <img src="{{ race.promo_image_url }}" alt="Imagen de {{ race.title }}" class="rounded-lg shadow-xl w-full max-w-md lg:max-w-sm object-cover h-64 lg:h-auto">
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Race Full Description (if different from hero) -->
                {% if race.description and race.description|length > 150 %}
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Descripción Detallada</h2>
                    <p class="text-gray-600 leading-relaxed whitespace-pre-line">{{ race.description }}</p>
                </div>
                {% endif %}

                <!-- Race Segments -->
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Segmentos de la Carrera</h2>
                    {% if race.segment_details and race.segment_details|length > 0 %}
                    <div class="timeline-line space-y-6 relative">
                        {% for detail in race.segment_details %}
                            {% if detail.segment %}
                                {% set segment_name = detail.segment.name %}
                                {% set segment_name_lower = segment_name.lower() %}
                                {% set border_color_class = 'transition-segment' %}
                                {% set icon_bg_color = 'bg-orange-500' %}
                                {% set text_color = 'text-orange-500' %}
                                {% set segment_icon = 'fa-exchange-alt' %}

                                {% if 'natación' in segment_name_lower or 'swim' in segment_name_lower %}
                                    {% set border_color_class = 'swim-segment' %}
                                    {% set icon_bg_color = 'bg-blue-500' %}
                                    {% set text_color = 'text-blue-500' %}
                                    {% set segment_icon = 'fa-swimmer' %}
                                {% elif 'ciclismo' in segment_name_lower or 'bike' in segment_name_lower %}
                                    {% set border_color_class = 'bike-segment' %}
                                    {% set icon_bg_color = 'bg-gray-700' %}
                                    {% set text_color = 'text-gray-700' %}
                                    {% set segment_icon = 'fa-biking' %}
                                {% elif 'carrera' in segment_name_lower or 'running' in segment_name_lower or 'run' in segment_name_lower %}
                                    {% set border_color_class = 'run-segment' %}
                                    {% set icon_bg_color = 'bg-green-500' %}
                                    {% set text_color = 'text-green-500' %}
                                    {% set segment_icon = 'fa-running' %}
                                {% endif %}

                            <!-- Segment Card -->
                            <div class="segment-card {{ border_color_class }} bg-white p-4 rounded-lg shadow-md ml-0 md:ml-6 relative pl-16 md:pl-4">
                                <div class="absolute left-0 top-1/2 transform -translate-y-1/2 -translate-x-1/2 md:-translate-x-1/2 w-12 h-12 {{ icon_bg_color }} rounded-full flex items-center justify-center border-4 border-white">
                                    <i class="fas {{ segment_icon }} text-white text-lg"></i>
                                </div>
                                <div class="flex items-center space-x-4 ml-8 md:ml-10">
                                    <div class="flex-1">
                                        <h3 class="font-bold text-gray-800">{{ segment_name }}</h3>
                                        <p class="text-gray-600 text-sm">{{ detail.distance_km }} km</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold {{ text_color }}">{{ detail.distance_km }} KM</div>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                                <div class="segment-card bg-white p-4 rounded-lg shadow-md ml-0 md:ml-6 relative pl-16 md:pl-4">
                                    <p class="text-red-500">Error: Datos del segmento incompletos.</p>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-gray-500">No hay detalles de segmentos para esta carrera.</p>
                    {% endif %}
                </div>

                <!-- Prediction Questions -->
                <div id="predictionQuestionsSection" class="bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Preguntas de Predicción</h2>
                        <div class="flex items-center space-x-4">
                            {% if currentUserRole == 'ADMIN' or currentUserRole == 'LEAGUE_ADMIN' %}
                            <button id="addNewQuestionBtn" class="btn btn-primary text-sm px-4 py-2">
                                <i class="fas fa-plus mr-2"></i>Añadir Pregunta
                            </button>
                            {% endif %}
                            <button onclick="toggleQuestions()" id="toggleQuestionsBtn" class="text-orange-500 hover:text-orange-600 font-medium">
                                <i id="expandIcon" class="fas fa-chevron-down mr-1"></i>Ver Preguntas
                            </button>
                        </div>
                    </div>
                    <div id="questionsLoading" class="text-center py-4">Cargando preguntas...</div>
                    <div id="questionsError" class="text-center py-4 text-red-600" style="display:none;"></div>
                    <div id="questionsContent" class="expandable-content space-y-6">
                        <!-- Questions will be rendered here by JavaScript -->
                    </div>
                    <div id="noQuestionsMessage" class="text-center py-6 text-gray-500" style="display:none;">
                        <i class="fas fa-question-circle text-3xl mb-3"></i>
                        <p>No hay preguntas de predicción para esta carrera todavía.</p>
                    </div>
                </div>

            </div>

            <!-- Sidebar -->
            <aside class="space-y-6 lg:sticky lg:top-24 self-start"> <!-- Added self-start for sticky behavior -->
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <h3 class="font-bold text-gray-800 mb-4">Organizador</h3>
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-user-tie text-orange-500 text-xl"></i>
                        </div>
                        <div>
                                <div class="font-semibold text-gray-800">{{ race.user.username if race.user else 'N/A' }}</div>
                            <!-- <div class="text-sm text-gray-600">Rol del organizador</div> Placeholder -->
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <h3 class="font-bold text-gray-800 mb-4">Estadísticas de la Carrera (Próx.)</h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between items-center"><span class="text-gray-600">Participantes:</span> <span class="font-semibold text-gray-800">N/A</span></div>
                        <div class="flex justify-between items-center"><span class="text-gray-600">Predicciones:</span> <span class="font-semibold text-green-600">N/A</span></div>
                        <div class="flex justify-between items-center"><span class="text-gray-600">Tiempo Restante:</span> <span class="font-semibold text-orange-600">N/A</span></div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <h3 class="font-bold text-gray-800 mb-4">Enlaces Rápidos (Próx.)</h3>
                    <div class="space-y-2">
                        <a href="#" class="flex items-center space-x-2 text-sm text-gray-600 hover:text-orange-500"><i class="fas fa-info-circle w-4"></i><span>Reglamento</span></a>
                        <a href="#" class="flex items-center space-x-2 text-sm text-gray-600 hover:text-orange-500"><i class="fas fa-map w-4"></i><span>Mapa</span></a>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p>&copy; {{ current_year }} Fantasy Tri. Todos los derechos reservados.</p>
        </div>
    </footer>

    <!-- Share Race Modal -->
    <div id="shareRaceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 110;">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">Compartir Enlace de Carrera</h2>
                <button id="closeShareRaceModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div class="mb-4">
                <label for="shareableLinkInput" class="block text-sm font-medium text-gray-700 mb-1">Enlace Compartible:</label>
                <input type="text" id="shareableLinkInput" readonly class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-gray-100 rounded-md shadow-sm sm:text-sm">
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" id="copyShareLinkBtn" class="btn btn-primary">Copiar Enlace</button>
            </div>
            <p id="copyShareLinkFeedback" class="text-sm text-green-600 mt-2" style="display:none;">¡Enlace copiado!</p>
        </div>
    </div>

    <!-- Edit Race Details Modal -->
    {% if currentUserRole == 'ADMIN' or currentUserRole == 'LEAGUE_ADMIN' %}
    <div id="editRaceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 100;">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Editar Detalles de la Carrera</h2>
                <button id="closeEditRaceModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <form id="editRaceForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="raceTitle" class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                        <input type="text" id="raceTitle" name="title" value="{{ race.title | default('') }}" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="raceLocation" class="block text-sm font-medium text-gray-700 mb-1">Ubicación</label>
                        <input type="text" id="raceLocation" name="location" value="{{ race.location | default('') }}" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                    </div>
                </div>
                <div class="mb-6"> <!-- New field for Category -->
                    <label for="raceCategory" class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                    <input type="text" id="raceCategory" name="category" value="{{ race.category | default('Elite') }}" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm" placeholder="Ej: Elite, Sub-23, General">
                </div>
                <div class="mb-6">
                    <label for="raceDescription" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                    <textarea id="raceDescription" name="description" rows="4" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">{{ race.description | default('') }}</textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="raceEventDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha y Hora del Evento</label>
                        <input type="datetime-local" id="raceEventDate" name="event_date" value="{{ race.event_date.strftime('%Y-%m-%dT%H:%M') if race.event_date else '' }}" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="raceGenderCategory" class="block text-sm font-medium text-gray-700 mb-1">Categoría de Género</label>
                        <select id="raceGenderCategory" name="gender_category" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                            <option value="MIXED" {% if race.gender_category == 'MIXED' %}selected{% endif %}>Mixta</option>
                            <option value="MALE_ONLY" {% if race.gender_category == 'MALE_ONLY' %}selected{% endif %}>Solo Hombres</option>
                            <option value="FEMALE_ONLY" {% if race.gender_category == 'FEMALE_ONLY' %}selected{% endif %}>Solo Mujeres</option>
                            <option value="OTHER" {% if race.gender_category == 'OTHER' %}selected{% endif %}>Otra</option>
                        </select>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="racePromoImageUrl" class="block text-sm font-medium text-gray-700 mb-1">URL Imagen Promocional</label>
                    <input type="url" id="racePromoImageUrl" name="promo_image_url" value="{{ race.promo_image_url | default('') }}" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm" placeholder="https://ejemplo.com/imagen.jpg">
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelEditRaceBtn" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" id="saveRaceChangesBtn" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <script>
        const raceId = "{{ race.id | default('') }}";
        const currentUserRole = "{{ current_user.role.code if current_user and current_user.is_authenticated and current_user.role else 'GUEST' }}";
        const isUserRegisteredForRace = {{ is_user_registered_for_race | tojson }};
        let allRaceQuestions = [];
        let isFetchingQuestions = false;

        // Global Helper Functions
        function toggleQuestions() {
            const questionsContentElem = document.getElementById('questionsContent');
            const expandIconElem = document.getElementById('expandIcon');
            const toggleQuestionsBtnElem = document.getElementById('toggleQuestionsBtn');

            if (questionsContentElem.classList.contains('expanded')) {
                questionsContentElem.classList.remove('expanded');
                if(expandIconElem) expandIconElem.classList.replace('fa-chevron-up', 'fa-chevron-down');
                if(toggleQuestionsBtnElem) toggleQuestionsBtnElem.innerHTML = '<i id="expandIcon" class="fas fa-chevron-down mr-1"></i>Ver Preguntas';
            } else {
                questionsContentElem.classList.add('expanded');
                if(expandIconElem) expandIconElem.classList.replace('fa-chevron-down', 'fa-chevron-up');
                if(toggleQuestionsBtnElem) toggleQuestionsBtnElem.innerHTML = '<i id="expandIcon" class="fas fa-chevron-up mr-1"></i>Ocultar Preguntas';
            }
        }

        function formatScoringInfoForDisplay(question) {
            let scoringText = '';
            switch (question.question_type) {
                case 'FREE_TEXT':
                    scoringText = `Máx. ${question.max_score_free_text || 'N/A'} pts.`;
                    break;
                case 'MULTIPLE_CHOICE':
                    if (question.is_mc_multiple_correct) {
                        scoringText = `Selección Múltiple. ${question.points_per_correct_mc || 'N/A'} pts/correcta, ${question.points_per_incorrect_mc || '0'} pts/incorrecta.`;
                    } else {
                        scoringText = `Selección Única. ${question.total_score_mc_single || 'N/A'} pts total.`;
                    }
                    break;
                case 'ORDERING':
                    scoringText = `Ordenamiento. ${question.points_per_correct_order || 'N/A'} pts/item, ${question.bonus_for_full_order || '0'} pts bonus.`;
                    break;
                default:
                    scoringText = 'Puntuación no especificada.';
            }
            return `<span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">${scoringText}</span>`;
        }

        function renderQuestions(questions) {
            const questionsLoadingDivElem = document.getElementById('questionsLoading');
            const questionsContentElem = document.getElementById('questionsContent');
            const noQuestionsMessageDivElem = document.getElementById('noQuestionsMessage');
            const currentToggleQuestionsBtnElem = document.getElementById('toggleQuestionsBtn');
            const currentSubmitPredictionsContainerElem = document.getElementById('submitPredictionsContainer');

            if(questionsLoadingDivElem) questionsLoadingDivElem.style.display = 'none';
            if(questionsContentElem) questionsContentElem.innerHTML = '';

            allRaceQuestions = questions;

            if (!questions || questions.length === 0) {
                if(noQuestionsMessageDivElem) noQuestionsMessageDivElem.style.display = 'block';
                if(currentToggleQuestionsBtnElem) {
                    currentToggleQuestionsBtnElem.innerHTML = '<i id="expandIcon" class="fas fa-info-circle mr-1"></i>No hay preguntas';
                }
                if(questionsContentElem) questionsContentElem.classList.remove('expanded');
                if(currentSubmitPredictionsContainerElem) currentSubmitPredictionsContainerElem.classList.add('hidden');
                return;
            }

            if(noQuestionsMessageDivElem) noQuestionsMessageDivElem.style.display = 'none';

            questions.forEach(q => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card p-5';
                let optionsHtml = '';
                if (q.question_type === 'MULTIPLE_CHOICE') {
                    optionsHtml += '<div class="space-y-2 mt-3">';
                    q.options.forEach(opt => {
                        const inputType = q.is_mc_multiple_correct ? 'checkbox' : 'radio';
                        optionsHtml += `
                            <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded-md border border-gray-200 hover:border-orange-300">
                                <input type="${inputType}" name="question_${q.id}" value="${opt.id}" class="text-orange-500 focus:ring-orange-400 focus:ring-offset-0">
                                <span class="text-gray-700">${opt.option_text}</span>
                            </label>
                        `;
                    });
                    optionsHtml += '</div>';
                } else if (q.question_type === 'FREE_TEXT') {
                    optionsHtml = `
                        <textarea class="w-full p-3 mt-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                  rows="3" placeholder="Escribe tu predicción..."></textarea>
                        <div class="flex justify-between items-center mt-1 text-xs text-gray-500">
                            <span>Texto libre</span>
                            <span>0/200 caracteres</span>
                        </div>
                    `;
                } else if (q.question_type === 'ORDERING') {
                     optionsHtml += '<div id="sortableList_' + q.id + '" class="space-y-2 mt-3">';
                     q.options.forEach(opt => {
                        optionsHtml += `
                            <div class="drag-item bg-gray-50 p-3 rounded-lg border-2 border-gray-200 cursor-move flex items-center justify-between">
                                <span class="text-gray-700">${opt.option_text}</span>
                                <i class="fas fa-grip-vertical text-gray-400"></i>
                            </div>
                        `;
                     });
                     optionsHtml += '</div>';
                }

                questionCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-semibold text-gray-800 flex-1 pr-2">${q.text} ${q.is_active ? '' : '<span class="text-red-500 text-xs font-normal">(Inactiva)</span>'}</h3>
                        ${formatScoringInfoForDisplay(q)}
                    </div>
                    ${optionsHtml}
                    <div class="flex justify-between items-center mt-4">
                        <div class="text-xs text-gray-500">${q.question_type.replace('_', ' ').toLowerCase()}</div>
                        {% if currentUserRole == 'ADMIN' or currentUserRole == 'LEAGUE_ADMIN' %}
                        <div class="space-x-2">
                            <button id="editQuestionBtn_${q.id}" class="text-blue-500 hover:text-blue-700 text-sm font-medium">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button id="deleteQuestionBtn_${q.id}" class="text-red-500 hover:text-red-700 text-sm font-medium">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                        {% endif %}
                    </div>
                `;
                if(questionsContentElem) questionsContentElem.appendChild(questionCard);

                if (currentUserRole === 'ADMIN' || currentUserRole === 'LEAGUE_ADMIN') {
                    const editBtn = document.getElementById(`editQuestionBtn_${q.id}`);
                    if (editBtn) {
                        editBtn.addEventListener('click', () => openEditQuestionModal(q.id));
                    }
                    const deleteBtn = document.getElementById(`deleteQuestionBtn_${q.id}`);
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', () => openDeleteConfirmModal(q.id));
                    }
                }
            });

            if(questionsContentElem) questionsContentElem.classList.add('expanded');
            if(currentToggleQuestionsBtnElem) {
                currentToggleQuestionsBtnElem.innerHTML = `<i id="expandIcon" class="fas fa-chevron-up mr-1"></i>Ocultar Preguntas (${questions.length})`;
            }
            if(currentSubmitPredictionsContainerElem) currentSubmitPredictionsContainerElem.classList.remove('hidden');
        }

        function fetchAndRenderQuestions() {
            const questionsLoadingDivElem = document.getElementById('questionsLoading');
            const questionsErrorDivElem = document.getElementById('questionsError');
            const noQuestionsMessageDivElem = document.getElementById('noQuestionsMessage');

            if(!raceId || !document.getElementById('predictionQuestionsSection')) return;

            if (isFetchingQuestions) return;
            isFetchingQuestions = true;

            if(questionsLoadingDivElem) questionsLoadingDivElem.style.display = 'block';
            if(questionsErrorDivElem) questionsErrorDivElem.style.display = 'none';
            if(noQuestionsMessageDivElem) noQuestionsMessageDivElem.style.display = 'none';

            fetch(`/api/races/${raceId}/questions`)
                .then(response => {
                    if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);
                    return response.json();
                })
                .then(questions => {
                    allRaceQuestions = questions;
                    renderQuestions(questions);
                })
                .catch(error => {
                    console.error('Error fetching questions:', error);
                    if(questionsLoadingDivElem) questionsLoadingDivElem.style.display = 'none';
                    if(questionsErrorDivElem) {
                        questionsErrorDivElem.textContent = `Error al cargar preguntas: ${error.message}.`;
                        questionsErrorDivElem.style.display = 'block';
                    }
                })
                .finally(() => {
                    isFetchingQuestions = false;
                    // Check to display Answer Questions button after questions are fetched
                    const answerQuestionsBtn = document.getElementById('answerQuestionsBtn');
                    if (answerQuestionsBtn && isUserRegisteredForRace && allRaceQuestions && allRaceQuestions.length > 0) {
                        answerQuestionsBtn.style.display = 'inline-flex'; // Or 'block' or other appropriate display style
                    }
                });
        }

        function handleQuestionTypeChange() {
            const mcFieldsContainer = document.getElementById('multipleChoiceFieldsContainer');
            const oFieldsContainer = document.getElementById('orderingFieldsContainer');
            const ftFieldsContainer = document.getElementById('freeTextFieldsContainer');
            const qTypeSelect = document.getElementById('questionTypeSelect');

            if (!mcFieldsContainer || !oFieldsContainer || !ftFieldsContainer || !qTypeSelect) return;
            mcFieldsContainer.style.display = 'none';
            oFieldsContainer.style.display = 'none';
            ftFieldsContainer.style.display = 'none';

            const selectedType = qTypeSelect.value;
            if (selectedType === 'MULTIPLE_CHOICE') {
                mcFieldsContainer.style.display = 'block';
            } else if (selectedType === 'ORDERING') {
                oFieldsContainer.style.display = 'block';
            } else if (selectedType === 'FREE_TEXT') {
                ftFieldsContainer.style.display = 'block';
            }
        }

        function resetAddEditQuestionForm() {
            const form = document.getElementById('addEditQuestionForm');
            const editingIdInput = document.getElementById('editingQuestionId');
            const qTypeSelect = document.getElementById('questionTypeSelect');
            const mcOptContainer = document.getElementById('mcOptionsContainer');
            const oOptContainer = document.getElementById('orderingOptionsContainer');
            const ptsPerCorrectMc = document.getElementById('pointsPerCorrectMc');
            const ptsPerIncorrectMc = document.getElementById('pointsPerIncorrectMc');
            const totalScoreMc = document.getElementById('totalScoreMcSingle');
            const ptsPerCorrectOrd = document.getElementById('pointsPerCorrectOrder');
            const bonusFullOrd = document.getElementById('bonusForFullOrder');
            const maxScoreFt = document.getElementById('maxScoreFreeText');

            if(form) form.reset();
            if(editingIdInput) editingIdInput.value = '';
            if(qTypeSelect) qTypeSelect.disabled = false;
            if(mcOptContainer) mcOptContainer.innerHTML = '';
            if(oOptContainer) oOptContainer.innerHTML = '';
            if(ptsPerCorrectMc) ptsPerCorrectMc.value = '';
            if(ptsPerIncorrectMc) ptsPerIncorrectMc.value = '';
            if(totalScoreMc) totalScoreMc.value = '';
            if(ptsPerCorrectOrd) ptsPerCorrectOrd.value = '';
            if(bonusFullOrd) bonusFullOrd.value = '';
            if(maxScoreFt) maxScoreFt.value = '';
            if(qTypeSelect) handleQuestionTypeChange();
        }

        function createOptionInputDiv(optionText = "", optionId = null, isCorrect = false, questionType = "MULTIPLE_CHOICE") {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'flex items-center space-x-2 mb-2';
            const textInput = document.createElement('input');
            textInput.type = 'text';
            textInput.className = 'mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm sm:text-sm flex-grow';
            textInput.value = optionText;
            textInput.placeholder = (questionType === "ORDERING") ? "Texto del ítem" : "Texto de la opción";
            optionDiv.appendChild(textInput);
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'text-red-500 hover:text-red-700';
            removeBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
            removeBtn.onclick = () => optionDiv.remove();
            optionDiv.appendChild(removeBtn);
            return optionDiv;
        }

        function openAddQuestionModal() {
            const modal = document.getElementById('addEditQuestionModal');
            const title = document.getElementById('addEditQuestionModalTitle');
            const editingIdInput = document.getElementById('editingQuestionId');
            const form = document.getElementById('addEditQuestionForm');
            const mcOptContainer = document.getElementById('mcOptionsContainer');
            const oOptContainer = document.getElementById('orderingOptionsContainer');
            const qTypeSelect = document.getElementById('questionTypeSelect');

            if (!modal) return;
            if(editingIdInput) editingIdInput.value = '';
            if(title) title.textContent = 'Añadir Nueva Pregunta';
            if(form) form.reset();
            if(mcOptContainer) mcOptContainer.innerHTML = '';
            if(oOptContainer) oOptContainer.innerHTML = '';
            if(qTypeSelect) handleQuestionTypeChange();
            const currentSelectedType = qTypeSelect ? qTypeSelect.value : null;
            if (currentSelectedType === 'MULTIPLE_CHOICE' && mcOptContainer) {
                mcOptContainer.appendChild(createOptionInputDiv("", null, false, "MULTIPLE_CHOICE"));
                mcOptContainer.appendChild(createOptionInputDiv("", null, false, "MULTIPLE_CHOICE"));
            } else if (currentSelectedType === 'ORDERING' && oOptContainer) {
                oOptContainer.appendChild(createOptionInputDiv("", null, false, "ORDERING"));
                oOptContainer.appendChild(createOptionInputDiv("", null, false, "ORDERING"));
            }
            modal.style.display = 'flex';
        }

        function openEditQuestionModal(questionId) {
            const modal = document.getElementById('addEditQuestionModal');
            const title = document.getElementById('addEditQuestionModalTitle');
            const editingIdInput = document.getElementById('editingQuestionId');
            const qTextInput = document.getElementById('questionText');
            const qTypeSelect = document.getElementById('questionTypeSelect');
            const maxScoreFtInput = document.getElementById('maxScoreFreeText');
            const isMcMultiCorrectCb = document.getElementById('isMcMultipleCorrect');
            const ptsPerCorrectMc = document.getElementById('pointsPerCorrectMc');
            const ptsPerIncorrectMc = document.getElementById('pointsPerIncorrectMc');
            const totalScoreMcSingle = document.getElementById('totalScoreMcSingle');
            const mcOptContainer = document.getElementById('mcOptionsContainer');
            const ptsPerCorrectOrd = document.getElementById('pointsPerCorrectOrder');
            const bonusForFullOrd = document.getElementById('bonusForFullOrder');
            const oOptContainer = document.getElementById('orderingOptionsContainer');

            if (!modal || !allRaceQuestions) return;
            const question = allRaceQuestions.find(q => q.id === questionId);
            if (!question) {
                alert('Error: No se encontró la pregunta para editar.');
                return;
            }
            resetAddEditQuestionForm();
            if(title) title.textContent = 'Editar Pregunta';
            if(editingIdInput) editingIdInput.value = question.id;
            if(qTextInput) qTextInput.value = question.text;
            if(qTypeSelect) {
                qTypeSelect.value = question.question_type;
                qTypeSelect.disabled = true;
            }
            handleQuestionTypeChange();
            if (question.question_type === 'FREE_TEXT') {
                if(maxScoreFtInput) maxScoreFtInput.value = question.max_score_free_text !== null ? question.max_score_free_text : '';
            } else if (question.question_type === 'MULTIPLE_CHOICE') {
                if(isMcMultiCorrectCb) isMcMultiCorrectCb.checked = question.is_mc_multiple_correct;
                if(ptsPerCorrectMc) ptsPerCorrectMc.value = question.points_per_correct_mc !== null ? question.points_per_correct_mc : '';
                if(ptsPerIncorrectMc) ptsPerIncorrectMc.value = question.points_per_incorrect_mc !== null ? question.points_per_incorrect_mc : '';
                if(totalScoreMcSingle) totalScoreMcSingle.value = question.total_score_mc_single !== null ? question.total_score_mc_single : '';
                if(mcOptContainer) {
                    mcOptContainer.innerHTML = '';
                    question.options.forEach(opt => {
                        mcOptContainer.appendChild(createOptionInputDiv(opt.option_text, opt.id, false, "MULTIPLE_CHOICE"));
                    });
                }
            } else if (question.question_type === 'ORDERING') {
                if(ptsPerCorrectOrd) ptsPerCorrectOrd.value = question.points_per_correct_order !== null ? question.points_per_correct_order : '';
                if(bonusForFullOrd) bonusForFullOrd.value = question.bonus_for_full_order !== null ? question.bonus_for_full_order : '';
                if(oOptContainer) {
                    oOptContainer.innerHTML = '';
                    question.options.forEach(opt => {
                        oOptContainer.appendChild(createOptionInputDiv(opt.option_text, opt.id, false, "ORDERING"));
                    });
                }
            }
            modal.style.display = 'flex';
        }

        function closeAddEditQuestionModal() {
            const modal = document.getElementById('addEditQuestionModal');
            const qTypeSelect = document.getElementById('questionTypeSelect');
            if (!modal) return;
            modal.style.display = 'none';
            if(qTypeSelect) qTypeSelect.disabled = false;
        }

        function openDeleteConfirmModal(questionId) {
            const modal = document.getElementById('deleteQuestionConfirmModal');
            const input = document.getElementById('questionIdToDelete');
            if(!modal) return;
            if(input) input.value = questionId;
            modal.style.display = 'flex';
        }

        function closeDeleteConfirmModal() {
            const modal = document.getElementById('deleteQuestionConfirmModal');
            if(!modal) return;
            modal.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function() {
            // DOM Element Declarations
            const logoutButtonNav = document.getElementById('logoutButtonNav');
            const questionsContent = document.getElementById('questionsContent');
            const expandIcon = document.getElementById('expandIcon');
            const toggleQuestionsBtn = document.getElementById('toggleQuestionsBtn');
            const submitPredictionsContainer = document.getElementById('submitPredictionsContainer');
            const questionsLoadingDiv = document.getElementById('questionsLoading');
            const questionsErrorDiv = document.getElementById('questionsError');
            const noQuestionsMessageDiv = document.getElementById('noQuestionsMessage');

            const addEditQuestionModal = document.getElementById('addEditQuestionModal');
            const addNewQuestionBtn = document.getElementById('addNewQuestionBtn');
            const closeAddEditQuestionModalBtn = document.getElementById('closeAddEditQuestionModalBtn');
            const cancelAddEditQuestionBtn = document.getElementById('cancelAddEditQuestionBtn');
            const addEditQuestionForm = document.getElementById('addEditQuestionForm');
            const saveQuestionBtn = document.getElementById('saveQuestionBtn');
            const addEditQuestionModalTitle = document.getElementById('addEditQuestionModalTitle');
            const editingQuestionIdInput = document.getElementById('editingQuestionId');

            const questionTextInput = document.getElementById('questionText');
            const questionTypeSelect = document.getElementById('questionTypeSelect');
            const multipleChoiceFieldsContainer = document.getElementById('multipleChoiceFieldsContainer');
            const orderingFieldsContainer = document.getElementById('orderingFieldsContainer');
            const freeTextFieldsContainer = document.getElementById('freeTextFieldsContainer');
            const mcOptionsContainer = document.getElementById('mcOptionsContainer');
            const addMcOptionBtn = document.getElementById('addMcOptionBtn');
            const isMcMultipleCorrectCheckbox = document.getElementById('isMcMultipleCorrect');
            const pointsPerCorrectMcInput = document.getElementById('pointsPerCorrectMc');
            const pointsPerIncorrectMcInput = document.getElementById('pointsPerIncorrectMc');
            const totalScoreMcSingleInput = document.getElementById('totalScoreMcSingle');
            const orderingOptionsContainer = document.getElementById('orderingOptionsContainer');
            const addOrderingOptionBtn = document.getElementById('addOrderingOptionBtn');
            const pointsPerCorrectOrderInput = document.getElementById('pointsPerCorrectOrder');
            const bonusForFullOrderInput = document.getElementById('bonusForFullOrder');
            const maxScoreFreeTextInput = document.getElementById('maxScoreFreeText');

            const deleteQuestionConfirmModal = document.getElementById('deleteQuestionConfirmModal');
            const questionIdToDeleteInput = document.getElementById('questionIdToDelete');
            const cancelDeleteQuestionBtn = document.getElementById('cancelDeleteQuestionBtn');
            const confirmDeleteQuestionBtn = document.getElementById('confirmDeleteQuestionBtn');

            const editRaceModal = document.getElementById('editRaceModal');
            const openEditRaceModalBtn = document.getElementById('openEditRaceModalBtn');
            const closeEditRaceModalBtn = document.getElementById('closeEditRaceModalBtn');
            const cancelEditRaceBtn = document.getElementById('cancelEditRaceBtn');
            const editRaceForm = document.getElementById('editRaceForm');
            const saveRaceChangesBtn = document.getElementById('saveRaceChangesBtn');
            const raceTitleInput = document.getElementById('raceTitle');
            const raceLocationInput = document.getElementById('raceLocation');
            const raceDescriptionInput = document.getElementById('raceDescription');
            const raceEventDateInput = document.getElementById('raceEventDate');
            const raceGenderCategoryInput = document.getElementById('raceGenderCategory');
            const racePromoImageUrlInput = document.getElementById('racePromoImageUrl');
            const deleteRaceBtn = document.getElementById('deleteRaceBtn');

            // Event Listener Attachments
            if (logoutButtonNav) {
                logoutButtonNav.addEventListener('click', function(event) {
                    event.preventDefault();
                    fetch("{{ url_for('logout_api') }}", { method: 'POST' })
                        .then(response => {
                            if (response.ok) window.location.href = "{{ url_for('serve_login_page') }}";
                            else alert('Logout failed.');
                        })
                        .catch(error => console.error('Logout error:', error));
                });
            }

            if(toggleQuestionsBtn) {
                 toggleQuestionsBtn.addEventListener('click', toggleQuestions);
            }

            if(addMcOptionBtn && mcOptionsContainer) {
                addMcOptionBtn.addEventListener('click', () => {
                    mcOptionsContainer.appendChild(createOptionInputDiv("", null, false, "MULTIPLE_CHOICE"));
                });
            }

            if(addOrderingOptionBtn && orderingOptionsContainer) {
                addOrderingOptionBtn.addEventListener('click', () => {
                    orderingOptionsContainer.appendChild(createOptionInputDiv("", null, false, "ORDERING"));
                });
            }

            // Edit Race Modal Functions (defined locally as they use DOMContentLoaded-defined consts)
            function openEditRaceModal() {
                if (!editRaceModal) return;
                editRaceModal.style.display = 'flex';
            }

            function closeEditRaceModal() {
                if (!editRaceModal) return;
                editRaceModal.style.display = 'none';
            }

            if (openEditRaceModalBtn) {
                openEditRaceModalBtn.addEventListener('click', openEditRaceModal);
            }
            if (closeEditRaceModalBtn) {
                closeEditRaceModalBtn.addEventListener('click', closeEditRaceModal);
            }
            if (cancelEditRaceBtn) {
                cancelEditRaceBtn.addEventListener('click', closeEditRaceModal);
            }

            if (editRaceForm) {
                editRaceForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    if(!saveRaceChangesBtn) return;
                    saveRaceChangesBtn.disabled = true;
                    saveRaceChangesBtn.classList.add('opacity-50');

                    const formData = {
                        title: raceTitleInput.value,
                        location: raceLocationInput.value,
                        description: raceDescriptionInput.value,
                        event_date: raceEventDateInput.value,
                        gender_category: raceGenderCategoryInput.value,
                        promo_image_url: racePromoImageUrlInput.value,
                        category: document.getElementById('raceCategory').value
                    };

                    if (!formData.title.trim()) {
                        alert('El título de la carrera es obligatorio.');
                        saveRaceChangesBtn.disabled = false;
                        saveRaceChangesBtn.classList.remove('opacity-50');
                        return;
                    }
                     if (!formData.event_date) {
                        alert('La fecha del evento es obligatoria.');
                        saveRaceChangesBtn.disabled = false;
                        saveRaceChangesBtn.classList.remove('opacity-50');
                        return;
                    }

                    fetch(`/api/races/${raceId}/details`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', },
                        body: JSON.stringify(formData)
                    })
                    .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, body: data })))
                    .then(result => {
                        if (result.ok) {
                            alert(result.body.message || 'Detalles de la carrera actualizados con éxito.');
                            closeEditRaceModal();
                            // Update page content dynamically
                            const titleElement = document.querySelector('.hero-bg h1');
                            if (titleElement) titleElement.textContent = result.body.race.title;
                            const heroDescription = document.querySelector('.hero-bg p.opacity-90');
                            if (heroDescription) heroDescription.textContent = result.body.race.description.substring(0,150) + (result.body.race.description.length > 150 ? '...' : '');
                            const detailedDescriptionP = document.querySelector('.bg-white.rounded-xl.p-6.shadow-lg > p.text-gray-600.leading-relaxed.whitespace-pre-line');
                            if(detailedDescriptionP && result.body.race.description.length > 150) {
                                detailedDescriptionP.textContent = result.body.race.description;
                                const detailedDescSection = detailedDescriptionP.closest('.bg-white.rounded-xl.p-6.shadow-lg');
                                if(detailedDescSection) detailedDescSection.style.display = 'block';
                            } else if (detailedDescriptionP && result.body.race.description.length <= 150) {
                                const detailedDescSection = detailedDescriptionP.closest('.bg-white.rounded-xl.p-6.shadow-lg');
                                if(detailedDescSection) detailedDescSection.style.display = 'none';
                            }
                            const heroDateSpan = document.querySelector('.hero-bg .fa-calendar').nextElementSibling;
                            if (heroDateSpan && result.body.race.event_date) {
                                const eventDate = new Date(result.body.race.event_date);
                                heroDateSpan.textContent = eventDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' }) + ' ' + eventDate.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                            } else if (heroDateSpan) {
                                heroDateSpan.textContent = 'Fecha no especificada';
                            }
                            const heroLocationSpan = document.querySelector('.hero-bg .fa-map-marker-alt').nextElementSibling;
                            if (heroLocationSpan) heroLocationSpan.textContent = result.body.race.location || 'Ubicación no especificada';
                            const genderBadge = document.querySelector('.hero-bg span.bg-white.bg-opacity-20:nth-of-type(2)');
                            if(genderBadge) genderBadge.textContent = result.body.race.gender_category;
                            const promoImage = document.querySelector('.hero-bg img');
                            const promoImageContainer = promoImage ? promoImage.parentElement : null;
                            if (promoImage && result.body.race.promo_image_url) {
                                promoImage.src = result.body.race.promo_image_url;
                                promoImage.alt = `Imagen de ${result.body.race.title}`;
                                if(promoImageContainer) promoImageContainer.style.display = '';
                            } else if (promoImage && !result.body.race.promo_image_url) {
                                if(promoImageContainer) promoImageContainer.style.display = 'none';
                            }
                            const raceCategoryInputModal = document.getElementById('raceCategory');
                            if (raceCategoryInputModal) raceCategoryInputModal.value = result.body.race.category;

                        } else {
                            alert(`Error: ${result.body.message || 'No se pudo actualizar la carrera.'}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error saving race details:', error);
                        alert('Error de conexión al guardar los detalles de la carrera.');
                    })
                    .finally(() => {
                        if(saveRaceChangesBtn) {
                            saveRaceChangesBtn.disabled = false;
                            saveRaceChangesBtn.classList.remove('opacity-50');
                        }
                    });
                });
            }

            // Add/Edit Question Modal Listeners
            if (addNewQuestionBtn) {
                addNewQuestionBtn.addEventListener('click', openAddQuestionModal);
            }
            if (closeAddEditQuestionModalBtn) {
                closeAddEditQuestionModalBtn.addEventListener('click', closeAddEditQuestionModal);
            }
            if (cancelAddEditQuestionBtn) {
                cancelAddEditQuestionBtn.addEventListener('click', closeAddEditQuestionModal);
            }
            if(questionTypeSelect) {
                questionTypeSelect.addEventListener('change', handleQuestionTypeChange);
            }

            // Delete Question Modal Listeners
            if(cancelDeleteQuestionBtn) {
                cancelDeleteQuestionBtn.addEventListener('click', closeDeleteConfirmModal);
            }
            if(addEditQuestionForm) {
                addEditQuestionForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    if(!saveQuestionBtn) return;

                    saveQuestionBtn.disabled = true;
                    saveQuestionBtn.classList.add('opacity-50');

                    const editingId = editingQuestionIdInput.value;
                    const type = questionTypeSelect.value;
                    let questionData = {
                        text: questionTextInput.value.trim(),
                        is_active: true,
                    };

                    if (!questionData.text) {
                        alert('El texto de la pregunta es obligatorio.');
                        saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                    }

                    let options = [];
                    if (type === 'MULTIPLE_CHOICE') {
                        mcOptionsContainer.querySelectorAll('input[type="text"]').forEach(input => {
                            if(input.value.trim()) options.push({ option_text: input.value.trim() });
                        });
                        if (options.length < 2) {
                            alert('Las preguntas de opción múltiple deben tener al menos 2 opciones con texto.');
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                        questionData.options = options;
                        questionData.is_mc_multiple_correct = isMcMultipleCorrectCheckbox.checked;

                        if (questionData.is_mc_multiple_correct) {
                            const pointsCorrect = parseInt(pointsPerCorrectMcInput.value);
                            const pointsIncorrect = parseInt(pointsPerIncorrectMcInput.value);
                            if (isNaN(pointsCorrect)) {
                                alert('Puntos por opción correcta debe ser un número para selección múltiple.');
                                saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                            }
                            if (isNaN(pointsIncorrect)) {
                                alert('Puntos por opción incorrecta debe ser un número para selección múltiple.');
                                saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                            }
                            questionData.points_per_correct_mc = pointsCorrect;
                            questionData.points_per_incorrect_mc = pointsIncorrect;
                        } else {
                            const totalScore = parseInt(totalScoreMcSingleInput.value);
                            if (isNaN(totalScore) || totalScore <= 0) {
                                alert('La puntuación total para opción única debe ser un número entero positivo.');
                                saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                            }
                            questionData.total_score_mc_single = totalScore;
                        }
                    } else if (type === 'ORDERING') {
                        orderingOptionsContainer.querySelectorAll('input[type="text"]').forEach(input => {
                           if(input.value.trim()) options.push({ option_text: input.value.trim() });
                        });
                        if (options.length < 2) {
                            alert('Las preguntas de ordenamiento deben tener al menos 2 ítems con texto.');
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                        questionData.options = options;
                        const pointsPerCorrect = parseInt(pointsPerCorrectOrderInput.value);
                        const bonusFullOrder = parseInt(bonusForFullOrderInput.value);
                        if (isNaN(pointsPerCorrect) || pointsPerCorrect <= 0) {
                             alert('Los puntos por ítem correcto en ordenamiento deben ser un número entero positivo.');
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                        if (isNaN(bonusFullOrder) || bonusFullOrder < 0) {
                             alert('El bonus por orden completo debe ser un número entero no negativo.');
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                        questionData.points_per_correct_order = pointsPerCorrect;
                        questionData.bonus_for_full_order = bonusFullOrder;
                    } else if (type === 'FREE_TEXT') {
                        const maxScore = parseInt(maxScoreFreeTextInput.value);
                        if (isNaN(maxScore) || maxScore <= 0) {
                             alert('La puntuación máxima para texto libre debe ser un número entero positivo.');
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                        questionData.max_score_free_text = maxScore;
                    }

                    let url, method;
                    const currentQuestionType = questionTypeSelect.value;
                    const typeSlug = currentQuestionType.toLowerCase().replace('_', '-');

                    if (editingId) {
                        url = `/api/questions/${typeSlug}/${editingId}`;
                        method = 'PUT';
                    } else {
                        if (!raceId) {
                            alert("Error: El ID de la carrera no está definido. No se puede crear la pregunta.");
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                        url = `/api/races/${raceId}/questions/${typeSlug}`;
                        method = 'POST';
                        questionData.is_active = true;
                    }

                    fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(questionData)
                    })
                    .then(response => response.json().then(data => ({ok: response.ok, status: response.status, body: data})))
                    .then(result => {
                        if (result.ok) {
                            alert(result.body.message || `Pregunta ${editingId ? 'actualizada' : 'creada'} con éxito.`);
                            closeAddEditQuestionModal();
                            fetchAndRenderQuestions();
                        } else {
                            alert(`Error: ${result.body.message || 'No se pudo guardar la pregunta.'}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error saving question:', error);
                        alert('Error de conexión al guardar la pregunta.');
                    })
                    .finally(() => {
                        if(saveQuestionBtn) {
                            saveQuestionBtn.disabled = false;
                            saveQuestionBtn.classList.remove('opacity-50');
                        }
                    });
                });
            }

            if(confirmDeleteQuestionBtn) {
                confirmDeleteQuestionBtn.addEventListener('click', function() {
                    const questionIdVal = questionIdToDeleteInput.value;
                    if (!questionIdVal) return;
                    if(!confirmDeleteQuestionBtn) return;

                    confirmDeleteQuestionBtn.disabled = true;
                    confirmDeleteQuestionBtn.classList.add('opacity-50');

                    fetch(`/api/questions/${questionIdVal}`, { method: 'DELETE' })
                    .then(response => response.json().then(data => ({ok: response.ok, status: response.status, body: data})))
                    .then(result => {
                        if (result.ok) {
                            alert(result.body.message || 'Pregunta eliminada con éxito.');
                            closeDeleteConfirmModal();
                            fetchAndRenderQuestions();
                        } else {
                            alert(`Error: ${result.body.message || 'No se pudo eliminar la pregunta.'}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting question:', error);
                        alert('Error de conexión al eliminar la pregunta.');
                    })
                    .finally(() => {
                        if(confirmDeleteQuestionBtn) {
                            confirmDeleteQuestionBtn.disabled = false;
                            confirmDeleteQuestionBtn.classList.remove('opacity-50');
                        }
                    });
                });
            }

            if (deleteRaceBtn) {
                deleteRaceBtn.addEventListener('click', function() {
                    const confirmationMessage = '¿Estás seguro de que quieres eliminar esta carrera? Esta acción no se puede deshacer y eliminará todos los datos asociados (segmentos, preguntas, etc.).';
                    if (confirm(confirmationMessage)) {
                        if (!raceId) {
                            alert('Error: ID de la carrera no encontrado.');
                            return;
                        }
                        fetch(`/api/races/${raceId}`, { method: 'DELETE' })
                        .then(response => {
                            const clonedResponse = response.clone();
                            return response.json()
                                .then(data => ({ ok: response.ok, status: response.status, body: data }))
                                .catch(() => clonedResponse.text().then(textData => ({
                                        ok: response.ok,
                                        status: response.status,
                                        body: { message: `Could not parse JSON. Raw text: ${textData}` }
                                    }))
                                );
                        })
                        .then(result => {
                            if (result.ok) {
                                alert(result.body.message || 'Carrera eliminada con éxito.');
                                window.location.href = "{{ url_for('serve_hello_world_page') }}";
                            } else {
                                alert(`Error al eliminar la carrera: ${result.body.message || `Error de servidor ${result.status}`}`);
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting race:', error);
                            alert('Error en la conexión o al procesar la solicitud de eliminación.');
                        });
                    }
                });
            }

            // Initial data fetch
            fetchAndRenderQuestions();

            // --- Question Wizard Logic ---
            let currentQuestionIndex = 0;
            let userWizardAnswers = {}; // Stores answers as { question_id: { ...answer_data } }

            // Wizard Modal DOM Elements
            const questionWizardModal = document.getElementById('questionWizardModal');
            const wizardQuestionProgress = document.getElementById('wizardQuestionProgress');
            const closeWizardModalBtn = document.getElementById('closeWizardModalBtn');
            const wizardQuestionText = document.getElementById('wizardQuestionText');
            const wizardAnswerOptions = document.getElementById('wizardAnswerOptions');
            const wizardPrevBtn = document.getElementById('wizardPrevBtn');
            const wizardNextBtn = document.getElementById('wizardNextBtn');
            const wizardFinishBtn = document.getElementById('wizardFinishBtn');
            const answerQuestionsBtn = document.getElementById('answerQuestionsBtn');

            function openWizard() {
                if (!allRaceQuestions || allRaceQuestions.length === 0) {
                    alert("No hay preguntas disponibles para esta carrera en este momento.");
                    return;
                }
                currentQuestionIndex = 0;
                userWizardAnswers = {}; // Reset answers when opening
                displayWizardQuestion(currentQuestionIndex);
                if(questionWizardModal) questionWizardModal.style.display = 'flex';
            }

            function closeWizard() {
                if(questionWizardModal) questionWizardModal.style.display = 'none';
            }

            function displayWizardQuestion(index) {
                if (!allRaceQuestions || allRaceQuestions.length === 0) {
                    console.error("displayWizardQuestion called with no questions available.");
                    closeWizard(); // Close wizard if no questions
                    return;
                }
                if (index < 0 || index >= allRaceQuestions.length) {
                    console.error("Invalid question index:", index);
                    return;
                }

                const question = allRaceQuestions[index];
                const existingAnswer = userWizardAnswers[question.id];

                if(wizardQuestionProgress) wizardQuestionProgress.textContent = `Pregunta ${index + 1} de ${allRaceQuestions.length}`;
                if(wizardQuestionText) wizardQuestionText.textContent = question.text;
                if(wizardAnswerOptions) wizardAnswerOptions.innerHTML = ''; // Clear previous options

                switch (question.question_type) {
                    case 'FREE_TEXT':
                        const textarea = document.createElement('textarea');
                        textarea.id = `wizardFreeTextAnswer_${question.id}`;
                        textarea.className = 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent';
                        textarea.rows = 4;
                        textarea.placeholder = 'Escribe tu respuesta...';
                        textarea.value = existingAnswer?.answer_text || '';
                        if (wizardAnswerOptions) wizardAnswerOptions.appendChild(textarea);
                        break;

                    case 'MULTIPLE_CHOICE':
                        question.options.forEach(opt => {
                            const label = document.createElement('label');
                            label.className = 'flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded-md border border-gray-200 hover:border-orange-300';

                            const input = document.createElement('input');
                            input.type = question.is_mc_multiple_correct ? 'checkbox' : 'radio';
                            input.name = `wizard_q_${question.id}`;
                            input.value = opt.id;
                            input.className = 'text-orange-500 focus:ring-orange-400 focus:ring-offset-0';
                            if (question.is_mc_multiple_correct) {
                                input.classList.add('rounded');
                                if (existingAnswer?.selected_option_ids?.includes(opt.id)) {
                                    input.checked = true;
                                }
                            } else {
                                if (existingAnswer?.selected_option_id == opt.id) {
                                    input.checked = true;
                                }
                            }

                            const span = document.createElement('span');
                            span.className = 'text-gray-700';
                            span.textContent = opt.option_text;

                            label.appendChild(input);
                            label.appendChild(span);
                            if (wizardAnswerOptions) wizardAnswerOptions.appendChild(label);
                        });
                        break;

                    case 'ORDERING':
                        const infoText = document.createElement('p');
                        infoText.className = 'text-sm text-gray-600 mb-2';
                        infoText.textContent = "Ordena los siguientes items. Indica tu orden en el cuadro de texto (ej: Opción C, Opción A, Opción B).";
                        if (wizardAnswerOptions) wizardAnswerOptions.appendChild(infoText);

                        const listContainer = document.createElement('div');
                        listContainer.className = 'space-y-1 mb-3 p-2 border rounded-md';
                        question.options.forEach(opt => {
                            const listItem = document.createElement('div');
                            listItem.className = 'bg-gray-100 p-2 rounded text-sm';
                            listItem.textContent = opt.option_text;
                            listContainer.appendChild(listItem);
                        });
                        if (wizardAnswerOptions) wizardAnswerOptions.appendChild(listContainer);

                        const orderingTextarea = document.createElement('textarea');
                        orderingTextarea.id = `wizardOrderingAnswer_${question.id}`;
                        orderingTextarea.className = 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent';
                        orderingTextarea.rows = 3;
                        orderingTextarea.placeholder = 'Ej: Item C, Item A, Item B';
                        orderingTextarea.value = existingAnswer?.ordered_options_text || '';
                        if (wizardAnswerOptions) wizardAnswerOptions.appendChild(orderingTextarea);
                        break;
                    default:
                        if (wizardAnswerOptions) wizardAnswerOptions.innerHTML = '<p class="text-red-500">Tipo de pregunta no soportado en el wizard.</p>';
                }

                if(wizardPrevBtn) wizardPrevBtn.style.display = index > 0 ? 'inline-flex' : 'none';
                if(wizardNextBtn) wizardNextBtn.style.display = index < allRaceQuestions.length - 1 ? 'inline-flex' : 'none';
                if(wizardFinishBtn) wizardFinishBtn.style.display = index === allRaceQuestions.length - 1 ? 'inline-flex' : 'none';
            }

            function saveCurrentWizardAnswer() {
                if (!allRaceQuestions || currentQuestionIndex < 0 || currentQuestionIndex >= allRaceQuestions.length) {
                    return;
                }
                const question = allRaceQuestions[currentQuestionIndex];
                if (!question) return;

                switch (question.question_type) {
                    case 'FREE_TEXT':
                        const textarea = document.getElementById(`wizardFreeTextAnswer_${question.id}`);
                        if (textarea) {
                            userWizardAnswers[question.id] = { question_id: question.id, answer_text: textarea.value.trim() };
                        }
                        break;
                    case 'MULTIPLE_CHOICE':
                        if (question.is_mc_multiple_correct) {
                            const selected_option_ids = [];
                            document.querySelectorAll(`input[name="wizard_q_${question.id}"]:checked`).forEach(cb => {
                                selected_option_ids.push(parseInt(cb.value));
                            });
                            userWizardAnswers[question.id] = { question_id: question.id, selected_option_ids: selected_option_ids };
                        } else {
                            const selectedRadio = document.querySelector(`input[name="wizard_q_${question.id}"]:checked`);
                            userWizardAnswers[question.id] = {
                                question_id: question.id,
                                selected_option_id: selectedRadio ? parseInt(selectedRadio.value) : null
                            };
                        }
                        break;
                    case 'ORDERING':
                        const orderingTextarea = document.getElementById(`wizardOrderingAnswer_${question.id}`);
                        if (orderingTextarea) {
                             userWizardAnswers[question.id] = { question_id: question.id, ordered_options_text: orderingTextarea.value.trim() };
                        }
                        break;
                }
            }

            function handleNextWizardQuestion() {
                saveCurrentWizardAnswer();
                if (currentQuestionIndex < allRaceQuestions.length - 1) {
                    currentQuestionIndex++;
                    displayWizardQuestion(currentQuestionIndex);
                }
            }

            function handlePreviousWizardQuestion() {
                saveCurrentWizardAnswer();
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    displayWizardQuestion(currentQuestionIndex);
                }
            }

            // Event Listeners for Wizard
            if (answerQuestionsBtn) {
                answerQuestionsBtn.addEventListener('click', openWizard);
            }
            if (closeWizardModalBtn) {
                closeWizardModalBtn.addEventListener('click', closeWizard);
            }
            if (wizardNextBtn) {
                wizardNextBtn.addEventListener('click', handleNextWizardQuestion);
            }
            if (wizardPrevBtn) {
                wizardPrevBtn.addEventListener('click', handlePreviousWizardQuestion);
            }
            if (wizardFinishBtn) {
                wizardFinishBtn.addEventListener('click', () => {
                    saveCurrentWizardAnswer();

                    if (Object.keys(userWizardAnswers).length === 0) {
                        alert("No has respondido ninguna pregunta aún.");
                        return;
                    }

                    wizardFinishBtn.disabled = true;
                    wizardFinishBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';

                    fetch(`/api/races/${raceId}/answers`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(userWizardAnswers)
                    })
                    .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, body: data })))
                    .then(result => {
                        if (result.ok) {
                            alert(result.body.message || '¡Respuestas guardadas con éxito!');
                            closeWizard();
                        } else {
                            alert(`Error al guardar respuestas: ${result.body.message || `Error ${result.status}`}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error saving answers:', error);
                        alert('Error de conexión al guardar respuestas. Por favor, inténtalo de nuevo.');
                    })
                    .finally(() => {
                        wizardFinishBtn.disabled = false;
                        wizardFinishBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Finalizar y Guardar';
                    });
                });
            }
            // --- End Question Wizard Logic ---

            // Share Race Functionality
            const shareRaceBtn = document.getElementById('shareRaceBtn');
            const shareRaceModal = document.getElementById('shareRaceModal');
            const closeShareRaceModalBtn = document.getElementById('closeShareRaceModalBtn');
            const shareableLinkInput = document.getElementById('shareableLinkInput');
            const copyShareLinkBtn = document.getElementById('copyShareLinkBtn');
            const copyShareLinkFeedback = document.getElementById('copyShareLinkFeedback');

            if (shareRaceBtn) {
                shareRaceBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    if (!raceId) {
                        alert('Error: ID de la carrera no disponible.');
                        return;
                    }
                    // Optional: Show loading state
                    shareRaceBtn.disabled = true;
                    shareRaceBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generando...';

                    fetch(`/api/races/${raceId}/share_link`)
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(err => { throw new Error(err.message || `Error ${response.status}`) });
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.share_link) {
                                const fullShareLink = window.location.origin + data.share_link;
                                shareableLinkInput.value = fullShareLink;
                                shareRaceModal.style.display = 'flex';
                            } else {
                                throw new Error('No se recibió el enlace para compartir.');
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching share link:', error);
                            alert(`Error al generar el enlace: ${error.message}`);
                        })
                        .finally(() => {
                            // Hide loading state
                            shareRaceBtn.disabled = false;
                            shareRaceBtn.innerHTML = '<i class="fas fa-share-alt mr-2"></i>Compartir Carrera';
                        });
                });
            }

            if (closeShareRaceModalBtn) {
                closeShareRaceModalBtn.addEventListener('click', function() {
                    shareRaceModal.style.display = 'none';
                    copyShareLinkFeedback.style.display = 'none'; // Hide feedback on close
                });
            }

            if (copyShareLinkBtn) {
                copyShareLinkBtn.addEventListener('click', function() {
                    if (shareableLinkInput.value) {
                        navigator.clipboard.writeText(shareableLinkInput.value)
                            .then(() => {
                                copyShareLinkFeedback.style.display = 'block';
                                setTimeout(() => {
                                    copyShareLinkFeedback.style.display = 'none';
                                }, 2000); // Hide feedback after 2 seconds
                            })
                            .catch(err => {
                                console.error('Error copying to clipboard:', err);
                                alert('No se pudo copiar el enlace. Por favor, cópielo manualmente.');
                            });
                    }
                });
            }
        });

        // --- End Question Wizard Logic ---

    </script>

    <!-- Question Wizard Modal -->
    <div id="questionWizardModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 120;">
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-lg sm:max-w-xl md:max-w-2xl mx-auto">
            <!-- Modal Header -->
            <div class="flex justify-between items-center mb-6">
                <h2 id="wizardQuestionProgress" class="text-xl sm:text-2xl font-bold text-gray-800">Pregunta X de Y</h2>
                <button id="closeWizardModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <!-- Modal Body: Question Display Area -->
            <div id="wizardQuestionArea" class="mb-6">
                <h3 id="wizardQuestionText" class="text-lg sm:text-xl font-semibold text-gray-700 mb-4"></h3>
                <div id="wizardAnswerOptions" class="space-y-3">
                    <!-- Input fields will be dynamically inserted here by JavaScript -->
                    <!-- Example for Free Text (to be controlled by JS) -->
                    <!-- <textarea id="wizardFreeTextAnswer" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" rows="4" placeholder="Escribe tu respuesta..."></textarea> -->

                    <!-- Example for MC Single (to be controlled by JS) -->
                    <!-- <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded-md border border-gray-200 hover:border-orange-300">
                        <input type="radio" name="wizardMcOption" value="option1" class="text-orange-500 focus:ring-orange-400 focus:ring-offset-0">
                        <span class="text-gray-700">Option 1</span>
                    </label> -->

                    <!-- Example for MC Multiple (to be controlled by JS) -->
                    <!-- <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded-md border border-gray-200 hover:border-orange-300">
                        <input type="checkbox" name="wizardMcOption_multi" value="optionA" class="text-orange-500 focus:ring-orange-400 focus:ring-offset-0 rounded">
                        <span class="text-gray-700">Option A</span>
                    </label> -->

                    <!-- Example for Ordering (placeholder, actual implementation might differ) -->
                    <!-- <div id="wizardOrderingOptionsContainer" class="space-y-2">
                         <div class="bg-gray-100 p-2 rounded border">Item A (Drag me)</div>
                         <div class="bg-gray-100 p-2 rounded border">Item B (Drag me)</div>
                    </div> -->
                </div>
            </div>

            <!-- Modal Footer: Navigation -->
            <div class="flex justify-between items-center pt-6 border-t border-gray-200">
                <button id="wizardPrevBtn" class="btn btn-secondary">
                    <i class="fas fa-arrow-left mr-2"></i>Anterior
                </button>
                <button id="wizardNextBtn" class="btn btn-primary">
                    Siguiente<i class="fas fa-arrow-right ml-2"></i>
                </button>
                <button id="wizardFinishBtn" class="btn btn-primary bg-green-500 hover:bg-green-600" style="display: none;">
                    <i class="fas fa-check mr-2"></i>Finalizar y Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Question Modal -->
    {% if currentUserRole == 'ADMIN' or currentUserRole == 'LEAGUE_ADMIN' %}
    <div id="addEditQuestionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 100;">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-3xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="addEditQuestionModalTitle" class="text-2xl font-bold text-gray-800">Añadir Nueva Pregunta</h2>
                <button id="closeAddEditQuestionModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <form id="addEditQuestionForm">
                <input type="hidden" id="editingQuestionId" value="">
                <div class="mb-4">
                    <label for="questionText" class="block text-sm font-medium text-gray-700 mb-1">Texto de la Pregunta</label>
                    <textarea id="questionText" name="text" rows="3" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm" placeholder="Ej: ¿Quién ganará la carrera?"></textarea>
                </div>

                <div class="mb-4">
                    <label for="questionTypeSelect" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Pregunta</label>
                    <select id="questionTypeSelect" name="question_type" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                        <option value="FREE_TEXT">Texto Libre</option>
                        <option value="MULTIPLE_CHOICE">Opción Múltiple</option>
                        <option value="ORDERING">Ordenamiento</option>
                    </select>
                </div>

                <!-- Dynamic fields based on question type -->
                <div id="questionTypeSpecificFields" class="space-y-4 mb-4">
                    <!-- Fields for MULTIPLE_CHOICE -->
                    <div id="multipleChoiceFieldsContainer" style="display:none;" class="p-4 border border-gray-200 rounded-md">
                        <h4 class="font-semibold text-gray-700 mb-2">Opciones de Opción Múltiple:</h4>
                        <div id="mcOptionsContainer" class="space-y-2">
                            <!-- JS will add option input fields here -->
                        </div>
                        <button type="button" id="addMcOptionBtn" class="btn btn-secondary btn-sm mt-2"><i class="fas fa-plus mr-1"></i>Añadir Opción</button>
                        <div class="mt-3">
                             <label class="flex items-center">
                                <input type="checkbox" id="isMcMultipleCorrect" name="is_mc_multiple_correct" class="h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                                <span class="ml-2 text-sm text-gray-700">Permitir múltiples respuestas correctas</span>
                            </label>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                            <div>
                                <label for="pointsPerCorrectMc" class="block text-sm font-medium text-gray-700">Puntos por opción correcta (si múltiple)</label>
                                <input type="number" id="pointsPerCorrectMc" name="points_per_correct_mc" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: 10">
                            </div>
                            <div>
                                <label for="pointsPerIncorrectMc" class="block text-sm font-medium text-gray-700">Puntos por opción incorrecta (si múltiple)</label>
                                <input type="number" id="pointsPerIncorrectMc" name="points_per_incorrect_mc" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: -5">
                            </div>
                             <div>
                                <label for="totalScoreMcSingle" class="block text-sm font-medium text-gray-700">Puntuación total (si única respuesta)</label>
                                <input type="number" id="totalScoreMcSingle" name="total_score_mc_single" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: 25">
                            </div>
                        </div>
                    </div>

                    <!-- Fields for ORDERING -->
                    <div id="orderingFieldsContainer" style="display:none;" class="p-4 border border-gray-200 rounded-md">
                        <h4 class="font-semibold text-gray-700 mb-2">Items para Ordenar:</h4>
                        <div id="orderingOptionsContainer" class="space-y-2">
                            <!-- JS will add item input fields here -->
                        </div>
                        <button type="button" id="addOrderingOptionBtn" class="btn btn-secondary btn-sm mt-2"><i class="fas fa-plus mr-1"></i>Añadir Item</button>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                           <div>
                                <label for="pointsPerCorrectOrder" class="block text-sm font-medium text-gray-700">Puntos por item en posición correcta</label>
                                <input type="number" id="pointsPerCorrectOrder" name="points_per_correct_order" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: 5">
                            </div>
                            <div>
                                <label for="bonusForFullOrder" class="block text-sm font-medium text-gray-700">Bonus por orden completo correcto</label>
                                <input type="number" id="bonusForFullOrder" name="bonus_for_full_order" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: 15">
                            </div>
                        </div>
                    </div>

                    <!-- Fields for FREE_TEXT -->
                    <div id="freeTextFieldsContainer" style="display:none;" class="p-4 border border-gray-200 rounded-md">
                        <h4 class="font-semibold text-gray-700 mb-2">Configuración de Texto Libre:</h4>
                        <div>
                            <label for="maxScoreFreeText" class="block text-sm font-medium text-gray-700">Puntuación Máxima</label>
                            <input type="number" id="maxScoreFreeText" name="max_score_free_text" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: 50">
                        </div>
                        <!-- Potentially add fields for keywords, case sensitivity etc. later -->
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancelAddEditQuestionBtn" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" id="saveQuestionBtn" class="btn btn-primary">Guardar Pregunta</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Question Confirmation Modal -->
    <div id="deleteQuestionConfirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 105;">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Confirmar Eliminación</h2>
            <p class="text-gray-600 mb-6">¿Estás seguro de que quieres eliminar esta pregunta? Esta acción no se puede deshacer.</p>
            <input type="hidden" id="questionIdToDelete" value="">
            <div class="flex justify-end space-x-3">
                <button type="button" id="cancelDeleteQuestionBtn" class="btn btn-secondary">Cancelar</button>
                <button type="button" id="confirmDeleteQuestionBtn" class="btn btn-danger bg-red-600 hover:bg-red-700 text-white">Eliminar</button>
            </div>
        </div>
    </div>
    {% endif %}


    <script>
        const raceId = "{{ race.id | default('') }}";
