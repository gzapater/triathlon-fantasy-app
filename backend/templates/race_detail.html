<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Triatl√≥n - {{ race.title if race else 'Detalle de Carrera' }}</title> <!-- Dynamic Title -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --orange-primary: #FF6B35;
            --orange-light: #FF8F65;
            --orange-dark: #FF4500;
            --orange-pale: #FFB380;
            --gray-dark: #2C3E50;
            --gray-medium: #34495E;
            --gray-light: #7F8C8D;
            --blue-water: #3498DB;
            --green-run: #27AE60;
            --red-accent: #E74C3C;
        }

        * {
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }

        .hero-bg {
            background: linear-gradient(135deg, var(--orange-dark) 0%, var(--orange-primary) 50%, var(--orange-light) 100%);
            position: relative;
            overflow: hidden;
        }

        /* .hero-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><defs><pattern id="triPattern" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="25" r="2" fill="rgba(255,255,255,0.1)"/><path d="M25,75 L75,75 L50,25 Z" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23triPattern)"/></svg>') repeat;
            opacity: 0.3;
        } */

        .segment-card {
            /* transition: all 0.3s ease; */
            border-left: 4px solid var(--orange-primary);
        }

        .segment-card:hover {
            /* transform: translateY(-2px); */
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.15);
        }

        .swim-segment { border-left-color: var(--blue-water); }
        .bike-segment { border-left-color: var(--gray-dark); }
        .run-segment { border-left-color: var(--green-run); }
        .transition-segment { border-left-color: var(--orange-primary); } /* Orange for transitions */

        .question-card {
            border: 1px solid #e5e7eb; /* Tailwind gray-200 */
            border-radius: 12px;      /* Slightly larger radius */
            /* transition: all 0.3s ease; */
            background-color: white; /* Ensure questions have white background */
        }

        .question-card:hover {
            /* border-color: var(--orange-primary); */
            /* box-shadow: 0 4px 12px rgba(255, 107, 53, 0.1); */
        }

        .btn { /* Base button style */
            padding: 0.625rem 1.25rem; /* py-2.5 px-5 */
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            /* transition: all 0.3s ease; */
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--orange-primary) 0%, var(--orange-dark) 100%);
            border: none;
            color: white;
        }

        .btn-primary:hover {
            /* transform: translateY(-1px); */
            /* box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3); */
        }

        .btn-secondary {
            background-color: #E5E7EB; /* Tailwind gray-200 */
            color: var(--gray-dark);
            border: 1px solid #D1D5DB; /* Tailwind gray-300 */
        }
        .btn-secondary:hover {
            /* background-color: #D1D5DB; */
        }


        .timeline-line {
            position: relative;
        }

        /* Adjusted timeline for better responsiveness and alignment */
        /* .timeline-line::before {
            content: '';
            position: absolute;
            left: calc(1.5rem + 1px);
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, var(--blue-water), var(--gray-dark), var(--green-run));
            transform: translateX(-50%);
            z-index: -1;
        } */

        .drag-item {
            cursor: move;
            /* transition: all 0.3s ease; */
        }

        .drag-item:hover {
            background-color: #f8f9fa;
        }

        .drag-item.dragging {
            /* opacity: 0.5; */
            /* transform: rotate(5deg); */
        }

        .stats-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            /* transition: all 0.3s ease; */
        }

        .stats-card:hover {
            /* box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12); */
        }

        @media (max-width: 768px) {
            /* In mobile, make timeline vertical and align to left of segment cards */
            /* .timeline-line::before {
                left: calc(1.5rem);
            } */
            .segment-card { /* Remove margin for mobile timeline */
                margin-left: 0 !important;
            }
        }


        .expandable-content {
            max-height: 0;
            overflow: hidden;
            /* transition: max-height 0.5s ease-out; */ /* Smoother transition */
        }

        .expandable-content.expanded {
            max-height: 2000px; /* Large enough for content */
        }

        .badge-role { /* Copied from index.html for consistency */
            color: white;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
        }
        .badge-admin { background: linear-gradient(135deg, var(--red-accent) 0%, #F1948A 100%); }
        .badge-league { background: linear-gradient(135deg, var(--orange-primary) 0%, var(--orange-light) 100%); }
        .badge-player { background: linear-gradient(135deg, var(--blue-water) 0%, #5DADE2 100%); }


        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            stroke-dasharray: 251.2 251.2; /* Circumference of circle with r=40 */
            stroke-dashoffset: 251.2;
            transition: stroke-dashoffset 0.3s ease;
        }
        /* Ensure Font Awesome icons align well with text */
        .fas, .fab {
            vertical-align: -0.125em; /* default is -0.125em, adjust if needed */
        }

        /* Custom Slider CSS */
        .custom-slider-container { user-select: none; -webkit-user-select: none; -ms-user-select: none; -moz-user-select: none; }
        .slider-thumb { box-sizing: border-box; } /* Ensure padding/border included in width/height */
        .slider-green-zone, .slider-yellow-zone-left, .slider-yellow-zone-right {
            height: 100%;
            box-sizing: border-box;
            display: flex; /* For potential inner text/icons, though not used now */
            align-items: center;
            justify-content: center;
        }
        .slider-value-display {
            min-height: 2.5em; /* Accommodate unit text wrapping */
            text-align: center; /* Ensure text is centered if not already by Tailwind */
        }
    </style>
</head>
<body class="text-gray-700">
    {% include '_header.html' %}

    <!-- Hero Section -->
    <div class="hero-bg text-white py-6 md:py-8 lg:py-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col lg:flex-row items-center justify-between">
                <div class="flex-1 text-center lg:text-left mb-6 lg:mb-0">
                    <div class="flex flex-wrap justify-center lg:justify-start gap-2 mb-3">
                        <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-xs sm:text-sm">{{ race.race_format.name | default('Formato no especificado') }}</span>
                        <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-xs sm:text-sm">{{ race.gender_category | default('N/A') }}</span>
                        {% if race.status %}
                            {% set status_text = race.status.value|capitalize %}
                            {% set status_bg_color = 'bg-gray-500' %} {# Default for unknown/other statuses #}
                            {% if race.status.value == 'PLANNED' %}
                                {% set status_bg_color = 'bg-blue-500' %}
                            {% elif race.status.value == 'ACTIVE' %}
                                {% set status_bg_color = 'bg-green-500' %}
                            {% elif race.status.value == 'ARCHIVED' %}
                                {% set status_bg_color = 'bg-gray-700' %}
                            {% endif %}
                            <span class="{{ status_bg_color }} px-3 py-1 rounded-full text-xs sm:text-sm text-white shadow">
                                {{ status_text }}
                            </span>
                        {% endif %}
                    </div>
                    <div class="flex items-center justify-center lg:justify-start mb-3"> <!-- Added a wrapper for icon and title -->
                        <span id="favoriteRaceIcon"
                              class="cursor-pointer text-2xl sm:text-3xl mr-3
                                     {% if is_favorite %}fas fa-heart text-red-500{% else %}far fa-heart text-white opacity-80 hover:opacity-100{% endif %}"
                              title="Pulsa para hacer favorito"
                              data-race-id="{{ race.id }}">
                            {# Font Awesome icon will be rendered by the class above #}
                        </span>
                        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold"> <!-- Removed mb-3 from h1 as it's now on the wrapper -->
                            {{ race.title | default('T√≠tulo de la Carrera no Disponible') }}
                        </h1>
                    </div>
                    <p class="text-lg sm:text-xl mb-5 opacity-90">{{ race.description | truncate(150) if race.description else 'Descripci√≥n no disponible.' }}</p>
                    <div class="flex flex-wrap justify-center lg:justify-start gap-x-4 gap-y-2 text-sm mb-6">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-calendar"></i>
                            <span>{{ race.event_date.strftime('%d %B, %Y %H:%M') if race.event_date else 'Fecha no especificada' }}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>{{ race.location if race.location else 'Ubicaci√≥n no especificada' }}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-user-tie"></i>
                            <span>Organizado por: <span class="font-semibold">{{ race.user.username if race.user else 'N/A' }}</span></span>
                        </div>
                    </div>

                    <!-- Event Tags Section -->
                    {% if race.event %}
                    <div class="mt-4 flex flex-wrap justify-center lg:justify-start gap-2 mb-4">
                        {% if race.event.is_good_for_debutants %}
                            <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs sm:text-sm shadow-sm border border-green-200">
                                <i class="fas fa-child mr-1"></i>Ideal para Debutantes
                            </span>
                        {% endif %}
                        {% if race.event.is_challenging %}
                            <span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs sm:text-sm shadow-sm border border-red-200">
                                <i class="fas fa-mountain mr-1"></i>Desafiante
                            </span>
                        {% endif %}
                        {% if race.event.has_great_views %}
                            <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs sm:text-sm shadow-sm border border-blue-200">
                                <i class="fas fa-binoculars mr-1"></i>Excelentes Vistas
                            </span>
                        {% endif %}
                        {% if race.event.has_good_atmosphere %}
                            <span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs sm:text-sm shadow-sm border border-yellow-200">
                                <i class="fas fa-users mr-1"></i>Buen Ambiente
                            </span>
                        {% endif %}
                        {% if race.event.is_world_qualifier %}
                            <span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-xs sm:text-sm shadow-sm border border-purple-200">
                                <i class="fas fa-trophy mr-1"></i>Clasificatorio Mundial
                            </span>
                        {% endif %}
                    </div>
                    {% endif %}
                    <!-- End of Event Tags Section -->

                    <div class="flex flex-wrap justify-center lg:justify-start gap-3">
                        {% if currentUserRole == 'ADMIN' or currentUserRole == 'LEAGUE_ADMIN' %}
                        <button id="openEditRaceModalBtn" class="btn btn-secondary px-5 py-2.5 sm:px-6 sm:py-3">
                            <i class="fas fa-edit mr-2"></i>Editar Detalles Carrera
                        </button>
                        <button id="deleteRaceBtn" class="btn bg-red-600 hover:bg-red-700 text-white px-5 py-2.5 sm:px-6 sm:py-3">
                            <i class="fas fa-trash-alt mr-2"></i>Eliminar Carrera
                        </button>
                        <button id="shareRaceBtn" class="btn bg-blue-500 hover:bg-blue-600 text-white px-5 py-2.5 sm:px-6 sm:py-3">
                            <i class="fas fa-share-alt mr-2"></i>Compartir Carrera
                        </button>
                        {% if race.status.value != 'ARCHIVED' and (currentUserRole == 'ADMIN' or (currentUserRole == 'LEAGUE_ADMIN' and race.user_id == current_user.id)) %}
                        <button id="archiveRaceBtn" class="btn bg-yellow-500 hover:bg-yellow-600 text-white px-5 py-2.5 sm:px-6 sm:py-3">
                            <i class="fas fa-archive mr-2"></i>Archivar Carrera
                        </button>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% if race.promo_image_url %}
                <div class="flex-shrink-0 lg:ml-12 mt-6 lg:mt-0">
                    <img src="{{ race.promo_image_url }}" alt="Imagen de {{ race.title }}" class="rounded-lg shadow-xl w-full max-w-md lg:max-w-sm object-cover h-64 lg:h-auto">
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Race Full Description (if different from hero) -->
                {% if race.description and race.description|length > 150 %}
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Descripci√≥n Detallada</h2>
                    <p class="text-gray-600 leading-relaxed whitespace-pre-line">{{ race.description }}</p>
                </div>
                {% endif %}

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="font-bold text-gray-800 mb-4">Estad√≠sticas de la Carrera</h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 flex items-center"><i class="fas fa-users mr-2"></i>Participantes:</span>
                                <span id="statParticipantsCount" class="font-semibold text-gray-800">Cargando...</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 flex items-center"><i class="fas fa-pencil-alt mr-2"></i>Predicciones:</span>
                                <span id="statPredictionsCount" class="font-semibold text-gray-800">Cargando...</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 flex items-center"><i class="fas fa-clock mr-2"></i>Tiempo Restante Quiniela:</span>
                                <span id="statTimeRemaining" class="font-semibold text-orange-600">Cargando...</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-800">Enlaces de Inter√©s</h3>
                            {% if currentUserRole == 'ADMIN' or currentUserRole == 'LEAGUE_ADMIN' %}
                            <button id="openFavoriteLinksModalBtn" class="btn btn-secondary btn-sm py-1 px-3">
                                <i class="fas fa-edit mr-1"></i>Editar Enlaces
                            </button>
                            {% endif %}
                        </div>
                        <div id="favoriteLinksListContainer" class="space-y-2">
                            <!-- Favorite links will be dynamically inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Prediction Questions / Quiniela -->
                <div id="predictionQuestionsSection" class="bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Quiniela de la carrera</h2>
                        {% if currentUserRole == 'ADMIN' or currentUserRole == 'LEAGUE_ADMIN' %}
                        <div class="flex space-x-2"> {# Wrapper for admin buttons #}
                            <button id="addNewQuestionBtn" class="btn btn-primary text-sm px-4 py-2"
                                    {% if race.quiniela_close_date and race.quiniela_close_date < current_time_utc %}
                                        disabled
                                        title="La quiniela ya esta cerrada y no se pueden a√±adir nuevas predicciones"
                                    {% endif %}>
                                <i class="fas fa-plus mr-2"></i>A√±adir Pregunta
                            </button>
                            {% if is_quiniela_actionable %}
                            <button data-race-id="{{ race.id }}" data-race-title="{{ race.title | e }}" onclick="openOfficialAnswersModal(this)" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors text-sm">
                                Gestionar Quiniela
                            </button>
                            {% else %}
                            <button disabled title="Se activar√° cuando se cierre la quiniela." class="bg-gray-400 text-gray-700 font-bold py-2 px-4 rounded cursor-not-allowed focus:outline-none focus:shadow-outline transition-colors text-sm">
                                Gestionar Quiniela
                            </button>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>

                    {% if not has_user_answered_pool %}
                        <p class="text-gray-600 mb-4">Participa en la quiniela de esta carrera y pon a prueba tus conocimientos.</p>
                        <button id="participateInPoolBtn" class="btn btn-primary w-full md:w-auto"
                                {% if race.quiniela_close_date and race.quiniela_close_date < current_time_utc %}
                                    disabled
                                    title="La quiniela ya esta cerrada y no se pueden a√±adir nuevas predicciones"
                                {% endif %}>
                            <i class="fas fa-tasks mr-2"></i>Participar
                        </button>
                        <!-- The original question display elements (questionsLoading, questionsError, etc.) are removed here -->
                        <!-- If you need to load questions for admins to manage even if user hasn't answered, that logic needs to be separate -->
                    {% else %}
                        <p class="text-gray-700 text-lg mb-3"><i class="fas fa-check-circle text-green-500 mr-2"></i>Ya has participado en esta Quiniela.</p>
                        {% if has_user_answered_pool and num_answered_questions_pool < num_total_questions_pool %}
                        <div id="unansweredQuestionsWarning" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 my-4 rounded-md cursor-pointer hover:bg-yellow-200 transition-colors">
                            <p class="font-bold">Atenci√≥n</p>
                            <p>Hay preguntas sin contestar.</p>
                        </div>
                        {% endif %}
                        <button id="reviewUserAnswersBtn" class="btn btn-secondary"
                                {% if race.quiniela_close_date and race.quiniela_close_date < current_time_utc %}
                                    disabled
                                    title="La quiniela ya esta cerrada y no se pueden a√±adir nuevas predicciones"
                                {% endif %}>
                            <i class="fas fa-eye mr-2"></i>Revisar respuestas
                        </button>
                    {% endif %}

                    {% if currentUserRole == 'LEAGUE_ADMIN' %}
                    <div id="adminQuestionsViewContainer" class="mt-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Todas las Preguntas de la Quiniela</h3>
                        <!-- Questions will be rendered here by JavaScript -->
                        <div id="adminQuestionsList" class="space-y-2">
                            <!-- JS will populate this -->
                        </div>
                    </div>
                    {% endif %}
                </div>

            </div>

            <!-- Sidebar -->
            <aside class="space-y-6 lg:sticky lg:top-24 self-start"> <!-- Added self-start for sticky behavior -->
                <!-- Clasificacion de la Quiniela Section -->
                {% if race.quiniela_close_date and race.quiniela_close_date < current_time_utc %}
                <div id="quinielaLeaderboardSection" class="bg-white rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Clasificaci√≥n de la Quiniela</h2>
                    <div id="quinielaLeaderboardListContainer">
                        <p id="loadingLeaderboardMsg" class="text-gray-600">Cargando clasificaci√≥n...</p>
                        <!-- Leaderboard items will be populated here by JavaScript -->
                    </div>
                </div>
                {% else %}
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Clasificaci√≥n de la Quiniela</h2>
                    <p class="text-gray-600">La clasificaci√≥n estar√° disponible cuando se cierre la quiniela.</p>
                </div>
                {% endif %}

                <!-- Race Participants Section (Moved Here) -->
                {% if currentUserRole == 'ADMIN' or currentUserRole == 'LEAGUE_ADMIN' %}
                <div id="raceParticipantsSection" class="bg-white rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Participantes de la Carrera</h2>
                    <div id="raceParticipantsListContainer">
                        <div id="loadingParticipantsMessage" style="display: none;">
                            <p class="text-gray-600">Cargando participantes...</p>
                        </div>
                        <div id="errorLoadingParticipantsMessage" style="display: none;">
                            <p class="text-red-500">Error al cargar los participantes.</p>
                        </div>
                        <!-- Participant list will be populated here by JavaScript -->
                    </div>
                </div>
                {% endif %}

                <!-- Race Segments (Moved Here) -->
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Segmentos de la Carrera</h2>
                    {% if race.segment_details and race.segment_details|length > 0 %}
                    <div class="space-y-6 relative"> {# <--- Removed timeline-line class #}
                        {% for detail in race.segment_details %}
                            {% if detail.segment %}
                                {% set segment_name = detail.segment.name %}
                                {% set segment_name_lower = segment_name.lower() %}
                                {% set border_color_class = 'transition-segment' %}
                                {% set icon_bg_color = 'bg-orange-500' %}
                                {% set text_color = 'text-orange-500' %}
                                {% set segment_icon = 'fa-exchange-alt' %}

                                {% if 'nataci√≥n' in segment_name_lower or 'swim' in segment_name_lower %}
                                    {% set border_color_class = 'swim-segment' %}
                                    {% set icon_bg_color = 'bg-blue-500' %}
                                    {% set text_color = 'text-blue-500' %}
                                    {% set segment_icon = 'fa-swimmer' %}
                                {% elif 'ciclismo' in segment_name_lower or 'bike' in segment_name_lower %}
                                    {% set border_color_class = 'bike-segment' %}
                                    {% set icon_bg_color = 'bg-gray-700' %}
                                    {% set text_color = 'text-gray-700' %}
                                    {% set segment_icon = 'fa-biking' %}
                                {% elif 'carrera' in segment_name_lower or 'running' in segment_name_lower or 'run' in segment_name_lower %}
                                    {% set border_color_class = 'run-segment' %}
                                    {% set icon_bg_color = 'bg-green-500' %}
                                    {% set text_color = 'text-green-500' %}
                                    {% set segment_icon = 'fa-running' %}
                                {% endif %}

                            <!-- Segment Card -->
                            <div class="segment-card {{ border_color_class }} bg-white p-4 rounded-lg shadow-md relative pl-12"> {# <--- Adjusted classes: removed md:ml-6, changed pl-16 md:pl-4 to pl-12 #}
                                <div class="absolute left-0 top-1/2 transform -translate-y-1/2 -translate-x-1/2 w-12 h-12 {{ icon_bg_color }} rounded-full flex items-center justify-center border-4 border-white"> {# <--- Removed md:-translate-x-1/2 #}
                                    <i class="fas {{ segment_icon }} text-white text-lg"></i>
                                </div>
                                <div class="flex items-center space-x-4 ml-8"> {# <--- Changed ml-8 md:ml-10 to ml-8 #}
                                    <div class="flex-1">
                                        <h3 class="font-bold text-gray-800">{{ segment_name }}</h3>
                                        <p class="text-gray-600 text-sm">{{ detail.distance_km }} km</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold {{ text_color }}">{{ detail.distance_km }} KM</div>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                                <div class="segment-card bg-white p-4 rounded-lg shadow-md relative pl-12"> {# <--- Adjusted classes similarly for error card #}
                                    <p class="text-red-500">Error: Datos del segmento incompletos.</p>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-gray-500">No hay detalles de segmentos para esta carrera.</p>
                    {% endif %}
                </div>
            </aside>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p>&copy; {{ current_year }} Fantasy Tri. Todos los derechos reservados.</p>
        </div>
    </footer>

    <!-- Share Race Modal -->
    <div id="shareRaceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 110;">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">Compartir Enlace de Carrera</h2>
                <button id="closeShareRaceModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div class="mb-4">
                <label for="shareableLinkInput" class="block text-sm font-medium text-gray-700 mb-1">Enlace Compartible:</label>
                <input type="text" id="shareableLinkInput" readonly class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-gray-100 rounded-md shadow-sm sm:text-sm">
            </div>
            <div class="mb-6"> <!-- Increased margin-bottom -->
                <label for="raceAccessCodeInput" class="block text-sm font-medium text-gray-700 mb-1">C√≥digo de Acceso:</label>
                <input type="text" id="raceAccessCodeInput" readonly class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-gray-100 rounded-md shadow-sm sm:text-sm">
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" id="copyShareLinkBtn" class="btn btn-primary">Copiar Enlace</button>
                <button type="button" id="copyAccessCodeBtn" class="btn btn-secondary">Copiar C√≥digo</button> <!-- New Button -->
            </div>
            <p id="copyShareLinkFeedback" class="text-sm text-green-600 mt-2" style="display:none;">¬°Enlace copiado!</p>
            <p id="copyAccessCodeFeedback" class="text-sm text-green-600 mt-2" style="display:none;">¬°C√≥digo copiado!</p> <!-- New Feedback P -->
        </div>
    </div>

    <!-- Edit Race Details Modal -->
    {% if currentUserRole == 'ADMIN' or currentUserRole == 'LEAGUE_ADMIN' %}
    <div id="editRaceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 100;">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Editar Detalles de la Carrera</h2>
                <button id="closeEditRaceModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <form id="editRaceForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="raceTitle" class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo</label>
                        <input type="text" id="raceTitle" name="title" value="{{ race.title | default('') }}" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="raceLocation" class="block text-sm font-medium text-gray-700 mb-1">Ubicaci√≥n</label>
                        <input type="text" id="raceLocation" name="location" value="{{ race.location | default('') }}" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                    </div>
                </div>
                <div class="mb-6"> <!-- New field for Category -->
                    <label for="raceCategory" class="block text-sm font-medium text-gray-700 mb-1">Categor√≠a</label>
                    <input type="text" id="raceCategory" name="category" value="{{ race.category | default('Elite') }}" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm" placeholder="Ej: Elite, Sub-23, General">
                </div>
                <div class="mb-6">
                    <label for="raceDescription" class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
                    <textarea id="raceDescription" name="description" rows="4" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">{{ race.description | default('') }}</textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="raceEventDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha y Hora del Evento</label>
                        <input type="datetime-local" id="raceEventDate" name="event_date" value="{{ race.event_date.strftime('%Y-%m-%dT%H:%M') if race.event_date else '' }}" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="raceGenderCategory" class="block text-sm font-medium text-gray-700 mb-1">Categor√≠a de G√©nero</label>
                        <select id="raceGenderCategory" name="gender_category" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                            <option value="MIXED" {% if race.gender_category == 'MIXED' %}selected{% endif %}>Mixta</option>
                            <option value="MALE_ONLY" {% if race.gender_category == 'MALE_ONLY' %}selected{% endif %}>Solo Hombres</option>
                            <option value="FEMALE_ONLY" {% if race.gender_category == 'FEMALE_ONLY' %}selected{% endif %}>Solo Mujeres</option>
                            <option value="OTHER" {% if race.gender_category == 'OTHER' %}selected{% endif %}>Otra</option>
                        </select>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="racePromoImageUrl" class="block text-sm font-medium text-gray-700 mb-1">URL Imagen Promocional</label>
                    <input type="url" id="racePromoImageUrl" name="promo_image_url" value="{{ race.promo_image_url | default('') }}" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm" placeholder="https://ejemplo.com/imagen.jpg">
                </div>
                <div class="mb-6">
                    <label for="editRaceQuinielaCloseDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha Cierre Quiniela</label>
                    <input type="datetime-local" id="editRaceQuinielaCloseDate" name="quiniela_close_date" value="{{ race.quiniela_close_date.strftime('%Y-%m-%dT%H:%M') if race.quiniela_close_date else '' }}" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelEditRaceBtn" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" id="saveRaceChangesBtn" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <script>
        const raceId = "{{ race.id | default('') }}";
        const raceAccessCode = "{{ race.access_code | default('') }}"; // Added access code
        const raceEventDateString = "{{ race.event_date.isoformat() if race.event_date else '' }}";
        const raceTitle = {{ race.title | tojson }};
        const currentUserRole = "{{ current_user.role.code if current_user and current_user.is_authenticated and current_user.role else 'GUEST' }}";
        const isUserRegisteredForRace = {{ is_user_registered_for_race | tojson }};
        const hasUserAnsweredPool = {{ has_user_answered_pool | tojson }}; // Added this line
        const quinielaCloseDate = "{{ race.quiniela_close_date.isoformat() if race.quiniela_close_date else '' }}";
        let allRaceQuestions = [];
        let isFetchingQuestions = false;
        let raceStatsCountdownInterval = null; // Variable to hold the interval ID

        function startCountdown(targetDateISO, displayElement) {
            if (raceStatsCountdownInterval) {
                clearInterval(raceStatsCountdownInterval); // Clear any existing interval
            }

            const targetDate = new Date(targetDateISO);

            function updateCountdown() {
                const now = new Date();
                const difference = targetDate - now;

                if (difference <= 0) {
                    displayElement.textContent = 'Quiniela Cerrada';
                    clearInterval(raceStatsCountdownInterval);
                    return;
                }

                const days = Math.floor(difference / (1000 * 60 * 60 * 24));
                const hours = Math.floor((difference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((difference % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((difference % (1000 * 60)) / 1000);

                let parts = [];
                if (days > 0) parts.push(days + (days === 1 ? ' d√≠a' : ' d√≠as'));
                if (hours > 0) parts.push(hours + (hours === 1 ? ' hr' : ' hrs'));
                if (minutes > 0) parts.push(minutes + (minutes === 1 ? ' min' : ' mins'));
                if (days === 0 && hours === 0 && minutes < 30) { // Show seconds only if less than 30 mins remaining and no days/hours
                     if (seconds > 0 || parts.length === 0) parts.push(seconds + (seconds === 1 ? ' seg' : ' segs'));
                }

                if (parts.length === 0 && difference > 0) { // If difference is small (e.g. few seconds)
                    displayElement.textContent = 'Cerrando pronto...';
                } else if (parts.length > 0) {
                    displayElement.textContent = parts.join(', ');
                } else { // Should be caught by difference <=0, but as a fallback
                    displayElement.textContent = 'Calculando...';
                }
            }

            updateCountdown(); // Initial call
            raceStatsCountdownInterval = setInterval(updateCountdown, 1000); // Update every second
        }

        function fetchAndDisplayRaceStats(raceIdForStats) {
            if (!raceIdForStats) return;

            const participantsSpan = document.getElementById('statParticipantsCount');
            const predictionsSpan = document.getElementById('statPredictionsCount');
            const timeRemainingSpan = document.getElementById('statTimeRemaining');

            if (!participantsSpan || !predictionsSpan || !timeRemainingSpan) {
                console.error("Statistic display elements not found.");
                return;
            }

            fetch(`/api/races/${raceIdForStats}/statistics`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(stats => {
                    participantsSpan.textContent = stats.participant_count !== undefined ? stats.participant_count : 'N/A';
                    predictionsSpan.textContent = stats.predictions_count !== undefined ? stats.predictions_count : 'N/A';

                    if (stats.quiniela_close_date) {
                        startCountdown(stats.quiniela_close_date, timeRemainingSpan);
                    } else {
                        timeRemainingSpan.textContent = 'No definida';
                    }
                })
                .catch(error => {
                    console.error('Error fetching race statistics:', error);
                    participantsSpan.textContent = 'Error';
                    predictionsSpan.textContent = 'Error';
                    timeRemainingSpan.textContent = 'Error';
                });
        }

        // Function to render questions for LEAGUE_ADMIN
        function renderAdminQuestionsView(questions) {
            const adminQuestionsListDiv = document.getElementById('adminQuestionsList');
            if (!adminQuestionsListDiv) {
                console.log("Admin questions list div not found");
                return;
            }

            adminQuestionsListDiv.innerHTML = ''; // Clear previous content

            if (!questions || questions.length === 0) {
                adminQuestionsListDiv.innerHTML = '<p class="text-gray-500">No hay preguntas definidas para esta carrera.</p>';
                return;
            }

        questions.forEach((q, index) => {
            const questionCard = document.createElement('div');
            questionCard.className = 'bg-white shadow-md rounded-lg p-4 mb-4'; // Main card styling

            // Question Text
            const questionTextElem = document.createElement('p');
            questionTextElem.className = 'font-semibold text-gray-800 mb-2'; // Adjusted margin
            questionTextElem.textContent = `${index + 1}-${q.text}`;
            questionCard.appendChild(questionTextElem);

            // Scoring Info (using existing function)
            const scoringInfoElem = document.createElement('div');
            scoringInfoElem.className = 'mb-3'; // Add some margin below scoring info
            scoringInfoElem.innerHTML = formatScoringInfoForDisplay(q); // Existing function
            questionCard.appendChild(scoringInfoElem);

            // Options (if any)
            if (q.options && q.options.length > 0) {
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'mt-3 border-t border-gray-200 pt-3';

                const optionsHeading = document.createElement('h5');
                optionsHeading.className = 'text-sm font-medium text-gray-700 mb-1';
                optionsHeading.textContent = 'Opciones Definidas:';
                optionsContainer.appendChild(optionsHeading);

                const optionsList = document.createElement('ul');
                optionsList.className = 'list-disc pl-5 space-y-1 text-xs text-gray-600';

                q.options.forEach(opt => {
                    const optionItem = document.createElement('li');
                    optionItem.textContent = opt.option_text;
                    optionsList.appendChild(optionItem);
                });
                optionsContainer.appendChild(optionsList);
                questionCard.appendChild(optionsContainer);
            }

            // Display Official Answer and Max Points
            const officialAnswerSection = document.createElement('div');
            officialAnswerSection.className = 'mt-3 border-t border-gray-200 pt-3';

            const officialAnswerTitle = document.createElement('h5');
            officialAnswerTitle.className = 'text-sm font-medium text-gray-700 mb-1';
            officialAnswerTitle.textContent = 'Respuesta Oficial:';
            officialAnswerSection.appendChild(officialAnswerTitle);

            const officialAnswerContent = document.createElement('div');
            officialAnswerContent.className = 'text-sm p-2 bg-blue-50 border border-blue-200 rounded';
            let formattedOfficialAns = formatAnswerForDisplay(
                q.official_answer, // This is the value/data of the official answer
                q.official_answer_question_type, // The type of the question for which this is an official answer
                q.official_answer_is_mc_multiple_correct // Flag for MC multiple correct
            );

            // Append slider unit if applicable
            if (q.official_answer_question_type === 'SLIDER' && q.slider_unit && q.official_answer !== null && q.official_answer !== undefined) {
                // Check if formattedOfficialAns is not the "No respondida" span
                if (!formattedOfficialAns.includes('<span class="italic text-gray-500">')) {
                     if (formattedOfficialAns.includes('</p>')) {
                        formattedOfficialAns = formattedOfficialAns.replace(/<\/p>$/, ` ${q.slider_unit}</p>`);
                    } else {
                        // If it's just the number (no <p>), append the unit directly.
                        // This might happen if formatAnswerForDisplay returns just the number for sliders.
                        formattedOfficialAns += ` ${q.slider_unit}`;
                    }
                }
            }
            officialAnswerContent.innerHTML = formattedOfficialAns;
            officialAnswerSection.appendChild(officialAnswerContent);
            questionCard.appendChild(officialAnswerSection);

            const maxPointsSection = document.createElement('div');
            maxPointsSection.className = 'mt-2 text-xs text-right text-gray-600';
            maxPointsSection.innerHTML = `Puntos M√°ximos: <span class="font-semibold text-orange-600">${q.max_points_possible !== undefined ? q.max_points_possible : 'N/A'}</span>`;
            questionCard.appendChild(maxPointsSection);

            // Display User's Answer and Points if available
            if (q.user_answer_details) {
                const userAnswerSection = document.createElement('div');
                userAnswerSection.className = 'mt-3 border-t border-gray-200 pt-3';

                const userAnswerTitle = document.createElement('h5');
                userAnswerTitle.className = 'text-sm font-medium text-gray-700 mb-1';
                userAnswerTitle.textContent = 'Tu Respuesta:';
                userAnswerSection.appendChild(userAnswerTitle);

                const userAnswerContent = document.createElement('div');
                userAnswerContent.className = 'text-sm p-2 bg-green-50 border border-green-200 rounded'; // Light green background for user answer

                let formattedUserAns = formatAnswerForDisplay(
                    q.user_answer_details.answer,
                    q.question_type, // Use the main question_type for formatting user's answer
                    q.is_mc_multiple_correct // Use the main flag for MC multiple correct
                );

                if (q.question_type === 'SLIDER' && q.slider_unit && q.user_answer_details.answer !== null && q.user_answer_details.answer !== undefined) {
                    if (!formattedUserAns.includes('<span class="italic text-gray-500">')) {
                        if (formattedUserAns.includes('</p>')) {
                            formattedUserAns = formattedUserAns.replace(/<\/p>$/, ` ${q.slider_unit}</p>`);
                        } else {
                            formattedUserAns += ` ${q.slider_unit}`;
                        }
                    }
                }
                userAnswerContent.innerHTML = formattedUserAns;
                userAnswerSection.appendChild(userAnswerContent);

                // Display points obtained by user for this question
                const userPointsSection = document.createElement('div');
                userPointsSection.className = 'mt-2 text-xs text-right';
                let pointsDisplay = 'Puntos Obtenidos: ';
                if (q.user_answer_details.points_obtained !== null && q.user_answer_details.points_obtained !== undefined) {
                    pointsDisplay += `<span class="font-semibold ${q.user_answer_details.points_obtained > 0 ? 'text-green-600' : (q.user_answer_details.points_obtained < 0 ? 'text-red-600' : 'text-gray-600')}">${q.user_answer_details.points_obtained}</span>`;
                } else {
                    pointsDisplay += '<span class="italic text-gray-500">No evaluado a√∫n</span>';
                }
                userPointsSection.innerHTML = pointsDisplay;
                userAnswerSection.appendChild(userPointsSection);

                questionCard.appendChild(userAnswerSection);
            }

            adminQuestionsListDiv.appendChild(questionCard);
        });
        }

        // Global Helper Functions
        // function toggleQuestions() { // Commenting out as it's no longer used directly by a button
        //     const questionsContentElem = document.getElementById('questionsContent');
        //     const expandIconElem = document.getElementById('expandIcon');
        //     const toggleQuestionsBtnElem = document.getElementById('toggleQuestionsBtn');

        //     if (questionsContentElem.classList.contains('expanded')) {
        //         questionsContentElem.classList.remove('expanded');
        //         if(expandIconElem) expandIconElem.classList.replace('fa-chevron-up', 'fa-chevron-down');
        //         if(toggleQuestionsBtnElem) toggleQuestionsBtnElem.innerHTML = '<i id="expandIcon" class="fas fa-chevron-down mr-1"></i>Ver Preguntas';
        //     } else {
        //         questionsContentElem.classList.add('expanded');
        //         if(expandIconElem) expandIconElem.classList.replace('fa-chevron-down', 'fa-chevron-up');
        //         if(toggleQuestionsBtnElem) toggleQuestionsBtnElem.innerHTML = '<i id="expandIcon" class="fas fa-chevron-up mr-1"></i>Ocultar Preguntas';
        //     }
        // }

        function formatScoringInfoForDisplay(question) {
            let scoringText = '';
            switch (question.question_type) {
                case 'FREE_TEXT':
                    scoringText = `M√°x. ${question.max_score_free_text || 'N/A'} pts.`;
                    break;
                case 'MULTIPLE_CHOICE':
                    if (question.is_mc_multiple_correct) {
                        scoringText = `Selecci√≥n M√∫ltiple. ${question.points_per_correct_mc || 'N/A'} pts/correcta, ${question.points_per_incorrect_mc || '0'} pts/incorrecta.`;
                    } else {
                        scoringText = `Selecci√≥n √önica. ${question.total_score_mc_single || 'N/A'} pts total.`;
                    }
                    break;
                case 'ORDERING':
                    scoringText = `Ordenamiento. ${question.points_per_correct_order || 'N/A'} pts/item, ${question.bonus_for_full_order || '0'} pts bonus.`;
                    break;
                case 'SLIDER':
                    scoringText = `Slider. Rango: [${question.slider_min_value !== null ? question.slider_min_value : 'N/A'} - ${question.slider_max_value !== null ? question.slider_max_value : 'N/A'}]${question.slider_unit ? ' ' + question.slider_unit : ''}.`;
                    scoringText += ` Paso: ${question.slider_step !== null ? question.slider_step : 'N/A'}.`;
                    scoringText += ` Pts exactos: ${question.slider_points_exact !== null ? question.slider_points_exact : 'N/A'}.`;
                    if (question.slider_threshold_partial !== null && question.slider_points_partial !== null) {
                        scoringText += ` Pts parciales: ${question.slider_points_partial} (umbral +/- ${question.slider_threshold_partial}).`;
                    }
                    break;
                default:
                    scoringText = 'Puntuaci√≥n no especificada.';
            }
            return `<span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">${scoringText}</span>`;
        }

        function renderQuestions(questions) {
            const questionsLoadingDivElem = document.getElementById('questionsLoading');
            const questionsContentElem = document.getElementById('questionsContent');
            const noQuestionsMessageDivElem = document.getElementById('noQuestionsMessage');
            const currentToggleQuestionsBtnElem = document.getElementById('toggleQuestionsBtn');
            const currentSubmitPredictionsContainerElem = document.getElementById('submitPredictionsContainer');

            if(questionsLoadingDivElem) questionsLoadingDivElem.style.display = 'none';
            if(questionsContentElem) questionsContentElem.innerHTML = '';

            allRaceQuestions = questions;

            if (!questions || questions.length === 0) {
                if(noQuestionsMessageDivElem) noQuestionsMessageDivElem.style.display = 'block';
                if(currentToggleQuestionsBtnElem) {
                    currentToggleQuestionsBtnElem.innerHTML = '<i id="expandIcon" class="fas fa-info-circle mr-1"></i>No hay preguntas';
                }
                if(questionsContentElem) questionsContentElem.classList.remove('expanded');
                if(currentSubmitPredictionsContainerElem) currentSubmitPredictionsContainerElem.classList.add('hidden');
                return;
            }

            if(noQuestionsMessageDivElem) noQuestionsMessageDivElem.style.display = 'none';

            questions.forEach((q, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card p-5';
                let optionsHtml = '';
                if (q.question_type === 'MULTIPLE_CHOICE') {
                    optionsHtml += '<div class="space-y-2 mt-3">';
                    q.options.forEach(opt => {
                        const inputType = q.is_mc_multiple_correct ? 'checkbox' : 'radio';
                        optionsHtml += `
                            <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded-md border border-gray-200 hover:border-orange-300">
                                <input type="${inputType}" name="question_${q.id}" value="${opt.id}" class="text-orange-500 focus:ring-orange-400 focus:ring-offset-0">
                                <span class="text-gray-700">${opt.option_text}</span>
                            </label>
                        `;
                    });
                    optionsHtml += '</div>';
                } else if (q.question_type === 'FREE_TEXT') {
                    optionsHtml = `
                        <textarea class="w-full p-3 mt-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                  rows="3" placeholder="Escribe tu predicci√≥n..."></textarea>
                        <div class="flex justify-between items-center mt-1 text-xs text-gray-500">
                            <span>Texto libre</span>
                            <span>0/200 caracteres</span>
                        </div>
                    `;
                } else if (q.question_type === 'ORDERING') {
                     optionsHtml += '<div id="sortableList_' + q.id + '" class="space-y-2 mt-3">';
                     q.options.forEach(opt => {
                        optionsHtml += `
                            <div class="drag-item bg-gray-50 p-3 rounded-lg border-2 border-gray-200 cursor-move flex items-center justify-between">
                                <span class="text-gray-700">${opt.option_text}</span>
                                <i class="fas fa-grip-vertical text-gray-400"></i>
                            </div>
                        `;
                     });
                     optionsHtml += '</div>';
                }

                questionCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-semibold text-gray-800 flex-1 pr-2">${index + 1}-${q.text} ${q.is_active ? '' : '<span class="text-red-500 text-xs font-normal">(Inactiva)</span>'}</h3>
                        ${formatScoringInfoForDisplay(q)}
                    </div>
                    ${optionsHtml}
                    <div class="flex justify-between items-center mt-4">
                        <div class="text-xs text-gray-500">${q.question_type.replace('_', ' ').toLowerCase()}</div>
                        {% if currentUserRole == 'ADMIN' or currentUserRole == 'LEAGUE_ADMIN' %}
                        <div class="space-x-2">
                            <button id="editQuestionBtn_${q.id}" class="text-blue-500 hover:text-blue-700 text-sm font-medium">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button id="deleteQuestionBtn_${q.id}" class="text-red-500 hover:text-red-700 text-sm font-medium">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                        {% endif %}
                    </div>
                `;
                if(questionsContentElem) questionsContentElem.appendChild(questionCard);

                if (currentUserRole === 'ADMIN' || currentUserRole === 'LEAGUE_ADMIN') {
                    const editBtn = document.getElementById(`editQuestionBtn_${q.id}`);
                    if (editBtn) {
                        editBtn.addEventListener('click', () => openEditQuestionModal(q.id));
                    }
                    const deleteBtn = document.getElementById(`deleteQuestionBtn_${q.id}`);
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', () => openDeleteConfirmModal(q.id));
                    }
                }
            });

            if(questionsContentElem) questionsContentElem.classList.add('expanded');
            if(currentToggleQuestionsBtnElem) {
                currentToggleQuestionsBtnElem.innerHTML = `<i id="expandIcon" class="fas fa-chevron-up mr-1"></i>Ocultar Preguntas (${questions.length})`;
            }
            if(currentSubmitPredictionsContainerElem) currentSubmitPredictionsContainerElem.classList.remove('hidden');
        }

        function fetchAndRenderQuestions() {
            const questionsLoadingDivElem = document.getElementById('questionsLoading');
            const questionsErrorDivElem = document.getElementById('questionsError');
            const noQuestionsMessageDivElem = document.getElementById('noQuestionsMessage');

            if(!raceId || !document.getElementById('predictionQuestionsSection')) return;

            if (isFetchingQuestions) return;
            isFetchingQuestions = true;

            if(questionsLoadingDivElem) questionsLoadingDivElem.style.display = 'block';
            if(questionsErrorDivElem) questionsErrorDivElem.style.display = 'none';
            if(noQuestionsMessageDivElem) noQuestionsMessageDivElem.style.display = 'none';

            fetch(`/api/races/${raceId}/questions`)
                .then(response => {
                    if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);
                    return response.json();
                })
                .then(questions => {
                    allRaceQuestions = questions;
                    renderQuestions(questions); // This is for the main question display (wizard/user participation)

                    // If the current user is LEAGUE_ADMIN, render the admin-specific view
                    if (currentUserRole === 'LEAGUE_ADMIN') {
                        const adminQuestionsListContainer = document.getElementById('adminQuestionsViewContainer');
                        if (adminQuestionsListContainer) { // Check if the container exists
                             renderAdminQuestionsView(allRaceQuestions);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching questions:', error);
                    if(questionsLoadingDivElem) questionsLoadingDivElem.style.display = 'none';
                    if(questionsErrorDivElem) {
                        questionsErrorDivElem.textContent = `Error al cargar preguntas: ${error.message}.`;
                        questionsErrorDivElem.style.display = 'block';
                    }
                })
                .finally(() => {
                    isFetchingQuestions = false;
                    // Check to display Answer Questions button after questions are fetched
                    const answerQuestionsBtn = document.getElementById('answerQuestionsBtn');
                    if (answerQuestionsBtn && isUserRegisteredForRace && allRaceQuestions && allRaceQuestions.length > 0) {
                        answerQuestionsBtn.style.display = 'inline-flex'; // Or 'block' or other appropriate display style
                    }
                });
        }

        function handleQuestionTypeChange() {
            const mcFieldsContainer = document.getElementById('multipleChoiceFieldsContainer');
            const oFieldsContainer = document.getElementById('orderingFieldsContainer');
            const ftFieldsContainer = document.getElementById('freeTextFieldsContainer');
            const slFieldsContainer = document.getElementById('sliderFieldsContainer'); // Get slider container
            const qTypeSelect = document.getElementById('questionTypeSelect');

            // Ensure all containers are valid before trying to set display property
            if (!mcFieldsContainer || !oFieldsContainer || !ftFieldsContainer || !slFieldsContainer || !qTypeSelect) {
                console.error("One or more question type field containers not found in handleQuestionTypeChange.");
                return;
            }

            mcFieldsContainer.style.display = 'none';
            oFieldsContainer.style.display = 'none';
            ftFieldsContainer.style.display = 'none';
            slFieldsContainer.style.display = 'none'; // Hide slider container by default

            const selectedType = qTypeSelect.value;
            if (selectedType === 'MULTIPLE_CHOICE') {
                mcFieldsContainer.style.display = 'block';
            } else if (selectedType === 'ORDERING') {
                oFieldsContainer.style.display = 'block';
            } else if (selectedType === 'FREE_TEXT') {
                ftFieldsContainer.style.display = 'block';
            } else if (selectedType === 'SLIDER') { // Show slider container
                slFieldsContainer.style.display = 'block';
            }
        }

        function resetAddEditQuestionForm() {
            const form = document.getElementById('addEditQuestionForm');
            const editingIdInput = document.getElementById('editingQuestionId');
            const qTypeSelect = document.getElementById('questionTypeSelect');
            const mcOptContainer = document.getElementById('mcOptionsContainer');
            const oOptContainer = document.getElementById('orderingOptionsContainer');
            const ptsPerCorrectMc = document.getElementById('pointsPerCorrectMc');
            const ptsPerIncorrectMc = document.getElementById('pointsPerIncorrectMc');
            const totalScoreMc = document.getElementById('totalScoreMcSingle');
            const ptsPerCorrectOrd = document.getElementById('pointsPerCorrectOrder');
            const bonusFullOrd = document.getElementById('bonusForFullOrder');
            const maxScoreFt = document.getElementById('maxScoreFreeText');
            // Slider fields for reset
            const sliderUnitInput = document.getElementById('sliderUnitInput');
            const sliderMinValueInput = document.getElementById('sliderMinValueInput');
            const sliderMaxValueInput = document.getElementById('sliderMaxValueInput');
            const sliderStepInput = document.getElementById('sliderStepInput');
            const sliderPointsExactInput = document.getElementById('sliderPointsExactInput');
            const sliderThresholdPartialInput = document.getElementById('sliderThresholdPartialInput');
            const sliderPointsPartialInput = document.getElementById('sliderPointsPartialInput');


            if(form) form.reset();
            if(editingIdInput) editingIdInput.value = '';
            if(qTypeSelect) qTypeSelect.disabled = false;

            // Reset common fields
            if(mcOptContainer) mcOptContainer.innerHTML = '';
            if(oOptContainer) oOptContainer.innerHTML = '';
            if(ptsPerCorrectMc) ptsPerCorrectMc.value = '';
            if(ptsPerIncorrectMc) ptsPerIncorrectMc.value = '';
            if(totalScoreMc) totalScoreMc.value = '';
            if(ptsPerCorrectOrd) ptsPerCorrectOrd.value = '';
            if(bonusFullOrd) bonusFullOrd.value = '';
            if(maxScoreFt) maxScoreFt.value = '';

            // Reset SLIDER specific fields
            if(sliderUnitInput) sliderUnitInput.value = '';
            if(sliderMinValueInput) sliderMinValueInput.value = '';
            if(sliderMaxValueInput) sliderMaxValueInput.value = '';
            if(sliderStepInput) sliderStepInput.value = '1'; // Default step to 1
            if(sliderPointsExactInput) sliderPointsExactInput.value = '';
            if(sliderThresholdPartialInput) sliderThresholdPartialInput.value = '';
            if(sliderPointsPartialInput) sliderPointsPartialInput.value = '';

            if(qTypeSelect) handleQuestionTypeChange(); // Apply visibility based on current (reset) type
        }

        function createOptionInputDiv(optionText = "", optionId = null, isCorrect = false, questionType = "MULTIPLE_CHOICE") {
            if (questionType === "ORDERING") {
                const listItem = document.createElement('li');
                // optionId is not strictly needed for new items until saved, but dataset can be used if ever required.
                // listItem.dataset.optionId = optionId || ''; // New items won't have an opt.id from the DB yet
                listItem.className = 'edit-modal-ordering-item p-2 border rounded-md bg-gray-50 flex items-center space-x-2 shadow-sm mb-2';

                const textInput = document.createElement('input');
                textInput.type = 'text';
                textInput.value = optionText; // Will be empty for new options
                textInput.className = 'flex-grow p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm';
                textInput.placeholder = 'Texto del √≠tem';
                listItem.appendChild(textInput);

                const upButton = document.createElement('button');
                upButton.innerHTML = '‚Üë';
                upButton.type = 'button';
                upButton.className = 'edit-modal-move-up-btn px-2 py-1 border rounded-md text-sm hover:bg-gray-200 focus:outline-none focus:ring-1 focus:ring-orange-300';
                upButton.addEventListener('click', () => {
                    const currentLi = upButton.closest('li');
                    if (currentLi && currentLi.previousElementSibling) {
                        currentLi.parentNode.insertBefore(currentLi, currentLi.previousElementSibling);
                        updateEditModalOrderingButtonStates(currentLi.parentNode);
                    }
                });
                listItem.appendChild(upButton);

                const downButton = document.createElement('button');
                downButton.innerHTML = '‚Üì';
                downButton.type = 'button';
                downButton.className = 'edit-modal-move-down-btn px-2 py-1 border rounded-md text-sm hover:bg-gray-200 focus:outline-none focus:ring-1 focus:ring-orange-300';
                downButton.addEventListener('click', () => {
                    const currentLi = downButton.closest('li');
                    if (currentLi && currentLi.nextElementSibling) {
                        currentLi.parentNode.insertBefore(currentLi, currentLi.nextElementSibling.nextSibling);
                        updateEditModalOrderingButtonStates(currentLi.parentNode);
                    }
                });
                listItem.appendChild(downButton);

                const removeButton = document.createElement('button');
                removeButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
                removeButton.type = 'button';
                removeButton.className = 'text-red-500 hover:text-red-700 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-red-300';
                removeButton.onclick = () => {
                    const parentUl = listItem.parentNode;
                    listItem.remove();
                    if (parentUl) updateEditModalOrderingButtonStates(parentUl);
                };
                listItem.appendChild(removeButton);
                return listItem;

            } else { // Existing logic for MULTIPLE_CHOICE
                const optionDiv = document.createElement('div');
                optionDiv.className = 'flex items-center space-x-2 mb-2';
                const textInput = document.createElement('input');
                textInput.type = 'text';
                textInput.className = 'mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm sm:text-sm flex-grow';
                textInput.value = optionText;
                textInput.placeholder = "Texto de la opci√≥n"; // Default placeholder
                optionDiv.appendChild(textInput);
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'text-red-500 hover:text-red-700';
                removeBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                removeBtn.onclick = () => optionDiv.remove();
                optionDiv.appendChild(removeBtn);
                return optionDiv;
            }
        }

        function openAddQuestionModal() {
            if (quinielaCloseDate && new Date(quinielaCloseDate) < new Date()) {
                alert("La quiniela ya est√° cerrada y no se pueden a√±adir nuevas preguntas.");
                return;
            }
            const modal = document.getElementById('addEditQuestionModal');
            const title = document.getElementById('addEditQuestionModalTitle');
            const editingIdInput = document.getElementById('editingQuestionId');
            const form = document.getElementById('addEditQuestionForm');
            const mcOptContainer = document.getElementById('mcOptionsContainer');
            const oOptContainer = document.getElementById('orderingOptionsContainer');
            const qTypeSelect = document.getElementById('questionTypeSelect');

            if (!modal) return;
            if(editingIdInput) editingIdInput.value = '';
            if(title) title.textContent = 'A√±adir Nueva Pregunta';
            if(form) form.reset();
            if(mcOptContainer) mcOptContainer.innerHTML = '';
            if(oOptContainer) oOptContainer.innerHTML = '';
            if(qTypeSelect) handleQuestionTypeChange();
            const currentSelectedType = qTypeSelect ? qTypeSelect.value : null;
            if (currentSelectedType === 'MULTIPLE_CHOICE' && mcOptContainer) {
                mcOptContainer.appendChild(createOptionInputDiv("", null, false, "MULTIPLE_CHOICE"));
                mcOptContainer.appendChild(createOptionInputDiv("", null, false, "MULTIPLE_CHOICE"));
            } else if (currentSelectedType === 'ORDERING' && oOptContainer) {
                oOptContainer.appendChild(createOptionInputDiv("", null, false, "ORDERING"));
                oOptContainer.appendChild(createOptionInputDiv("", null, false, "ORDERING"));
            }
            modal.style.display = 'flex';
        }

        function openEditQuestionModal(questionId) {
            const modal = document.getElementById('addEditQuestionModal');
            const title = document.getElementById('addEditQuestionModalTitle');
            const editingIdInput = document.getElementById('editingQuestionId');
            const qTextInput = document.getElementById('questionText');
            const qTypeSelect = document.getElementById('questionTypeSelect');
            const maxScoreFtInput = document.getElementById('maxScoreFreeText');
            const isMcMultiCorrectCb = document.getElementById('isMcMultipleCorrect');
            const ptsPerCorrectMc = document.getElementById('pointsPerCorrectMc');
            const ptsPerIncorrectMc = document.getElementById('pointsPerIncorrectMc');
            const totalScoreMcSingle = document.getElementById('totalScoreMcSingle');
            const mcOptContainer = document.getElementById('mcOptionsContainer');
            const ptsPerCorrectOrd = document.getElementById('pointsPerCorrectOrder');
            const bonusForFullOrd = document.getElementById('bonusForFullOrder');
            const oOptContainer = document.getElementById('orderingOptionsContainer');
            // Slider specific input elements for editing
            const sliderUnitInput = document.getElementById('sliderUnitInput');
            const sliderMinValueInput = document.getElementById('sliderMinValueInput');
            const sliderMaxValueInput = document.getElementById('sliderMaxValueInput');
            const sliderStepInput = document.getElementById('sliderStepInput');
            const sliderPointsExactInput = document.getElementById('sliderPointsExactInput');
            const sliderThresholdPartialInput = document.getElementById('sliderThresholdPartialInput');
            const sliderPointsPartialInput = document.getElementById('sliderPointsPartialInput');


            if (!modal || !allRaceQuestions) return;
            const question = allRaceQuestions.find(q => q.id === questionId);
            if (!question) {
                alert('Error: No se encontr√≥ la pregunta para editar.');
                return;
            }
            resetAddEditQuestionForm();
            if(title) title.textContent = 'Editar Pregunta';
            if(editingIdInput) editingIdInput.value = question.id;
            if(qTextInput) qTextInput.value = question.text;
            if(qTypeSelect) {
                qTypeSelect.value = question.question_type;
                qTypeSelect.disabled = true;
            }
            handleQuestionTypeChange();
            if (question.question_type === 'FREE_TEXT') {
                if(maxScoreFtInput) maxScoreFtInput.value = question.max_score_free_text !== null ? question.max_score_free_text : '';
            } else if (question.question_type === 'MULTIPLE_CHOICE') {
                if(isMcMultiCorrectCb) isMcMultiCorrectCb.checked = question.is_mc_multiple_correct;
                if(ptsPerCorrectMc) ptsPerCorrectMc.value = question.points_per_correct_mc !== null ? question.points_per_correct_mc : '';
                if(ptsPerIncorrectMc) ptsPerIncorrectMc.value = question.points_per_incorrect_mc !== null ? question.points_per_incorrect_mc : '';
                if(totalScoreMcSingle) totalScoreMcSingle.value = question.total_score_mc_single !== null ? question.total_score_mc_single : '';
                if(mcOptContainer) {
                    mcOptContainer.innerHTML = '';
                    question.options.forEach(opt => {
                        mcOptContainer.appendChild(createOptionInputDiv(opt.option_text, opt.id, false, "MULTIPLE_CHOICE"));
                    });
                }
            } else if (question.question_type === 'ORDERING') {
                if(ptsPerCorrectOrd) ptsPerCorrectOrd.value = question.points_per_correct_order !== null ? question.points_per_correct_order : '';
                if(bonusForFullOrd) bonusForFullOrd.value = question.bonus_for_full_order !== null ? question.bonus_for_full_order : '';
                if(oOptContainer) {
                    oOptContainer.innerHTML = ''; // Clear existing
                    question.options.forEach(opt => {
                        const listItem = document.createElement('li');
                        listItem.dataset.optionId = opt.id || ''; // Store original ID if present
                        listItem.className = 'edit-modal-ordering-item p-2 border rounded-md bg-gray-50 flex items-center space-x-2 shadow-sm mb-2';

                        const textInput = document.createElement('input');
                        textInput.type = 'text';
                        textInput.value = opt.option_text;
                        textInput.className = 'flex-grow p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm';
                        textInput.placeholder = 'Texto del √≠tem';
                        listItem.appendChild(textInput);

                        const upButton = document.createElement('button');
                        upButton.innerHTML = '‚Üë';
                        upButton.type = 'button';
                        upButton.className = 'edit-modal-move-up-btn px-2 py-1 border rounded-md text-sm hover:bg-gray-200 focus:outline-none focus:ring-1 focus:ring-orange-300';
                        upButton.addEventListener('click', () => {
                            const currentLi = upButton.closest('li');
                            if (currentLi && currentLi.previousElementSibling) {
                                currentLi.parentNode.insertBefore(currentLi, currentLi.previousElementSibling);
                                updateEditModalOrderingButtonStates(oOptContainer);
                            }
                        });
                        listItem.appendChild(upButton);

                        const downButton = document.createElement('button');
                        downButton.innerHTML = '‚Üì';
                        downButton.type = 'button';
                        downButton.className = 'edit-modal-move-down-btn px-2 py-1 border rounded-md text-sm hover:bg-gray-200 focus:outline-none focus:ring-1 focus:ring-orange-300';
                        downButton.addEventListener('click', () => {
                            const currentLi = downButton.closest('li');
                            if (currentLi && currentLi.nextElementSibling) {
                                currentLi.parentNode.insertBefore(currentLi, currentLi.nextElementSibling.nextSibling);
                                updateEditModalOrderingButtonStates(oOptContainer);
                            }
                        });
                        listItem.appendChild(downButton);

                        const removeButton = document.createElement('button');
                        removeButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
                        removeButton.type = 'button';
                        removeButton.className = 'text-red-500 hover:text-red-700 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-red-300';
                        removeButton.onclick = () => {
                            listItem.remove();
                            // Potentially call updateEditModalOrderingButtonStates here if the list becomes empty or changes significantly
                            const listContainer = document.getElementById('orderingOptionsContainer');
                            if (listContainer) updateEditModalOrderingButtonStates(listContainer);
                        };
                        listItem.appendChild(removeButton);

                        oOptContainer.appendChild(listItem);
                    });
                    if (oOptContainer.firstChild) { // Check if there are items before calling
                        updateEditModalOrderingButtonStates(oOptContainer);
                    }
                }
            } else if (question.question_type === 'SLIDER') {
                if(sliderUnitInput) sliderUnitInput.value = question.slider_unit || '';
                if(sliderMinValueInput) sliderMinValueInput.value = question.slider_min_value !== null ? question.slider_min_value : '';
                if(sliderMaxValueInput) sliderMaxValueInput.value = question.slider_max_value !== null ? question.slider_max_value : '';
                if(sliderStepInput) sliderStepInput.value = question.slider_step !== null ? question.slider_step : '1';
                if(sliderPointsExactInput) sliderPointsExactInput.value = question.slider_points_exact !== null ? question.slider_points_exact : '';
                if(sliderThresholdPartialInput) sliderThresholdPartialInput.value = question.slider_threshold_partial !== null ? question.slider_threshold_partial : '';
                if(sliderPointsPartialInput) sliderPointsPartialInput.value = question.slider_points_partial !== null ? question.slider_points_partial : '';
            }
            modal.style.display = 'flex';
        }

        function closeAddEditQuestionModal() {
            const modal = document.getElementById('addEditQuestionModal');
            const qTypeSelect = document.getElementById('questionTypeSelect');
            if (!modal) return;
            modal.style.display = 'none';
            if(qTypeSelect) qTypeSelect.disabled = false;
        }

        function openDeleteConfirmModal(questionId) {
            const modal = document.getElementById('deleteQuestionConfirmModal');
            const input = document.getElementById('questionIdToDelete');
            if(!modal) return;
            if(input) input.value = questionId;
            modal.style.display = 'flex';
        }

        function closeDeleteConfirmModal() {
            const modal = document.getElementById('deleteQuestionConfirmModal');
            if(!modal) return;
            modal.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function() {
            // DOM Element Declarations
            // const logoutButtonNav = document.getElementById('logoutButtonNav'); // Removed, handled by _header.html
            // const questionsContent = document.getElementById('questionsContent'); // Commented out
            // const expandIcon = document.getElementById('expandIcon'); // Commented out
            // const toggleQuestionsBtn = document.getElementById('toggleQuestionsBtn'); // Commented out
            // const submitPredictionsContainer = document.getElementById('submitPredictionsContainer'); // Commented out
            // const questionsLoadingDiv = document.getElementById('questionsLoading'); // Commented out
            // const questionsErrorDiv = document.getElementById('questionsError'); // Commented out
            // const noQuestionsMessageDiv = document.getElementById('noQuestionsMessage'); // Commented out

            const addEditQuestionModal = document.getElementById('addEditQuestionModal');
            const addNewQuestionBtn = document.getElementById('addNewQuestionBtn');
            const closeAddEditQuestionModalBtn = document.getElementById('closeAddEditQuestionModalBtn');
            const cancelAddEditQuestionBtn = document.getElementById('cancelAddEditQuestionBtn');
            const addEditQuestionForm = document.getElementById('addEditQuestionForm');
            const saveQuestionBtn = document.getElementById('saveQuestionBtn');
            const addEditQuestionModalTitle = document.getElementById('addEditQuestionModalTitle');
            const editingQuestionIdInput = document.getElementById('editingQuestionId');

            const questionTextInput = document.getElementById('questionText');
            const questionTypeSelect = document.getElementById('questionTypeSelect');
            const multipleChoiceFieldsContainer = document.getElementById('multipleChoiceFieldsContainer');
            const orderingFieldsContainer = document.getElementById('orderingFieldsContainer');
            const freeTextFieldsContainer = document.getElementById('freeTextFieldsContainer');
            const mcOptionsContainer = document.getElementById('mcOptionsContainer');
            const addMcOptionBtn = document.getElementById('addMcOptionBtn');
            const isMcMultipleCorrectCheckbox = document.getElementById('isMcMultipleCorrect');
            const pointsPerCorrectMcInput = document.getElementById('pointsPerCorrectMc');
            const pointsPerIncorrectMcInput = document.getElementById('pointsPerIncorrectMc');
            const totalScoreMcSingleInput = document.getElementById('totalScoreMcSingle');
            const orderingOptionsContainer = document.getElementById('orderingOptionsContainer');
            const addOrderingOptionBtn = document.getElementById('addOrderingOptionBtn');
            const pointsPerCorrectOrderInput = document.getElementById('pointsPerCorrectOrder');
            const bonusForFullOrderInput = document.getElementById('bonusForFullOrder');
            const maxScoreFreeTextInput = document.getElementById('maxScoreFreeText');

            const deleteQuestionConfirmModal = document.getElementById('deleteQuestionConfirmModal');
            const questionIdToDeleteInput = document.getElementById('questionIdToDelete');
            const cancelDeleteQuestionBtn = document.getElementById('cancelDeleteQuestionBtn');
            const confirmDeleteQuestionBtn = document.getElementById('confirmDeleteQuestionBtn');

            const editRaceModal = document.getElementById('editRaceModal');
            const openEditRaceModalBtn = document.getElementById('openEditRaceModalBtn');
            const closeEditRaceModalBtn = document.getElementById('closeEditRaceModalBtn');
            const cancelEditRaceBtn = document.getElementById('cancelEditRaceBtn');
            const editRaceForm = document.getElementById('editRaceForm');
            const saveRaceChangesBtn = document.getElementById('saveRaceChangesBtn');
            const raceTitleInput = document.getElementById('raceTitle');
            const raceLocationInput = document.getElementById('raceLocation');
            const raceDescriptionInput = document.getElementById('raceDescription');
            const raceEventDateInput = document.getElementById('raceEventDate');
            const raceGenderCategoryInput = document.getElementById('raceGenderCategory');
            const racePromoImageUrlInput = document.getElementById('racePromoImageUrl');
            const editRaceQuinielaCloseDateInput = document.getElementById('editRaceQuinielaCloseDate'); // Added
            const deleteRaceBtn = document.getElementById('deleteRaceBtn');

            // --- Notification Modal Elements & Functions ---
            const notificationModal = document.getElementById('notificationModal');
            const notificationModalTitle = document.getElementById('notificationModalTitle');
            const notificationModalMessage = document.getElementById('notificationModalMessage');
            const closeNotificationModalBtn = document.getElementById('closeNotificationModalBtn');
            const acceptNotificationModalBtn = document.getElementById('acceptNotificationModalBtn');

            function showNotificationModal(title, message, type = 'info') {
                if (!notificationModal || !notificationModalTitle || !notificationModalMessage) return;

                notificationModalTitle.textContent = title;
                notificationModalMessage.textContent = message;

                // Reset title color
                notificationModalTitle.classList.remove('text-green-600', 'text-red-600', 'text-orange-600', 'text-blue-600', 'text-gray-800');

                switch (type) {
                    case 'success':
                        notificationModalTitle.classList.add('text-green-600');
                        break;
                    case 'error':
                        notificationModalTitle.classList.add('text-red-600');
                        break;
                    case 'validation':
                        notificationModalTitle.classList.add('text-orange-600');
                        break;
                    case 'info':
                    default:
                        notificationModalTitle.classList.add('text-blue-600'); // Default to blue for info
                        break;
                }
                notificationModal.style.display = 'flex';
            }

            function closeNotificationModal() {
                if (notificationModal) notificationModal.style.display = 'none';
            }

            if (closeNotificationModalBtn) closeNotificationModalBtn.addEventListener('click', closeNotificationModal);
            if (acceptNotificationModalBtn) acceptNotificationModalBtn.addEventListener('click', closeNotificationModal);


            // --- Confirm Delete Race Modal Elements & Functions ---
            const confirmDeleteRaceModal = document.getElementById('confirmDeleteRaceModal');
            const confirmDeleteRaceModalTitle = document.getElementById('confirmDeleteRaceModalTitle');
            const confirmDeleteRaceModalMessage = document.getElementById('confirmDeleteRaceModalMessage');
            const cancelDeleteRaceBtnModal = document.getElementById('cancelDeleteRaceBtnModal');
            const confirmDeleteRaceActionBtn = document.getElementById('confirmDeleteRaceActionBtn');
            let confirmDeleteRaceCallback = null;

            function showConfirmDeleteRaceModal(title, message, callback) {
                if (!confirmDeleteRaceModal || !confirmDeleteRaceModalTitle || !confirmDeleteRaceModalMessage) return;
                confirmDeleteRaceModalTitle.textContent = title;
                confirmDeleteRaceModalMessage.textContent = message;
                confirmDeleteRaceCallback = callback;
                confirmDeleteRaceModal.style.display = 'flex';
            }

            function closeConfirmDeleteRaceModal() {
                if (confirmDeleteRaceModal) confirmDeleteRaceModal.style.display = 'none';
                confirmDeleteRaceCallback = null;
            }

            if (cancelDeleteRaceBtnModal) cancelDeleteRaceBtnModal.addEventListener('click', closeConfirmDeleteRaceModal);
            if (confirmDeleteRaceActionBtn) {
                confirmDeleteRaceActionBtn.addEventListener('click', () => {
                    if (typeof confirmDeleteRaceCallback === 'function') {
                        confirmDeleteRaceCallback();
                    }
                    closeConfirmDeleteRaceModal();
                });
            }

            // Event Listener Attachments
            // Logout is now handled by _header.html
            // if (logoutButtonNav) {
            //     logoutButtonNav.addEventListener('click', function(event) {
            //         event.preventDefault();
            //         fetch("{{ url_for('logout_api') }}", { method: 'POST' })
            //             .then(response => {
            //                 if (response.ok) window.location.href = "{{ url_for('serve_login_page') }}";
            //                 else alert('Logout failed.');
            //             })
            //             .catch(error => console.error('Logout error:', error));
            //     });
            // }

            // if(toggleQuestionsBtn) { // Commented out
            //      toggleQuestionsBtn.addEventListener('click', toggleQuestions);
            // }

            const participateInPoolBtn = document.getElementById('participateInPoolBtn');
            if (participateInPoolBtn) {
                participateInPoolBtn.addEventListener('click', function(event) {
                    if (typeof openWizard === 'function') {
                        openWizard();
                    }
                    // El else que conten√≠a el console.error y el alert ha sido eliminado,
                    // ya que la funcionalidad principal de openWizard es correcta al momento del click.
                });
            }

            const reviewUserAnswersBtn = document.getElementById('reviewUserAnswersBtn');
            const reviewUserAnswersModal = document.getElementById('reviewUserAnswersModal');
            const closeReviewUserAnswersModalBtn = document.getElementById('closeReviewUserAnswersModalBtn');
            const reviewUserAnswersContentWrapper = document.getElementById('reviewUserAnswersContentWrapper');
            const reviewUserAnswersDisplayArea = document.getElementById('reviewUserAnswersDisplayArea');
            // Renamed confirmAndCloseReviewModalBtn to saveAllReviewedAnswersBtn
            const saveAllReviewedAnswersBtn = document.getElementById('saveAllReviewedAnswersBtn');
            const reviewAnswersLoading = document.getElementById('reviewAnswersLoading');
            const reviewAnswersError = document.getElementById('reviewAnswersError');

            // Elements for Edit Answer Modal
            const editAnswerModal = document.getElementById('editAnswerModal');
            const closeEditAnswerModalBtn = document.getElementById('closeEditAnswerModalBtn');
            const cancelEditAnswerBtn = document.getElementById('cancelEditAnswerBtn');
            const saveEditedAnswerBtn = document.getElementById('saveEditedAnswerBtn');
            const editAnswerQuestionText = document.getElementById('editAnswerQuestionText');
            const editAnswerOptionsArea = document.getElementById('editAnswerOptionsArea');
            const editingQuestionIdStore = document.getElementById('editingQuestionIdStore');
            const editingUserAnswerIdStore = document.getElementById('editingUserAnswerIdStore');
            const editAnswerLoading = document.getElementById('editAnswerLoading');
            const editAnswerError = document.getElementById('editAnswerError');

            let currentUserAnswersData = []; // To store fetched user answers
            let reviewModeAnswers = {}; // To store answers edited/added in review modal before final save

            // Refactored function to load and display user answers
            async function loadAndDisplayUserAnswers(raceIdToLoad) {
                if (!reviewUserAnswersModal || !reviewAnswersLoading || !reviewAnswersError || !reviewUserAnswersDisplayArea) {
                    console.error("Review answers modal elements not found for loadAndDisplayUserAnswers");
                    return;
                }
                reviewUserAnswersDisplayArea.innerHTML = '';
                reviewAnswersError.style.display = 'none';
                reviewAnswersLoading.style.display = 'block';
                // reviewUserAnswersModal.style.display = 'flex'; // Ensure modal is visible if called independently

                try {
                    // Fetch all questions for the race first
                    const questionsResponse = await fetch(`/api/races/${raceIdToLoad}/questions`);
                    if (!questionsResponse.ok) {
                        const errData = await questionsResponse.json().catch(() => null);
                        throw new Error(errData?.message || `Error fetching all questions: ${questionsResponse.status}: ${questionsResponse.statusText}`);
                    }
                    allRaceQuestions = await questionsResponse.json(); // Update global allRaceQuestions

                    // Then fetch the user's specific answers
                    const userAnswersResponse = await fetch(`/api/races/${raceIdToLoad}/user_answers`);
                    if (!userAnswersResponse.ok) {
                        const errData = await userAnswersResponse.json().catch(() => null);
                        throw new Error(errData?.message || `Error fetching user answers: ${userAnswersResponse.status}: ${userAnswersResponse.statusText}`);
                    }
                    const userAnswersResponseData = await userAnswersResponse.json();
                    currentUserAnswersData = userAnswersResponseData.answers; // Assign the array of answers

                    // You might want to use userAnswersResponseData.num_total_questions and
                    // userAnswersResponseData.num_answered_questions here if needed for the UI

                    reviewAnswersLoading.style.display = 'none';

                    if (allRaceQuestions && allRaceQuestions.length > 0) {
                        allRaceQuestions.forEach((question, index) => {
                            const userAnswer = currentUserAnswersData.find(ua => ua.question_id === question.id);
                            // Pass the full question object and the specific user answer (if it exists)
                            // to renderQuestionForReview or a new function that handles this combined display.
                            // For now, renderQuestionForReview will be modified to accept the question and optional answer.
                            reviewUserAnswersDisplayArea.appendChild(renderQuestionForReview(question, userAnswer, index));
                        });
                    } else {
                        reviewUserAnswersDisplayArea.innerHTML = '<p class="text-gray-600 text-center py-4">No hay preguntas definidas para esta carrera.</p>';
                    }
                } catch (error) {
                    console.error('Error loading questions or user answers:', error);
                    reviewAnswersLoading.style.display = 'none';
                    reviewAnswersError.textContent = `Error al cargar datos: ${error.message}. Int√©ntalo de nuevo.`;
                    reviewAnswersError.style.display = 'block';
                    reviewUserAnswersDisplayArea.innerHTML = '';
                }
            }

            if (reviewUserAnswersBtn) {
                reviewUserAnswersBtn.addEventListener('click', function() {
                    reviewUserAnswersModal.style.display = 'flex'; // Show modal first
                    loadAndDisplayUserAnswers(raceId);
                });
            }

            if (closeReviewUserAnswersModalBtn) {
                closeReviewUserAnswersModalBtn.addEventListener('click', function() {
                    if(reviewUserAnswersModal) reviewUserAnswersModal.style.display = 'none';
                    reviewModeAnswers = {}; // Clear pending changes if modal is closed via "X"
                });
            }

            if (saveAllReviewedAnswersBtn) {
                saveAllReviewedAnswersBtn.textContent = 'Guardar Todos los Cambios'; // Ensure button text is updated
                saveAllReviewedAnswersBtn.addEventListener('click', function() {
                    saveAllReviewedAnswersBtn.disabled = true;
                    saveAllReviewedAnswersBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando Todo...';

                    // Prepare the final payload. Start with existing answers, then override with reviewModeAnswers.
                    // The backend /api/races/<race_id>/answers expects a flat dict of {question_id: answer_payload}
                    let finalPayload = {};

                    // Iterate over ALL questions for the race
                    allRaceQuestions.forEach(q => {
                        const questionIdStr = q.id.toString();
                        if (reviewModeAnswers.hasOwnProperty(questionIdStr)) {
                            // If this question was edited/answered in review mode, use that data
                            finalPayload[questionIdStr] = reviewModeAnswers[questionIdStr];
                        } else {
                            // Otherwise, check if there was an original answer for this question
                            const originalAnswer = currentUserAnswersData.find(ans => ans.question_id == q.id);
                            if (originalAnswer) {
                                // Map originalAnswer to the expected payload structure for the backend
                                // This is crucial if the structure of currentUserAnswersData items differs from what backend expects for POST
                                let answerForPayload = { question_id: q.id };
                                if (q.question_type === 'FREE_TEXT') answerForPayload.answer_text = originalAnswer.answer_text;
                                if (q.question_type === 'ORDERING') answerForPayload.ordered_options_text = originalAnswer.answer_text; // Assuming original answer_text is already in correct format
                                if (q.question_type === 'SLIDER') answerForPayload.slider_answer_value = originalAnswer.slider_answer_value;
                                if (q.question_type === 'MULTIPLE_CHOICE') {
                                    if (q.is_mc_multiple_correct) {
                                        answerForPayload.selected_option_ids = originalAnswer.selected_mc_options ? originalAnswer.selected_mc_options.map(opt => opt.option_id) : [];
                                    } else {
                                        answerForPayload.selected_option_id = originalAnswer.selected_option_id;
                                    }
                                }
                                finalPayload[questionIdStr] = answerForPayload;
                            } else {
                                // This is a new question that wasn't touched in reviewMode, so no answer to submit for it
                                // unless we want to submit "empty" answers, but the backend POST usually only processes what's sent.
                            }
                        }
                    });

                    if (Object.keys(finalPayload).length === 0) {
                        showNotificationModal("Sin Cambios", "No hay respuestas nuevas o modificadas para guardar.", "info");
                        saveAllReviewedAnswersBtn.disabled = false;
                        saveAllReviewedAnswersBtn.innerHTML = 'Guardar Todos los Cambios';
                        if(reviewUserAnswersModal) reviewUserAnswersModal.style.display = 'none';
                        return;
                    }

                    fetch(`/api/races/${raceId}/answers`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}'
                        },
                        body: JSON.stringify(finalPayload)
                    })
                    .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, body: data })))
                    .then(result => {
                        if (result.ok) {
                            showNotificationModal("√âxito", result.body.message || 'Todas las respuestas guardadas con √©xito.', "success");
                            if(reviewUserAnswersModal) reviewUserAnswersModal.style.display = 'none';
                            reviewModeAnswers = {}; // Clear pending changes
                            // Potentially reload the page or just update UI state
                            setTimeout(() => window.location.reload(), 1500);
                        } else {
                            showNotificationModal("Error", `Error al guardar respuestas: ${result.body.message || `Error ${result.status}`}`, "error");
                        }
                    })
                    .catch(error => {
                        console.error('Error saving all reviewed answers:', error);
                        showNotificationModal("Error de Conexi√≥n", "Error de conexi√≥n al guardar las respuestas. Por favor, int√©ntalo de nuevo.", "error");
                    })
                    .finally(() => {
                        saveAllReviewedAnswersBtn.disabled = false;
                        saveAllReviewedAnswersBtn.innerHTML = 'Guardar Todos los Cambios';
                    });
                });
            }

            // Renamed from renderSingleUserAnswer to renderQuestionForReview
            // Now accepts a full `question` object, an optional `userAnswer` object, and an index.
            function renderQuestionForReview(question, userAnswer, index) {
                const questionItemDiv = document.createElement('div');
                questionItemDiv.className = 'p-4 border border-gray-200 rounded-lg bg-white shadow mb-3';

                let formattedAnswerHtml = '';
                // userAnswerIdForButton will be the actual ID if userAnswer exists, otherwise it's an empty string.
                // This helps the button's data attribute.
                const userAnswerIdForButton = userAnswer ? userAnswer.user_answer_id : '';

                if (userAnswer) {
                    // We have an existing answer from the user for this question.
                    // Note: question.question_type refers to the type of the question itself,
                    // userAnswer.question_type might also exist if your /api/races/<id>/user_answers returns it per answer.
                    // Prefer question.question_type for consistency.
                    switch (question.question_type) {
                        case 'FREE_TEXT':
                            formattedAnswerHtml = `<p class="text-gray-700">${userAnswer.answer_text || '<span class="text-gray-500 italic">No respondida</span>'}</p>`;
                            break;
                        case 'ORDERING':
                            formattedAnswerHtml = `<p class="text-gray-700">${userAnswer.answer_text || '<span class="text-gray-500 italic">No respondida</span>'}</p>`;
                            break;
                        case 'MULTIPLE_CHOICE':
                            // The structure of userAnswer for MC questions needs to be consistent.
                            // Assuming userAnswer.selected_option_text for single-choice,
                            // and userAnswer.selected_mc_options (array of {option_id, option_text}) for multi-choice.
                            if (question.is_mc_multiple_correct) { // Check the question's property
                                if (userAnswer.selected_mc_options && userAnswer.selected_mc_options.length > 0) {
                                    formattedAnswerHtml = '<ul class="list-disc list-inside text-gray-700 space-y-1">';
                                    userAnswer.selected_mc_options.forEach(opt => {
                                        formattedAnswerHtml += `<li>${opt.option_text}</li>`;
                                    });
                                    formattedAnswerHtml += '</ul>';
                                } else {
                                    formattedAnswerHtml = '<p class="text-gray-500 italic">No seleccionaste ninguna opci√≥n.</p>';
                                }
                            } else { // Single choice
                                if (userAnswer.selected_option_text) {
                                    formattedAnswerHtml = `<p class="text-gray-700">${userAnswer.selected_option_text}</p>`;
                                } else {
                                    formattedAnswerHtml = '<p class="text-gray-500 italic">No seleccionaste ninguna opci√≥n.</p>';
                                }
                            }
                            break;
                        case 'SLIDER':
                            if (userAnswer.slider_answer_value !== null && userAnswer.slider_answer_value !== undefined) {
                                // Ensure question.slider_unit is accessed correctly, it's part of the question object.
                                formattedAnswerHtml = `<p class="text-gray-700">${userAnswer.slider_answer_value} ${question.slider_unit || ''}</p>`;
                            } else {
                                formattedAnswerHtml = '<p class="text-gray-500 italic">No respondida.</p>';
                            }
                            break;
                        default:
                            formattedAnswerHtml = '<p class="text-red-500">Tipo de respuesta no reconocido.</p>';
                    }
                } else {
                    // This is a new question for the user, not yet answered.
                    formattedAnswerHtml = '<p class="text-gray-500 italic">A√∫n no has respondido esta pregunta.</p>';
                }

                questionItemDiv.innerHTML = `
                    <p class="font-semibold text-gray-800 mb-1">${index + 1}-${question.text}</p>
                    <div class="text-xs text-gray-500 mb-2">${userAnswer ? 'Tu respuesta:' : 'Respuesta pendiente:'}</div>
                    <div class="p-3 bg-gray-50 border border-gray-300 rounded-md min-h-[40px]">
                        ${formattedAnswerHtml}
                    </div>
                    <div class="text-right mt-3">
                        <button class="editAnswerBtn btn btn-sm btn-secondary hover:bg-gray-300"
                                data-question-id="${question.id}"
                                data-user-answer-id="${userAnswerIdForButton}"
                                ${quinielaCloseDate && new Date(quinielaCloseDate) < new Date() ? 'disabled title="La quiniela ya esta cerrada y no se pueden modificar las predicciones"' : ''}>
                            <i class="fas fa-edit mr-1"></i>${userAnswer ? 'Editar' : 'Responder'}
                        </button>
                    </div>
                `;

                const editButton = questionItemDiv.querySelector('.editAnswerBtn');
                if(editButton) {
                    if (!editButton.hasAttribute('disabled')) {
                        editButton.addEventListener('click', function() {
                            const questionId = this.dataset.questionId;
                            const userAnswerId = this.dataset.userAnswerId; // This will be empty string for new questions

                            if (!editAnswerModal || !editingQuestionIdStore || !editingUserAnswerIdStore || !editAnswerQuestionText || !editAnswerOptionsArea || !editAnswerLoading || !editAnswerError) {
                                console.error("Edit answer modal elements not found");
                                return;
                            }

                            editAnswerLoading.style.display = 'block';
                            editAnswerError.style.display = 'none';
                            editAnswerOptionsArea.innerHTML = ''; // Clear previous content
                            editAnswerModal.style.display = 'flex';

                            editingQuestionIdStore.value = questionId;
                            editingUserAnswerIdStore.value = userAnswerId;

                            const fullQuestionData = allRaceQuestions.find(q => q.id == questionId);
                            // If userAnswerId is an empty string, existingUserAnswerData will be null, which is correct.
                            const existingUserAnswerData = userAnswerId ? currentUserAnswersData.find(ans => ans.user_answer_id == userAnswerId) : null;

                            if (fullQuestionData) {
                                // Find the index of the current question to display number
                                const questionIndex = allRaceQuestions.findIndex(q => q.id == questionId);
                                editAnswerQuestionText.textContent = `${questionIndex + 1}-${fullQuestionData.text}`;
                                populateEditAnswerForm(fullQuestionData, existingUserAnswerData); // Pass both
                                editAnswerLoading.style.display = 'none';
                            } else {
                                editAnswerQuestionText.textContent = 'Error: Pregunta no encontrada.';
                                editAnswerError.textContent = 'Error: No se pudieron cargar los detalles de la pregunta.';
                                editAnswerError.style.display = 'block';
                                editAnswerLoading.style.display = 'none';
                            }
                        });
                    }
                }
                return questionItemDiv;
            }

            // Modified to accept the full question data and an optional existing answer data
            function populateEditAnswerForm(questionData, userAnswerData) {
                if (!editAnswerOptionsArea || !questionData) {
                    console.error("populateEditAnswerForm: Essential elements or questionData missing.");
                    editAnswerOptionsArea.innerHTML = '<p class="text-red-500">Error al cargar el formulario de edici√≥n.</p>';
                    return;
                }
                editAnswerOptionsArea.innerHTML = ''; // Clear previous inputs

                // Use questionData for question type and options, userAnswerData for existing values
                switch (questionData.question_type) {
                    case 'FREE_TEXT':
                        const textarea = document.createElement('textarea');
                        textarea.id = `editFreeTextAnswer_${questionData.id}`; // Use questionData.id
                        textarea.className = 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent';
                        textarea.rows = 4;
                        textarea.value = userAnswerData?.answer_text || ''; // Pre-fill if userAnswerData exists
                        editAnswerOptionsArea.appendChild(textarea);
                        break;

                    case 'ORDERING':
                        const orderingInfo = document.createElement('p');
                        orderingInfo.className = 'text-sm text-gray-600 mb-2';
                        orderingInfo.textContent = "Reordena los siguientes items. Indica tu orden en el cuadro de texto (ej: Opci√≥n C, Opci√≥n A, Opci√≥n B).";
                        editAnswerOptionsArea.appendChild(orderingInfo);

                        const itemsList = document.createElement('ul');
                        itemsList.className = 'list-disc list-inside bg-gray-100 p-3 rounded-md mb-2';
                        // Options should come from questionData.options
                        if (questionData.options && questionData.options.length > 0) {
                            questionData.options.forEach(opt => {
                                const item = document.createElement('li');
                                item.textContent = opt.option_text;
                                itemsList.appendChild(item);
                            });
                        } else {
                            itemsList.innerHTML = '<li class="text-gray-500 italic">No hay opciones definidas para esta pregunta.</li>';
                        }
                        editAnswerOptionsArea.appendChild(itemsList);

                        const orderingTextarea = document.createElement('textarea');
                        orderingTextarea.id = `editOrderingAnswer_${questionData.id}`;
                        orderingTextarea.className = 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent';
                        orderingTextarea.rows = 3;
                        orderingTextarea.placeholder = 'Ej: Item C, Item A, Item B';
                        orderingTextarea.value = userAnswerData?.answer_text || ''; // Pre-fill
                        // editAnswerOptionsArea.appendChild(orderingTextarea); // Old textarea logic

                        // New list-based rendering for ordering questions
                        editAnswerOptionsArea.innerHTML = ''; // Clear previous content like info text or old textarea

                        const orderingList = document.createElement('ul');
                        orderingList.id = `editAnswerOrderingList_${questionData.id}`;
                        orderingList.className = 'list-none p-0 m-0 space-y-2';

                        let optionsInOrder = [...questionData.options]; // Default to original question option order

                        if (userAnswerData && userAnswerData.answer_text) {
                            const savedOrderIds = userAnswerData.answer_text.split(',').map(id => parseInt(id.trim(), 10));
                            const questionOptionsMap = new Map(questionData.options.map(opt => [opt.id, opt]));
                            const reorderedOptions = [];
                            const addedIds = new Set();

                            savedOrderIds.forEach(id => {
                                if (questionOptionsMap.has(id)) {
                                    reorderedOptions.push(questionOptionsMap.get(id));
                                    addedIds.add(id);
                                }
                            });
                            // Add any options from questionData.options not present in savedOrderIds (e.g. new options to question)
                            questionData.options.forEach(opt => {
                                if (!addedIds.has(opt.id)) {
                                    reorderedOptions.push(opt);
                                }
                            });
                            if (reorderedOptions.length === questionData.options.length) { // Ensure integrity
                                optionsInOrder = reorderedOptions;
                            }
                        }

                        if (optionsInOrder && optionsInOrder.length > 0) {
                            optionsInOrder.forEach(opt => {
                                const listItem = document.createElement('li');
                                listItem.dataset.optionId = opt.id;
                                listItem.className = 'p-3 border rounded-md bg-gray-50 flex justify-between items-center shadow-sm';

                                const textSpan = document.createElement('span');
                                textSpan.className = 'text-gray-700';
                                textSpan.textContent = opt.option_text; // Text is not editable here
                                listItem.appendChild(textSpan);

                                const buttonContainer = document.createElement('div');
                                buttonContainer.className = 'space-x-1';

                                const moveUpBtn = document.createElement('button');
                                moveUpBtn.innerHTML = '‚Üë';
                                moveUpBtn.type = 'button';
                                moveUpBtn.className = 'edit-answer-move-up-btn px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-200 transition-colors focus:outline-none focus:ring-2 focus:ring-orange-300';
                                moveUpBtn.addEventListener('click', () => {
                                    const currentLi = moveUpBtn.closest('li');
                                    if (currentLi && currentLi.previousElementSibling) {
                                        currentLi.parentNode.insertBefore(currentLi, currentLi.previousElementSibling);
                                        updateEditAnswerModalOrderingButtonStates(orderingList);
                                    }
                                });
                                buttonContainer.appendChild(moveUpBtn);

                                const moveDownBtn = document.createElement('button');
                                moveDownBtn.innerHTML = '‚Üì';
                                moveDownBtn.type = 'button';
                                moveDownBtn.className = 'edit-answer-move-down-btn px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-200 transition-colors focus:outline-none focus:ring-2 focus:ring-orange-300';
                                moveDownBtn.addEventListener('click', () => {
                                    const currentLi = moveDownBtn.closest('li');
                                    if (currentLi && currentLi.nextElementSibling) {
                                        currentLi.parentNode.insertBefore(currentLi, currentLi.nextElementSibling.nextSibling);
                                        updateEditAnswerModalOrderingButtonStates(orderingList);
                                    }
                                });
                                buttonContainer.appendChild(moveDownBtn);

                                listItem.appendChild(buttonContainer);
                                orderingList.appendChild(listItem);
                            });
                            // Initial call to update button states
                            if (orderingList.firstChild) {
                                updateEditAnswerModalOrderingButtonStates(orderingList);
                            }
                        } else {
                            orderingList.innerHTML = '<p class="text-sm text-gray-500">No hay opciones para ordenar.</p>';
                        }
                        editAnswerOptionsArea.appendChild(orderingList);
                        break;

                    case 'MULTIPLE_CHOICE':
                        if (!questionData.options || questionData.options.length === 0) {
                            editAnswerOptionsArea.innerHTML = '<p class="text-red-500">No hay opciones definidas para esta pregunta de opci√≥n m√∫ltiple.</p>';
                            return;
                        }
                        questionData.options.forEach(opt => {
                            const label = document.createElement('label');
                            label.className = 'flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded-md border border-gray-200 hover:border-orange-300';
                            const input = document.createElement('input');
                            input.name = `edit_q_${questionData.id}`;
                            input.value = opt.id;
                            input.className = 'text-orange-500 focus:ring-orange-400 focus:ring-offset-0';

                            if (questionData.is_mc_multiple_correct) {
                                input.type = 'checkbox';
                                input.classList.add('rounded');
                                // Check if this option was selected in userAnswerData
                                if (userAnswerData?.selected_mc_options?.some(selOpt => selOpt.option_id == opt.id)) {
                                    input.checked = true;
                                }
                            } else { // Single-select
                                input.type = 'radio';
                                if (userAnswerData?.selected_option_id == opt.id) {
                                    input.checked = true;
                                }
                            }

                            const span = document.createElement('span');
                            span.className = 'text-gray-700';
                            span.textContent = opt.option_text;

                            label.appendChild(input);
                            label.appendChild(span);
                            editAnswerOptionsArea.appendChild(label);
                        });
                        break;

                    case 'SLIDER':
                        const sliderMinValue = parseFloat(questionData.slider_min_value);
                        const sliderMaxValue = parseFloat(questionData.slider_max_value);
                        const sliderStep = parseFloat(questionData.slider_step) > 0 ? parseFloat(questionData.slider_step) : 1;
                        const sliderUnit = questionData.slider_unit || "";

                        const editSliderContainer = document.createElement('div');
                        editSliderContainer.className = 'pt-4 pb-2';

                        const sliderInput = document.createElement('input');
                        sliderInput.type = 'range';
                        sliderInput.id = `editSliderAnswer_${questionData.id}`;
                        sliderInput.min = sliderMinValue;
                        sliderInput.max = sliderMaxValue;
                        sliderInput.step = sliderStep;
                        // Pre-fill with user's answer, or default to min value if no answer or invalid
                        let currentSliderValue = userAnswerData?.slider_answer_value;
                        if (currentSliderValue === null || currentSliderValue === undefined || isNaN(parseFloat(currentSliderValue))) {
                            currentSliderValue = sliderMinValue;
                        } else {
                            currentSliderValue = parseFloat(currentSliderValue);
                        }
                        sliderInput.value = Math.max(sliderMinValue, Math.min(sliderMaxValue, currentSliderValue));

                        sliderInput.className = 'w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-orange-500';

                        const sliderValueDisplay = document.createElement('div');
                        sliderValueDisplay.id = `editSliderValueDisplay_${questionData.id}`;
                        sliderValueDisplay.className = 'text-center text-sm text-gray-700 mt-2';
                        sliderValueDisplay.textContent = `${sliderInput.value} ${sliderUnit}`;

                        sliderInput.oninput = () => {
                            sliderValueDisplay.textContent = `${sliderInput.value} ${sliderUnit}`;
                        };

                        editSliderContainer.appendChild(sliderInput);
                        editSliderContainer.appendChild(sliderValueDisplay);
                        editAnswerOptionsArea.appendChild(editSliderContainer);
                        break;

                    default:
                        editAnswerOptionsArea.innerHTML = `<p class="text-red-500">Tipo de pregunta '${questionData.question_type}' no soportado para edici√≥n.</p>`;
                }
            }

            if (closeEditAnswerModalBtn) {
                closeEditAnswerModalBtn.addEventListener('click', () => { if(editAnswerModal) editAnswerModal.style.display = 'none'; });
            }
            if (cancelEditAnswerBtn) {
                cancelEditAnswerBtn.addEventListener('click', () => { if(editAnswerModal) editAnswerModal.style.display = 'none'; });
            }
            if (saveEditedAnswerBtn) {
                saveEditedAnswerBtn.addEventListener('click', function() {
                    const userAnswerId = editingUserAnswerIdStore.value;
                    const questionId = editingQuestionIdStore.value;

                    // const userAnswerId = editingUserAnswerIdStore.value; // Not directly needed for saving to reviewModeAnswers

                    if (!questionId) {
                        editAnswerError.textContent = 'Error: No se pudo identificar la pregunta para guardar los cambios.';
                        editAnswerError.style.display = 'block';
                        return;
                    }

                    saveEditedAnswerBtn.disabled = true;
                    saveEditedAnswerBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Confirmando...';
                    editAnswerError.style.display = 'none';

                    const questionData = allRaceQuestions.find(q => q.id == questionId);
                    if (!questionData) {
                        editAnswerError.textContent = 'Error: Datos de la pregunta no encontrados.';
                        editAnswerError.style.display = 'block';
                        saveEditedAnswerBtn.disabled = false;
                        saveEditedAnswerBtn.innerHTML = 'Confirmar Cambios para esta Pregunta';
                        return;
                    }

                    let collectedAnswerData = { question_id: parseInt(questionId) };
                    // Important: for existing answers, we need to preserve the user_answer_id if we want to treat them as updates later.
                    // However, the target POST endpoint /api/races/<race_id>/answers handles this by deleting and recreating.
                    // So, not strictly necessary to pass userAnswerId in reviewModeAnswers if that's the final submission target.

                    switch (questionData.question_type) {
                        case 'FREE_TEXT':
                            const ftTextarea = editAnswerOptionsArea.querySelector(`#editFreeTextAnswer_${questionId}`);
                            collectedAnswerData.answer_text = ftTextarea ? ftTextarea.value.trim() : null;
                            break;
                        case 'ORDERING':
                            // const orTextarea = editAnswerOptionsArea.querySelector(`#editOrderingAnswer_${questionId}`); // Old textarea logic
                            // collectedAnswerData.ordered_options_text = orTextarea ? orTextarea.value.trim() : null;
                            const orderingList = editAnswerOptionsArea.querySelector(`#editAnswerOrderingList_${questionId}`);
                            if (orderingList) {
                                const orderedOptionIds = Array.from(orderingList.querySelectorAll('li[data-option-id]'))
                                                              .map(li => li.dataset.optionId);
                                collectedAnswerData.ordered_options_text = orderedOptionIds.join(',');
                            } else {
                                collectedAnswerData.ordered_options_text = ''; // Should not happen if populated correctly
                            }
                            break;
                        case 'MULTIPLE_CHOICE':
                            if (questionData.is_mc_multiple_correct) {
                                collectedAnswerData.selected_option_ids = [];
                                editAnswerOptionsArea.querySelectorAll(`input[name="edit_q_${questionId}"]:checked`).forEach(cb => {
                                    collectedAnswerData.selected_option_ids.push(parseInt(cb.value));
                                });
                            } else { // Single-select
                                const checkedRadio = editAnswerOptionsArea.querySelector(`input[name="edit_q_${questionId}"]:checked`);
                                collectedAnswerData.selected_option_id = checkedRadio ? parseInt(checkedRadio.value) : null;
                            }
                            break;
                        case 'SLIDER':
                            const sliderInput = editAnswerOptionsArea.querySelector(`#editSliderAnswer_${questionId}`);
                            if (sliderInput) {
                                collectedAnswerData.slider_answer_value = parseFloat(sliderInput.value);
                            } else {
                                collectedAnswerData.slider_answer_value = null;
                            }
                            break;
                        default:
                            editAnswerError.textContent = 'Tipo de pregunta no reconocido para guardar.';
                            editAnswerError.style.display = 'block';
                            saveEditedAnswerBtn.disabled = false;
                            saveEditedAnswerBtn.innerHTML = 'Confirmar Cambios para esta Pregunta';
                            return;
                    }

                    reviewModeAnswers[questionId] = collectedAnswerData;

                    // Visually update the item in the reviewUserAnswersDisplayArea
                    // This requires finding the specific div for this question and re-rendering it.
                    const displayArea = document.getElementById('reviewUserAnswersDisplayArea');
                    const questionDivToUpdate = displayArea.querySelector(`div[class*="p-4 border border-gray-200"][data-question-id="${questionId}"]`);

                    // To re-render, we need to reconstruct the `userAnswer` object structure that `renderQuestionForReview` expects.
                    // This involves mapping `collectedAnswerData` to the structure of `currentUserAnswersData` items.
                    // This is a bit complex as `currentUserAnswersData` items have `selected_option_text`, etc.
                    // For simplicity, we might just reload the entire review modal's content after this local "save".
                    // Or, better, ensure `renderQuestionForReview` can derive its display from `collectedAnswerData` combined with `questionData`.

                    // For now, let's just close the edit modal. The visual update in the list is complex.
                    // A simpler visual update would be to mark it as "edited" or just rely on the user remembering.
                    // The proper way is to re-render that specific item.
                    // Let's try to re-render the whole list for now, it's simpler than targeted DOM update with complex data mapping.
                    if(editAnswerModal) editAnswerModal.style.display = 'none';

                    // After "saving" to reviewModeAnswers and closing edit modal, refresh the review list display
                    // This will make renderQuestionForReview pick up the changes from reviewModeAnswers (or we adapt it to do so)
                    // This implies loadAndDisplayUserAnswers or renderQuestionForReview needs to check reviewModeAnswers.
                    // This is getting complex. Let's simplify: the save to reviewModeAnswers is enough for now.
                    // The final "Save All" will use reviewModeAnswers.
                    // The visual update in the list can be a later refinement if needed.
                    // For now, just closing the modal is fine. The data IS in reviewModeAnswers.

                    saveEditedAnswerBtn.disabled = false;
                    saveEditedAnswerBtn.innerHTML = 'Confirmar Cambios para esta Pregunta'; // Changed text

                    // Let's try to refresh the specific item.
                    // We need to create a temporary "userAnswer" like object from reviewModeAnswers[questionId]
                    // and the original questionData.
                    let tempUserAnswerForDisplay = { // Construct a temporary object for rendering
                        ...reviewModeAnswers[questionId], // The core answer values
                        question_id: parseInt(questionId),
                        question_text: questionData.text, // From full question data
                        question_type: questionData.question_type,
                        // For MC single, we need to derive selected_option_text
                        // For MC multi, we need to derive selected_mc_options (array of {option_id, option_text})
                    };

                    if (questionData.question_type === 'MULTIPLE_CHOICE') {
                        if (questionData.is_mc_multiple_correct) {
                            tempUserAnswerForDisplay.selected_mc_options = [];
                            if (collectedAnswerData.selected_option_ids) {
                                collectedAnswerData.selected_option_ids.forEach(id => {
                                    const opt = questionData.options.find(o => o.id == id);
                                    if (opt) tempUserAnswerForDisplay.selected_mc_options.push({option_id: id, option_text: opt.option_text});
                                });
                            }
                        } else {
                            if (collectedAnswerData.selected_option_id !== null) {
                                const opt = questionData.options.find(o => o.id == collectedAnswerData.selected_option_id);
                                tempUserAnswerForDisplay.selected_option_text = opt ? opt.option_text : 'Opci√≥n no encontrada';
                            } else {
                                tempUserAnswerForDisplay.selected_option_text = null;
                            }
                        }
                    }
                    // Update the display in the review list
                    if (questionDivToUpdate && displayArea) {
                         // Find the question div in reviewUserAnswersDisplayArea and replace it
                        const parent = questionDivToUpdate.parentNode;
                            // Find the index of the current question to pass to renderQuestionForReview
                            const questionIndex = allRaceQuestions.findIndex(q => q.id == questionId);
                            const newRenderedItem = renderQuestionForReview(questionData, tempUserAnswerForDisplay, questionIndex);
                        // Add the question ID to the new rendered item for future lookups
                        newRenderedItem.dataset.questionId = questionData.id;
                        parent.replaceChild(newRenderedItem, questionDivToUpdate);
                    }


                });
            }


            if(addMcOptionBtn && mcOptionsContainer) {
                addMcOptionBtn.addEventListener('click', () => {
                    mcOptionsContainer.appendChild(createOptionInputDiv("", null, false, "MULTIPLE_CHOICE"));
                });
            }

            if(addOrderingOptionBtn && orderingOptionsContainer) {
                addOrderingOptionBtn.addEventListener('click', () => {
                    orderingOptionsContainer.appendChild(createOptionInputDiv("", null, false, "ORDERING"));
                });
            }

            // Edit Race Modal Functions (defined locally as they use DOMContentLoaded-defined consts)
            function openEditRaceModal() {
                if (!editRaceModal) return;
                editRaceModal.style.display = 'flex';
            }

            function closeEditRaceModal() {
                if (!editRaceModal) return;
                editRaceModal.style.display = 'none';
            }

            if (openEditRaceModalBtn) {
                openEditRaceModalBtn.addEventListener('click', openEditRaceModal);
            }
            if (closeEditRaceModalBtn) {
                closeEditRaceModalBtn.addEventListener('click', closeEditRaceModal);
            }
            if (cancelEditRaceBtn) {
                cancelEditRaceBtn.addEventListener('click', closeEditRaceModal);
            }

            if (editRaceForm) {
                editRaceForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    if(!saveRaceChangesBtn) return;
                    saveRaceChangesBtn.disabled = true;
                    saveRaceChangesBtn.classList.add('opacity-50');

                    const formData = {
                        title: raceTitleInput.value,
                        location: raceLocationInput.value,
                        description: raceDescriptionInput.value,
                        event_date: raceEventDateInput.value,
                        gender_category: raceGenderCategoryInput.value,
                        promo_image_url: racePromoImageUrlInput.value,
                        category: document.getElementById('raceCategory').value,
                        quiniela_close_date: document.getElementById('editRaceQuinielaCloseDate').value // Added
                    };

                    if (!formData.title.trim()) {
                        showNotificationModal('Validaci√≥n Fallida', 'El t√≠tulo de la carrera es obligatorio.', 'validation');
                        saveRaceChangesBtn.disabled = false;
                        saveRaceChangesBtn.classList.remove('opacity-50');
                        return;
                    }
                     if (!formData.event_date) {
                        showNotificationModal('Validaci√≥n Fallida', 'La fecha del evento es obligatoria.', 'validation');
                        saveRaceChangesBtn.disabled = false;
                        saveRaceChangesBtn.classList.remove('opacity-50');
                        return;
                    }

                    fetch(`/api/races/${raceId}/details`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', },
                        body: JSON.stringify(formData)
                    })
                    .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, body: data })))
                    .then(result => {
                        if (result.ok) {
                            showNotificationModal('√âxito', result.body.message || 'Detalles de la carrera actualizados con √©xito.', 'success');
                            closeEditRaceModal();
                            // Update page content dynamically
                            const titleElement = document.querySelector('.hero-bg h1');
                            if (titleElement) titleElement.textContent = result.body.race.title;
                            const heroDescription = document.querySelector('.hero-bg p.opacity-90');
                            if (heroDescription) heroDescription.textContent = result.body.race.description.substring(0,150) + (result.body.race.description.length > 150 ? '...' : '');
                            const detailedDescriptionP = document.querySelector('.bg-white.rounded-xl.p-6.shadow-lg > p.text-gray-600.leading-relaxed.whitespace-pre-line');
                            if(detailedDescriptionP && result.body.race.description.length > 150) {
                                detailedDescriptionP.textContent = result.body.race.description;
                                const detailedDescSection = detailedDescriptionP.closest('.bg-white.rounded-xl.p-6.shadow-lg');
                                if(detailedDescSection) detailedDescSection.style.display = 'block';
                            } else if (detailedDescriptionP && result.body.race.description.length <= 150) {
                                const detailedDescSection = detailedDescriptionP.closest('.bg-white.rounded-xl.p-6.shadow-lg');
                                if(detailedDescSection) detailedDescSection.style.display = 'none';
                            }
                            const heroDateSpan = document.querySelector('.hero-bg .fa-calendar').nextElementSibling;
                            if (heroDateSpan && result.body.race.event_date) {
                                const eventDate = new Date(result.body.race.event_date);
                                heroDateSpan.textContent = eventDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' }) + ' ' + eventDate.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                            } else if (heroDateSpan) {
                                heroDateSpan.textContent = 'Fecha no especificada';
                            }
                            const heroLocationSpan = document.querySelector('.hero-bg .fa-map-marker-alt').nextElementSibling;
                            if (heroLocationSpan) heroLocationSpan.textContent = result.body.race.location || 'Ubicaci√≥n no especificada';
                            const genderBadge = document.querySelector('.hero-bg span.bg-white.bg-opacity-20:nth-of-type(2)');
                            if(genderBadge) genderBadge.textContent = result.body.race.gender_category;
                            const promoImage = document.querySelector('.hero-bg img');
                            const promoImageContainer = promoImage ? promoImage.parentElement : null;
                            if (promoImage && result.body.race.promo_image_url) {
                                promoImage.src = result.body.race.promo_image_url;
                                promoImage.alt = `Imagen de ${result.body.race.title}`;
                                if(promoImageContainer) promoImageContainer.style.display = '';
                            } else if (promoImage && !result.body.race.promo_image_url) {
                                if(promoImageContainer) promoImageContainer.style.display = 'none';
                            }
                            const raceCategoryInputModal = document.getElementById('raceCategory');
                            if (raceCategoryInputModal) raceCategoryInputModal.value = result.body.race.category;

                            // Update global race variable or re-fetch if necessary for quiniela_close_date
                            // For now, assuming direct update to the 'race' object if it's accessible globally
                            // or that the page might be reloaded/data re-fetched by other means for other sections.
                            // The modal itself will be repopulated with fresh data from result.body.race if reopened.
                            if (typeof race === 'object' && race !== null && result.body.race.quiniela_close_date) {
                                race.quiniela_close_date = result.body.race.quiniela_close_date;
                            }

                        } else {
                            showNotificationModal('Error', result.body.message || 'No se pudo actualizar la carrera.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error saving race details:', error);
                        showNotificationModal('Error de Conexi√≥n', 'No se pudo guardar los detalles de la carrera debido a un problema de red.', 'error');
                    })
                    .finally(() => {
                        if(saveRaceChangesBtn) {
                            saveRaceChangesBtn.disabled = false;
                            saveRaceChangesBtn.classList.remove('opacity-50');
                        }
                    });
                });
            }

            // Add/Edit Question Modal Listeners
            if (addNewQuestionBtn) {
                addNewQuestionBtn.addEventListener('click', openAddQuestionModal);
            }
            if (closeAddEditQuestionModalBtn) {
                closeAddEditQuestionModalBtn.addEventListener('click', closeAddEditQuestionModal);
            }
            if (cancelAddEditQuestionBtn) {
                cancelAddEditQuestionBtn.addEventListener('click', closeAddEditQuestionModal);
            }
            if(questionTypeSelect) {
                questionTypeSelect.addEventListener('change', handleQuestionTypeChange);
            }

            // Delete Question Modal Listeners
            if(cancelDeleteQuestionBtn) {
                cancelDeleteQuestionBtn.addEventListener('click', closeDeleteConfirmModal);
            }
            if(addEditQuestionForm) {
                addEditQuestionForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    if(!saveQuestionBtn) return;

                    saveQuestionBtn.disabled = true;
                    saveQuestionBtn.classList.add('opacity-50');

                    const editingId = editingQuestionIdInput.value;
                    const type = questionTypeSelect.value;
                    // NOTE: The question text from the form (questionTextInput.value) already includes the number if editing.
                    // We need to strip it if it's there, or ensure it's not saved with the number.
                    // For simplicity, we'll assume the backend or a later step handles stripping it if necessary,
                    // or that it's fine for question.text in the DB to not have the number.
                    // The numeration is primarily for display.
                    // For ADDING a new question, the number is not present in the input.
                    // For EDITING an existing question, the modal is populated WITHOUT the number in the input field.
                    // The 'openEditQuestionModal' function populates 'qTextInput.value = question.text;' which is the raw text.
                    // So, questionTextInput.value.trim() should be the raw text without numbering.
                    let questionData = {
                        text: questionTextInput.value.trim(),
                        is_active: true,
                    };

                    if (!questionData.text) {
                        alert('El texto de la pregunta es obligatorio.');
                        saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                    }

                    let options = [];
                    if (type === 'MULTIPLE_CHOICE') {
                        mcOptionsContainer.querySelectorAll('input[type="text"]').forEach(input => {
                            if(input.value.trim()) options.push({ option_text: input.value.trim() });
                        });
                        if (options.length < 2) {
                            alert('Las preguntas de opci√≥n m√∫ltiple deben tener al menos 2 opciones con texto.');
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                        questionData.options = options;
                        questionData.is_mc_multiple_correct = isMcMultipleCorrectCheckbox.checked;

                        if (questionData.is_mc_multiple_correct) {
                            const pointsCorrect = parseInt(pointsPerCorrectMcInput.value);
                            const pointsIncorrect = parseInt(pointsPerIncorrectMcInput.value);
                            if (isNaN(pointsCorrect)) {
                                alert('Puntos por opci√≥n correcta debe ser un n√∫mero para selecci√≥n m√∫ltiple.');
                                saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                            }
                            if (isNaN(pointsIncorrect)) {
                                alert('Puntos por opci√≥n incorrecta debe ser un n√∫mero para selecci√≥n m√∫ltiple.');
                                saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                            }
                            questionData.points_per_correct_mc = pointsCorrect;
                            questionData.points_per_incorrect_mc = pointsIncorrect;
                        } else {
                            const totalScore = parseInt(totalScoreMcSingleInput.value);
                            if (isNaN(totalScore) || totalScore <= 0) {
                                alert('La puntuaci√≥n total para opci√≥n √∫nica debe ser un n√∫mero entero positivo.');
                                saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                            }
                            questionData.total_score_mc_single = totalScore;
                        }
                    } else if (type === 'ORDERING') {
                        // Iterate over li elements to preserve order and potentially IDs
                        orderingOptionsContainer.querySelectorAll('li.edit-modal-ordering-item').forEach(li => {
                            const textInput = li.querySelector('input[type="text"]');
                            if (textInput && textInput.value.trim()) {
                                const optionData = { option_text: textInput.value.trim() };
                                if (li.dataset.optionId && li.dataset.optionId !== 'null' && li.dataset.optionId !== '') {
                                    // Include original ID if it exists (for existing options)
                                    // The backend needs to handle how it uses these IDs (e.g., for updates vs. creates)
                                    optionData.id = parseInt(li.dataset.optionId, 10);
                                }
                                options.push(optionData);
                            }
                        });

                        if (options.length < 2) {
                            alert('Las preguntas de ordenamiento deben tener al menos 2 √≠tems con texto.');
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                        questionData.options = options; // This now sends an array of {option_text: "...", id: ...} in the correct order
                        const pointsPerCorrect = parseInt(pointsPerCorrectOrderInput.value);
                        const bonusFullOrder = parseInt(bonusForFullOrderInput.value);
                        if (isNaN(pointsPerCorrect) || pointsPerCorrect <= 0) {
                             alert('Los puntos por √≠tem correcto en ordenamiento deben ser un n√∫mero entero positivo.');
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                        if (isNaN(bonusFullOrder) || bonusFullOrder < 0) {
                             alert('El bonus por orden completo debe ser un n√∫mero entero no negativo.');
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                        questionData.points_per_correct_order = pointsPerCorrect;
                        questionData.bonus_for_full_order = bonusFullOrder;
                    } else if (type === 'FREE_TEXT') {
                        const maxScore = parseInt(maxScoreFreeTextInput.value);
                        if (isNaN(maxScore) || maxScore <= 0) {
                             alert('La puntuaci√≥n m√°xima para texto libre debe ser un n√∫mero entero positivo.');
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                        questionData.max_score_free_text = maxScore;
                    } else if (type === 'SLIDER') {
                        // Retrieve values from SLIDER specific fields
                        questionData.slider_unit = document.getElementById('sliderUnitInput').value.trim();
                        questionData.slider_min_value = parseFloat(document.getElementById('sliderMinValueInput').value);
                        questionData.slider_max_value = parseFloat(document.getElementById('sliderMaxValueInput').value);
                        questionData.slider_step = parseFloat(document.getElementById('sliderStepInput').value);
                        questionData.slider_points_exact = parseInt(document.getElementById('sliderPointsExactInput').value);

                        const thresholdPartialStr = document.getElementById('sliderThresholdPartialInput').value;
                        questionData.slider_threshold_partial = thresholdPartialStr.trim() === '' ? null : parseFloat(thresholdPartialStr);

                        const pointsPartialStr = document.getElementById('sliderPointsPartialInput').value;
                        questionData.slider_points_partial = pointsPartialStr.trim() === '' ? null : parseInt(pointsPartialStr);

                        // Basic validation for slider (can be expanded)
                        if (isNaN(questionData.slider_min_value) || isNaN(questionData.slider_max_value) || isNaN(questionData.slider_step) || isNaN(questionData.slider_points_exact)) {
                            alert('Los campos num√©ricos del slider (Min, Max, Step, Puntos Exactos) son obligatorios y deben ser n√∫meros.');
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                        if (questionData.slider_max_value <= questionData.slider_min_value) {
                            alert('El valor m√°ximo del slider debe ser mayor que el valor m√≠nimo.');
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                         if (questionData.slider_step <= 0) {
                            alert('El paso (step) del slider debe ser un n√∫mero positivo.');
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                        if ((questionData.slider_threshold_partial !== null && isNaN(questionData.slider_threshold_partial)) || (questionData.slider_points_partial !== null && isNaN(questionData.slider_points_partial))) {
                            alert('Si se proporcionan, el umbral parcial y los puntos parciales deben ser n√∫meros.');
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                        if ((questionData.slider_threshold_partial === null && questionData.slider_points_partial !== null) || (questionData.slider_threshold_partial !== null && questionData.slider_points_partial === null)) {
                            alert('Para la puntuaci√≥n parcial, se deben proporcionar tanto el umbral como los puntos, o ninguno de los dos.');
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                    }


                    let url, method;
                    const currentQuestionType = questionTypeSelect.value;
                    const typeSlug = currentQuestionType.toLowerCase().replace('_', '-');

                    if (editingId) {
                        url = `/api/questions/${typeSlug}/${editingId}`;
                        method = 'PUT';
                    } else {
                        if (!raceId) {
                            alert("Error: El ID de la carrera no est√° definido. No se puede crear la pregunta.");
                            saveQuestionBtn.disabled = false; saveQuestionBtn.classList.remove('opacity-50'); return;
                        }
                        url = `/api/races/${raceId}/questions/${typeSlug}`;
                        method = 'POST';
                        questionData.is_active = true;
                    }

                    fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(questionData)
                    })
                    .then(response => response.json().then(data => ({ok: response.ok, status: response.status, body: data})))
                    .then(result => {
                        if (result.ok) {
                            alert(result.body.message || `Pregunta ${editingId ? 'actualizada' : 'creada'} con √©xito.`);
                            closeAddEditQuestionModal();
                            fetchAndRenderQuestions();
                        } else {
                            alert(`Error: ${result.body.message || 'No se pudo guardar la pregunta.'}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error saving question:', error);
                        alert('Error de conexi√≥n al guardar la pregunta.');
                    })
                    .finally(() => {
                        if(saveQuestionBtn) {
                            saveQuestionBtn.disabled = false;
                            saveQuestionBtn.classList.remove('opacity-50');
                        }
                    });
                });
            }

            if(confirmDeleteQuestionBtn) {
                confirmDeleteQuestionBtn.addEventListener('click', function() {
                    const questionIdVal = questionIdToDeleteInput.value;
                    if (!questionIdVal) return;
                    if(!confirmDeleteQuestionBtn) return;

                    confirmDeleteQuestionBtn.disabled = true;
                    confirmDeleteQuestionBtn.classList.add('opacity-50');

                    fetch(`/api/questions/${questionIdVal}`, { method: 'DELETE' })
                    .then(response => response.json().then(data => ({ok: response.ok, status: response.status, body: data})))
                    .then(result => {
                        if (result.ok) {
                            alert(result.body.message || 'Pregunta eliminada con √©xito.');
                            closeDeleteConfirmModal();
                            fetchAndRenderQuestions();
                        } else {
                            alert(`Error: ${result.body.message || 'No se pudo eliminar la pregunta.'}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting question:', error);
                        alert('Error de conexi√≥n al eliminar la pregunta.');
                    })
                    .finally(() => {
                        if(confirmDeleteQuestionBtn) {
                            confirmDeleteQuestionBtn.disabled = false;
                            confirmDeleteQuestionBtn.classList.remove('opacity-50');
                        }
                    });
                });
            }

            if (deleteRaceBtn) {
                deleteRaceBtn.addEventListener('click', function() {
                    const title = 'Confirmar Eliminaci√≥n';
                    const message = '¬øEst√°s seguro de que quieres eliminar esta carrera? Esta acci√≥n no se puede deshacer y eliminar√° todos los datos asociados (segmentos, preguntas, etc.).';

                    showConfirmDeleteRaceModal(title, message, () => {
                        if (!raceId) {
                            showNotificationModal('Error', 'ID de la carrera no encontrado.', 'error');
                            return;
                        }
                        fetch(`/api/races/${raceId}`, { method: 'DELETE' })
                        .then(response => {
                            const clonedResponse = response.clone();
                            return response.json()
                                .then(data => ({ ok: response.ok, status: response.status, body: data }))
                                .catch(() => clonedResponse.text().then(textData => ({
                                        ok: response.ok,
                                        status: response.status,
                                        body: { message: `Could not parse JSON. Raw text: ${textData}` }
                                    }))
                                );
                        })
                        .then(result => {
                            if (result.ok) {
                                // Show success message and then redirect
                                showNotificationModal('√âxito', result.body.message || 'Carrera eliminada con √©xito.', 'success');
                                // Add a small delay before redirecting to allow the user to see the message
                                setTimeout(() => {
                                    window.location.href = "{{ url_for('serve_hello_world_page') }}";
                                }, 2000); // 2 seconds delay
                            } else {
                                showNotificationModal('Error', `Error al eliminar la carrera: ${result.body.message || `Error de servidor ${result.status}`}`, 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting race:', error);
                            showNotificationModal('Error de Conexi√≥n', 'Error en la conexi√≥n o al procesar la solicitud de eliminaci√≥n.', 'error');
                        });
                    });
                });
            }

            // Clear All Official Results Button Logic
            const clearAllOfficialResultsBtn = document.getElementById('clearAllOfficialResultsBtn');
            if (clearAllOfficialResultsBtn && (currentUserRole === 'ADMIN' || currentUserRole === 'LEAGUE_ADMIN')) {
                clearAllOfficialResultsBtn.addEventListener('click', function() {
                    if (confirm("¬øEst√°s seguro de que quieres borrar todos los resultados oficiales para esta carrera? Esta acci√≥n no se puede deshacer.")) {
                        this.disabled = true;
                        this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Borrando...';

                        fetch(`/api/races/${raceId}/official_answers`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                                // 'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}' // Add CSRF if needed
                            }
                        })
                        .then(response => {
                            this.disabled = false;
                            this.innerHTML = '<i class="fas fa-trash-alt mr-2"></i>Borrar Todos los Resultados';

                            if (response.ok) {
                                // Try to parse JSON, but if it fails (e.g. empty response with 204),
                                // still treat as success for deletion.
                                return response.json().catch(() => ({
                                    message: "Resultados oficiales borrados con √©xito.",
                                    ok: true,
                                    status: response.status
                                }));
                            } else {
                                // If response is not OK, try to parse error from JSON body
                                return response.json().then(err => { throw err; });
                            }
                        })
                        .then(data => {
                            alert(data.message || "Resultados oficiales borrados con √©xito.");
                            const officialResultsContent = document.getElementById('officialResultsContent');
                            if (officialResultsContent) {
                                officialResultsContent.innerHTML = '<p id="loadingOfficialResultsMsg" class="text-gray-600">Los resultados oficiales han sido borrados. Recarga la p√°gina para actualizar la vista o para volver a cargarlos.</p>';
                                // Consider hiding the edit/clear buttons or calling fetchAndDisplayOfficialResults()
                                // if it correctly handles an empty or "no results" state.
                                // For now, just updating the message.
                            }
                        })
                        .catch(error => {
                            this.disabled = false;
                            this.innerHTML = '<i class="fas fa-trash-alt mr-2"></i>Borrar Todos los Resultados';
                            alert('Error al borrar los resultados oficiales: ' + (error.message || error.detail || 'Error desconocido. Revisa la consola para m√°s detalles.'));
                            console.error('Error clearing official results:', error);
                        });
                    }
                });
            }

            // Helper function for Edit Answer Modal ordering buttons
            function updateEditAnswerModalOrderingButtonStates(ulElement) {
                if (!ulElement) return;
                const listItems = ulElement.querySelectorAll('li[data-option-id]'); // Target li with data-option-id
                listItems.forEach((li, index) => {
                    const upButton = li.querySelector('.edit-answer-move-up-btn');
                    const downButton = li.querySelector('.edit-answer-move-down-btn');

                    if (upButton) {
                        upButton.disabled = (index === 0);
                        upButton.classList.toggle('opacity-50', upButton.disabled);
                        upButton.classList.toggle('cursor-not-allowed', upButton.disabled);
                    }
                    if (downButton) {
                        downButton.disabled = (index === listItems.length - 1);
                        downButton.classList.toggle('opacity-50', downButton.disabled);
                        downButton.classList.toggle('cursor-not-allowed', downButton.disabled);
                    }
                });
            }

            // Initial data fetch
            // fetchAndRenderQuestions(); // Commented out - questions are now fetched by wizard or admin section
            // Admin might still need a way to see questions even if user hasn't answered.
            // For now, this is removed to simplify. If questions need to be displayed for admins
            // outside the wizard, fetchAndRenderQuestions() should be called conditionally based on role.
            // e.g., if (currentUserRole === 'ADMIN' || currentUserRole === 'LEAGUE_ADMIN') { fetchAndRenderQuestions(); }
            // But ensure it doesn't interfere with the new `has_user_answered_pool` logic.

            // If admin needs to manage questions, they should be loaded regardless of has_user_answered_pool
            // The display of these questions for admin management would be separate from the user participation flow.
            // For now, let's assume question management is handled by "A√±adir Pregunta" and subsequent edit/delete in modals.
            // The `fetchAndRenderQuestions` was originally tied to the "Ver Preguntas" button which is removed.
            // If questions are needed for the wizard, the wizard should fetch them.
            // The current `fetchAndRenderQuestions` also populates `allRaceQuestions` which is used by the wizard.
            // So, it needs to be called, but its rendering part should be conditional or managed.

            if (allRaceQuestions.length === 0 && (currentUserRole === 'ADMIN' || currentUserRole === 'LEAGUE_ADMIN' || !hasUserAnsweredPool) ) {
                 // Fetch questions if they are not yet loaded, and user is admin/league_admin OR if user has not answered (for wizard)
                fetchAndRenderQuestions();
            }


            // Fetch and Display Race Participants Logic
            if (currentUserRole === 'ADMIN' || currentUserRole === 'LEAGUE_ADMIN') {
                if (raceId) {
                    const participantsContainer = document.getElementById('raceParticipantsListContainer');
                    const loadingMsg = document.getElementById('loadingParticipantsMessage');
                    const errorMsg = document.getElementById('errorLoadingParticipantsMessage');

                    if (participantsContainer && loadingMsg && errorMsg) {
                        loadingMsg.style.display = 'block';
                        errorMsg.style.display = 'none';

                        fetch(`/api/races/${raceId}/participants`)
                            .then(response => {
                                loadingMsg.style.display = 'none';
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(data => { // Changed 'participants' to 'data' to reflect the new structure
                                participantsContainer.innerHTML = ''; // Clear previous content or loading message

                                const totalQuestionsInRace = data.total_questions_in_race;

                                if (data.participants && data.participants.length > 0) {
                                    data.participants.forEach(participant => {
                                        const participantItem = document.createElement('div');
                                        participantItem.className = 'participant-item flex justify-between items-center py-2 border-b border-gray-200';

                                        const userLink = document.createElement('a');
                                        userLink.href = '#'; // Prevent page jump, will be handled by JS
                                        userLink.className = 'participant-details-link text-blue-600 hover:underline';
                                        userLink.textContent = participant.username;
                                        userLink.dataset.userId = participant.user_id;
                                        userLink.addEventListener('click', function(event) {
                                            event.preventDefault();
                                            console.log(`Clicked participant: ${participant.username}, ID: ${participant.user_id}`);
                                            // Placeholder for future functionality to show specific user answers
                                        });

                                        const answeredIcon = document.createElement('i');
                                        const answeredCount = participant.answered_questions_count;

                                        if (answeredCount === 0) {
                                            answeredIcon.className = 'fas fa-minus-circle text-red-500';
                                            answeredIcon.title = 'No ha respondido nada';
                                        } else if (answeredCount > 0 && answeredCount < totalQuestionsInRace) {
                                            answeredIcon.className = 'fas fa-exclamation-circle text-yellow-500';
                                            answeredIcon.title = `Respuestas incompletas (${answeredCount}/${totalQuestionsInRace})`;
                                        } else if (answeredCount === totalQuestionsInRace) {
                                            answeredIcon.className = 'fas fa-check-circle text-green-500';
                                            answeredIcon.title = `Todo respondido (${answeredCount}/${totalQuestionsInRace})`;
                                        } else { // Fallback, though ideally answeredCount should not exceed totalQuestionsInRace
                                            answeredIcon.className = 'fas fa-question-circle text-gray-500';
                                            answeredIcon.title = `Datos de respuesta inusuales (${answeredCount}/${totalQuestionsInRace})`;
                                        }

                                        participantItem.appendChild(userLink);
                                        participantItem.appendChild(answeredIcon);
                                        participantsContainer.appendChild(participantItem);
                                    });
                                } else {
                                    participantsContainer.innerHTML = '<p class="text-gray-600">No hay participantes inscritos en esta carrera.</p>';
                                }
                            })
                            .catch(error => {
                                loadingMsg.style.display = 'none';
                                errorMsg.style.display = 'block';
                                console.error('Error fetching race participants:', error);
                            });
                    } else {
                        console.error('Required elements for participants list not found in the DOM.');
                    }
                } else {
                    console.error('Race ID not available for fetching participants.');
                     const errorMsgElem = document.getElementById('errorLoadingParticipantsMessage');
                     if(errorMsgElem) {
                        errorMsgElem.textContent = 'ID de la carrera no disponible.';
                        errorMsgElem.style.display = 'block';
                     }
                }
            }

            // Share Race Functionality
            const participantAnswersModal = document.getElementById('participantAnswersModal');
            const participantAnswersModalTitle = document.getElementById('participantAnswersModalTitle');
            const participantAnswersModalBody = document.getElementById('participantAnswersModalBody');
            const closeParticipantAnswersModalBtn = document.getElementById('closeParticipantAnswersModalBtn');
            const closeParticipantAnswersModalFooterBtn = document.getElementById('closeParticipantAnswersModalFooterBtn');
            const raceParticipantsListContainer = document.getElementById('raceParticipantsListContainer');


            function openParticipantAnswersModal() {
                if (participantAnswersModal) {
                    participantAnswersModal.classList.remove('hidden');
                    participantAnswersModal.classList.add('flex');
                }
            }

            function closeParticipantAnswersModal() {
                if (participantAnswersModal) {
                    participantAnswersModal.classList.add('hidden');
                    participantAnswersModal.classList.remove('flex');
                    if (participantAnswersModalTitle) {
                        participantAnswersModalTitle.textContent = 'Respuestas del Participante'; // Reset title
                    }
                    if (participantAnswersModalBody) {
                        participantAnswersModalBody.innerHTML = '<p>Cargando respuestas...</p>'; // Reset body
                    }
                }
            }

            if (raceParticipantsListContainer) {
                raceParticipantsListContainer.addEventListener('click', function(event) {
                    const targetLink = event.target.closest('.participant-details-link');
                    if (targetLink) {
                        event.preventDefault();
                        const userId = targetLink.dataset.userId;
                        const username = targetLink.textContent;

                        if (participantAnswersModalTitle) {
                            participantAnswersModalTitle.textContent = 'Respuestas de ' + username;
                        }
                        if (participantAnswersModalBody) {
                            participantAnswersModalBody.innerHTML = '<p class="text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Cargando respuestas...</p>';
                        }
                        openParticipantAnswersModal();

                        fetch(`/api/races/${raceId}/participants/${userId}/answers`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(answersDetails => {
                                if (participantAnswersModalBody) {
                                    participantAnswersModalBody.innerHTML = ''; // Clear loading message
                                    if (answersDetails && answersDetails.length > 0) {
                                        answersDetails.forEach((detail, index) => {
                                            const itemDiv = document.createElement('div');
                                            itemDiv.className = 'py-3 border-b last:border-b-0 border-gray-200';

                                            const questionTextP = document.createElement('p');
                                            questionTextP.className = 'font-semibold text-gray-700 mb-1';
                                            questionTextP.textContent = `${index + 1}-${detail.question_text}`;
                                            itemDiv.appendChild(questionTextP);

                                            const answerDiv = document.createElement('div');
                                            answerDiv.className = 'pl-4 text-gray-600 bg-gray-50 p-2 rounded';

                                            let answerDisplay = '<span class="italic text-gray-500">No respondida</span>'; // Default for no answer

                                            if (detail.participant_answer !== null) {
                                                switch (detail.question_type) {
                                                    case 'FREE_TEXT':
                                                    case 'ORDERING':
                                                        answerDisplay = detail.participant_answer ? detail.participant_answer : '<span class="italic text-gray-500">No respondida</span>';
                                                        break;
                                                    case 'MULTIPLE_CHOICE':
                                                        if (detail.question_is_mc_multiple_correct) {
                                                            if (Array.isArray(detail.participant_answer) && detail.participant_answer.length > 0) {
                                                                answerDisplay = '<ul class="list-disc list-inside">';
                                                                detail.participant_answer.forEach(opt => {
                                                                    answerDisplay += `<li>${opt.text}</li>`;
                                                                });
                                                                answerDisplay += '</ul>';
                                                            }
                                                        } else {
                                                            if (detail.participant_answer && detail.participant_answer.text) {
                                                                answerDisplay = detail.participant_answer.text;
                                                            }
                                                        }
                                                        break;
                                                    case 'SLIDER':
                                                        if (detail.participant_answer !== null && detail.participant_answer !== undefined) {
                                                            answerDisplay = `${detail.participant_answer} ${detail.question_slider_unit || ''}`;
                                                        }
                                                        break;
                                                }
                                            }
                                            answerDiv.innerHTML = answerDisplay;
                                            itemDiv.appendChild(answerDiv);
                                            participantAnswersModalBody.appendChild(itemDiv);
                                        });
                                    } else {
                                        participantAnswersModalBody.innerHTML = '<p class="text-gray-600 text-center py-4">No se encontraron respuestas para este participante.</p>';
                                    }
                                }
                            })
                            .catch(error => {
                                if (participantAnswersModalBody) {
                                    participantAnswersModalBody.innerHTML = '<p class="text-red-500 text-center py-4">Error al cargar las respuestas del participante.</p>';
                                }
                                console.error('Error fetching participant answers:', error);
                            });
                    }
                });
            }

            if (closeParticipantAnswersModalBtn) {
                closeParticipantAnswersModalBtn.addEventListener('click', closeParticipantAnswersModal);
            }
            if (closeParticipantAnswersModalFooterBtn) {
                closeParticipantAnswersModalFooterBtn.addEventListener('click', closeParticipantAnswersModal);
            }
            // Close modal by clicking on backdrop
            if (participantAnswersModal) {
                participantAnswersModal.addEventListener('click', function(event) {
                    if (event.target === participantAnswersModal) { // Check if the click is on the backdrop itself
                        closeParticipantAnswersModal();
                    }
                });
            }


            const shareRaceBtn = document.getElementById('shareRaceBtn');
            const shareRaceModal = document.getElementById('shareRaceModal');
            const closeShareRaceModalBtn = document.getElementById('closeShareRaceModalBtn');
            const shareableLinkInput = document.getElementById('shareableLinkInput');
            const copyShareLinkBtn = document.getElementById('copyShareLinkBtn');
            const copyShareLinkFeedback = document.getElementById('copyShareLinkFeedback');
            // New elements for access code
            const raceAccessCodeInput = document.getElementById('raceAccessCodeInput');
            const copyAccessCodeBtn = document.getElementById('copyAccessCodeBtn');
            const copyAccessCodeFeedback = document.getElementById('copyAccessCodeFeedback');

            const archiveRaceBtn = document.getElementById('archiveRaceBtn');

            // Event listener for the unanswered questions warning
            const unansweredWarningDiv = document.getElementById('unansweredQuestionsWarning');
            if (unansweredWarningDiv) {
                unansweredWarningDiv.addEventListener('click', function() {
                    // Option 1: If "Revisar respuestas" button opens the same wizard to edit/complete.
                    // Simulate a click on the "Revisar respuestas" button.
                    // This assumes the "Revisar respuestas" button's logic correctly handles opening the wizard
                    // in a state where users can complete or edit answers.
                    const reviewBtn = document.getElementById('reviewUserAnswersBtn');
                    if (reviewBtn) {
                        reviewBtn.click();
                    }

                    // Option 2: Directly call openWizard() if that's more appropriate
                    // and `openWizard` is globally available and handles loading existing answers.
                    // if (typeof openWizard === 'function') {
                    //    openWizard();
                    // }
                    // Ensure that when the wizard opens, it loads the user's existing answers.
                    // The existing logic for `reviewUserAnswersBtn` should already handle this,
                    // as it calls `loadAndDisplayUserAnswers`. If `openWizard` is used directly,
                    // it should also ensure answers are loaded or that `reviewUserAnswersBtn`'s functionality
                    // for loading answers is triggered.
                    // Given the current structure, clicking `reviewUserAnswersBtn` seems more robust
                    // as it's already set up to open the modal and load answers.
                });
            }

            if (shareRaceBtn) {
                shareRaceBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    if (!raceId) {
                        alert('Error: ID de la carrera no disponible.');
                        return;
                    }
                    // Optional: Show loading state
                    shareRaceBtn.disabled = true;
                    shareRaceBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generando...';

                    fetch(`/api/races/${raceId}/share_link`)
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(err => { throw new Error(err.message || `Error ${response.status}`) });
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.share_link) {
                                const fullShareLink = window.location.origin + data.share_link;
                                if(shareableLinkInput) shareableLinkInput.value = fullShareLink;
                                if(raceAccessCodeInput && raceAccessCode) raceAccessCodeInput.value = raceAccessCode; // Populate access code
                                if(shareRaceModal) shareRaceModal.style.display = 'flex';
                            } else {
                                throw new Error('No se recibi√≥ el enlace para compartir.');
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching share link:', error);
                            alert(`Error al generar el enlace: ${error.message}`);
                        })
                        .finally(() => {
                            // Hide loading state
                            shareRaceBtn.disabled = false;
                            shareRaceBtn.innerHTML = '<i class="fas fa-share-alt mr-2"></i>Compartir Carrera';
                        });
                });
            }

            if (closeShareRaceModalBtn) {
                closeShareRaceModalBtn.addEventListener('click', function() {
                    shareRaceModal.style.display = 'none';
                if(copyShareLinkFeedback) copyShareLinkFeedback.style.display = 'none'; // Hide feedback on close
                if(copyAccessCodeFeedback) copyAccessCodeFeedback.style.display = 'none'; // Hide access code feedback too
                });
            }

        if (copyShareLinkBtn && shareableLinkInput && copyShareLinkFeedback) {
                copyShareLinkBtn.addEventListener('click', function() {
                    if (shareableLinkInput.value) {
                        navigator.clipboard.writeText(shareableLinkInput.value)
                            .then(() => {
                            copyShareLinkFeedback.textContent = '¬°Enlace copiado!';
                                copyShareLinkFeedback.style.display = 'block';
                            if(copyAccessCodeFeedback) copyAccessCodeFeedback.style.display = 'none'; // Hide other feedback
                                setTimeout(() => {
                                    copyShareLinkFeedback.style.display = 'none';
                            }, 2000);
                            })
                            .catch(err => {
                            console.error('Error copying share link to clipboard:', err);
                                alert('No se pudo copiar el enlace. Por favor, c√≥pielo manualmente.');
                            });
                    }
                });
            }

        // Event listener for the new "Copy Code" button
        if (copyAccessCodeBtn && raceAccessCodeInput && copyAccessCodeFeedback) {
            copyAccessCodeBtn.addEventListener('click', function() {
                if (raceAccessCodeInput.value) {
                    navigator.clipboard.writeText(raceAccessCodeInput.value)
                        .then(() => {
                            copyAccessCodeFeedback.textContent = '¬°C√≥digo copiado!';
                            copyAccessCodeFeedback.style.display = 'block';
                            if(copyShareLinkFeedback) copyShareLinkFeedback.style.display = 'none'; // Hide other feedback
                            setTimeout(() => {
                                copyAccessCodeFeedback.style.display = 'none';
                            }, 2000);
                        })
                        .catch(err => {
                            console.error('Error copying access code to clipboard:', err);
                            alert('No se pudo copiar el c√≥digo. Por favor, c√≥pielo manualmente.');
                        });
                }
            });
        }


            if (archiveRaceBtn) {
                archiveRaceBtn.addEventListener('click', function() {
                    const title = 'Confirmar Archivar';
                    const message = '¬øEst√°s seguro de que quieres archivar esta carrera? No podr√°s editar sus detalles ni la quiniela una vez archivada (aunque los datos se conservar√°n).';

                    // Using the existing confirmDeleteRaceModal structure for simplicity, but changing texts
                    const confirmModal = document.getElementById('confirmDeleteRaceModal');
                    const modalTitle = document.getElementById('confirmDeleteRaceModalTitle');
                    const modalMessage = document.getElementById('confirmDeleteRaceModalMessage');
                    const confirmActionBtn = document.getElementById('confirmDeleteRaceActionBtn');
                    const cancelBtn = document.getElementById('cancelDeleteRaceBtnModal'); // Assuming this is the cancel button for that modal

                    if (!confirmModal || !modalTitle || !modalMessage || !confirmActionBtn || !cancelBtn) {
                        alert('Error: Elementos del modal de confirmaci√≥n no encontrados.');
                        return;
                    }

                    modalTitle.textContent = title;
                    modalMessage.textContent = message;
                    confirmActionBtn.textContent = 'Archivar'; // Change button text
                    confirmActionBtn.classList.remove('bg-red-600', 'hover:bg-red-700'); // Remove delete styling
                    confirmActionBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600'); // Add archive styling

                    const archiveRaceCallback = () => {
                        confirmActionBtn.disabled = true;
                        confirmActionBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Archivando...';

                        fetch(`/api/races/${raceId}/archive`, { method: 'POST' })
                        .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, body: data })))
                        .then(result => {
                            if (result.ok) {
                                showNotificationModal('√âxito', result.body.message || 'Carrera archivada con √©xito.', 'success');
                                // Update UI: hide archive button, maybe show "Archived" badge
                                if(archiveRaceBtn) archiveRaceBtn.style.display = 'none';
                                // You might want to update a status display on the page here
                                // For now, just hiding the button and showing a success message.
                                // Potentially refresh page or parts of it.
                                // Example: Update a status badge if it exists
                                const statusBadge = document.querySelector('.hero-bg span.bg-green-500'); // Assuming this is the status badge
                                if (statusBadge) {
                                    statusBadge.textContent = 'Archivada';
                                    statusBadge.classList.remove('bg-green-500');
                                    statusBadge.classList.add('bg-gray-500'); // Or some other color for archived
                                }

                                // Hide other action buttons like edit, delete, share, add question, manage quiniela
                                const editRaceBtn = document.getElementById('openEditRaceModalBtn');
                                const deleteRaceBtnElem = document.getElementById('deleteRaceBtn'); // Renamed to avoid conflict with outer scope
                                const shareRaceBtnElem = document.getElementById('shareRaceBtn'); // Renamed
                                const addNewQuestionBtnElem = document.getElementById('addNewQuestionBtn');
                                const manageQuinielaBtn = document.querySelector('button[onclick^="openOfficialAnswersModal"]');

                                if(editRaceBtn) editRaceBtn.style.display = 'none';
                                if(deleteRaceBtnElem) deleteRaceBtnElem.style.display = 'none';
                                // Share button might still be useful for archived races, decide based on requirements.
                                // if(shareRaceBtnElem) shareRaceBtnElem.style.display = 'none';
                                if(addNewQuestionBtnElem) addNewQuestionBtnElem.style.display = 'none';
                                if(manageQuinielaBtn) manageQuinielaBtn.style.display = 'none';


                            } else {
                                showNotificationModal('Error', `Error al archivar la carrera: ${result.body.message || `Error de servidor ${result.status}`}`, 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Error archiving race:', error);
                            showNotificationModal('Error de Conexi√≥n', 'Error en la conexi√≥n o al procesar la solicitud de archivado.', 'error');
                        })
                        .finally(() => {
                            confirmActionBtn.disabled = false;
                            confirmActionBtn.innerHTML = 'Archivar';
                            // Reset styles if modal is reused for delete
                            // confirmActionBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                            // confirmActionBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                            closeConfirmDeleteRaceModal(); // Use the existing close function for this modal
                        });
                    };

                    // Detach any existing listener from confirmActionBtn to avoid multiple calls or wrong actions
                    const newConfirmActionBtn = confirmActionBtn.cloneNode(true);
                    confirmActionBtn.parentNode.replaceChild(newConfirmActionBtn, confirmActionBtn);
                    newConfirmActionBtn.addEventListener('click', archiveRaceCallback);
                    newConfirmActionBtn.textContent = 'Archivar'; // Ensure text is correct
                    newConfirmActionBtn.classList.remove('bg-red-600', 'hover:bg-red-700'); // Remove delete styling
                    newConfirmActionBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600'); // Add archive styling


                    // Also ensure cancel button works as expected
                    const newCancelBtn = cancelBtn.cloneNode(true);
                    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                    newCancelBtn.addEventListener('click', () => {
                        closeConfirmDeleteRaceModal();
                         // Reset confirm button style if modal is closed without archiving
                        const confirmBtnToReset = document.getElementById('confirmDeleteRaceActionBtn');
                        if (confirmBtnToReset){
                            confirmBtnToReset.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                            confirmBtnToReset.classList.add('bg-red-600', 'hover:bg-red-700');
                            confirmBtnToReset.textContent = 'Eliminar'; // Reset to original text for delete
                        }
                    });


                    confirmModal.style.display = 'flex';
                });
            }
        });

        // --- End Question Wizard Logic ---

        // --- Quiniela Leaderboard & Participant Answer Details ---
        const quinielaLeaderboardSection = document.getElementById('quinielaLeaderboardSection');
        const quinielaLeaderboardListContainer = document.getElementById('quinielaLeaderboardListContainer');
        const loadingLeaderboardMsg = document.getElementById('loadingLeaderboardMsg');

        // Note: The specific modal elements 'participantAnswersModal', 'participantAnswersModalTitle',
        // and 'participantAnswersModalBody' are now selected *inside* the leaderboard click handler below.
        // Global references to them here have been removed to avoid confusion and ensure fresh selection.

        // Close buttons for the participantAnswersModal are expected to be handled by its own generic
        // modal closing logic if it exists (e.g. if it shares classes or structure with other modals
        // that have existing close handlers). If not, specific handlers for its close buttons
        // ('closeParticipantAnswersModalBtn', 'closeParticipantAnswersModalFooterBtn') would be needed.
        // The HTML review confirmed these specific button IDs exist.

        function formatAnswerForDisplay(answerData, questionType, isMultipleCorrect) {
            if (answerData === null || answerData === undefined) {
                return '<span class="italic text-gray-500">No respondida</span>';
            }
            switch (questionType) {
                case 'FREE_TEXT':
                    return `<p class="text-gray-700">${answerData || '<span class="italic text-gray-500">No respondida</span>'}</p>`;
                case 'ORDERING':
                    if (answerData && typeof answerData === 'string' && answerData.trim() !== '') {
                        const orderedItems = answerData.split(',').map(item => item.trim());
                        let html = '<ol class="list-decimal list-inside text-gray-700 space-y-1">';
                        orderedItems.forEach(itemText => {
                            html += `<li>${itemText.startsWith("[ID de opci√≥n inv√°lido:") ? `<span class="text-red-500 italic">${itemText}</span>` : itemText}</li>`;
                        });
                        html += '</ol>';
                        return html;
                    }
                    return '<span class="italic text-gray-500">No respondida o formato incorrecto.</span>';
                case 'MULTIPLE_CHOICE':
                    if (isMultipleCorrect) { // Array of {id, text} objects
                        if (Array.isArray(answerData) && answerData.length > 0) {
                            let html = '<ul class="list-disc list-inside text-gray-700 space-y-1">';
                            answerData.forEach(opt => {
                                // Ensure opt and opt.text are defined
                                const text = opt && opt.text !== undefined && opt.text !== null ? opt.text : 'Opci√≥n inv√°lida';
                                const idText = opt && opt.id !== undefined && opt.id !== null ? ` (ID: ${opt.id})` : '';
                                html += `<li>${text}${idText}</li>`;
                            });
                            html += '</ul>';
                            return html;
                        }
                        return '<span class="italic text-gray-500">Ninguna opci√≥n seleccionada.</span>';
                    } else { // Single object {id, text}
                        // Ensure answerData and answerData.text are defined
                        const text = answerData && answerData.text !== undefined && answerData.text !== null ? answerData.text : 'Opci√≥n inv√°lida';
                        const idText = answerData && answerData.id !== undefined && answerData.id !== null ? ` (ID: ${answerData.id})` : '';
                        return answerData && answerData.text ? `<p class="text-gray-700">${text}${idText}</p>` : '<span class="italic text-gray-500">Ninguna opci√≥n seleccionada.</span>';
                    }
                case 'SLIDER':
                    // For SLIDER, answerData is expected to be the numeric value.
                    // The unit needs to be fetched from the question object itself, which is not directly passed here.
                    // This function is generic. If it's used for official answers, the calling context (renderAdminQuestionsView)
                    // will need to pass the question's slider_unit or append it.
                    // For now, just display the value.
                    if (typeof answerData === 'number') {
                        // The backend now provides q.official_answer_question_type, q.official_answer_is_mc_multiple_correct
                        // and q.slider_unit (on the question object itself, not part of official_answer object).
                        // The renderAdminQuestionsView will need to handle adding the unit if necessary.
                        // Here, we just format the value.
                        return `<p class="text-gray-700">${answerData}</p>`;
                    }
                    return '<span class="italic text-gray-500">Valor no especificado.</span>';
                default:
                    return '<span class="text-red-500">Tipo de respuesta no reconocido o dato inv√°lido.</span>';
            }
        }

        async function fetchAndDisplayLeaderboard(currentRaceId) {
            if (!quinielaLeaderboardListContainer || !loadingLeaderboardMsg) return;

            loadingLeaderboardMsg.style.display = 'block';
            quinielaLeaderboardListContainer.innerHTML = ''; // Clear previous

            try {
                const response = await fetch(`/api/races/${currentRaceId}/quiniela_leaderboard`);
                if (!response.ok) {
                    const errData = await response.json().catch(() => null);
                    throw new Error(errData?.message || `Error ${response.status}`);
                }
                const data = await response.json(); // Changed variable name to 'data'
                loadingLeaderboardMsg.style.display = 'none';

                if (!data || !Array.isArray(data) || data.length === 0) {
                    quinielaLeaderboardListContainer.innerHTML = '<p class="text-gray-600">No hay datos de clasificaci√≥n disponibles.</p>';
                    return;
                }

                const ul = document.createElement('ul');
                ul.className = 'space-y-1'; // Reduced space for more compact list

                let rankCounter = 0;
                let previousScore = -Infinity;
                let displayRank = 0;

                data.forEach((participant, index) => {
                    const currentIndex = index + 1; // 1-based for direct use if needed, or for rankCounter logic
                    if (participant.score !== previousScore) {
                        rankCounter = currentIndex;
                    }
                    displayRank = rankCounter;
                    previousScore = participant.score;

                    let medalEmoji = '';
                    if (displayRank === 1) medalEmoji = 'ü•á';
                    else if (displayRank === 2) medalEmoji = 'ü•à';
                    else if (displayRank === 3) medalEmoji = 'ü•â';

                    const participantItem = document.createElement('li');
                    // Tailwind classes for flex, items-center, justify-between, py-2, border-b
                    participantItem.className = 'leaderboard-participant-item flex items-center justify-between py-2 px-3 border-b border-gray-100 hover:bg-gray-50 transition-colors';
                    participantItem.dataset.userId = participant.user_id;
                    participantItem.dataset.username = participant.username;

                    participantItem.innerHTML = `
                        <div class="flex items-center space-x-2 mr-2 flex-shrink-0"> <!-- Rank and Medal group -->
                            <span class="w-7 text-sm text-gray-500 text-right">${displayRank}.</span>
                            <span class="text-xl">${medalEmoji}</span>
                        </div>
                        <span class="flex-grow text-gray-800 truncate mx-2 min-w-0" title="${participant.username}"> <!-- Username container -->
                            <a href="#" class="username-answers-link text-blue-600 hover:text-blue-700 hover:underline focus:outline-none focus:ring-2 focus:ring-blue-300 rounded-sm">${participant.username}</a>
                        </span>
                        <span class="font-semibold text-orange-600 text-sm whitespace-nowrap ml-3 flex-shrink-0">${participant.score} pts</span> <!-- Score (changed mr-3 to ml-3 for spacing from username) -->
                    `;

                    ul.appendChild(participantItem);
                });
                quinielaLeaderboardListContainer.appendChild(ul);

            } catch (error) {
                console.error('Error fetching leaderboard:', error);
                loadingLeaderboardMsg.style.display = 'none';
                quinielaLeaderboardListContainer.innerHTML = `<p class="text-red-500">Error al cargar la clasificaci√≥n: ${error.message}</p>`;
            }
        }

        if (quinielaLeaderboardSection && loadingLeaderboardMsg) { // Check if the section is rendered (quiniela closed)
            fetchAndDisplayLeaderboard(raceId); // raceId is globally available from the template
        }

        if (quinielaLeaderboardListContainer) {
            quinielaLeaderboardListContainer.addEventListener('click', async function(event) {
                const usernameLink = event.target.closest('.username-answers-link');
                if (!usernameLink) {
                    // console.log('Click was not on a .username-answers-link.'); // Optional
                    return;
                }
                event.preventDefault(); // Prevent default <a> tag behavior
                console.log('Username link clicked.');

                const participantItem = usernameLink.closest('.leaderboard-participant-item');
                if (!participantItem) {
                    console.error('Could not find parent .leaderboard-participant-item for the clicked username link.');
                    return;
                }
                console.log('Parent participant item found for username link:', participantItem);

                const userId = participantItem.dataset.userId;
                const username = participantItem.dataset.username;
                console.log('User ID:', userId, 'Username:', username);

                // Select modal elements *inside* the handler
                const participantAnswersModal = document.getElementById('participantAnswersModal');
                const participantAnswersModalTitle = document.getElementById('participantAnswersModalTitle');
                const participantAnswersModalBody = document.getElementById('participantAnswersModalBody');

                // Log their state immediately after selection within the handler
                console.log('Modal elements selected INSIDE click handler:', {
                    modal: participantAnswersModal,
                    title: participantAnswersModalTitle,
                    body: participantAnswersModalBody
                });

                // LOG ADDED - Check variables right before use in the handler (this refers to the locally scoped ones now)
                // console.log('Modal elements in click handler (before check):', { // This log becomes redundant due to the one above
                //     modal: participantAnswersModal,
                //     title: participantAnswersModalTitle,
                //     body: participantAnswersModalBody
                // });

                if (!participantAnswersModal || !participantAnswersModalTitle || !participantAnswersModalBody) {
                    console.error('Participant answers modal elements not found (selected inside handler). Modal:', participantAnswersModal, 'Title:', participantAnswersModalTitle, 'Body:', participantAnswersModalBody);
                    return;
                }

                participantAnswersModalTitle.textContent = `Respuestas de ${username}`;
                participantAnswersModalBody.innerHTML = '<p class="text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Cargando respuestas detalladas...</p>';

                console.log('Attempting to show participantAnswersModal (selected inside handler)...');
                participantAnswersModal.classList.remove('hidden'); // Show modal
                participantAnswersModal.classList.add('flex');
                console.log('participantAnswersModal display attempted. Check if visible. Computed display:', window.getComputedStyle(participantAnswersModal).display);


                try {
                    console.log('Fetching answers for User ID:', userId, 'Race ID:', raceId);
                    const response = await fetch(`/api/races/${raceId}/participants/${userId}/answers`);
                    if (!response.ok) {
                        // Check content type before trying to parse as JSON
                        const contentType = response.headers.get("content-type");
                        let errorJson = null;
                        if (contentType && contentType.indexOf("application/json") !== -1) {
                            errorJson = await response.json().catch(() => null);
                        } else {
                            // If not JSON, try to get text, but don't fail if that also errors.
                            // The main point is to avoid the "Unexpected token '<'" from response.json() on HTML.
                            const errorText = await response.text().catch(() => "Server returned non-JSON response.");
                            console.warn("Server returned non-JSON error response:", errorText.substring(0, 200)); // Log first 200 chars
                        }
                        throw new Error(errorJson?.message || `Error ${response.status}`);
                    }
                    const answerDetails = await response.json();
                    console.log('Fetched answer details:', answerDetails); // LOG ADDED
                    participantAnswersModalBody.innerHTML = ''; // Clear loading

                    if (!answerDetails || answerDetails.length === 0) {
                        participantAnswersModalBody.innerHTML = '<p class="text-gray-600 text-center py-4">No se encontraron respuestas para este participante.</p>';
                        console.log('No answer details found or empty array.'); // LOG ADDED
                        return;
                    }

                    answerDetails.forEach((detail, index) => {
                        console.log('Processing answer detail for question:', detail.question_text, detail); // LOG ADDED
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'p-4 border border-gray-200 rounded-lg bg-white shadow mb-3';

                        let correctnessClass = detail.is_correct ? 'text-green-500' : 'text-red-500';
                        let correctnessIcon = detail.is_correct ? 'fa-check-circle' : 'fa-times-circle';
                        let correctnessText = detail.is_correct ? 'Correcto' : 'Incorrecto';
                        if (detail.official_answer === null || detail.official_answer === undefined) { // If no official answer, can't determine correctness
                             correctnessClass = 'text-gray-500';
                             correctnessIcon = 'fa-question-circle';
                             correctnessText = 'No evaluado';
                        }


                        itemDiv.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold text-gray-800 flex-1 pr-2">${index + 1}-${detail.question_text}</h4>
                                <span class="${correctnessClass} text-sm font-medium whitespace-nowrap">
                                    <i class="fas ${correctnessIcon} mr-1"></i> ${correctnessText}
                                </span>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                <div class="bg-gray-50 p-3 rounded-md border border-gray-100">
                                    <p class="text-xs text-gray-500 mb-1">Tu Respuesta:</p>
                                    ${formatAnswerForDisplay(detail.participant_answer, detail.question_type, detail.question_is_mc_multiple_correct)}
                                </div>
                                <div class="bg-blue-50 p-3 rounded-md border border-blue-100">
                                    <p class="text-xs text-blue-500 mb-1">Respuesta Oficial:</p>
                                    ${formatAnswerForDisplay(detail.official_answer, detail.question_type, detail.question_is_mc_multiple_correct)}
                                </div>
                            </div>
                            <div class="text-right text-sm">
                                <span class="font-semibold text-gray-700">Puntos: ${detail.points_obtained} / ${detail.max_points_possible}</span>
                            </div>
                        `;
                        participantAnswersModalBody.appendChild(itemDiv);
                    });

                } catch (error) {
                    console.error('Error fetching answers in click handler:', error); // LOG MODIFIED
                    participantAnswersModalBody.innerHTML = `<p class="text-red-500 text-center py-4">Error al cargar los detalles: ${error.message}</p>`;
                }
            });
        }
        // End Quiniela Leaderboard & Participant Answer Details ---


        // --- Official Results Modal & Logic ---
            // const editOfficialResultsBtn = document.getElementById('editOfficialResultsBtn'); // Added in previous step, ensure it's declared if used here
        const setOfficialResultsBtn = document.getElementById('setOfficialResultsBtn');
        const officialResultsModal = document.getElementById('officialResultsModal');
        const closeOfficialResultsModalBtn = document.getElementById('closeOfficialResultsModalBtn');
        const cancelOfficialResultsBtn = document.getElementById('cancelOfficialResultsBtn');
        const saveOfficialResultsForm = document.getElementById('saveOfficialResultsForm');
        const officialResultsFormContent = document.getElementById('officialResultsFormContent');
        const officialResultsModalTitle = document.getElementById('officialResultsModalTitle');

        function showSetOfficialResultsButton() {
            if (setOfficialResultsBtn && (currentUserRole === 'ADMIN' || currentUserRole === 'LEAGUE_ADMIN')) {
                if (raceEventDateString) {
                    const eventDate = new Date(raceEventDateString);
                    if (eventDate < new Date()) {
                        setOfficialResultsBtn.style.display = 'inline-flex';
                    }
                }
            }
        }

        async function populateOfficialResultsForm() {
            if (!officialResultsFormContent) return;
            officialResultsFormContent.innerHTML = '<p class="text-center">Cargando preguntas...</p>';

            try {
                // Fetch all questions for the race
                const questionsResponse = await fetch(`/api/races/${raceId}/questions`);
                if (!questionsResponse.ok) throw new Error('Failed to fetch questions');
                const questions = await questionsResponse.json();

                // Fetch existing official answers
                let existingOfficialAnswers = {};
                try {
                    const officialAnswersResponse = await fetch(`/api/races/${raceId}/official_answers`);
                    if (officialAnswersResponse.ok) {
                        existingOfficialAnswers = await officialAnswersResponse.json(); // Expected: { "question_id": { answer_data... } }
                    } else if (officialAnswersResponse.status !== 404) { // 404 is fine (no answers yet)
                        console.warn('Could not fetch existing official answers, proceeding with empty form.');
                    }
                } catch (error) {
                    console.warn('Error fetching existing official answers:', error);
                }


                if (!questions || questions.length === 0) {
                    officialResultsFormContent.innerHTML = '<p class="text-center text-red-500">No hay preguntas configuradas para esta carrera.</p>';
                    return;
                }

                officialResultsFormContent.innerHTML = ''; // Clear loading message

                questions.forEach((q, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50';
                    questionDiv.dataset.questionId = q.id;
                    questionDiv.dataset.questionType = q.question_type;
                    questionDiv.dataset.isMcMultipleCorrect = q.is_mc_multiple_correct || false;


                    let inputHtml = `<h4 class="font-semibold text-gray-700 mb-2">${index + 1}-${q.text}</h4>`;
                    const currentAnswer = existingOfficialAnswers[q.id.toString()] || {};

                    switch (q.question_type) {
                        case 'FREE_TEXT':
                            inputHtml += `<textarea name="official_answer_q${q.id}_text" class="w-full p-2 border border-gray-300 rounded-md" rows="3">${currentAnswer.answer_text || ''}</textarea>`;
                            break;
                        case 'ORDERING':
                            inputHtml += `<textarea name="official_answer_q${q.id}_ordering" class="w-full p-2 border border-gray-300 rounded-md" rows="3" placeholder="Ej: Opci√≥n C, Opci√≥n A, Opci√≥n B">${currentAnswer.ordered_options_text || ''}</textarea>`;
                            // Display options for reference
                            if (q.options && q.options.length > 0) {
                                inputHtml += '<p class="text-xs text-gray-500 mt-1">Opciones disponibles (para referencia de ordenamiento):</p><ul class="text-xs list-disc list-inside pl-4">';
                                q.options.forEach(opt => inputHtml += `<li>${opt.option_text} (ID: ${opt.id})</li>`);
                                inputHtml += '</ul>';
                            }
                            break;
                        case 'MULTIPLE_CHOICE':
                            if (q.options && q.options.length > 0) {
                                inputHtml += '<div class="space-y-2 mt-1">';
                                q.options.forEach(opt => {
                                    if (q.is_mc_multiple_correct) {
                                        const isChecked = currentAnswer.selected_option_ids?.includes(opt.id) ? 'checked' : '';
                                        inputHtml += `
                                            <label class="flex items-center space-x-2 p-1 hover:bg-gray-100 rounded">
                                                <input type="checkbox" name="official_answer_q${q.id}_option" value="${opt.id}" class="form-checkbox h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500" ${isChecked}>
                                                <span>${opt.option_text}</span>
                                            </label>`;
                                    } else {
                                        const isChecked = currentAnswer.selected_option_id == opt.id ? 'checked' : '';
                                        inputHtml += `
                                            <label class="flex items-center space-x-2 p-1 hover:bg-gray-100 rounded">
                                                <input type="radio" name="official_answer_q${q.id}_option" value="${opt.id}" class="form-radio h-4 w-4 text-orange-600 border-gray-300 focus:ring-orange-500" ${isChecked}>
                                                <span>${opt.option_text}</span>
                                            </label>`;
                                    }
                                });
                                inputHtml += '</div>';
                            } else {
                                inputHtml += '<p class="text-red-500 text-sm">No hay opciones para esta pregunta.</p>';
                            }
                            break;
                        default:
                            inputHtml += '<p class="text-red-500 text-sm">Tipo de pregunta no soportado para resultados oficiales.</p>';
                    }
                    questionDiv.innerHTML = inputHtml;
                    officialResultsFormContent.appendChild(questionDiv);
                });

            } catch (error) {
                console.error('Error populating official results form:', error);
                officialResultsFormContent.innerHTML = `<p class="text-center text-red-500">Error al cargar el formulario: ${error.message}</p>`;
            }
        }

        if (setOfficialResultsBtn) {
            setOfficialResultsBtn.addEventListener('click', () => {
                if (officialResultsModalTitle) officialResultsModalTitle.textContent = `Set Official Quiniela Results for ${raceTitle}`;
                populateOfficialResultsForm();
                if (officialResultsModal) officialResultsModal.style.display = 'flex';
            });
        }

        if (closeOfficialResultsModalBtn) {
            closeOfficialResultsModalBtn.addEventListener('click', () => {
                if (officialResultsModal) officialResultsModal.style.display = 'none';
            });
        }
        if (cancelOfficialResultsBtn) {
            cancelOfficialResultsBtn.addEventListener('click', () => {
                if (officialResultsModal) officialResultsModal.style.display = 'none';
            });
        }

        if (saveOfficialResultsForm) {
            saveOfficialResultsForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const saveButton = saveOfficialResultsForm.querySelector('button[type="submit"]');
                saveButton.disabled = true;
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';

                const payload = {};
                const questionDivs = officialResultsFormContent.querySelectorAll('div[data-question-id]');

                questionDivs.forEach(div => {
                    const questionId = div.dataset.questionId;
                    const questionType = div.dataset.questionType;
                    const isMultipleCorrect = div.dataset.isMcMultipleCorrect === 'true';
                    let answerData = {};

                    switch (questionType) {
                        case 'FREE_TEXT':
                            const ftTextarea = div.querySelector(`textarea[name="official_answer_q${questionId}_text"]`);
                            if (ftTextarea) answerData.answer_text = ftTextarea.value;
                            break;
                        case 'ORDERING':
                            const orTextarea = div.querySelector(`textarea[name="official_answer_q${questionId}_ordering"]`);
                            if (orTextarea) answerData.ordered_options_text = orTextarea.value;
                            break;
                        case 'MULTIPLE_CHOICE':
                            if (isMultipleCorrect) {
                                answerData.selected_option_ids = [];
                                div.querySelectorAll(`input[name="official_answer_q${questionId}_option"]:checked`).forEach(checkbox => {
                                    answerData.selected_option_ids.push(parseInt(checkbox.value));
                                });
                            } else {
                                const radioChecked = div.querySelector(`input[name="official_answer_q${questionId}_option"]:checked`);
                                answerData.selected_option_id = radioChecked ? parseInt(radioChecked.value) : null;
                            }
                            break;
                    }
                    payload[questionId] = answerData;
                });

                try {
                    const response = await fetch(`/api/races/${raceId}/official_answers`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}' // If CSRF needed
                        },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (response.ok) {
                        alert(result.message || 'Resultados oficiales guardados con √©xito.');
                        if (officialResultsModal) officialResultsModal.style.display = 'none';
                    } else {
                        alert(`Error: ${result.body.message || 'No se pudieron guardar los resultados oficiales.'}`);
                    }
                } catch (error) {
                    console.error('Error saving official results:', error);
                    alert('Error de conexi√≥n al guardar los resultados oficiales.');
                } finally {
                    saveButton.disabled = false;
                    saveButton.innerHTML = 'Guardar Resultados Oficiales';
                }
            });
        }
        // --- End Official Results Modal & Logic ---

        // --- Display Official Results Logic ---
        async function fetchAndDisplayOfficialResults() {
            const officialResultsSection = document.getElementById('officialResultsSection');
            const officialResultsContent = document.getElementById('officialResultsContent');
            const loadingMsg = document.getElementById('loadingOfficialResultsMsg');

            if (!officialResultsSection || !officialResultsContent || !loadingMsg) {
                console.error("Official results display elements not found.");
                return;
            }

            // Ensure questions are loaded first, as we need question text
            if (allRaceQuestions.length === 0) {
                try {
                    const qResponse = await fetch(`/api/races/${raceId}/questions`);
                    if (!qResponse.ok) throw new Error('Failed to fetch questions for official results display');
                    allRaceQuestions = await qResponse.json();
                } catch (error) {
                    console.error("Error pre-fetching questions for official results:", error);
                    loadingMsg.textContent = 'Error al cargar datos de preguntas para mostrar resultados.';
                    officialResultsSection.style.display = 'block'; // Show section to display error
                    return;
                }
            }

            if (!raceEventDateString || new Date(raceEventDateString) > new Date()) {
                // Race hasn't concluded or no date available, so don't attempt to show official results.
                // The section will remain hidden by default.
                console.log("Race has not concluded or event date is not available. Official results will not be displayed.");
                return;
            }

            loadingMsg.style.display = 'block';
            officialResultsContent.innerHTML = ''; // Clear previous content (like loading message if it was there)
            officialResultsContent.appendChild(loadingMsg); // Re-add loading message for this specific fetch
            officialResultsSection.style.display = 'block'; // Show the section

            try {
                const response = await fetch(`/api/races/${raceId}/official_answers`);
                if (!response.ok) {
                    if (response.status === 403) {
                        const eventDate = new Date(raceEventDateString);
                        const formattedEventDate = eventDate.toLocaleString(); // Format to local date/time
                        loadingMsg.textContent = `Los resultados oficiales estar√°n disponibles despu√©s de la fecha y hora del evento: ${formattedEventDate}. Por favor, int√©ntalo de nuevo m√°s tarde.`;
                        officialResultsSection.style.display = 'block'; // Ensure section is visible
                        return;
                    }
                    throw new Error(`Error ${response.status}: Failed to fetch official answers.`);
                }
                const officialAnswersData = await response.json();

                if (Object.keys(officialAnswersData).length === 0) {
                    loadingMsg.textContent = 'Los resultados oficiales a√∫n no han sido cargados por el administrador.';
                    officialResultsSection.style.display = 'block'; // Ensure section is visible
                    return;
                }

                loadingMsg.style.display = 'none'; // Hide loading message
                let questionCounter = 0; // Initialize a counter for question numbering

                for (const qIdStr in officialAnswersData) {
                    const answerInfo = officialAnswersData[qIdStr];
                    const question = allRaceQuestions.find(q => q.id.toString() === qIdStr);

                    if (!question) {
                        console.warn(`Question with ID ${qIdStr} not found in allRaceQuestions. Skipping display for this official answer.`);
                        continue;
                    }
                    questionCounter++; // Increment for each question processed

                    const resultItemDiv = document.createElement('div');
                    resultItemDiv.className = 'p-4 border border-gray-200 rounded-lg bg-gray-50 shadow-sm';

                    let answerHtml = '';
                    switch (answerInfo.question_type) {
                        case 'FREE_TEXT':
                        case 'ORDERING':
                            answerHtml = `<p class="text-gray-800">${answerInfo.answer_text || '<em class="text-gray-500">No se proporcion√≥ respuesta.</em>'}</p>`;
                            break;
                        case 'MULTIPLE_CHOICE':
                            if (answerInfo.selected_option_text !== undefined) { // Single choice
                                answerHtml = `<p class="text-gray-800">${answerInfo.selected_option_text || '<em class="text-gray-500">Ninguna opci√≥n seleccionada.</em>'}</p>`;
                                if (answerInfo.selected_option_id && answerInfo.selected_option_text === null) {
                                    console.warn(`Official answer for single-choice MC Question ID ${qIdStr} (text: "${question.text}") references selected_option_id ${answerInfo.selected_option_id}, but this option was not found or has no text. Check data integrity.`);
                                }
                            } else if (answerInfo.selected_options && answerInfo.selected_options.length > 0) { // Multiple choice
                                answerHtml = '<ul class="list-disc list-inside space-y-1">';
                                answerInfo.selected_options.forEach(opt => {
                                    const questionOptionExists = question.options.find(qOpt => qOpt.id === opt.option_id);
                                    if (!questionOptionExists) {
                                        console.warn(`Official answer for multi-choice MC Question ID ${qIdStr} (text: "${question.text}") includes an option_id ${opt.option_id} ("${opt.option_text}") which was not found among the question's defined options. Check data integrity.`);
                                    }
                                    answerHtml += `<li class="text-gray-800">${opt.option_text}</li>`;
                                });
                                answerHtml += '</ul>';
                            } else {
                                answerHtml = '<em class="text-gray-500">Ninguna opci√≥n seleccionada.</em>';
                            }
                            break;
                        default:
                            answerHtml = '<em class="text-red-500">Tipo de respuesta no reconocido.</em>';
                    }

                    resultItemDiv.innerHTML = `
                        <h4 class="font-semibold text-gray-700 mb-1">${questionCounter}-${question.text}</h4>
                        <div class="text-sm text-gray-500 mb-2">Respuesta Oficial:</div>
                        <div class="p-2 rounded-md bg-white border border-gray-300 min-h-[30px]">${answerHtml}</div>
                    `;
                    officialResultsContent.appendChild(resultItemDiv);
                }

            } catch (error) {
                console.error('Error fetching or displaying official results:', error);
                loadingMsg.textContent = `Se produjo un error al intentar cargar los resultados oficiales. Por favor, int√©ntalo de nuevo m√°s tarde. (${error.message})`;
                officialResultsSection.style.display = 'block'; // Ensure section is visible
            }
        }
        // --- End Display Official Results Logic ---


        document.addEventListener('DOMContentLoaded', function() {
            // --- Question Wizard Logic ---
            let currentQuestionIndex = 0;
            let userWizardAnswers = {}; // Stores answers as { question_id: { ...answer_data } }

            // Helper function to update enabled/disabled state of move buttons in wizard ordering list
            function updateWizardOrderingButtonStates(ulElement) {
                if (!ulElement) return;
                const listItems = ulElement.querySelectorAll('li[data-option-id]');
                listItems.forEach((li, index) => {
                    const upButton = li.querySelector('.wizard-move-up-btn');
                    const downButton = li.querySelector('.wizard-move-down-btn');

                    if (upButton) {
                        upButton.disabled = (index === 0);
                        upButton.classList.toggle('opacity-50', upButton.disabled);
                        upButton.classList.toggle('cursor-not-allowed', upButton.disabled);
                    }
                    if (downButton) {
                        downButton.disabled = (index === listItems.length - 1);
                        downButton.classList.toggle('opacity-50', downButton.disabled);
                        downButton.classList.toggle('cursor-not-allowed', downButton.disabled);
                    }
                });
            }

            // Helper function for Edit Modal ordering buttons
            function updateEditModalOrderingButtonStates(ulElement) {
                if (!ulElement) return;
                const listItems = ulElement.querySelectorAll('li.edit-modal-ordering-item');
                listItems.forEach((li, index) => {
                    const upButton = li.querySelector('.edit-modal-move-up-btn');
                    const downButton = li.querySelector('.edit-modal-move-down-btn');

                    if (upButton) {
                        upButton.disabled = (index === 0);
                        upButton.classList.toggle('opacity-50', upButton.disabled);
                        upButton.classList.toggle('cursor-not-allowed', upButton.disabled);
                    }
                    if (downButton) {
                        downButton.disabled = (index === listItems.length - 1);
                        downButton.classList.toggle('opacity-50', downButton.disabled);
                        downButton.classList.toggle('cursor-not-allowed', downButton.disabled);
                    }
                });
            }

            // Helper function for Edit Answer Modal ordering buttons
            function updateEditAnswerModalOrderingButtonStates(ulElement) {
                if (!ulElement) return;
                const listItems = ulElement.querySelectorAll('li[data-option-id]'); // Target li with data-option-id
                listItems.forEach((li, index) => {
                    const upButton = li.querySelector('.edit-answer-move-up-btn'); // Corrected class
                    const downButton = li.querySelector('.edit-answer-move-down-btn'); // Corrected class

                    if (upButton) {
                        upButton.disabled = (index === 0);
                        upButton.classList.toggle('opacity-50', upButton.disabled);
                        upButton.classList.toggle('cursor-not-allowed', upButton.disabled);
                    }
                    if (downButton) {
                        downButton.disabled = (index === listItems.length - 1);
                        downButton.classList.toggle('opacity-50', downButton.disabled);
                        downButton.classList.toggle('cursor-not-allowed', downButton.disabled);
                    }
                });
            }


            // Wizard Modal DOM Elements
            const questionWizardModal = document.getElementById('questionWizardModal');
            const wizardQuestionProgress = document.getElementById('wizardQuestionProgress');
            const closeWizardModalBtn = document.getElementById('closeWizardModalBtn');
            const wizardQuestionText = document.getElementById('wizardQuestionText');
            const wizardAnswerOptions = document.getElementById('wizardAnswerOptions');
            const wizardPrevBtn = document.getElementById('wizardPrevBtn');
            const wizardNextBtn = document.getElementById('wizardNextBtn');
            const wizardFinishBtn = document.getElementById('wizardFinishBtn');
            const answerQuestionsBtn = document.getElementById('answerQuestionsBtn'); // This is the hero button

            function openWizard() {
                if (quinielaCloseDate && new Date(quinielaCloseDate) < new Date()) {
                    showNotificationModal("Quiniela Cerrada", "La quiniela ya est√° cerrada y no se puede participar.", "info");
                    return;
                }
                // If questions haven't been loaded yet (e.g. for a player who hasn't answered)
                // Ensure questions are fetched before opening the wizard.
                if (allRaceQuestions.length === 0) {
                    // Temporarily show a loading indicator for the wizard button or modal
                    const wizardTriggerButton = document.getElementById('participateInPoolBtn') || document.getElementById('answerQuestionsBtn');
                    let originalButtonText = '';
                    if (wizardTriggerButton) {
                        originalButtonText = wizardTriggerButton.innerHTML;
                        wizardTriggerButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Cargando Quiniela...';
                        wizardTriggerButton.disabled = true;
                    }

                    fetch(`/api/races/${raceId}/questions`)
                        .then(response => {
                            if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);
                            return response.json();
                        })
                        .then(questions => {
                            allRaceQuestions = questions; // Populate global questions
                            if (!allRaceQuestions || allRaceQuestions.length === 0) {
                                showNotificationModal("Sin Preguntas", "No hay preguntas disponibles para esta carrera en este momento.", "info");
                                if (wizardTriggerButton) { // Restore button
                                    wizardTriggerButton.innerHTML = originalButtonText;
                                    wizardTriggerButton.disabled = false;
                                }
                                return;
                            }
                            // Now that questions are loaded, proceed to open wizard
                            currentQuestionIndex = 0;
                            userWizardAnswers = {}; // Reset answers
                            displayWizardQuestion(currentQuestionIndex);
                            if(questionWizardModal) questionWizardModal.style.display = 'flex';

                            // Also, if LEAGUE_ADMIN, ensure their view is updated if wizard was the first to fetch.
                            if (currentUserRole === 'LEAGUE_ADMIN') {
                                const adminQuestionsListContainer = document.getElementById('adminQuestionsViewContainer');
                                if (adminQuestionsListContainer) {
                                     renderAdminQuestionsView(allRaceQuestions);
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching questions for wizard:', error);
                            showNotificationModal("Error", `Error al cargar las preguntas de la quiniela: ${error.message}. Int√©ntalo de nuevo.`, "error");
                        })
                        .finally(() => {
                            if (wizardTriggerButton) { // Restore button
                                wizardTriggerButton.innerHTML = originalButtonText;
                                wizardTriggerButton.disabled = false;
                            }
                        });
                } else {
                    // Questions are already loaded, open wizard directly
                    currentQuestionIndex = 0;
                    userWizardAnswers = {}; // Reset answers
                    displayWizardQuestion(currentQuestionIndex);
                    if(questionWizardModal) questionWizardModal.style.display = 'flex';

                    // If questions were pre-loaded and user is LEAGUE_ADMIN, render their view.
                    // This handles the case where fetchAndRenderQuestions() might not have been the one populating allRaceQuestions.
                    if (currentUserRole === 'LEAGUE_ADMIN') {
                         const adminQuestionsListContainer = document.getElementById('adminQuestionsViewContainer');
                         if (adminQuestionsListContainer && allRaceQuestions.length > 0) { // Ensure container and questions exist
                            renderAdminQuestionsView(allRaceQuestions);
                         }
                    }
                }
            }

            function closeWizard() {
                if(questionWizardModal) questionWizardModal.style.display = 'none';
            }

            function displayWizardQuestion(index) {
                // const questionForLog = allRaceQuestions && index >= 0 && index < allRaceQuestions.length ? allRaceQuestions[index] : undefined;
                // console.log('Wizard: displayWizardQuestion called. Index:', index, 'Question to display:', questionForLog);

                if(wizardAnswerOptions) wizardAnswerOptions.innerHTML = '<p class="text-center text-gray-500 py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Cargando pregunta...</p>';

                if (!allRaceQuestions || allRaceQuestions.length === 0) {
                    // console.error("displayWizardQuestion called with no questions available."); // Puede ser √∫til mantenerlo si hay problemas futuros
                    if(wizardQuestionText) wizardQuestionText.textContent = 'Error';
                    if(wizardAnswerOptions) wizardAnswerOptions.innerHTML = '<p class="text-red-500 text-center py-4">Error: No hay preguntas disponibles para esta carrera.</p>';
                    if(wizardNextBtn) wizardNextBtn.style.display = 'none';
                    if(wizardFinishBtn) wizardFinishBtn.style.display = 'none';
                    // Keep PrevBtn to allow user to go back if possible, or hide it too if state is unrecoverable.
                    // closeWizard(); // Or let user close manually.
                    return;
                }
                if (index < 0 || index >= allRaceQuestions.length) {
                    // console.error("Invalid question index:", index);  // Puede ser √∫til mantenerlo si hay problemas futuros
                    if(wizardQuestionText) wizardQuestionText.textContent = 'Error';
                    if(wizardAnswerOptions) wizardAnswerOptions.innerHTML = '<p class="text-red-500 text-center py-4">Error: √çndice de pregunta no v√°lido.</p>';
                    if(wizardNextBtn) wizardNextBtn.style.display = 'none';
                    if(wizardFinishBtn) wizardFinishBtn.style.display = 'none';
                    return;
                }

                const question = allRaceQuestions[index];
                if (!question) {
                    if(wizardQuestionText) wizardQuestionText.textContent = 'Error';
                    if(wizardAnswerOptions) wizardAnswerOptions.innerHTML = '<p class="text-red-500 text-center py-4">Error: No se pudo cargar esta pregunta (datos no v√°lidos).</p>';
                    // console.error('displayWizardQuestion: question data is invalid for index', index, 'in allRaceQuestions:', allRaceQuestions); // Puede ser √∫til
                    if(wizardNextBtn) wizardNextBtn.style.display = 'none';
                    if(wizardFinishBtn) wizardFinishBtn.style.display = 'none';
                    return;
                }
                const existingAnswer = userWizardAnswers[question.id];

                if(wizardQuestionProgress) wizardQuestionProgress.textContent = `Pregunta ${index + 1} de ${allRaceQuestions.length}`;
                if(wizardQuestionText) wizardQuestionText.textContent = `${index + 1}-${question.text}`;
                // Clear previous options, will be repopulated in try or error caught in catch
                if(wizardAnswerOptions) wizardAnswerOptions.innerHTML = '';

                try {
                    switch (question.question_type) {
                        case 'FREE_TEXT':
                            const textarea = document.createElement('textarea');
                        textarea.id = `wizardFreeTextAnswer_${question.id}`;
                        textarea.className = 'w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent';
                        textarea.rows = 4;
                        textarea.placeholder = 'Escribe tu respuesta...';
                        textarea.value = existingAnswer?.answer_text || '';
                        if (wizardAnswerOptions) wizardAnswerOptions.appendChild(textarea);
                        break;

                    case 'MULTIPLE_CHOICE':
                        if (!question.options || !Array.isArray(question.options)) {
                            throw new Error('Datos de opciones de Opci√≥n M√∫ltiple no v√°lidos o ausentes.');
                        }
                        question.options.forEach(opt => {
                            const label = document.createElement('label');
                            label.className = 'flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded-md border border-gray-200 hover:border-orange-300';

                            const input = document.createElement('input');
                            input.type = question.is_mc_multiple_correct ? 'checkbox' : 'radio';
                            input.name = `wizard_q_${question.id}`;
                            input.value = opt.id;
                            input.className = 'text-orange-500 focus:ring-orange-400 focus:ring-offset-0';
                            if (question.is_mc_multiple_correct) {
                                input.classList.add('rounded');
                                if (existingAnswer?.selected_option_ids?.includes(opt.id)) {
                                    input.checked = true;
                                }
                            } else {
                                if (existingAnswer?.selected_option_id == opt.id) {
                                    input.checked = true;
                                }
                            }

                            const span = document.createElement('span');
                            span.className = 'text-gray-700';
                            span.textContent = opt.option_text;

                            label.appendChild(input);
                            label.appendChild(span);
                            if (wizardAnswerOptions) wizardAnswerOptions.appendChild(label);
                        });
                        break;

                    case 'ORDERING':
                        const infoText = document.createElement('p');
                        infoText.className = 'text-sm text-gray-600 mb-2';
                        infoText.textContent = "Ordena los siguientes items. Indica tu orden en el cuadro de texto (ej: Opci√≥n C, Opci√≥n A, Opci√≥n B).";
                        if (wizardAnswerOptions) wizardAnswerOptions.appendChild(infoText);

                        const listContainer = document.createElement('div');
                        listContainer.className = 'space-y-1 mb-3 p-2 border rounded-md';
                        question.options.forEach(opt => {
                            const listItem = document.createElement('div');
                            listItem.className = 'bg-gray-100 p-2 rounded text-sm';
                            listItem.textContent = opt.option_text;
                            listContainer.appendChild(listItem);
                        });
                        if (wizardAnswerOptions) wizardAnswerOptions.appendChild(listContainer);

                        const orderingListContainer = document.createElement('ul');
                        orderingListContainer.id = `wizardOrderingList_${question.id}`;
                        orderingListContainer.className = 'list-none p-0 m-0 space-y-2';

                        if (question.options && question.options.length > 0) {
                            let orderedOptions = [...question.options]; // Default to original order

                            if (existingAnswer && existingAnswer.ordered_options_text) {
                                const savedOrderIds = existingAnswer.ordered_options_text.split(',').map(id => parseInt(id.trim(), 10));
                                const optionsMap = new Map(question.options.map(opt => [opt.id, opt]));
                                const newOrderedOptions = [];
                                const addedOptionIds = new Set();

                                // Add options based on saved order
                                savedOrderIds.forEach(id => {
                                    if (optionsMap.has(id)) {
                                        newOrderedOptions.push(optionsMap.get(id));
                                        addedOptionIds.add(id);
                                    }
                                });

                                // Add any remaining options not in the saved order (e.g., if new options were added to question)
                                question.options.forEach(opt => {
                                    if (!addedOptionIds.has(opt.id)) {
                                        newOrderedOptions.push(opt);
                                    }
                                });
                                orderedOptions = newOrderedOptions;
                            }

                            orderedOptions.forEach(opt => {
                                const listItem = document.createElement('li');
                                listItem.dataset.optionId = opt.id;
                                listItem.className = 'p-3 border rounded-md bg-gray-50 flex justify-between items-center shadow-sm';

                                const textSpan = document.createElement('span');
                                textSpan.className = 'text-gray-700';
                                textSpan.textContent = opt.option_text;
                                listItem.appendChild(textSpan);

                                const buttonContainer = document.createElement('div');
                                buttonContainer.className = 'space-x-1';

                                const moveUpBtn = document.createElement('button');
                                moveUpBtn.innerHTML = '‚Üë';
                                moveUpBtn.type = 'button'; // Important for forms
                                moveUpBtn.className = 'wizard-move-up-btn px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-200 transition-colors focus:outline-none focus:ring-2 focus:ring-orange-300';
                                moveUpBtn.addEventListener('click', () => {
                                    const currentLi = moveUpBtn.closest('li');
                                    if (currentLi && currentLi.previousElementSibling) {
                                        currentLi.parentNode.insertBefore(currentLi, currentLi.previousElementSibling);
                                        updateWizardOrderingButtonStates(orderingListContainer);
                                    }
                                });
                                buttonContainer.appendChild(moveUpBtn);

                                const moveDownBtn = document.createElement('button');
                                moveDownBtn.innerHTML = '‚Üì';
                                moveDownBtn.type = 'button'; // Important for forms
                                moveDownBtn.className = 'wizard-move-down-btn px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-200 transition-colors focus:outline-none focus:ring-2 focus:ring-orange-300';
                                moveDownBtn.addEventListener('click', () => {
                                    const currentLi = moveDownBtn.closest('li');
                                    if (currentLi && currentLi.nextElementSibling) {
                                        currentLi.parentNode.insertBefore(currentLi, currentLi.nextElementSibling.nextSibling);
                                        updateWizardOrderingButtonStates(orderingListContainer);
                                    }
                                });
                                buttonContainer.appendChild(moveDownBtn);

                                listItem.appendChild(buttonContainer);
                                orderingListContainer.appendChild(listItem);
                            });
                        } else {
                            orderingListContainer.innerHTML = '<p class="text-sm text-gray-500">No hay opciones para ordenar en esta pregunta.</p>';
                        }
                        if (wizardAnswerOptions) {
                            wizardAnswerOptions.appendChild(orderingListContainer);
                            // Initial call to set button states for the newly rendered list
                            if (orderingListContainer.firstChild) { // Check if there are items
                                updateWizardOrderingButtonStates(orderingListContainer);
                            }
                        }
                        break;
                    case 'SLIDER':
                        if (!wizardAnswerOptions) break;
                        wizardAnswerOptions.innerHTML = ''; // Clear previous content

                        // Ensure essential slider configuration values are numbers
                        const minValue = parseFloat(question.slider_min_value);
                        const maxValue = parseFloat(question.slider_max_value);
                        const unit = question.slider_unit || "";

                        // Robust stepValue parsing
                        let parsedStep = parseFloat(question.slider_step);
                        let stepValue;
                        if (question.slider_step == null || isNaN(parsedStep) || parsedStep <= 0) { // Also ensure step is positive
                            stepValue = 1;
                        } else {
                            stepValue = parsedStep;
                        }

                        // Defensive check for invalid range or non-numeric configuration
                        let errorMessage = "";
                        if (isNaN(minValue)) {
                            errorMessage = "Error en la configuraci√≥n del slider: El valor m√≠nimo (min) no es num√©rico o no est√° definido.";
                        } else if (isNaN(maxValue)) {
                            errorMessage = "Error en la configuraci√≥n del slider: El valor m√°ximo (max) no es num√©rico o no est√° definido.";
                        } else if (maxValue <= minValue) {
                            errorMessage = "Error en la configuraci√≥n del slider: El valor m√°ximo debe ser mayor que el valor m√≠nimo.";
                        } else if (isNaN(stepValue)) { // Fallback, stepValue should be 1 if parsing failed
                            errorMessage = "Error en la configuraci√≥n del slider: El valor de paso (step) es inv√°lido.";
                        }

                        if (errorMessage) {
                            wizardAnswerOptions.innerHTML = `<p class="text-red-500 text-center py-4">${errorMessage}</p>`;
                            if(wizardNextBtn) wizardNextBtn.style.display = 'none';
                            if(wizardFinishBtn) wizardFinishBtn.style.display = 'none';
                            break;
                        }

                        if (!wizardAnswerOptions) break;
                        wizardAnswerOptions.innerHTML = ''; // Clear previous content

                        // Main container
                        const sliderContainer = document.createElement('div');
                        sliderContainer.className = 'custom-slider-container w-full pt-8 pb-4 relative select-none'; // Added select-none

                        // Track background
                        const trackBackground = document.createElement('div');
                        trackBackground.className = 'slider-track-background h-2 bg-gray-300 rounded-full absolute top-1/2 left-0 right-0 -translate-y-1/2';
                        sliderContainer.appendChild(trackBackground);

                        // Thumb (draggable part)
                        const thumb = document.createElement('div');
                        thumb.className = 'slider-thumb absolute top-1/2 -translate-y-1/2 flex items-stretch h-6 rounded shadow-md border border-gray-400';
                        thumb.style.cursor = 'grab';
                        thumb.id = `sliderThumb_${question.id}`;

                        const yellowZoneLeft = document.createElement('div');
                        yellowZoneLeft.className = 'slider-yellow-zone-left bg-yellow-300 border-r border-yellow-400'; // Adjusted colors
                        thumb.appendChild(yellowZoneLeft);

                        const greenZone = document.createElement('div');
                        greenZone.className = 'slider-green-zone bg-green-500 border-l border-r border-green-600';
                        thumb.appendChild(greenZone);

                        const yellowZoneRight = document.createElement('div');
                        yellowZoneRight.className = 'slider-yellow-zone-right bg-yellow-300 border-l border-yellow-400'; // Adjusted colors
                        thumb.appendChild(yellowZoneRight);
                        sliderContainer.appendChild(thumb);

                        // Value display
                        const valueDisplay = document.createElement('div');
                        valueDisplay.id = `wizardSliderValueDisplay_${question.id}`;
                        valueDisplay.className = 'slider-value-display text-center text-lg font-semibold text-gray-700 mt-3 mb-1';
                        sliderContainer.appendChild(valueDisplay);

                        // Min/Max Labels
                        const labelsContainerElement = document.createElement('div'); // Renamed to avoid conflict
                        labelsContainerElement.className = 'slider-labels flex justify-between text-xs text-gray-500';
                        const minLabel = document.createElement('span');
                        minLabel.id = `wizardSliderMinLabel_${question.id}`;
                        const maxLabel = document.createElement('span');
                        maxLabel.id = `wizardSliderMaxLabel_${question.id}`;
                        labelsContainerElement.appendChild(minLabel);
                        labelsContainerElement.appendChild(maxLabel);
                        sliderContainer.appendChild(labelsContainerElement);

                        const hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.id = `hiddenSliderValue_${question.id}`;
                        sliderContainer.appendChild(hiddenInput);

                        wizardAnswerOptions.appendChild(sliderContainer);

                        // Defer dimension calculations and initial setup
                        requestAnimationFrame(() => {
                            const minValue = parseFloat(question.slider_min_value); // Initial declaration now inside requestAnimationFrame
                            const maxValue = parseFloat(question.slider_max_value);
                            const stepValue = parseFloat(question.slider_step) > 0 ? parseFloat(question.slider_step) : 1;
                            const unit = question.slider_unit || "";
                            const thresholdPartial = parseFloat(question.slider_threshold_partial) || 0;
                            const greenZoneUnitWidth = 1;

                            // console.log("Slider Init: wizardAnswerOptions offsetWidth", wizardAnswerOptions.offsetWidth); // Debug
                            // console.log("Slider Init: sliderContainer offsetWidth", sliderContainer.offsetWidth); // Debug
                            // console.log("Slider Init: trackBackground offsetWidth before query", trackBackground.offsetWidth); // Debug
                            // console.log("Slider Init: trackBackground display style", window.getComputedStyle(trackBackground).display); // Debug
                            // const questionWizardModal = document.getElementById('questionWizardModal'); // Debug
                            // if (questionWizardModal) { // Debug
                            //     console.log("Slider Init: questionWizardModal display style", window.getComputedStyle(questionWizardModal).display); // Debug
                            //     console.log("Slider Init: questionWizardModal visibility", window.getComputedStyle(questionWizardModal).visibility); // Debug
                            //     console.log("Slider Init: questionWizardModal opacity", window.getComputedStyle(questionWizardModal).opacity); // Debug
                            // } // Debug

                            const trackWidthPx = trackBackground.offsetWidth;
                            const valueRange = maxValue - minValue;

                            if (valueRange <= 0 || trackWidthPx === 0) {
                                wizardAnswerOptions.innerHTML = '<p class="text-red-500 text-center">Error: Configuraci√≥n de slider inv√°lida o el contenedor no es visible (offsetWidth issue).</p>';
                                if(wizardNextBtn) wizardNextBtn.style.display = 'none';
                                if(wizardFinishBtn) wizardFinishBtn.style.display = 'none';
                                return;
                            }
                            const pixelsPerUnit = trackWidthPx / valueRange;

                            const greenZonePxWidth = Math.max(2, greenZoneUnitWidth * pixelsPerUnit);
                            const yellowZonePxWidth = Math.max(0, thresholdPartial * pixelsPerUnit);

                            greenZone.style.width = `${greenZonePxWidth}px`;
                            yellowZoneLeft.style.width = `${yellowZonePxWidth}px`;
                            yellowZoneRight.style.width = `${yellowZonePxWidth}px`;

                            const thumbWidthPx = greenZonePxWidth + (2 * yellowZonePxWidth);
                            thumb.style.width = `${thumbWidthPx}px`;

                            minLabel.textContent = `${minValue} ${unit}`;
                            maxLabel.textContent = `${maxValue} ${unit}`;

                            let initialValue = parseFloat(existingAnswer?.slider_answer_value ?? minValue);
                            initialValue = Math.max(minValue, Math.min(maxValue, initialValue));
                            let numDecimalPlaces = stepValue.toString().includes('.') ? (stepValue.toString().split('.')[1].length || 0) : 0;
                            initialValue = parseFloat((Math.round((initialValue - minValue) / stepValue) * stepValue + minValue).toFixed(numDecimalPlaces));

                            hiddenInput.value = initialValue;
                            valueDisplay.textContent = `${initialValue} ${unit}`;

                            const valuePointOffsetWithinThumbPx = yellowZonePxWidth + (greenZonePxWidth / 2);
                            let initialValuePointOnTrackPx = ((initialValue - minValue) / valueRange) * trackWidthPx;
                            initialValuePointOnTrackPx = Math.max(0, Math.min(initialValuePointOnTrackPx, trackWidthPx));
                            thumb.style.left = (initialValuePointOnTrackPx - valuePointOffsetWithinThumbPx) + 'px';

                            // Dragging logic (moved inside setTimeout to access calculated variables)
                            let isDragging = false;
                            let dragStartX;
                            let thumbInitialLeftPx;

                            thumb.addEventListener('pointerdown', (e) => {
                                if (e.button !== 0) return;
                                isDragging = true;
                                dragStartX = e.clientX;
                                thumbInitialLeftPx = thumb.offsetLeft;

                                thumb.setPointerCapture(e.pointerId);
                                thumb.style.cursor = 'grabbing';
                                document.body.style.userSelect = 'none';

                                document.addEventListener('pointermove', onPointerMove);
                                document.addEventListener('pointerup', onPointerUp);
                            });

                            function onPointerMove(e) {
                                if (!isDragging) return;
                                let dx = e.clientX - dragStartX;
                                let desiredThumbLeftPx = thumbInitialLeftPx + dx;

                                const valuePointOffsetWithinThumbPxLocal = parseFloat(yellowZoneLeft.style.width) + (parseFloat(greenZone.style.width) / 2);
                                let desiredValuePointOnTrackPx = desiredThumbLeftPx + valuePointOffsetWithinThumbPxLocal;
                                let clampedValuePointOnTrackPx = Math.max(0, Math.min(desiredValuePointOnTrackPx, trackWidthPx));

                                let currentValue = (clampedValuePointOnTrackPx / trackWidthPx) * valueRange + minValue;
                                currentValue = Math.max(minValue, Math.min(maxValue, currentValue));

                                let numDecimalPlacesLocal = stepValue.toString().includes('.') ? (stepValue.toString().split('.')[1].length || 0) : 0;
                                currentValue = parseFloat((Math.round((currentValue - minValue) / stepValue) * stepValue + minValue).toFixed(numDecimalPlacesLocal));
                                currentValue = Math.max(minValue, Math.min(maxValue, currentValue));

                                hiddenInput.value = currentValue;
                                valueDisplay.textContent = `${currentValue} ${unit}`;

                                let finalValuePointOnTrackPx = ((currentValue - minValue) / valueRange) * trackWidthPx;
                                finalValuePointOnTrackPx = Math.max(0, Math.min(finalValuePointOnTrackPx, trackWidthPx));
                                thumb.style.left = (finalValuePointOnTrackPx - valuePointOffsetWithinThumbPxLocal) + 'px';
                            }

                            function onPointerUp(e) {
                                if (!isDragging) return;
                                isDragging = false;
                                thumb.releasePointerCapture(e.pointerId);
                                thumb.style.cursor = 'grab';
                                document.body.style.userSelect = '';
                                document.removeEventListener('pointermove', onPointerMove);
                                document.removeEventListener('pointerup', onPointerUp);
                            }

                            // Scoring Info Display
                            const scoringInfoContainer = document.createElement('div');
                            scoringInfoContainer.className = 'slider-scoring-info mt-3 pt-3 border-t border-gray-200 text-sm text-gray-600';

                            const exactPointsP = document.createElement('p');
                            exactPointsP.className = 'mb-1';
                            exactPointsP.innerHTML = `Puntos por respuesta exacta (zona verde): <strong class="text-green-600">${question.slider_points_exact !== null ? question.slider_points_exact : 'N/A'}</strong>`;
                            scoringInfoContainer.appendChild(exactPointsP);

                            if (question.slider_points_partial !== null && question.slider_points_partial > 0 && question.slider_threshold_partial !== null) {
                                const partialPointsP = document.createElement('p');
                                // 'unit' is already defined in this requestAnimationFrame scope
                                partialPointsP.innerHTML = `Puntos por respuesta parcial (zona amarilla, +/- ${question.slider_threshold_partial} ${unit}): <strong class="text-yellow-600">${question.slider_points_partial}</strong>`;
                                scoringInfoContainer.appendChild(partialPointsP);
                            }
                            wizardAnswerOptions.appendChild(scoringInfoContainer); // Append below sliderContainer

                        }); // End of requestAnimationFrame
                        break;
                    default:
                        if (wizardAnswerOptions) wizardAnswerOptions.innerHTML = `<p class="text-red-500">Tipo de pregunta '${question.question_type}' no soportado en el wizard.</p>`;
                }
            } catch (e) {
                console.error('Error rendering question in wizard:', e, 'Question data:', question);
                if(wizardQuestionText) wizardQuestionText.textContent = 'Error de Visualizaci√≥n';
                if(wizardAnswerOptions) wizardAnswerOptions.innerHTML = '<p class="text-red-500 text-center py-4">Ocurri√≥ un error al mostrar esta pregunta. Por favor, intente avanzar a la siguiente o reinicie la quiniela.</p>';
                // Optionally hide next/finish if error is critical for this question
                // if(wizardNextBtn) wizardNextBtn.style.display = 'none';
                // if(wizardFinishBtn) wizardFinishBtn.style.display = 'none';
            }

                if(wizardPrevBtn) wizardPrevBtn.style.display = index > 0 ? 'inline-flex' : 'none';
                if(wizardNextBtn) wizardNextBtn.style.display = index < allRaceQuestions.length - 1 ? 'inline-flex' : 'none';
                if(wizardFinishBtn) wizardFinishBtn.style.display = index === allRaceQuestions.length - 1 ? 'inline-flex' : 'none';
            }

            function saveCurrentWizardAnswer() {
                if (!allRaceQuestions || currentQuestionIndex < 0 || currentQuestionIndex >= allRaceQuestions.length) {
                    return;
                }
                const question = allRaceQuestions[currentQuestionIndex];
                if (!question) return;

                switch (question.question_type) {
                    case 'FREE_TEXT':
                        const textarea = document.getElementById(`wizardFreeTextAnswer_${question.id}`);
                        if (textarea) {
                            userWizardAnswers[question.id] = { question_id: question.id, answer_text: textarea.value.trim() };
                        }
                        break;
                    case 'MULTIPLE_CHOICE':
                        if (question.is_mc_multiple_correct) {
                            const selected_option_ids = [];
                            document.querySelectorAll(`input[name="wizard_q_${question.id}"]:checked`).forEach(cb => {
                                selected_option_ids.push(parseInt(cb.value));
                            });
                            userWizardAnswers[question.id] = { question_id: question.id, selected_option_ids: selected_option_ids };
                        } else {
                            const selectedRadio = document.querySelector(`input[name="wizard_q_${question.id}"]:checked`);
                            userWizardAnswers[question.id] = {
                                question_id: question.id,
                                selected_option_id: selectedRadio ? parseInt(selectedRadio.value) : null
                            };
                        }
                        break;
                    case 'ORDERING':
                        const orderingListContainer = document.getElementById(`wizardOrderingList_${question.id}`);
                        if (orderingListContainer) {
                            const orderedOptionIds = Array.from(orderingListContainer.querySelectorAll('li[data-option-id]'))
                                                          .map(li => li.dataset.optionId);
                            userWizardAnswers[question.id] = { question_id: question.id, ordered_options_text: orderedOptionIds.join(',') };
                        }
                        break;
                    case 'SLIDER':
                        const hiddenSliderInput = document.getElementById(`hiddenSliderValue_${question.id}`);
                        if (hiddenSliderInput) {
                            const sliderValue = parseFloat(hiddenSliderInput.value);
                            if (!isNaN(sliderValue)) {
                                userWizardAnswers[question.id] = { question_id: question.id, slider_answer_value: sliderValue };
                            } else {
                                userWizardAnswers[question.id] = { question_id: question.id, slider_answer_value: null };
                                    // console.warn(`Could not parse slider value for question ${question.id}. Value was: ${hiddenSliderInput.value}`); // Mantener por si acaso
                            }
                        } else {
                                // console.error(`Hidden slider input not found for question ${question.id}`); // Mantener por si acaso
                        }
                        break;
                }
            }

            function handleNextWizardQuestion() {
                saveCurrentWizardAnswer();
                if (currentQuestionIndex < allRaceQuestions.length - 1) {
                    currentQuestionIndex++;
                    displayWizardQuestion(currentQuestionIndex);
                }
            }

            function handlePreviousWizardQuestion() {
                saveCurrentWizardAnswer();
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    displayWizardQuestion(currentQuestionIndex);
                }
            }

            // Event Listeners for Wizard
            if (answerQuestionsBtn) {
                answerQuestionsBtn.addEventListener('click', openWizard);
            }
            if (closeWizardModalBtn) {
                closeWizardModalBtn.addEventListener('click', closeWizard);
            }
            if (wizardNextBtn) {
                wizardNextBtn.addEventListener('click', handleNextWizardQuestion);
            }
            if (wizardPrevBtn) {
                wizardPrevBtn.addEventListener('click', handlePreviousWizardQuestion);
            }
            if (wizardFinishBtn) {
                wizardFinishBtn.addEventListener('click', () => {
                    saveCurrentWizardAnswer();

                    if (Object.keys(userWizardAnswers).length === 0) {
                        showNotificationModal("Sin Respuestas", "No has respondido ninguna pregunta a√∫n.", "info");
                        return;
                    }

                    wizardFinishBtn.disabled = true;
                    wizardFinishBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';

                    fetch(`/api/races/${raceId}/answers`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(userWizardAnswers)
                    })
                    .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, body: data })))
                    .then(result => {
                        if (result.ok) {
                            closeWizard();
                            showNotificationModal("√âxito", result.body.message || '¬°Respuestas guardadas con √©xito!', "success");
                            // SIN RECARGA AUTOM√ÅTICA
                        } else {
                            closeWizard();
                            showNotificationModal("Error", `Error al guardar respuestas: ${result.body.message || `Error ${result.status}`}`, "error");
                        }
                    })
                    .catch(error => {
                        console.error('Error saving answers:', error);
                        closeWizard();
                        showNotificationModal("Error de Conexi√≥n", "Error de conexi√≥n al guardar respuestas. Por favor, int√©ntalo de nuevo.", "error");
                    })
                    .finally(() => {
                        wizardFinishBtn.disabled = false;
                        wizardFinishBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Finalizar y Guardar';
                    });
                });
            }
            // console.log('DEBUG: openWizard function should now be defined. Typeof openWizard:', typeof openWizard); // Depuraci√≥n finalizada
            // --- End Question Wizard Logic ---

            // DOM Element Declarations
            const logoutButtonNav = document.getElementById('logoutButtonNav');
            showSetOfficialResultsButton(); // Call function to determine button visibility after DOM is loaded
            fetchAndDisplayOfficialResults(); // Attempt to display official results

            const participateInPoolBtn = document.getElementById('participateInPoolBtn');
            if (participateInPoolBtn) {
                participateInPoolBtn.addEventListener('click', openWizard);
            }
            // ... (rest of existing DOMContentLoaded listeners) ...

            // Initial call for LEAGUE_ADMIN if questions are already loaded (e.g. by a different mechanism or edge case)
            // This is a fallback, the primary calls are within fetchAndRenderQuestions and openWizard success paths.
            if (currentUserRole === 'LEAGUE_ADMIN' && allRaceQuestions.length > 0) {
                const adminQuestionsListContainer = document.getElementById('adminQuestionsViewContainer');
                if (adminQuestionsListContainer && !adminQuestionsListContainer.querySelector('ul')) { // Avoid re-rendering if already populated
                    // Check if adminQuestionsList is empty before rendering to avoid duplicate calls from different paths.
                    const adminList = document.getElementById('adminQuestionsList');
                    if (adminList && adminList.innerHTML.trim() === '') {
                         renderAdminQuestionsView(allRaceQuestions);
                    }
                }
            }

            // Event listener for "Edit Official Results" button
            const editOfficialResultsBtn = document.getElementById('editOfficialResultsBtn');
            if (editOfficialResultsBtn && (currentUserRole === 'ADMIN' || currentUserRole === 'LEAGUE_ADMIN')) {
                editOfficialResultsBtn.addEventListener('click', () => {
                    console.log('DEBUG: editOfficialResultsBtn clicked. Attempting to open officialResultsModal and populate form.');
                    const officialResultsModal = document.getElementById('officialResultsModal');
                    const officialResultsModalTitle = document.getElementById('officialResultsModalTitle');

                    if (officialResultsModalTitle) {
                        officialResultsModalTitle.textContent = `Editar Resultados Oficiales de Quiniela para ${raceTitle}`;
                    } else {
                        console.error('DEBUG: officialResultsModalTitle element not found');
                    }

                    populateOfficialResultsForm(); // Ensure this line is present and uncommented

                    if (officialResultsModal) {
                        officialResultsModal.style.display = 'flex';
                    } else {
                        console.error('DEBUG: officialResultsModal element not found');
                    }
                });
            }

            // Fetch Race Statistics
            if (raceId) {
                fetchAndDisplayRaceStats(raceId);
            }

            // Fetch and Display Favorite Links
            if (raceId) {
                fetchAndDisplayFavoriteLinks(raceId);
            }

        }); // Main DOMContentLoaded closing bracket

        function fetchAndDisplayFavoriteLinks(raceIdForLinks) {
            const container = document.getElementById('favoriteLinksListContainer');
            if (!container) {
                console.error('Favorite links container not found.');
                return;
            }
            container.innerHTML = '<p class="text-gray-500 text-sm">Cargando enlaces...</p>'; // Loading message

            if (!raceIdForLinks) {
                container.innerHTML = '<p class="text-red-500 text-sm">Error: ID de carrera no disponible.</p>';
                return;
            }

            fetch(`/api/races/${raceIdForLinks}/favorite_links`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(links => {
                    container.innerHTML = ''; // Clear loading message
                    if (links && links.length > 0) {
                        links.forEach(link => {
                            const linkElement = document.createElement('a');
                            linkElement.href = link.url;
                            linkElement.target = '_blank';
                            linkElement.className = 'flex items-center space-x-2 text-sm text-gray-600 hover:text-orange-500 transition-colors';

                            const iconElement = document.createElement('i');
                            iconElement.className = 'fas fa-link w-4 text-gray-400'; // Generic link icon

                            const spanElement = document.createElement('span');
                            spanElement.textContent = link.title;

                            linkElement.appendChild(iconElement);
                            linkElement.appendChild(spanElement);
                            container.appendChild(linkElement);
                        });
                    } else {
                        container.innerHTML = '<p class="text-gray-500 text-sm">No hay enlaces de inter√©s para esta carrera.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching favorite links:', error);
                    container.innerHTML = '<p class="text-red-500 text-sm">No se pudieron cargar los enlaces.</p>';
                });
        }
    </script>

    {% include '_official_answers_modal.html' %}

    <!-- Question Wizard Modal -->
    <div id="questionWizardModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 120;">
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-lg sm:max-w-xl md:max-w-2xl mx-auto">
            <!-- Modal Header -->
            <div class="flex justify-between items-center mb-6">
                <h2 id="wizardQuestionProgress" class="text-xl sm:text-2xl font-bold text-gray-800">Pregunta X de Y</h2>
                <button id="closeWizardModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <!-- Modal Body: Question Display Area -->
            <div id="wizardQuestionArea" class="mb-6">
                <h3 id="wizardQuestionText" class="text-lg sm:text-xl font-semibold text-gray-700 mb-4"></h3>
                <div id="wizardAnswerOptions" class="space-y-3">
                    <!-- Input fields will be dynamically inserted here by JavaScript -->
                    <!-- Example for Free Text (to be controlled by JS) -->
                    <!-- <textarea id="wizardFreeTextAnswer" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" rows="4" placeholder="Escribe tu respuesta..."></textarea> -->

                    <!-- Example for MC Single (to be controlled by JS) -->
                    <!-- <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded-md border border-gray-200 hover:border-orange-300">
                        <input type="radio" name="wizardMcOption" value="option1" class="text-orange-500 focus:ring-orange-400 focus:ring-offset-0">
                        <span class="text-gray-700">Option 1</span>
                    </label> -->

                    <!-- Example for MC Multiple (to be controlled by JS) -->
                    <!-- <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded-md border border-gray-200 hover:border-orange-300">
                        <input type="checkbox" name="wizardMcOption_multi" value="optionA" class="text-orange-500 focus:ring-orange-400 focus:ring-offset-0 rounded">
                        <span class="text-gray-700">Option A</span>
                    </label> -->

                    <!-- Example for Ordering (placeholder, actual implementation might differ) -->
                    <!-- <div id="wizardOrderingOptionsContainer" class="space-y-2">
                         <div class="bg-gray-100 p-2 rounded border">Item A (Drag me)</div>
                         <div class="bg-gray-100 p-2 rounded border">Item B (Drag me)</div>
                    </div> -->
                </div>
            </div>

            <!-- Modal Footer: Navigation -->
            <div class="flex justify-between items-center pt-6 border-t border-gray-200">
                <button id="wizardPrevBtn" class="btn btn-secondary">
                    <i class="fas fa-arrow-left mr-2"></i>Anterior
                </button>
                <button id="wizardNextBtn" class="btn btn-primary">
                    Siguiente<i class="fas fa-arrow-right ml-2"></i>
                </button>
                <button id="wizardFinishBtn" class="btn btn-primary bg-green-500 hover:bg-green-600" style="display: none;">
                    <i class="fas fa-check mr-2"></i>Finalizar y Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Question Modal -->
    {% if currentUserRole == 'ADMIN' or currentUserRole == 'LEAGUE_ADMIN' %}
    <div id="addEditQuestionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 100;">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-3xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="addEditQuestionModalTitle" class="text-2xl font-bold text-gray-800">A√±adir Nueva Pregunta</h2>
                <button id="closeAddEditQuestionModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <form id="addEditQuestionForm">
                <input type="hidden" id="editingQuestionId" value="">
                <div class="mb-4">
                    <label for="questionText" class="block text-sm font-medium text-gray-700 mb-1">Texto de la Pregunta</label>
                    <textarea id="questionText" name="text" rows="3" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm" placeholder="Ej: ¬øQui√©n ganar√° la carrera?"></textarea>
                </div>

                <div class="mb-4">
                    <label for="questionTypeSelect" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Pregunta</label>
                    <select id="questionTypeSelect" name="question_type" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                        <option value="FREE_TEXT">Texto Libre</option>
                        <option value="MULTIPLE_CHOICE">Opci√≥n M√∫ltiple</option>
                        <option value="ORDERING">Ordenamiento</option>
                        <option value="SLIDER">Slider</option>
                    </select>
                </div>

                <!-- Dynamic fields based on question type -->
                <div id="questionTypeSpecificFields" class="space-y-4 mb-4">
                    <!-- Fields for MULTIPLE_CHOICE -->
                    <div id="multipleChoiceFieldsContainer" style="display:none;" class="p-4 border border-gray-200 rounded-md">
                        <h4 class="font-semibold text-gray-700 mb-2">Opciones de Opci√≥n M√∫ltiple:</h4>
                        <div id="mcOptionsContainer" class="space-y-2">
                            <!-- JS will add option input fields here -->
                        </div>
                        <button type="button" id="addMcOptionBtn" class="btn btn-secondary btn-sm mt-2"><i class="fas fa-plus mr-1"></i>A√±adir Opci√≥n</button>
                        <div class="mt-3">
                             <label class="flex items-center">
                                <input type="checkbox" id="isMcMultipleCorrect" name="is_mc_multiple_correct" class="h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                                <span class="ml-2 text-sm text-gray-700">Permitir m√∫ltiples respuestas correctas</span>
                            </label>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                            <div>
                                <label for="pointsPerCorrectMc" class="block text-sm font-medium text-gray-700">Puntos por opci√≥n correcta (si m√∫ltiple)</label>
                                <input type="number" id="pointsPerCorrectMc" name="points_per_correct_mc" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: 10">
                            </div>
                            <div>
                                <label for="pointsPerIncorrectMc" class="block text-sm font-medium text-gray-700">Puntos por opci√≥n incorrecta (si m√∫ltiple)</label>
                                <input type="number" id="pointsPerIncorrectMc" name="points_per_incorrect_mc" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: -5">
                            </div>
                             <div>
                                <label for="totalScoreMcSingle" class="block text-sm font-medium text-gray-700">Puntuaci√≥n total (si √∫nica respuesta)</label>
                                <input type="number" id="totalScoreMcSingle" name="total_score_mc_single" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: 25">
                            </div>
                        </div>
                    </div>

                    <!-- Fields for ORDERING -->
                    <div id="orderingFieldsContainer" style="display:none;" class="p-4 border border-gray-200 rounded-md">
                        <h4 class="font-semibold text-gray-700 mb-2">Items para Ordenar:</h4>
                        <div id="orderingOptionsContainer" class="space-y-2">
                            <!-- JS will add item input fields here -->
                        </div>
                        <button type="button" id="addOrderingOptionBtn" class="btn btn-secondary btn-sm mt-2"><i class="fas fa-plus mr-1"></i>A√±adir Item</button>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                           <div>
                                <label for="pointsPerCorrectOrder" class="block text-sm font-medium text-gray-700">Puntos por item en posici√≥n correcta</label>
                                <input type="number" id="pointsPerCorrectOrder" name="points_per_correct_order" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: 5">
                            </div>
                            <div>
                                <label for="bonusForFullOrder" class="block text-sm font-medium text-gray-700">Bonus por orden completo correcto</label>
                                <input type="number" id="bonusForFullOrder" name="bonus_for_full_order" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: 15">
                            </div>
                        </div>
                    </div>

                    <!-- Fields for FREE_TEXT -->
                    <div id="freeTextFieldsContainer" style="display:none;" class="p-4 border border-gray-200 rounded-md">
                        <h4 class="font-semibold text-gray-700 mb-2">Configuraci√≥n de Texto Libre:</h4>
                        <div>
                            <label for="maxScoreFreeText" class="block text-sm font-medium text-gray-700">Puntuaci√≥n M√°xima</label>
                            <input type="number" id="maxScoreFreeText" name="max_score_free_text" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: 50">
                        </div>
                        <!-- Potentially add fields for keywords, case sensitivity etc. later -->
                    </div>

                    <!-- Fields for SLIDER -->
                    <div id="sliderFieldsContainer" style="display:none;" class="p-4 border border-gray-200 rounded-md space-y-3">
                        <h4 class="font-semibold text-gray-700 mb-2">Configuraci√≥n de Slider:</h4>

                        <div>
                            <label for="sliderUnitInput" class="block text-sm font-medium text-gray-700">Unidad del Slider (ej: km, min, pts)</label>
                            <input type="text" id="sliderUnitInput" name="slider_unit" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: minutos">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="sliderMinValueInput" class="block text-sm font-medium text-gray-700">Valor M√≠nimo</label>
                                <input type="number" id="sliderMinValueInput" name="slider_min_value" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: 0">
                            </div>
                            <div>
                                <label for="sliderMaxValueInput" class="block text-sm font-medium text-gray-700">Valor M√°ximo</label>
                                <input type="number" id="sliderMaxValueInput" name="slider_max_value" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: 100">
                            </div>
                            <div>
                                <label for="sliderStepInput" class="block text-sm font-medium text-gray-700">Paso (Step)</label>
                                <input type="number" id="sliderStepInput" name="slider_step" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: 1">
                            </div>
                        </div>

                        <div>
                            <label for="sliderPointsExactInput" class="block text-sm font-medium text-gray-700">Puntos por Respuesta Exacta</label>
                            <input type="number" id="sliderPointsExactInput" name="slider_points_exact" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: 50">
                        </div>

                        <h5 class="font-medium text-gray-700 pt-2 border-t border-gray-200">Puntuaci√≥n Parcial (Opcional):</h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="sliderThresholdPartialInput" class="block text-sm font-medium text-gray-700">Umbral para Puntuaci√≥n Parcial (+/-)</label>
                                <input type="number" id="sliderThresholdPartialInput" name="slider_threshold_partial" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: 5 (si la respuesta est√° a +/- 5 de la correcta)">
                            </div>
                            <div>
                                <label for="sliderPointsPartialInput" class="block text-sm font-medium text-gray-700">Puntos Parciales</label>
                                <input type="number" id="sliderPointsPartialInput" name="slider_points_partial" class="mt-1 block w-full py-2 px-3 border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Ej: 20">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancelAddEditQuestionBtn" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" id="saveQuestionBtn" class="btn btn-primary">Guardar Pregunta</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Question Confirmation Modal -->
    <div id="deleteQuestionConfirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 105;">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Confirmar Eliminaci√≥n</h2>
            <p class="text-gray-600 mb-6">¬øEst√°s seguro de que quieres eliminar esta pregunta? Esta acci√≥n no se puede deshacer.</p>
            <input type="hidden" id="questionIdToDelete" value="">
            <div class="flex justify-end space-x-3">
                <button type="button" id="cancelDeleteQuestionBtn" class="btn btn-secondary">Cancelar</button>
                <button type="button" id="confirmDeleteQuestionBtn" class="btn btn-danger bg-red-600 hover:bg-red-700 text-white">Eliminar</button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Edit Answer Modal -->
    <div id="editAnswerModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 130;"> <!-- Higher z-index -->
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-lg sm:max-w-xl md:max-w-2xl mx-auto">
            <!-- Modal Header -->
            <div class="flex justify-between items-center mb-6">
                <h2 id="editAnswerModalTitle" class="text-xl sm:text-2xl font-bold text-gray-800">Editar Respuesta</h2>
                <button id="closeEditAnswerModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <!-- Modal Body: Edit Area -->
            <input type="hidden" id="editingQuestionIdStore" value="">
            <input type="hidden" id="editingUserAnswerIdStore" value="">

            <div id="editAnswerQuestionText" class="text-lg font-semibold text-gray-700 mb-4"></div>
            <div id="editAnswerOptionsArea" class="space-y-3 mb-6">
                <!-- Input fields will be dynamically inserted here -->
                <div id="editAnswerLoading" style="display: none;" class="text-center py-4">Cargando pregunta... <i class="fas fa-spinner fa-spin"></i></div>
                <div id="editAnswerError" style="display: none;" class="text-red-500 py-4"></div>
            </div>

            <!-- Modal Footer -->
            <div class="flex justify-end items-center pt-6 border-t border-gray-200 space-x-3">
                <button id="cancelEditAnswerBtn" class="btn btn-secondary">Cancelar</button>
                <button id="saveEditedAnswerBtn" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Review User Answers Modal -->
    <div id="reviewUserAnswersModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 120;">
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-lg sm:max-w-xl md:max-w-2xl mx-auto">
            <!-- Modal Header -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Mis Respuestas de la Quiniela</h2>
                <button id="closeReviewUserAnswersModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <!-- Modal Body: Answers Display Area -->
            <div id="reviewUserAnswersContentWrapper" class="space-y-4 max-h-96 overflow-y-auto mb-6">
                 <div id="reviewAnswersLoading" style="display: none;" class="text-center py-4">Cargando respuestas... <i class="fas fa-spinner fa-spin"></i></div>
                 <div id="reviewAnswersError" style="display: none;" class="text-red-500 py-4 text-center"></div>
                 <div id="reviewUserAnswersDisplayArea" class="space-y-3"> <!-- Added space-y-3 for spacing between answers -->
                    <!-- Answers will be dynamically inserted here -->
                 </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex justify-end items-center pt-6 border-t border-gray-200">
                <button id="saveAllReviewedAnswersBtn" class="btn btn-primary"> <!-- ID and Text Updated -->
                    Guardar Todos los Cambios
                </button>
            </div>
        </div>
    </div>

    <!-- Participant Answers Modal -->
    <div id="participantAnswersModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center hidden" style="z-index: 140;">
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-lg sm:max-w-xl md:max-w-2xl mx-auto">
            <!-- Modal Header -->
            <div class="flex justify-between items-center mb-6 pb-3 border-b border-gray-200">
                <h2 id="participantAnswersModalTitle" class="text-xl sm:text-2xl font-bold text-gray-800">Respuestas del Participante</h2>
                <button id="closeParticipantAnswersModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <!-- Modal Body: Answers Display Area -->
            <div id="participantAnswersModalBody" class="space-y-4 max-h-96 overflow-y-auto mb-6">
                 <p>Cargando respuestas...</p>
                 <!-- Answers will be dynamically inserted here by JavaScript -->
            </div>

            <!-- Modal Footer -->
            <div class="flex justify-end items-center pt-6 border-t border-gray-200">
                <button id="closeParticipantAnswersModalFooterBtn" class="btn btn-secondary">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
    <script src="{{ url_for('static', filename='js/admin_official_answers.js') }}"></script>

    <script>
document.addEventListener('DOMContentLoaded', function() {
    const favoriteIcon = document.getElementById('favoriteRaceIcon');

    if (favoriteIcon) {
        favoriteIcon.addEventListener('click', function() {
            const raceId = this.dataset.raceId;
            // Check for 'fas' and 'fa-heart' to be sure it's the favorited state,
            // not potentially a spinner state that also uses 'fas'.
            const isCurrentlyFavorite = this.classList.contains('fas') && this.classList.contains('fa-heart');

            const method = isCurrentlyFavorite ? 'DELETE' : 'POST';
            const url = `/api/races/${raceId}/favorite`;

            // Store original classes to revert on error, carefully
            const originalClasses = Array.from(this.classList);

            // Add loading state to icon
            this.classList.remove('fas', 'far', 'fa-heart', 'text-red-500', 'text-white', 'opacity-80', 'hover:opacity-100');
            this.classList.add('fas', 'fa-spinner', 'fa-spin', 'text-gray-400'); // Using gray for spinner for visibility on potentially varied backgrounds

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    // Add X-CSRFToken header here if required by your Flask setup for POST/DELETE
                    // 'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}'
                }
            })
            .then(response => {
                // Remove loading state first
                this.classList.remove('fas', 'fa-spinner', 'fa-spin', 'text-gray-400');
                this.classList.add('fa-heart'); // Re-add fa-heart, common to both states

                if (response.ok) {
                    return response.json();
                } else {
                    return response.json().then(errData => {
                        throw new Error(errData.message || `Error ${response.status}`);
                    }).catch(() => {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    });
                }
            })
            .then(data => {
                console.log(data.message); // Log success message
                if (isCurrentlyFavorite) {
                    // Was favorite, now unfavorited: far fa-heart text-white opacity-80 hover:opacity-100
                    this.classList.remove('fas', 'text-red-500'); // remove 'fas' and its color
                    this.classList.add('far', 'text-white', 'opacity-80', 'hover:opacity-100'); // add 'far' and its styles
                } else {
                    // Was not favorite, now favorited: fas fa-heart text-red-500
                    this.classList.remove('far', 'text-white', 'opacity-80', 'hover:opacity-100'); // remove 'far' and its styles
                    this.classList.add('fas', 'text-red-500'); // add 'fas' and its color
                }
            })
            .catch(error => {
                console.error('Favorite toggle error:', error);
                alert('Error updating favorite status: ' + error.message);

                // Remove spinner classes and fa-heart (if it was removed) before restoring original
                this.classList.remove('fas', 'fa-spinner', 'fa-spin', 'text-gray-400', 'fa-heart');
                // Restore original classes
                originalClasses.forEach(cls => this.classList.add(cls));
            });
        });
    }
});
    </script>

    <!-- Favorite Links Management Modal -->
    {% if currentUserRole == 'ADMIN' or currentUserRole == 'LEAGUE_ADMIN' %}
    <div id="favoriteLinksModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 150;">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl mx-auto">
            <div class="flex justify-between items-center mb-6 pb-3 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800">Gestionar Enlaces de Inter√©s</h2>
                <button id="closeFavoriteLinksModalHeaderBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <!-- Section to list and reorder existing links -->
            <div class="mb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Enlaces Existentes</h3>
                <div id="existingFavoriteLinksList" class="space-y-3 max-h-60 overflow-y-auto border border-gray-200 p-3 rounded-md bg-gray-50">
                    <!-- JS will populate this list. Example item structure:
                    <div class="flex items-center justify-between p-2 border rounded bg-white shadow-sm" data-link-id="1">
                        <span class="link-title">Reglamento</span> - <a href="url" target="_blank" class="link-url text-blue-500 hover:underline text-sm">url</a> (Orden: <span class="link-order">0</span>)
                        <div>
                            <button class="edit-link-btn btn btn-xs btn-secondary py-1 px-2"><i class="fas fa-edit"></i></button>
                            <button class="delete-link-btn btn btn-xs btn-danger py-1 px-2"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                     -->
                     <p class="text-gray-500">Cargando enlaces existentes...</p>
                </div>
                 <p class="text-xs text-gray-500 mt-2">Puedes arrastrar y soltar los enlaces para reordenarlos.</p>
            </div>

            <!-- Form to add a new link -->
            <div class="mb-6 pt-4 border-t border-gray-200">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">A√±adir Nuevo Enlace</h3>
                <form id="addFavoriteLinkForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="newLinkTitle" class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo</label>
                            <input type="text" id="newLinkTitle" name="title" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm" placeholder="Ej: Reglamento Oficial">
                        </div>
                        <div>
                            <label for="newLinkUrl" class="block text-sm font-medium text-gray-700 mb-1">URL</label>
                            <input type="url" id="newLinkUrl" name="url" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm" placeholder="https://ejemplo.com/documento.pdf">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="newLinkOrder" class="block text-sm font-medium text-gray-700 mb-1">Orden (opcional)</label>
                        <input type="number" id="newLinkOrder" name="order" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm" placeholder="Ej: 0 (menor primero)">
                         <p class="text-xs text-gray-500 mt-1">Si se deja vac√≠o, se a√±adir√° al final.</p>
                    </div>
                    <div class="mt-4 text-right">
                        <button type="button" id="addNewFavoriteLinkBtn" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>A√±adir Enlace</button>
                    </div>
                </form>
            </div>

            <!-- Form to edit an existing link (hidden by default) -->
            <div id="editFavoriteLinkFormContainer" class="mb-6 pt-4 border-t border-gray-200" style="display:none;">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Editar Enlace</h3>
                <input type="hidden" id="editingFavoriteLinkId" value="">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editLinkTitle" class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo</label>
                        <input type="text" id="editLinkTitle" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="editLinkUrl" class="block text-sm font-medium text-gray-700 mb-1">URL</label>
                        <input type="url" id="editLinkUrl" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                    </div>
                </div>
                <div class="mt-4">
                    <label for="editLinkOrder" class="block text-sm font-medium text-gray-700 mb-1">Orden</label>
                    <input type="number" id="editLinkOrder" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                </div>
                <div class="mt-4 text-right space-x-2">
                    <button type="button" id="cancelEditFavoriteLinkBtn" class="btn btn-secondary">Cancelar Edici√≥n</button>
                    <button type="button" id="saveEditedFavoriteLinkBtn" class="btn btn-primary"><i class="fas fa-save mr-2"></i>Guardar Cambios Enlace</button>
                </div>
            </div>


            <!-- Modal Action Buttons -->
            <div class="flex justify-end items-center pt-6 border-t border-gray-200 space-x-3">
                <button id="closeFavoriteLinksModalBtn" class="btn btn-secondary">Cerrar</button>
                <button id="saveFavoriteLinksOrderBtn" class="btn btn-primary"><i class="fas fa-save mr-2"></i>Guardar Orden</button>
            </div>
        </div>
    </div>
    {% endif %}

    <script src="{{ url_for('static', filename='js/favorite_links_admin.js') }}"></script>

    <!-- Confirm Delete Race Modal -->
    <div id="confirmDeleteRaceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 105;">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto">
            <h2 id="confirmDeleteRaceModalTitle" class="text-xl font-bold text-gray-800 mb-4">Confirmar Eliminaci√≥n</h2>
            <p id="confirmDeleteRaceModalMessage" class="text-gray-600 mb-6">¬øEst√°s seguro de que quieres eliminar esta carrera? Esta acci√≥n no se puede deshacer y eliminar√° todos los datos asociados.</p>
            <div class="flex justify-end space-x-3">
                <button type="button" id="cancelDeleteRaceBtnModal" class="btn btn-secondary">Cancelar</button>
                <button type="button" id="confirmDeleteRaceActionBtn" class="btn btn-danger bg-red-600 hover:bg-red-700 text-white">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Simple Notification Modal -->
    <div id="notificationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 160;">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 id="notificationModalTitle" class="text-xl font-bold">Notificaci√≥n</h2>
                <button id="closeNotificationModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <p id="notificationModalMessage" class="text-gray-600 mb-6">Mensaje aqu√≠.</p>
            <div class="flex justify-end space-x-3">
                <button type="button" id="acceptNotificationModalBtn" class="btn btn-primary">Aceptar</button>
            </div>
        </div>
    </div>
</body>
</html>
