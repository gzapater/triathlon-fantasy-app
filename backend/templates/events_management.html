{% extends "base.html" %}

{% block title %}Gestión de Eventos - {{ super() }}{% endblock %}

{% block head_extra %}
    {# base.html ya incluye FontAwesome y los estilos principales.
       Añadimos estilos específicos para esta página si son necesarios. #}
    <style>
        /* Estilos para filtros y tabla de gestión de eventos */
        .filter-dropdown {
            max-height: 20rem; /* Aumentado para más opciones */
            overflow-y: auto;
            border-top-width: 0; /* Evitar doble borde con el botón */
        }
        .table-header-custom th { /* Aplicar a los th dentro de un thead con esta clase */
            background-color: var(--orange-primary);
            color: white;
            font-weight: 600; /*semibold*/
        }
        .no-print { /* Para ocultar elementos al imprimir */
            @media print {
                display: none !important;
            }
        }
    </style>
{% endblock %}

{% block hero %}
    {# Usamos el _hero_section.html que ahora está en base.html #}
    {% set hero_title = "Gestión de Eventos TriCal" %}
    {% set hero_subtitle = "Administra, filtra y crea nuevos eventos del calendario." %}
    {% include '_hero_section.html' %}
{% endblock hero %}


{% block content %}
<div class="px-4 sm:px-6 lg:px-8 py-8"> {# Ajustado padding para consistencia #}

    {# Contenedor para mensajes Flash (si se usa un sistema JS de mensajes) #}
    <div id="flash-messages-container-events" class="mb-4"></div>

    <!-- Filters Section -->
    <section class="bg-white shadow-xl rounded-lg p-6 mb-8 no-print">
        <h2 class="text-xl font-bold text-gray-dark brand-font mb-4">Filtrar Eventos</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 items-end">
            <div>
                <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-1">Búsqueda:</label>
                <input type="text" id="searchInput" placeholder="Nombre, ciudad..."
                       class="input-field w-full bg-white h-10">
            </div>
            <div>
                <label for="disciplineFilterBtn" class="block text-sm font-medium text-gray-700 mb-1">Disciplina:</label>
                <div class="relative">
                    <button id="disciplineFilterBtn" type="button" class="select-field-custom bg-white w-full h-10 text-left flex items-center justify-between">
                        <span class="truncate">Todas</span> <i class="fas fa-chevron-down ml-2 text-gray-500"></i>
                    </button>
                    <div id="disciplineFilterDropdown" class="hidden absolute z-20 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg filter-dropdown"></div>
                </div>
            </div>
            <div>
                <label for="distanceFilterBtn" class="block text-sm font-medium text-gray-700 mb-1">Distancia:</label>
                <div class="relative">
                    <button id="distanceFilterBtn" type="button" class="select-field-custom bg-white w-full h-10 text-left flex items-center justify-between">
                        <span class="truncate">Todas</span> <i class="fas fa-chevron-down ml-2 text-gray-500"></i>
                    </button>
                    <div id="distanceFilterDropdown" class="hidden absolute z-20 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg filter-dropdown"></div>
                </div>
            </div>
            <div>
                <label for="provinceFilterBtn" class="block text-sm font-medium text-gray-700 mb-1">Provincia:</label>
                <div class="relative">
                    <button id="provinceFilterBtn" type="button" class="select-field-custom bg-white w-full h-10 text-left flex items-center justify-between">
                        <span class="truncate">Todas</span> <i class="fas fa-chevron-down ml-2 text-gray-500"></i>
                    </button>
                    <div id="provinceFilterDropdown" class="hidden absolute z-20 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg filter-dropdown"></div>
                </div>
            </div>
            <div>
                <label for="monthFilterBtn" class="block text-sm font-medium text-gray-700 mb-1">Mes:</label>
                <div class="relative">
                    <button id="monthFilterBtn" type="button" class="select-field-custom bg-white w-full h-10 text-left flex items-center justify-between">
                        <span class="truncate">Todos</span> <i class="fas fa-chevron-down ml-2 text-gray-500"></i>
                    </button>
                    <div id="monthFilterDropdown" class="hidden absolute z-20 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg filter-dropdown"></div>
                </div>
            </div>
        </div>
        <div class="mt-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Etiquetas:</label>
            <div id="tagFiltersContainer" class="flex flex-wrap gap-2"></div>
        </div>
        <div class="flex flex-wrap items-center justify-between mt-6 gap-4">
            <div class="flex flex-wrap gap-2">
                <button id="clearFilters" class="btn btn-secondary btn-sm"><i class="fas fa-times mr-1"></i> Limpiar Filtros</button>
                {# El botón de ordenar por fecha general se elimina, se usa el de la cabecera de tabla #}
            </div>
            <div class="text-sm text-gray-600">
                Mostrando <span id="visibleCount" class="font-semibold">0</span> de <span id="totalCount" class="font-semibold">0</span> eventos
            </div>
        </div>
    </section>

    <!-- Tabla de Eventos -->
    <div class="bg-white shadow-xl rounded-lg overflow-hidden">
        <div class="flex flex-wrap justify-between items-center p-6 border-b border-gray-200 gap-4">
            <h2 class="text-2xl font-bold text-gray-dark brand-font">Eventos Existentes</h2>
            <button id="open-create-event-modal-btn" class="btn btn-primary btn-sm">
                <i class="fas fa-plus mr-2"></i> Crear Nuevo Evento
            </button>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full table-hover">
                <thead class="table-header-custom">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Nombre del Evento</th>
                        <th id="table-header-fecha" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider cursor-pointer hover:bg-orange-dark transition-colors">
                            Fecha <span id="sort-indicator-fecha" class="ml-1"></span>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Localización</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Disciplina</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Distancia</th>
                        <th class="px-6 py-3 text-right text-xs font-semibold uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody id="events-table-body" class="bg-white divide-y divide-gray-200">
                    {# Filas cargadas por JS #}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal para Crear/Editar Evento -->
<div id="create-event-modal" class="fixed inset-0 modal-backdrop hidden z-[1050] flex items-center justify-center p-4">
    <div class="relative bg-white rounded-xl shadow-2xl p-6 md:p-8 m-4 max-w-2xl max-h-[90vh] overflow-y-auto w-full transform transition-all">
        <div class="flex justify-between items-center pb-4 border-b border-gray-200">
            <h3 id="create-event-modal-title" class="text-2xl font-bold text-orange-primary brand-font">Crear Nuevo Evento</h3>
            <button id="close-create-event-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors"><i class="fas fa-times text-2xl"></i></button>
        </div>
        <form id="create-event-form" class="mt-6 space-y-5">
            <input type="hidden" name="event_id_hidden" id="event_id_hidden">
            <div>
                <label for="event_name" class="block text-sm font-medium text-gray-700 mb-1">Nombre Evento <span class="text-red-500">*</span></label>
                <input type="text" name="name" id="event_name" required class="input-field w-full bg-white">
            </div>
            <div>
                <label for="event_date" class="block text-sm font-medium text-gray-700 mb-1">Fecha Evento <span class="text-red-500">*</span></label>
                <input type="date" name="event_date" id="event_date" required class="input-field w-full bg-white">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div>
                    <label for="event_city" class="block text-sm font-medium text-gray-700 mb-1">Ciudad</label>
                    <input type="text" name="city" id="event_city" class="input-field w-full bg-white">
                </div>
                <div>
                    <label for="event_province" class="block text-sm font-medium text-gray-700 mb-1">Provincia</label>
                    <input type="text" name="province" id="event_province" class="input-field w-full bg-white">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div>
                    <label for="event_discipline" class="block text-sm font-medium text-gray-700 mb-1">Disciplina</label>
                    <input type="text" name="discipline" id="event_discipline" class="input-field w-full bg-white">
                </div>
                <div>
                    <label for="event_distance" class="block text-sm font-medium text-gray-700 mb-1">Distancia</label>
                    <input type="text" name="distance" id="event_distance" class="input-field w-full bg-white">
                </div>
            </div>
            <div>
                <label for="event_source_url" class="block text-sm font-medium text-gray-700 mb-1">URL de Origen</label>
                <input type="url" name="source_url" id="event_source_url" placeholder="https://example.com" class="input-field w-full bg-white">
            </div>
            <fieldset class="space-y-3 border border-gray-200 p-4 rounded-md">
                <legend class="text-sm font-medium text-gray-dark px-1">Etiquetas de Curación:</legend>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                    {% for key, tag_info in tag_properties_for_template.items() %}
                    <div class="relative flex items-start">
                        <div class="flex items-center h-5">
                            <input id="event_{{ key }}" name="{{ key }}" type="checkbox" class="focus:ring-orange-primary h-4 w-4 text-orange-primary border-gray-300 rounded">
                        </div>
                        <div class="ml-3 text-sm">
                            <label for="event_{{ key }}" class="font-medium text-gray-700">{{ tag_info.text }}</label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </fieldset>
            <div class="pt-6 border-t border-gray-200 flex items-center justify-end space-x-3">
                <button id="cancel-create-event-btn" type="button" class="btn btn-secondary">Cancelar</button>
                <button id="save-event-btn" type="submit" class="btn btn-primary">Guardar Evento</button> {# Cambiado <a> a <button type="submit"> #}
            </div>
        </form>
    </div>
</div>
{% endblock content %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const eventsTableBody = document.getElementById('events-table-body');
    const apiBaseUrl = "{{ url_for('api_events_list') }}"; // Asegurar que esta ruta exista para GET/POST
    const eventApiUrl = (id) => `{{ url_for('api_event_detail', event_id=0) }}`.replace('0', id); // Para PUT/DELETE

    const createEventModal = document.getElementById('create-event-modal');
    const openCreateEventModalBtn = document.getElementById('open-create-event-modal-btn');
    const closeCreateEventModalBtn = document.getElementById('close-create-event-modal-btn');
    const cancelCreateEventBtn = document.getElementById('cancel-create-event-btn');
    const createEventForm = document.getElementById('create-event-form');
    const saveEventBtn = document.getElementById('save-event-btn'); // Este es el botón de submit ahora
    const modalTitleElement = document.getElementById('create-event-modal-title');
    const eventIdHiddenInput = document.getElementById('event_id_hidden');

    let allEvents = [];
    let currentSortAscending = true; // For table header date sort (default: oldest first)

    const searchInput = document.getElementById('searchInput');
    const tableHeaderFecha = document.getElementById('table-header-fecha');
    const sortIndicatorFecha = document.getElementById('sort-indicator-fecha');

    const filterButtonIds = ['disciplineFilterBtn', 'distanceFilterBtn', 'provinceFilterBtn', 'monthFilterBtn'];
    const filterDropdownIds = ['disciplineFilterDropdown', 'distanceFilterDropdown', 'provinceFilterDropdown', 'monthFilterDropdown'];
    const filterDataKeys = ['discipline', 'distance', 'province', 'month'];
    const filterButtons = {};
    const filterDropdowns = {};
    filterButtonIds.forEach((btnId, index) => {
        filterButtons[filterDataKeys[index]] = document.getElementById(btnId);
        filterDropdowns[filterDataKeys[index]] = document.getElementById(filterDropdownIds[index]);
    });

    const tagFiltersContainer = document.getElementById('tagFiltersContainer');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const visibleCountDisplay = document.getElementById('visibleCount');
    const totalCountDisplay = document.getElementById('totalCount');

    const TAG_PROPERTIES = {{ tag_properties_for_template | tojson | safe }};

    // --- Flash Message System (similar to admin_sugerencias.html) ---
    function showAppFlashMessage(message, category, containerId = 'flash-messages-container-events') {
        const flashContainer = document.getElementById(containerId);
        if (!flashContainer) {
            console.error('Flash message container not found:', containerId);
            alert(`${category.toUpperCase()}: ${message}`); return;
        }
        // ... (implementación de showAppFlashMessage como en admin_sugerencias.html, usando FontAwesome y Tailwind)
        // For brevity, not repeating the full function here. Assume it's similar.
        // Ensure it creates icons, uses correct colors from main_theme.css variables or Tailwind classes.
        const alertDiv = document.createElement('div');
        let bgColor, textColor, borderColor, iconHtml;
        switch (category) {
            case 'success': bgColor = 'bg-green-100'; textColor = 'text-green-700'; borderColor = 'border-green-400'; iconHtml = '<i class="fas fa-check-circle mr-2"></i>'; break;
            case 'error': bgColor = 'bg-red-100'; textColor = 'text-red-700'; borderColor = 'border-red-400'; iconHtml = '<i class="fas fa-exclamation-triangle mr-2"></i>'; break;
            default: bgColor = 'bg-blue-100'; textColor = 'text-blue-700'; borderColor = 'border-blue-400'; iconHtml = '<i class="fas fa-info-circle mr-2"></i>'; break;
        }
        alertDiv.className = `${bgColor} ${textColor} border-l-4 ${borderColor} p-4 mb-4 rounded-md shadow-sm flex items-center`;
        alertDiv.innerHTML = `${iconHtml}<span>${message}</span><button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-transparent ${textColor} rounded-lg focus:ring-2 focus:ring-opacity-50 p-1.5 hover:bg-opacity-20 inline-flex h-8 w-8" onclick="this.parentElement.remove();"><span class="sr-only">Cerrar</span><i class="fas fa-times"></i></button>`;
        while (flashContainer.firstChild) { flashContainer.removeChild(flashContainer.firstChild); }
        flashContainer.appendChild(alertDiv);
        setTimeout(() => { if (alertDiv.parentElement) { alertDiv.remove(); } }, 7000);
    }


    // --- Filter Logic (adaptada de TriCal.html y el script original) ---
    function populateTagFilterButtons() { /* ... (igual que original, usando TAG_PROPERTIES) ... */
        if (!tagFiltersContainer || !TAG_PROPERTIES) return;
        tagFiltersContainer.innerHTML = '';
        for (const key in TAG_PROPERTIES) {
            const tagInfo = TAG_PROPERTIES[key];
            const button = document.createElement('button');
            button.id = `filter-${key}`;
            button.dataset.tagKey = key;
            button.className = `btn btn-sm ${tagInfo.filterColor || 'btn-outline-secondary'} transition-all duration-200`; // Usar clases btn
            button.innerHTML = `<i class="${tagInfo.icon} mr-1.5"></i> ${tagInfo.text}`;
            button.setAttribute('aria-pressed', 'false');
            button.dataset.active = "false";
            button.addEventListener('click', () => {
                const isActive = button.dataset.active === "true";
                button.dataset.active = isActive ? "false" : "true";
                button.setAttribute('aria-pressed', !isActive);
                button.classList.toggle(tagInfo.filterActiveColor || 'btn-primary', !isActive);
                button.classList.toggle(tagInfo.filterColor || 'btn-outline-secondary', isActive);
                filterAndSortEvents();
            });
            tagFiltersContainer.appendChild(button);
        }
    }

    function populateFilterOptions(events) { /* ... (igual que original) ... */
        const disciplines = new Set(); const distances = new Set(); const provinces = new Set();
        events.forEach(event => {
            if (event.discipline) disciplines.add(event.discipline);
            if (event.distance) distances.add(event.distance);
            if (event.province) provinces.add(event.province);
        });
        function createCheckboxItem(filterKey, value, text) { /* ... (igual) ... */
            const itemDiv = document.createElement('div'); itemDiv.className = 'px-3 py-2 hover:bg-gray-50 cursor-pointer';
            const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.id = `filter-${filterKey}-${value.replace(/\s+/g, '-')}`; checkbox.name = filterKey; checkbox.value = value;
            checkbox.className = 'form-checkbox h-4 w-4 text-orange-primary focus:ring-orange-light border-gray-300 rounded mr-2';
            checkbox.addEventListener('change', () => { updateFilterButtonText(filterKey); filterAndSortEvents(); });
            const label = document.createElement('label'); label.htmlFor = checkbox.id; label.textContent = text; label.className = 'text-sm text-gray-700 select-none cursor-pointer';
            itemDiv.appendChild(checkbox); itemDiv.appendChild(label);
            itemDiv.addEventListener('click', (e) => { if (e.target !== checkbox) checkbox.click(); });
            return itemDiv;
        }
        function updateFilterButtonText(filterKey) { /* ... (igual) ... */
            const dropdown = filterDropdowns[filterKey]; const button = filterButtons[filterKey]; if (!dropdown || !button) return;
            const selectedCheckboxes = Array.from(dropdown.querySelectorAll('input[type="checkbox"]:checked'));
            const buttonTextSpan = button.querySelector('span');
            if (selectedCheckboxes.length === 0) { buttonTextSpan.textContent = (filterKey === 'month' ? 'Todos' : 'Todas'); }
            else if (selectedCheckboxes.length === 1) { buttonTextSpan.textContent = selectedCheckboxes[0].parentElement.querySelector('label').textContent; }
            else {
                let baseName = '';
                if (filterKey === 'discipline') baseName = 'Disciplinas'; else if (filterKey === 'distance') baseName = 'Distancias';
                else if (filterKey === 'province') baseName = 'Provincias'; else if (filterKey === 'month') baseName = 'Meses';
                buttonTextSpan.textContent = `${baseName} (${selectedCheckboxes.length})`;
            }
        }
        ['discipline', 'distance', 'province'].forEach(key => { /* ... (igual) ... */
            const dropdownElement = filterDropdowns[key]; if (!dropdownElement) return; dropdownElement.innerHTML = '';
            let currentSet;
            if (key === 'discipline') currentSet = disciplines; else if (key === 'distance') currentSet = distances; else if (key === 'province') currentSet = provinces;
            Array.from(currentSet).sort().forEach(value => { dropdownElement.appendChild(createCheckboxItem(key, value, value)); });
            updateFilterButtonText(key);
        });
        const monthDropdown = filterDropdowns['month']; /* ... (igual) ... */
        if (monthDropdown) {
            monthDropdown.innerHTML = ''; const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            monthNames.forEach((name, index) => { monthDropdown.appendChild(createCheckboxItem('month', (index + 1).toString(), name)); });
            updateFilterButtonText('month');
        }
    }
    function filterAndSortEvents() { /* ... (igual que original, pero usa currentSortAscending para la fecha) ... */
        let filteredEvents = [...allEvents];
        const searchTerm = searchInput.value.toLowerCase().trim();
        const selectedDisciplines = Array.from(filterDropdowns['discipline'].querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        const selectedDistances = Array.from(filterDropdowns['distance'].querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        const selectedProvinces = Array.from(filterDropdowns['province'].querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        const selectedMonths = Array.from(filterDropdowns['month'].querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        const activeTagFilters = {};
        if (tagFiltersContainer) { tagFiltersContainer.querySelectorAll('button').forEach(btn => { if (btn.dataset.active === "true") activeTagFilters[btn.dataset.tagKey] = true; });}

        if (searchTerm) { filteredEvents = filteredEvents.filter(event => (event.name && event.name.toLowerCase().includes(searchTerm)) || (event.city && event.city.toLowerCase().includes(searchTerm)) || (event.province && event.province.toLowerCase().includes(searchTerm)) || (event.discipline && event.discipline.toLowerCase().includes(searchTerm)) || (event.distance && event.distance.toLowerCase().includes(searchTerm))); }
        if (selectedDisciplines.length > 0) { filteredEvents = filteredEvents.filter(event => selectedDisciplines.includes(event.discipline)); }
        if (selectedDistances.length > 0) { filteredEvents = filteredEvents.filter(event => selectedDistances.includes(event.distance)); }
        if (selectedProvinces.length > 0) { filteredEvents = filteredEvents.filter(event => selectedProvinces.includes(event.province)); }
        if (selectedMonths.length > 0) { filteredEvents = filteredEvents.filter(event => { if (!event.event_date) return false; const event_date_obj = new Date(event.event_date + 'T00:00:00Z'); const event_month = (event_date_obj.getUTCMonth() + 1).toString(); return selectedMonths.includes(event_month); }); }
        const activeTagKeys = Object.keys(activeTagFilters);
        if (activeTagKeys.length > 0) { filteredEvents = filteredEvents.filter(event => activeTagKeys.every(tagKey => event[tagKey] === true || event[tagKey] === 1 || String(event[tagKey]).toLowerCase() === 'true'));}

        filteredEvents.sort((a, b) => {
            const dateA = a.event_date ? new Date(a.event_date + 'T00:00:00Z') : null; const dateB = b.event_date ? new Date(b.event_date + 'T00:00:00Z') : null;
            if (!dateA && !dateB) return 0; if (!dateA) return 1; if (!dateB) return -1;
            return currentSortAscending ? dateA - dateB : dateB - dateA; // Usa currentSortAscending
        });
        renderEventsTable(filteredEvents);
        if (visibleCountDisplay) visibleCountDisplay.textContent = filteredEvents.length;
        updateFechaSortIndicator();
    }

    function updateFechaSortIndicator() { /* ... (igual) ... */
        if (sortIndicatorFecha) { sortIndicatorFecha.innerHTML = currentSortAscending ? '<i class="fas fa-arrow-down"></i>' : '<i class="fas fa-arrow-up"></i>'; }
    }
    let openDropdown = null; /* ... (lógica de custom dropdown igual) ... */
    function toggleDropdown(filterKey) { const dropdown = filterDropdowns[filterKey]; if (!dropdown) return; if (openDropdown && openDropdown !== dropdown) { openDropdown.classList.add('hidden'); } dropdown.classList.toggle('hidden'); openDropdown = dropdown.classList.contains('hidden') ? null : dropdown; }
    filterDataKeys.forEach(key => { if (filterButtons[key]) { filterButtons[key].addEventListener('click', (event) => { event.stopPropagation(); toggleDropdown(key); }); } });
    document.addEventListener('click', (event) => { if (openDropdown && !openDropdown.contains(event.target) && !Array.from(Object.values(filterButtons)).some(btn => btn.contains(event.target))) { openDropdown.classList.add('hidden'); openDropdown = null; } });


    // --- Modal de Crear/Editar Evento ---
    function openModalForCreate() { /* ... (igual, pero usa showAppFlashMessage) ... */
        if (!createEventModal || !createEventForm || !eventIdHiddenInput || !modalTitleElement || !saveEventBtn) return;
        createEventModal.classList.remove('hidden'); createEventForm.reset(); eventIdHiddenInput.value = '';
        modalTitleElement.textContent = 'Crear Nuevo Evento'; saveEventBtn.textContent = 'Guardar Evento';
    }
    function openModalForEdit(eventData) { /* ... (igual) ... */
        if (!createEventModal || !createEventForm || !eventIdHiddenInput || !modalTitleElement || !saveEventBtn) return;
        createEventModal.classList.remove('hidden'); createEventForm.reset();
        modalTitleElement.textContent = 'Editar Evento'; saveEventBtn.textContent = 'Actualizar Evento';
        eventIdHiddenInput.value = eventData.id;
        createEventForm.elements['name'].value = eventData.name;
        createEventForm.elements['event_date'].value = eventData.event_date ? eventData.event_date.split('T')[0] : '';
        createEventForm.elements['city'].value = eventData.city || ''; createEventForm.elements['province'].value = eventData.province || '';
        createEventForm.elements['discipline'].value = eventData.discipline || ''; createEventForm.elements['distance'].value = eventData.distance || '';
        createEventForm.elements['source_url'].value = eventData.source_url || '';
        for (const key in TAG_PROPERTIES) { if (createEventForm.elements[key]) createEventForm.elements[key].checked = eventData[key] || false; }
    }
    function closeModal() { /* ... (igual) ... */
        if(createEventModal) createEventModal.classList.add('hidden'); if(createEventForm) createEventForm.reset(); if(eventIdHiddenInput) eventIdHiddenInput.value = '';
        if(modalTitleElement) modalTitleElement.textContent = 'Crear Nuevo Evento'; if(saveEventBtn) saveEventBtn.textContent = 'Guardar Evento';
    }

    if (openCreateEventModalBtn) openCreateEventModalBtn.addEventListener('click', (e) => { e.preventDefault(); openModalForCreate(); });
    if (closeCreateEventModalBtn) closeCreateEventModalBtn.addEventListener('click', closeModal);
    if (cancelCreateEventBtn) cancelCreateEventBtn.addEventListener('click', closeModal);

    if (createEventForm) {
        createEventForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            if(saveEventBtn) saveEventBtn.classList.add('opacity-50', 'pointer-events-none');
            const formData = new FormData(createEventForm); const data = Object.fromEntries(formData.entries());
            delete data.event_id_hidden; // Usar el valor de eventIdHiddenInput.value directamente
            for (const key in TAG_PROPERTIES) { data[key] = formData.has(key); }
            if (!data.name || !data.event_date) { showAppFlashMessage('Nombre y Fecha son obligatorios.', 'error'); if(saveEventBtn) saveEventBtn.classList.remove('opacity-50', 'pointer-events-none'); return; }

            const editingId = eventIdHiddenInput.value;
            const method = editingId ? 'PUT' : 'POST';
            const url = editingId ? eventApiUrl(editingId) : apiBaseUrl;
            const successMessage = editingId ? 'Evento actualizado' : 'Evento creado';
            const errorMessageBase = editingId ? 'Error al actualizar' : 'Error al crear';

            try {
                const response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json', /* CSRF */ }, body: JSON.stringify(data) });
                const result = await response.json(); // Leer JSON siempre
                if (response.ok) {
                    showAppFlashMessage(result.message || successMessage, 'success'); closeModal(); loadEvents(); // Recargar
                } else {
                    showAppFlashMessage(result.message || `${errorMessageBase} (${response.status})`, 'error');
                }
            } catch (error) {
                console.error(`Error en ${method}:`, error); showAppFlashMessage(`Error de conexión.`, 'error');
            } finally {
                if(saveEventBtn) saveEventBtn.classList.remove('opacity-50', 'pointer-events-none');
            }
        });
    }

    // --- Carga y renderizado de eventos ---
    async function loadEvents() { /* ... (igual, pero usa showAppFlashMessage) ... */
        try {
            const response = await fetch(apiBaseUrl);
            if (response.ok) {
                const events_data = await response.json();
                allEvents = events_data.map(event => ({ ...event, event_date: event.event_date ? event.event_date : null }));
                if (totalCountDisplay) totalCountDisplay.textContent = allEvents.length;
                populateFilterOptions(allEvents); populateTagFilterButtons(); filterAndSortEvents();
            } else { showAppFlashMessage('Error al cargar eventos.', 'error'); if (totalCountDisplay) totalCountDisplay.textContent = 0; if (visibleCountDisplay) visibleCountDisplay.textContent = 0;}
        } catch (error) { console.error('Error cargando eventos:', error); showAppFlashMessage('Error de conexión al cargar.', 'error'); if (totalCountDisplay) totalCountDisplay.textContent = 0; if (visibleCountDisplay) visibleCountDisplay.textContent = 0;}
    }
    function renderEventsTable(eventsToRender) { /* ... (igual, usa clases de Tailwind/main_theme) ... */
        if(!eventsTableBody) return; eventsTableBody.innerHTML = '';
        if (eventsToRender.length === 0) { eventsTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500"><i class="fas fa-ghost fa-2x mb-2"></i><p>No hay eventos que coincidan.</p></td></tr>'; if (visibleCountDisplay) visibleCountDisplay.textContent = 0; return; }
        if (visibleCountDisplay) visibleCountDisplay.textContent = eventsToRender.length;
        eventsToRender.forEach(event => {
            const row = eventsTableBody.insertRow();
            const displayDate = event.event_date ? new Date(event.event_date + 'T00:00:00Z').toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'UTC' }) : 'N/A';
            let location = 'N/A'; if (event.city && event.province) location = `${event.city}, ${event.province}`; else if (event.city) location = event.city; else if (event.province) location = event.province;
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-dark">${event.name}</div></td>
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-600">${displayDate}</div></td>
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-600">${location}</div></td>
                <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">${event.discipline || 'N/A'}</span></td>
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-600">${event.distance || 'N/A'}</div></td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="triggerEditEvent(${event.id})" class="btn btn-link text-orange-primary hover:text-orange-dark p-1"><i class="fas fa-edit"></i> Editar</button>
                    <button onclick="deleteEventConfirmation(${event.id})" class="btn btn-link text-red-accent hover:text-red-700 p-1 ml-2"><i class="fas fa-trash"></i> Eliminar</button>
                </td>`;
        });
    }
    window.triggerEditEvent = async function(id) { /* ... (igual, usa showAppFlashMessage) ... */
        try {
            const response = await fetch(eventApiUrl(id));
            if (!response.ok) { const errorResult = await response.json(); throw new Error(errorResult.message || 'Evento no encontrado'); }
            const eventData = await response.json(); openModalForEdit(eventData);
        } catch (error) { console.error('Error al cargar evento para editar:', error); showAppFlashMessage(error.message || 'No se pudo cargar el evento.', 'error'); }
    }
    window.deleteEventConfirmation = function(id) { /* ... (igual) ... */
        if (confirm('¿Estás seguro de eliminar este evento? Esta acción no se puede deshacer.')) { deleteEvent(id); }
    }
    async function deleteEvent(id) { /* ... (igual, usa showAppFlashMessage) ... */
        try {
            const response = await fetch(eventApiUrl(id), { method: 'DELETE' });
            const result = await response.json(); // Leer JSON siempre
            if (response.ok) { showAppFlashMessage(result.message || 'Evento eliminado', 'success'); loadEvents(); }
            else { showAppFlashMessage(result.message || 'Error al eliminar', 'error'); }
        } catch (error) { console.error('Error al eliminar evento:', error); showAppFlashMessage('Error de conexión.', 'error'); }
    }

    // --- Event Listeners para Filtros ---
    if (searchInput) searchInput.addEventListener('input', filterAndSortEvents);
    if (tableHeaderFecha) { tableHeaderFecha.addEventListener('click', () => { currentSortAscending = !currentSortAscending; filterAndSortEvents(); }); }
    if (clearFiltersBtn) { clearFiltersBtn.addEventListener('click', () => { /* ... (igual) ... */
        if (searchInput) searchInput.value = '';
        filterDataKeys.forEach(key => { const dropdown = filterDropdowns[key]; if (dropdown) { dropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false); updateFilterButtonText(key);}});
        currentSortAscending = true; updateFechaSortIndicator();
        if (tagFiltersContainer) { tagFiltersContainer.querySelectorAll('button').forEach(button => { const tagKey = button.dataset.tagKey; const tagInfo = TAG_PROPERTIES[tagKey]; button.dataset.active = "false"; button.setAttribute('aria-pressed', 'false'); button.className = `btn btn-sm ${tagInfo.filterColor || 'btn-outline-secondary'} transition-all duration-200`; });}
        filterAndSortEvents();
    });}

    // Inicializar
    loadEvents();
    updateFechaSortIndicator(); // Set initial indicator

});
</script>
{% endblock scripts %}
