{% extends "admin_dashboard.html" %}

{% block full_width_page %}1{% endblock %} {# This signals admin_dashboard to not restrict width #}

{% block title %}Gestión de Eventos - TriPredict{% endblock %}

{% block header_title %}Gestión de Eventos TriCal{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{{ url_for('serve_hello_world_page') }}">Dashboard</a></li>
    <li class="breadcrumb-item active" aria-current="page">Gestión de Eventos</li>
{% endblock %}

{% block join_by_code_button %}{% endblock %} {# Esto oculta el botón de unirse por código #}

{% block main_dashboard_content %}
<div class="w-full px-4 py-px"> <!-- Cambiado container-fluid mx-auto a w-full -->
    <!-- Filters Section (adaptada de TriCal.html) -->
    <section class="bg-white shadow-md rounded-lg p-6 mt-8 mb-8 no-print">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Filtrar Eventos</h2>
        <div class="flex flex-wrap gap-4 items-center"> <!-- Changed items-end to items-center for better vertical alignment -->
            <!-- Search -->
            <div class="flex-grow min-w-[200px] lg:min-w-[250px]">
                <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-1">Búsqueda:</label>
                <input type="text" id="searchInput" placeholder="Nombre, ciudad, provincia..."
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm p-2 h-10"> <!-- Added h-10 for consistent height -->
            </div>

            <!-- Discipline Filter - Custom Dropdown -->
            <div class="flex-grow min-w-[170px] relative">
                <label for="disciplineFilterBtn" class="block text-sm font-medium text-gray-700 mb-1">Disciplina:</label>
                <button id="disciplineFilterBtn" type="button" class="mt-1 h-10 bg-white w-full border border-gray-300 rounded-md shadow-sm px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 flex items-center justify-between">
                    <span class="truncate">Todas</span> <i class="fas fa-chevron-down ml-2 text-gray-500"></i>
                </button>
                <div id="disciplineFilterDropdown" class="hidden absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
                    <!-- Checkbox items will be populated by JS -->
                </div>
            </div>

            <!-- Distance Filter - Custom Dropdown -->
            <div class="flex-grow min-w-[170px] relative">
                <label for="distanceFilterBtn" class="block text-sm font-medium text-gray-700 mb-1">Distancia:</label>
                <button id="distanceFilterBtn" type="button" class="mt-1 h-10 bg-white w-full border border-gray-300 rounded-md shadow-sm px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 flex items-center justify-between">
                    <span class="truncate">Todas</span> <i class="fas fa-chevron-down ml-2 text-gray-500"></i>
                </button>
                <div id="distanceFilterDropdown" class="hidden absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
                    <!-- Checkbox items will be populated by JS -->
                </div>
            </div>

            <!-- Province Filter - Custom Dropdown -->
            <div class="flex-grow min-w-[170px] relative">
                <label for="provinceFilterBtn" class="block text-sm font-medium text-gray-700 mb-1">Provincia:</label>
                <button id="provinceFilterBtn" type="button" class="mt-1 h-10 bg-white w-full border border-gray-300 rounded-md shadow-sm px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 flex items-center justify-between">
                    <span class="truncate">Todas</span> <i class="fas fa-chevron-down ml-2 text-gray-500"></i>
                </button>
                <div id="provinceFilterDropdown" class="hidden absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
                    <!-- Checkbox items will be populated by JS -->
                </div>
            </div>

            <!-- Month Filter - Custom Dropdown -->
            <div class="flex-grow min-w-[170px] relative">
                <label for="monthFilterBtn" class="block text-sm font-medium text-gray-700 mb-1">Mes:</label>
                <button id="monthFilterBtn" type="button" class="mt-1 h-10 bg-white w-full border border-gray-300 rounded-md shadow-sm px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 flex items-center justify-between">
                    <span class="truncate">Todos</span> <i class="fas fa-chevron-down ml-2 text-gray-500"></i>
                </button>
                <div id="monthFilterDropdown" class="hidden absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
                    <!-- Checkbox items for months will be populated by JS (or could be static if preferred) -->
                </div>
            </div>
        </div>

        <!-- Tag Filters Section -->
        <div class="mt-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Etiquetas:</label>
            <div id="tagFiltersContainer" class="flex flex-wrap gap-2">
                <!-- Tag filter buttons will be populated by JS -->
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-wrap items-center justify-between mt-6 gap-4">
            <div class="flex flex-wrap gap-2">
                <button id="clearFilters" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors text-sm">
                    <i class="fas fa-times mr-1"></i> Limpiar Filtros
                </button>
                <button id="sortDate" class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600 transition-colors text-sm">
                    <i class="fas fa-sort mr-1"></i> Ordenar por Fecha
                </button>
            </div>
            <div class="text-sm text-gray-600">
                Mostrando <span id="visibleCount">0</span> de <span id="totalCount">0</span> eventos
            </div>
        </div>
    </section>

    <!-- Tabla de Eventos Existentes -->
    <div class="bg-white shadow-md rounded-lg overflow-hidden mt-8">
        <h2 class="text-2xl font-semibold text-gray-700 p-6">Eventos Existentes</h2>
        <div class="overflow-x-auto">
            <table class="w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ciudad</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Provincia</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Disciplina</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Distancia</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="events-table-body">
                    <!-- Las filas se cargarán aquí por JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // const eventModal = document.getElementById('event-modal'); // Eliminado
    // const openEventModalBtn = document.getElementById('open-event-modal-btn'); // Eliminado
    // const closeEventModalBtn = document.getElementById('close-event-modal-btn'); // Eliminado
    // const cancelEventModalBtn = document.getElementById('cancel-event-modal-btn'); // Eliminado

    // const eventForm = document.getElementById('event-form'); // Eliminado
    const eventsTableBody = document.getElementById('events-table-body');
    // const modalTitle = document.getElementById('modal-title'); // Eliminado
    // const eventIdInput = document.getElementById('event_id'); // Eliminado
    // const submitBtn = document.getElementById('submit-btn'); // Eliminado

    const apiBaseUrl = '/api/events';

    // --- Variables para Filtros (adaptado de TriCal.html) ---
    let allEvents = [];
    let currentSortAscending = true;

    const searchInput = document.getElementById('searchInput');
    // Custom dropdown elements
    const filterButtonIds = ['disciplineFilterBtn', 'distanceFilterBtn', 'provinceFilterBtn', 'monthFilterBtn'];
    const filterDropdownIds = ['disciplineFilterDropdown', 'distanceFilterDropdown', 'provinceFilterDropdown', 'monthFilterDropdown'];
    const filterDataKeys = ['discipline', 'distance', 'province', 'month']; // To map buttons/dropdowns to event data keys

    // Store references to buttons and dropdowns
    const filterButtons = {};
    const filterDropdowns = {};
    filterButtonIds.forEach((btnId, index) => {
        filterButtons[filterDataKeys[index]] = document.getElementById(btnId);
        filterDropdowns[filterDataKeys[index]] = document.getElementById(filterDropdownIds[index]);
    });

    // Original select elements (will be removed or repurposed by JS logic if they were for data storage; now data is in JS)
    // const disciplineFilter = document.getElementById('disciplineFilter'); // No longer a select
    // const distanceFilter = document.getElementById('distanceFilter');   // No longer a select
    // const provinceFilter = document.getElementById('provinceFilter');   // No longer a select
    // const monthFilter = document.getElementById('monthFilter');       // No longer a select

    const tagFiltersContainer = document.getElementById('tagFiltersContainer');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const sortDateBtn = document.getElementById('sortDate');
    const visibleCountDisplay = document.getElementById('visibleCount');
    const totalCountDisplay = document.getElementById('totalCount');

    // --- Constante para Etiquetas (adaptado de TriCal.html) ---
    const tagProperties = {
        is_good_for_debutants: { text: "Good for Debutants", color: "bg-green-100 text-green-800", filterColor: "bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-300", filterActiveColor: "bg-green-600 text-white", icon: "fas fa-seedling" },
        is_challenging: { text: "Challenging", color: "bg-red-100 text-red-800", filterColor: "bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-300", filterActiveColor: "bg-red-600 text-white", icon: "fas fa-mountain" },
        has_great_views: { text: "Great Views", color: "bg-blue-100 text-blue-800", filterColor: "bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-300", filterActiveColor: "bg-blue-600 text-white", icon: "fas fa-image" },
        has_good_atmosphere: { text: "Good Atmosphere", color: "bg-purple-100 text-purple-800", filterColor: "bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-300", filterActiveColor: "bg-purple-600 text-white", icon: "fas fa-users" },
        is_world_qualifier: { text: "World Qualifier", color: "bg-yellow-100 text-yellow-800", filterColor: "bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-300", filterActiveColor: "bg-yellow-500 text-gray-900", icon: "fas fa-trophy" }
    };

    // --- Modal Handling (eliminado) ---

    // --- Funciones de Filtros (adaptadas de TriCal.html) ---
    function populateTagFilterButtons() {
        if (!tagFiltersContainer) return;
        tagFiltersContainer.innerHTML = '';

        for (const key in tagProperties) {
            const tagInfo = tagProperties[key];
            const button = document.createElement('button');
            button.id = `filter-${key}`;
            button.dataset.tagKey = key;
            button.className = `px-3 py-2 text-sm font-medium rounded-md transition-colors ${tagInfo.filterColor}`;
            button.innerHTML = `<i class="${tagInfo.icon} mr-1.5"></i> ${tagInfo.text}`;
            button.setAttribute('aria-pressed', 'false');
            button.dataset.active = "false";

            button.addEventListener('click', () => {
                const isActive = button.dataset.active === "true";
                if (isActive) {
                    button.dataset.active = "false";
                    button.setAttribute('aria-pressed', 'false');
                    button.className = `px-3 py-2 text-sm font-medium rounded-md transition-colors ${tagInfo.filterColor}`;
                } else {
                    button.dataset.active = "true";
                    button.setAttribute('aria-pressed', 'true');
                    button.className = `px-3 py-2 text-sm font-medium rounded-md transition-colors ${tagInfo.filterActiveColor}`;
                }
                filterAndSortEvents();
            });
            tagFiltersContainer.appendChild(button);
        }
    }

    function populateFilterOptions(events) {
        const disciplines = new Set();
        const distances = new Set();
        const provinces = new Set();

        events.forEach(event => {
            if (event.discipline) disciplines.add(event.discipline);
            if (event.distance) distances.add(event.distance);
            if (event.province) provinces.add(event.province);
        });

        // --- Helper function to create checkbox items for custom dropdowns ---
        function createCheckboxItem(filterKey, value, text) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `filter-${filterKey}-${value}`;
            checkbox.name = filterKey;
            checkbox.value = value;
            checkbox.className = 'form-checkbox h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500 mr-2';
            checkbox.addEventListener('change', () => {
                updateFilterButtonText(filterKey);
                filterAndSortEvents();
            });

            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.textContent = text;
            label.className = 'text-sm text-gray-700 select-none';

            itemDiv.appendChild(checkbox);
            itemDiv.appendChild(label);
            // Allow clicking the div to toggle checkbox
            itemDiv.addEventListener('click', (e) => {
                if (e.target !== checkbox) checkbox.click();
            });
            return itemDiv;
        }

        // --- Helper function to update filter button text ---
        function updateFilterButtonText(filterKey) {
            const dropdown = filterDropdowns[filterKey];
            const button = filterButtons[filterKey];
            if (!dropdown || !button) return;

            const selectedCheckboxes = Array.from(dropdown.querySelectorAll('input[type="checkbox"]:checked'));
            const buttonTextSpan = button.querySelector('span');

            if (selectedCheckboxes.length === 0) {
                buttonTextSpan.textContent = 'Todas'; // Or 'Todos' for month
            } else if (selectedCheckboxes.length === 1) {
                buttonTextSpan.textContent = selectedCheckboxes[0].parentElement.querySelector('label').textContent;
            } else {
                let baseName = '';
                if (filterKey === 'discipline') baseName = 'Disciplinas';
                else if (filterKey === 'distance') baseName = 'Distancias';
                else if (filterKey === 'province') baseName = 'Provincias';
                else if (filterKey === 'month') baseName = 'Meses';
                buttonTextSpan.textContent = `${baseName} (${selectedCheckboxes.length})`;
            }
        }


        // Populate dynamic filters (Discipline, Distance, Province)
        ['discipline', 'distance', 'province'].forEach(key => {
            const dropdownElement = filterDropdowns[key];
            if (!dropdownElement) return;
            dropdownElement.innerHTML = ''; // Clear previous options

            let currentSet;
            if (key === 'discipline') currentSet = disciplines;
            else if (key === 'distance') currentSet = distances;
            else if (key === 'province') currentSet = provinces;

            Array.from(currentSet).sort().forEach(value => {
                dropdownElement.appendChild(createCheckboxItem(key, value, value));
            });
            updateFilterButtonText(key); // Initial button text
        });

        // Populate Month Filter (static options)
        const monthDropdown = filterDropdowns['month'];
        if (monthDropdown) {
            monthDropdown.innerHTML = ''; // Clear previous
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            monthNames.forEach((name, index) => {
                monthDropdown.appendChild(createCheckboxItem('month', (index + 1).toString(), name));
            });
            updateFilterButtonText('month'); // Initial button text
        }
    }

    function filterAndSortEvents() {
        let filteredEvents = [...allEvents];
        const searchTerm = searchInput.value.toLowerCase().trim();

        // Get selected values from custom checkbox dropdowns
        const selectedDisciplines = Array.from(filterDropdowns['discipline'].querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        const selectedDistances = Array.from(filterDropdowns['distance'].querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        const selectedProvinces = Array.from(filterDropdowns['province'].querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        const selectedMonths = Array.from(filterDropdowns['month'].querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);

        const activeTagFilters = {};
        if (tagFiltersContainer) {
            tagFiltersContainer.querySelectorAll('button').forEach(btn => {
                if (btn.dataset.active === "true") {
                    activeTagFilters[btn.dataset.tagKey] = true;
                }
            });
        }

        if (searchTerm) {
            filteredEvents = filteredEvents.filter(event =>
                (event.name && event.name.toLowerCase().includes(searchTerm)) ||
                (event.city && event.city.toLowerCase().includes(searchTerm)) ||
                (event.province && event.province.toLowerCase().includes(searchTerm)) ||
                (event.discipline && event.discipline.toLowerCase().includes(searchTerm)) ||
                (event.distance && event.distance.toLowerCase().includes(searchTerm))
            );
        }

        if (selectedDisciplines.length > 0) {
            filteredEvents = filteredEvents.filter(event => selectedDisciplines.includes(event.discipline));
        }
        if (selectedDistances.length > 0) {
            filteredEvents = filteredEvents.filter(event => selectedDistances.includes(event.distance));
        }
        if (selectedProvinces.length > 0) {
            filteredEvents = filteredEvents.filter(event => selectedProvinces.includes(event.province));
        }
        if (selectedMonths.length > 0) {
            filteredEvents = filteredEvents.filter(event => {
                if (!event.event_date) return false;
                const event_date_obj = new Date(event.event_date + 'T00:00:00Z');
                const event_month = (event_date_obj.getUTCMonth() + 1).toString();
                return selectedMonths.includes(event_month);
            });
        }

        const activeTagKeys = Object.keys(activeTagFilters);
        if (activeTagKeys.length > 0) {
            filteredEvents = filteredEvents.filter(event => {
                return activeTagKeys.every(tagKey => {
                    return event[tagKey] === true || event[tagKey] === 1 || event[tagKey] === '1' || event[tagKey] === 't' || String(event[tagKey]).toLowerCase() === 'true';
                });
            });
        }

        filteredEvents.sort((a, b) => {
            const dateA = a.event_date ? new Date(a.event_date + 'T00:00:00Z') : null;
            const dateB = b.event_date ? new Date(b.event_date + 'T00:00:00Z') : null;

            if (!dateA && !dateB) return 0;
            if (!dateA) return 1;
            if (!dateB) return -1;

            return currentSortAscending ? dateA - dateB : dateB - dateA;
        });

        renderEventsTable(filteredEvents); // Llamar a renderEventsTable en lugar de renderEvents
        if (visibleCountDisplay) visibleCountDisplay.textContent = filteredEvents.length;
    }
    // --- End Funciones de Filtros ---

    // --- Custom Dropdown Logic ---
    let openDropdown = null; // Track the currently open dropdown

    function toggleDropdown(filterKey) {
        const dropdown = filterDropdowns[filterKey];
        if (!dropdown) return;

        if (openDropdown && openDropdown !== dropdown) {
            openDropdown.classList.add('hidden');
        }
        dropdown.classList.toggle('hidden');
        openDropdown = dropdown.classList.contains('hidden') ? null : dropdown;
    }

    filterDataKeys.forEach(key => {
        if (filterButtons[key]) {
            filterButtons[key].addEventListener('click', (event) => {
                event.stopPropagation(); // Prevent click from bubbling to document
                toggleDropdown(key);
            });
        }
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', (event) => {
        if (openDropdown && !openDropdown.contains(event.target) && !Array.from(Object.values(filterButtons)).some(btn => btn.contains(event.target))) {
            openDropdown.classList.add('hidden');
            openDropdown = null;
        }
    });
    // --- End Custom Dropdown Logic ---


    // Cargar eventos al iniciar
    loadEvents();

    // eventForm.addEventListener('submit', async function(e) { // Eliminado
    //     e.preventDefault();
    //     const formData = new FormData(eventForm);
    //     const data = Object.fromEntries(formData.entries());

    //     // Convertir checkboxes a booleanos
    //     data.is_good_for_debutants = formData.has('is_good_for_debutants');
    //     data.is_challenging = formData.has('is_challenging');
    //     data.has_great_views = formData.has('has_great_views');
    //     data.has_good_atmosphere = formData.has('has_good_atmosphere');
    //     data.is_world_qualifier = formData.has('is_world_qualifier');

    //     const eventId = data.event_id;
    //     let url = apiBaseUrl;
    //     let method = 'POST';

    //     if (eventId) {
    //         url = `${apiBaseUrl}/${eventId}`;
    //         method = 'PUT';
    //     }

    //     try {
    //         const response = await fetch(url, {
    //             method: method,
    //             headers: {
    //                 'Content-Type': 'application/json',
    //                 // Añadir CSRF token si es necesario
    //             },
    //             body: JSON.stringify(data)
    //         });

    //         if (response.ok) {
    //             const result = await response.json();
    //             showFlashMessage(result.message || (eventId ? 'Evento actualizado con éxito' : 'Evento creado con éxito'), 'success');
    //             resetForm();
    //             loadEvents();
    //         } else {
    //             const errorResult = await response.json();
    //             showFlashMessage(errorResult.message || 'Error al guardar el evento', 'error');
    //         }
    //     } catch (error) {
    //         console.error('Error en la petición:', error);
    //         showFlashMessage('Error de conexión al guardar el evento.', 'error');
    //     }
    // });

    // cancelEditBtn.addEventListener('click', function() { // Eliminado
    //     resetForm();
    // });

    async function loadEvents() {
        try {
            const response = await fetch(apiBaseUrl);
            if (response.ok) {
                const events_data = await response.json();
                allEvents = events_data.map(event => ({ // Almacenar en allEvents
                    ...event,
                    event_date: event.event_date ? event.event_date : null
                }));

                if (totalCountDisplay) totalCountDisplay.textContent = allEvents.length;

                populateFilterOptions(allEvents);
                populateTagFilterButtons();
                filterAndSortEvents(); // Esto llamará a renderEventsTable
                // renderEventsTable(allEvents); // Ya no se llama directamente aquí
            } else {
                showFlashMessage('Error al cargar los eventos.', 'error');
                 if (totalCountDisplay) totalCountDisplay.textContent = 0;
                 if (visibleCountDisplay) visibleCountDisplay.textContent = 0;
            }
        } catch (error) {
            console.error('Error cargando eventos:', error);
            showFlashMessage('Error de conexión al cargar eventos.', 'error');
            if (totalCountDisplay) totalCountDisplay.textContent = 0;
            if (visibleCountDisplay) visibleCountDisplay.textContent = 0;
        }
    }

    function renderEventsTable(eventsToRender) { // Recibe eventsToRender
        eventsTableBody.innerHTML = '';
        if (eventsToRender.length === 0) {
            eventsTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No hay eventos que coincidan con los filtros.</td></tr>';
            // Actualizar contador de visibles a 0
            if (visibleCountDisplay) visibleCountDisplay.textContent = 0;
            return;
        }
        // Actualizar contador de visibles
        if (visibleCountDisplay) visibleCountDisplay.textContent = eventsToRender.length;

        eventsToRender.forEach(event => {
            const row = eventsTableBody.insertRow();
            // Asegurarse que la fecha se interprete como UTC para evitar desfases al usar toLocaleDateString
            // El backend devuelve 'YYYY-MM-DD'. Si se crea new Date('YYYY-MM-DD'), se interpreta como local.
            // Para consistencia con el filtro de mes, y para mostrar la fecha tal cual es, es mejor añadir 'T00:00:00Z'.
            const displayDate = event.event_date ? new Date(event.event_date + 'T00:00:00Z').toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'UTC' }) : 'N/A';

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${event.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${displayDate}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${event.city || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${event.province || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${event.discipline || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${event.distance || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <!-- <button onclick="editEvent(${event.id})" class="text-indigo-600 hover:text-indigo-900 mr-3">Editar</button> -->
                    <button onclick="deleteEventConfirmation(${event.id})" class="text-red-600 hover:text-red-900">Eliminar</button>
                </td>
            `;
        });
    }

    window.editEvent = function(id) {
        // En una implementación real, aquí se buscaría el evento por ID y se poblaría el formulario
        // Por ahora, simulamos la carga. Idealmente, se hace una petición GET /api/events/<id>
        fetch(`${apiBaseUrl}/${id}`) // Asumiendo que tienes una ruta GET para un evento específico
            .then(response => {
                if (!response.ok) throw new Error('Evento no encontrado o error al cargar');
                return response.json();
            })
            .then(event => {
                modalTitle.textContent = 'Editar Evento'; // Usar modalTitle
                eventIdInput.value = event.id;
                eventForm.elements['name'].value = event.name;
                // Formatear la fecha para el input type="date" (YYYY-MM-DD)
                eventForm.elements['event_date'].value = event.event_date ? event.event_date.split('T')[0] : '';
                eventForm.elements['city'].value = event.city || '';
                eventForm.elements['province'].value = event.province || '';
                eventForm.elements['discipline'].value = event.discipline || '';
                eventForm.elements['distance'].value = event.distance || '';
                eventForm.elements['source_url'].value = event.source_url || '';

                eventForm.elements['is_good_for_debutants'].checked = event.is_good_for_debutants || false;
                eventForm.elements['is_challenging'].checked = event.is_challenging || false;
                eventForm.elements['has_great_views'].checked = event.has_great_views || false;
                eventForm.elements['has_good_atmosphere'].checked = event.has_good_atmosphere || false;
                eventForm.elements['is_world_qualifier'].checked = event.is_world_qualifier || false;

                submitBtn.textContent = 'Actualizar Evento';
                // cancelEditBtn.classList.remove('hidden'); // El botón de cancelar del modal siempre está visible dentro del modal
                openModal(); // Abrir el modal en lugar de hacer scroll
            })
            .catch(error => {
                console.error('Error al cargar evento para editar:', error);
                showFlashMessage(error.message || 'No se pudo cargar el evento para editar.', 'error');
            });
    }

    window.deleteEventConfirmation = function(id) {
        if (confirm('¿Estás seguro de que quieres eliminar este evento? Esta acción no se puede deshacer.')) {
            deleteEvent(id);
        }
    }

    // La función editEvent ya no es necesaria aquí ya que el modal fue eliminado.
    // Si se necesita editar, se debería implementar una página separada o un mecanismo diferente.
    // Por ahora, el botón "Editar" en la tabla simplemente no hará nada o podría eliminarse también.
    // Vamos a comentar la función window.editEvent y la referencia a ella en la tabla.

    // window.editEvent = function(id) { ... } // Comentado o eliminado

    async function deleteEvent(id) {
        try {
            const response = await fetch(`${apiBaseUrl}/${id}`, { method: 'DELETE' });
            if (response.ok) {
                const result = await response.json();
                showFlashMessage(result.message || 'Evento eliminado con éxito', 'success');
                loadEvents(); // Recargar eventos para reflejar la eliminación
            } else {
                const errorResult = await response.json();
                showFlashMessage(errorResult.message || 'Error al eliminar el evento', 'error');
            }
        } catch (error) {
            console.error('Error al eliminar evento:', error);
            showFlashMessage('Error de conexión al eliminar el evento.', 'error');
        }
    }

    // function resetForm() { // Eliminado, ya no hay formulario principal de creación/edición
    //     // eventForm.reset();
    //     // eventIdInput.value = '';
    // }

    // --- Event Listeners para Filtros (adaptado de TriCal.html) ---
    if (searchInput) searchInput.addEventListener('input', filterAndSortEvents);
    if (disciplineFilter) disciplineFilter.addEventListener('change', filterAndSortEvents);
    if (distanceFilter) distanceFilter.addEventListener('change', filterAndSortEvents);
    if (provinceFilter) provinceFilter.addEventListener('change', filterAndSortEvents);
    if (monthFilter) monthFilter.addEventListener('change', filterAndSortEvents);

    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', () => {
            if (searchInput) searchInput.value = '';

            // For custom dropdowns, uncheck all checkboxes and update button text
            filterDataKeys.forEach(key => {
                const dropdown = filterDropdowns[key];
                if (dropdown) {
                    const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => cb.checked = false);
                    updateFilterButtonText(key); // Reset button text to 'Todas'/'Todos'
                }
            });

            currentSortAscending = true;
            if (sortDateBtn) sortDateBtn.innerHTML = '<i class="fas fa-sort-amount-down mr-1"></i> Fecha (Antiguas primero)';

            if (tagFiltersContainer) {
                tagFiltersContainer.querySelectorAll('button').forEach(button => {
                    const tagKey = button.dataset.tagKey;
                    const tagInfo = tagProperties[tagKey];
                    button.dataset.active = "false";
                    button.setAttribute('aria-pressed', 'false');
                    button.className = `px-3 py-2 text-sm font-medium rounded-md transition-colors ${tagInfo.filterColor}`;
                });
            }
            filterAndSortEvents();
        });
    }

    if (sortDateBtn) {
        sortDateBtn.addEventListener('click', () => {
            currentSortAscending = !currentSortAscending;
            sortDateBtn.innerHTML = currentSortAscending ?
                '<i class="fas fa-sort-amount-down mr-1"></i> Fecha (Antiguas primero)' :
                '<i class="fas fa-sort-amount-up mr-1"></i> Fecha (Nuevas primero)';
            filterAndSortEvents();
        });
        // Initial sort button text
        sortDateBtn.innerHTML = '<i class="fas fa-sort-amount-down mr-1"></i> Fecha (Antiguas primero)';
    }
    // --- Fin Event Listeners para Filtros ---

    // Función para mostrar mensajes flash (simulada, ya que el header maneja los reales)
    function showFlashMessage(message, category) {
        // Esta es una simulación. En una app real, podrías redirigir o recargar
        // para que los mensajes flash de Flask se muestren, o implementar un sistema de notificaciones JS.
        // Por ahora, usaremos un simple alert y un console.log
        console.log(`FLASH (${category}): ${message}`);
        // alert(`${category.toUpperCase()}: ${message}`);

        // Intentar crear un mensaje flash dinámico similar al del _header.html
        const flashContainer = document.getElementById('flash-messages-container') || createFlashContainer();

        const alertDiv = document.createElement('div');
        alertDiv.className = `alert-flash alert-${category} p-4 mb-3 text-sm rounded-lg shadow-md
                        ${category === 'error' ? 'bg-red-100 border border-red-300 text-red-700' : ''}
                        ${category === 'success' ? 'bg-green-100 border border-green-300 text-green-700' : ''}
                        ${category === 'warning' ? 'bg-yellow-100 border border-yellow-300 text-yellow-700' : ''}
                        ${!['error', 'success', 'warning'].includes(category) ? 'bg-blue-100 border border-blue-300 text-blue-700' : ''}`;
        alertDiv.setAttribute('role', 'alert');

        let iconClass = 'fas fa-info-circle';
        let typeText = 'Info:';
        if (category === 'error') { iconClass = 'fas fa-times-circle'; typeText = 'Error:'; }
        else if (category === 'success') { iconClass = 'fas fa-check-circle'; typeText = 'Éxito:'; }
        else if (category === 'warning') { iconClass = 'fas fa-exclamation-triangle'; typeText = 'Advertencia:'; }

        alertDiv.innerHTML = `
            <div class="flex items-center">
                <span class="font-medium mr-2"><i class="${iconClass}"></i> ${typeText}</span>
                <span>${message}</span>
                <button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-transparent text-current rounded-lg focus:ring-2 p-1.5 inline-flex h-8 w-8 hover:bg-opacity-20
                                            ${category === 'error' ? 'hover:bg-red-200 focus:ring-red-400' : ''}
                                            ${category === 'success' ? 'hover:bg-green-200 focus:ring-green-400' : ''}
                                            ${category === 'warning' ? 'hover:bg-yellow-200 focus:ring-yellow-400' : ''}
                                            ${!['error', 'success', 'warning'].includes(category) ? 'hover:bg-blue-200 focus:ring-blue-400' : ''}"
                        onclick="this.closest('.alert-flash').remove();" aria-label="Dismiss">
                  <span class="sr-only">Dismiss</span>
                  <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
            </div>`;

        flashContainer.appendChild(alertDiv);

        setTimeout(() => {
            alertDiv.style.transition = 'opacity 0.5s ease-out';
            alertDiv.style.opacity = '0';
            setTimeout(() => alertDiv.remove(), 500);
        }, 7000);
    }

    function createFlashContainer() {
        let container = document.getElementById('flash-messages-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'flash-messages-container';
            container.className = 'fixed top-5 left-1/2 transform -translate-x-1/2 z-[1000] w-full max-w-xl px-4';
            container.style.marginTop = '60px'; // Similar al _header.html
            // Intentar insertar después del header o al inicio del body
            const header = document.querySelector('header');
            if (header && header.parentNode) {
                header.parentNode.insertBefore(container, header.nextSibling);
            } else {
                document.body.prepend(container);
            }
        }
        return container;
    }
});
</script>
{% endblock %} {# main_dashboard_content #}

{% block additional_scripts %}
    {{ super() }}
    <!-- Puedes añadir scripts específicos para esta página aquí si es necesario -->
{% endblock %}
