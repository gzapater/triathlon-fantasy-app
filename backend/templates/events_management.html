{% extends "admin_dashboard.html" %}

{% block title %}Gestión de Eventos - TriPredict{% endblock %}

{% block header_title %}Gestión de Eventos TriCal{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{{ url_for('serve_hello_world_page') }}">Dashboard</a></li>
    <li class="breadcrumb-item active" aria-current="page">Gestión de Eventos</li>
{% endblock %}

{% block main_dashboard_content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Administrar Eventos de TriCal</h1>

    <!-- Botón para abrir el modal de creación de evento -->
    <div class="mb-6 text-right">
        <button id="open-event-modal-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded shadow-lg hover:shadow-xl transition duration-150 ease-in-out">
            <i class="fas fa-plus mr-2"></i> Crear Nuevo Evento
        </button>
    </div>

    <!-- Modal para Añadir/Editar Evento -->
    <div id="event-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white">
            <!-- Modal Header -->
            <div class="flex justify-between items-center pb-3">
                <h2 class="text-2xl font-semibold text-gray-700" id="form-title">Añadir Nuevo Evento</h2>
                <button id="close-event-modal-btn" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <!-- Modal Body (Formulario) -->
            <div class="bg-white rounded-lg p-0"> <!-- Eliminado shadow-md, mb-8 y p-6 ya que el modal tiene su propio padding y estructura -->
                <form id="event-form">
                    <input type="hidden" id="event_id" name="event_id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Evento:</label>
                            <input type="text" id="name" name="name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm p-2">
                        </div>
                        <div>
                            <label for="event_date" class="block text-sm font-medium text-gray-700 mb-1">Fecha del Evento:</label>
                            <input type="date" id="event_date" name="event_date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm p-2">
                        </div>
                        <div>
                            <label for="city" class="block text-sm font-medium text-gray-700 mb-1">Ciudad:</label>
                            <input type="text" id="city" name="city" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm p-2">
                        </div>
                        <div>
                            <label for="province" class="block text-sm font-medium text-gray-700 mb-1">Provincia:</label>
                            <input type="text" id="province" name="province" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm p-2">
                        </div>
                        <div>
                            <label for="discipline" class="block text-sm font-medium text-gray-700 mb-1">Disciplina:</label>
                            <input type="text" id="discipline" name="discipline" placeholder="Ej: Triatlón, Duatlón, Acuatlón" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm p-2">
                        </div>
                        <div>
                            <label for="distance" class="block text-sm font-medium text-gray-700 mb-1">Distancia:</label>
                            <input type="text" id="distance" name="distance" placeholder="Ej: Olímpica, Sprint, Media Distancia" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm p-2">
                        </div>
                        <div class="md:col-span-2">
                            <label for="source_url" class="block text-sm font-medium text-gray-700 mb-1">URL Fuente (Organizador):</label>
                            <input type="url" id="source_url" name="source_url" placeholder="https://www.example.com" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm p-2">
                        </div>
                    </div>

                    <fieldset class="mb-4">
                        <legend class="text-lg font-medium text-gray-900 mb-2">Puntuación TriCal (Opcional):</legend>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    <input id="is_good_for_debutants" name="is_good_for_debutants" type="checkbox" class="focus:ring-orange-500 h-4 w-4 text-orange-600 border-gray-300 rounded">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="is_good_for_debutants" class="font-medium text-gray-700">Ideal para Debutantes</label>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    <input id="is_challenging" name="is_challenging" type="checkbox" class="focus:ring-orange-500 h-4 w-4 text-orange-600 border-gray-300 rounded">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="is_challenging" class="font-medium text-gray-700">Desafiante</label>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    <input id="has_great_views" name="has_great_views" type="checkbox" class="focus:ring-orange-500 h-4 w-4 text-orange-600 border-gray-300 rounded">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="has_great_views" class="font-medium text-gray-700">Vistas Espectaculares</label>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    <input id="has_good_atmosphere" name="has_good_atmosphere" type="checkbox" class="focus:ring-orange-500 h-4 w-4 text-orange-600 border-gray-300 rounded">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="has_good_atmosphere" class="font-medium text-gray-700">Buen Ambiente</label>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    <input id="is_world_qualifier" name="is_world_qualifier" type="checkbox" class="focus:ring-orange-500 h-4 w-4 text-orange-600 border-gray-300 rounded">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="is_world_qualifier" class="font-medium text-gray-700">Clasificatorio Mundial</label>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" id="cancel-edit-btn" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">Cancelar</button>
                        <button type="submit" id="submit-btn" class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
                            Guardar Evento
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tabla de Eventos Existentes -->
    <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <h2 class="text-2xl font-semibold text-gray-700 p-6">Eventos Existentes</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ciudad</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Provincia</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Disciplina</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Distancia</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="events-table-body">
                    <!-- Las filas se cargarán aquí por JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const eventForm = document.getElementById('event-form');
    const eventsTableBody = document.getElementById('events-table-body');
    const formTitle = document.getElementById('form-title');
    const eventIdInput = document.getElementById('event_id');
    const submitBtn = document.getElementById('submit-btn');
    const cancelEditBtn = document.getElementById('cancel-edit-btn'); // Este es el botón "Cancelar" dentro del modal

    const eventModal = document.getElementById('event-modal');
    const openEventModalBtn = document.getElementById('open-event-modal-btn');
    const closeEventModalBtn = document.getElementById('close-event-modal-btn');


    const apiBaseUrl = '/api/events'; // Ajusta si tu API base es diferente

    // Cargar eventos al iniciar
    loadEvents();

    // --- Modal Control ---
    function showModal() {
        eventModal.classList.remove('hidden');
    }

    function hideModal() {
        eventModal.classList.add('hidden');
    }

    openEventModalBtn.addEventListener('click', function() {
        resetForm(); // Asegura que el formulario esté limpio para crear
        formTitle.textContent = 'Añadir Nuevo Evento'; // Asegura el título correcto
        submitBtn.textContent = 'Guardar Evento'; // Asegura el texto del botón de envío
        cancelEditBtn.classList.remove('hidden'); // El botón cancelar siempre visible en el modal
        showModal();
    });

    closeEventModalBtn.addEventListener('click', function() {
        resetForm(); // Limpia el formulario al cerrar con 'X'
        hideModal();
    });

    // El botón "Cancelar" dentro del formulario ahora también cierra el modal
    cancelEditBtn.addEventListener('click', function() {
        resetForm(); // resetForm ya se encarga de limpiar y ajustar títulos/botones
        hideModal(); // Añadido para ocultar el modal
    });


    eventForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(eventForm);
        const data = Object.fromEntries(formData.entries());

        // Convertir checkboxes a booleanos
        data.is_good_for_debutants = formData.has('is_good_for_debutants');
        data.is_challenging = formData.has('is_challenging');
        data.has_great_views = formData.has('has_great_views');
        data.has_good_atmosphere = formData.has('has_good_atmosphere');
        data.is_world_qualifier = formData.has('is_world_qualifier');

        const eventId = data.event_id;
        let url = apiBaseUrl;
        let method = 'POST';

        if (eventId) {
            url = `${apiBaseUrl}/${eventId}`;
            method = 'PUT';
        }

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    // Añadir CSRF token si es necesario
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                const result = await response.json();
                showFlashMessage(result.message || (eventId ? 'Evento actualizado con éxito' : 'Evento creado con éxito'), 'success');
                resetForm();
                hideModal(); // Ocultar el modal después de éxito
                // loadEvents(); // loadEvents actualiza la tabla. La recarga de página lo hará de todas formas.
                location.reload(); // Recargar la página como solicitado.
            } else {
                const errorResult = await response.json();
                showFlashMessage(errorResult.message || 'Error al guardar el evento', 'error');
                // No ocultar el modal en caso de error para que el usuario pueda corregir.
            }
        } catch (error) {
            console.error('Error en la petición:', error);
            showFlashMessage('Error de conexión al guardar el evento.', 'error');
             // No ocultar el modal en caso de error de conexión.
        }
    });

    // cancelEditBtn click listener ya modificado arriba para incluir hideModal()

    async function loadEvents() {
        try {
            const response = await fetch(apiBaseUrl); // Ruta GET para listar eventos
            if (response.ok) {
                const events = await response.json();
                renderEventsTable(events);
            } else {
                showFlashMessage('Error al cargar los eventos.', 'error');
            }
        } catch (error) {
            console.error('Error cargando eventos:', error);
            showFlashMessage('Error de conexión al cargar eventos.', 'error');
        }
    }

    function renderEventsTable(events) {
        eventsTableBody.innerHTML = ''; // Limpiar tabla
        if (events.length === 0) {
            eventsTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No hay eventos registrados.</td></tr>';
            return;
        }
        events.forEach(event => {
            const row = eventsTableBody.insertRow();
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${event.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${event.event_date ? new Date(event.event_date + 'T00:00:00Z').toLocaleDateString() : 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${event.city || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${event.province || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${event.discipline || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${event.distance || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="editEvent(${event.id})" class="text-indigo-600 hover:text-indigo-900 mr-3">Editar</button>
                    <button onclick="deleteEventConfirmation(${event.id})" class="text-red-600 hover:text-red-900">Eliminar</button>
                </td>
            `;
        });
    }

    window.editEvent = function(id) {
        // En una implementación real, aquí se buscaría el evento por ID y se poblaría el formulario
        // Por ahora, simulamos la carga. Idealmente, se hace una petición GET /api/events/<id>
        fetch(`${apiBaseUrl}/${id}`) // Asumiendo que tienes una ruta GET para un evento específico
            .then(response => {
                if (!response.ok) throw new Error('Evento no encontrado o error al cargar');
                return response.json();
            })
            .then(event => {
                formTitle.textContent = 'Editar Evento';
                eventIdInput.value = event.id;
                eventForm.elements['name'].value = event.name;
                // Formatear la fecha para el input type="date" (YYYY-MM-DD)
                eventForm.elements['event_date'].value = event.event_date ? event.event_date.split('T')[0] : '';
                eventForm.elements['city'].value = event.city || '';
                eventForm.elements['province'].value = event.province || '';
                eventForm.elements['discipline'].value = event.discipline || '';
                eventForm.elements['distance'].value = event.distance || '';
                eventForm.elements['source_url'].value = event.source_url || '';

                eventForm.elements['is_good_for_debutants'].checked = event.is_good_for_debutants || false;
                eventForm.elements['is_challenging'].checked = event.is_challenging || false;
                eventForm.elements['has_great_views'].checked = event.has_great_views || false;
                eventForm.elements['has_good_atmosphere'].checked = event.has_good_atmosphere || false;
                eventForm.elements['is_world_qualifier'].checked = event.is_world_qualifier || false;

                submitBtn.textContent = 'Actualizar Evento';
                cancelEditBtn.classList.remove('hidden'); // Asegurar que el botón cancelar está visible
                showModal(); // Mostrar el modal con el formulario poblado
                // window.scrollTo(0, 0); // Ya no es necesario hacer scroll, el modal aparece en el centro
            })
            .catch(error => {
                console.error('Error al cargar evento para editar:', error);
                showFlashMessage(error.message || 'No se pudo cargar el evento para editar.', 'error');
            });
    }

    window.deleteEventConfirmation = function(id) {
        if (confirm('¿Estás seguro de que quieres eliminar este evento? Esta acción no se puede deshacer.')) {
            deleteEvent(id);
        }
    }

    async function deleteEvent(id) {
        try {
            const response = await fetch(`${apiBaseUrl}/${id}`, { method: 'DELETE' });
            if (response.ok) {
                const result = await response.json();
                showFlashMessage(result.message || 'Evento eliminado con éxito', 'success');
                loadEvents();
            } else {
                const errorResult = await response.json();
                showFlashMessage(errorResult.message || 'Error al eliminar el evento', 'error');
            }
        } catch (error) {
            console.error('Error al eliminar evento:', error);
            showFlashMessage('Error de conexión al eliminar el evento.', 'error');
        }
    }

    function resetForm() {
        eventForm.reset();
        eventIdInput.value = ''; // Limpiar el ID del evento
        formTitle.textContent = 'Añadir Nuevo Evento'; // Restablecer título del formulario/modal
        submitBtn.textContent = 'Guardar Evento'; // Restablecer texto del botón de envío
        // cancelEditBtn.classList.add('hidden'); // Ya no es necesario ocultar/mostrar, siempre está en el modal
                                                // y su comportamiento de cierre de modal está manejado.
                                                // Si se decide que solo aparezca en modo edición, entonces:
                                                // cancelEditBtn.classList.add('hidden');
                                                // Pero para un modal, es común tener siempre visible el "Cancelar".
    }

    // Función para mostrar mensajes flash (simulada, ya que el header maneja los reales)
    function showFlashMessage(message, category) {
        // Esta es una simulación. En una app real, podrías redirigir o recargar
        // para que los mensajes flash de Flask se muestren, o implementar un sistema de notificaciones JS.
        // Por ahora, usaremos un simple alert y un console.log
        console.log(`FLASH (${category}): ${message}`);
        // alert(`${category.toUpperCase()}: ${message}`);

        // Intentar crear un mensaje flash dinámico similar al del _header.html
        const flashContainer = document.getElementById('flash-messages-container') || createFlashContainer();

        const alertDiv = document.createElement('div');
        alertDiv.className = `alert-flash alert-${category} p-4 mb-3 text-sm rounded-lg shadow-md
                        ${category === 'error' ? 'bg-red-100 border border-red-300 text-red-700' : ''}
                        ${category === 'success' ? 'bg-green-100 border border-green-300 text-green-700' : ''}
                        ${category === 'warning' ? 'bg-yellow-100 border border-yellow-300 text-yellow-700' : ''}
                        ${!['error', 'success', 'warning'].includes(category) ? 'bg-blue-100 border border-blue-300 text-blue-700' : ''}`;
        alertDiv.setAttribute('role', 'alert');

        let iconClass = 'fas fa-info-circle';
        let typeText = 'Info:';
        if (category === 'error') { iconClass = 'fas fa-times-circle'; typeText = 'Error:'; }
        else if (category === 'success') { iconClass = 'fas fa-check-circle'; typeText = 'Éxito:'; }
        else if (category === 'warning') { iconClass = 'fas fa-exclamation-triangle'; typeText = 'Advertencia:'; }

        alertDiv.innerHTML = `
            <div class="flex items-center">
                <span class="font-medium mr-2"><i class="${iconClass}"></i> ${typeText}</span>
                <span>${message}</span>
                <button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-transparent text-current rounded-lg focus:ring-2 p-1.5 inline-flex h-8 w-8 hover:bg-opacity-20
                                            ${category === 'error' ? 'hover:bg-red-200 focus:ring-red-400' : ''}
                                            ${category === 'success' ? 'hover:bg-green-200 focus:ring-green-400' : ''}
                                            ${category === 'warning' ? 'hover:bg-yellow-200 focus:ring-yellow-400' : ''}
                                            ${!['error', 'success', 'warning'].includes(category) ? 'hover:bg-blue-200 focus:ring-blue-400' : ''}"
                        onclick="this.closest('.alert-flash').remove();" aria-label="Dismiss">
                  <span class="sr-only">Dismiss</span>
                  <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
            </div>`;

        flashContainer.appendChild(alertDiv);

        setTimeout(() => {
            alertDiv.style.transition = 'opacity 0.5s ease-out';
            alertDiv.style.opacity = '0';
            setTimeout(() => alertDiv.remove(), 500);
        }, 7000);
    }

    function createFlashContainer() {
        let container = document.getElementById('flash-messages-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'flash-messages-container';
            container.className = 'fixed top-5 left-1/2 transform -translate-x-1/2 z-[1000] w-full max-w-xl px-4';
            container.style.marginTop = '60px'; // Similar al _header.html
            // Intentar insertar después del header o al inicio del body
            const header = document.querySelector('header');
            if (header && header.parentNode) {
                header.parentNode.insertBefore(container, header.nextSibling);
            } else {
                document.body.prepend(container);
            }
        }
        return container;
    }
});
</script>
{% endblock %} {# main_dashboard_content #}

{% block additional_scripts %}
    {{ super() }}
    <!-- Puedes añadir scripts específicos para esta página aquí si es necesario -->
{% endblock %}
